(()=>{var e={6914:(e,t,n)=>{"use strict";var r={};n.r(r),n.d(r,{R:()=>Ya,s:()=>$a});var a=n(4048),o=n(388),i=(n(3792),n(3362),n(9085),n(9391),n(3751)),s=n(1034),c=(n(2675),n(9463),n(641)),l=n(953),u=n(33),p={class:"flex-none p-6 text-xl font-bold text-center text-tech-primary border-b border-gray-100"},d={class:"flex-1 p-6 overflow-y-auto custom-scrollbar"},h=["innerHTML"],g={class:"flex-none p-6 border-t border-gray-100"};const f=Object.assign({name:"ModalDialog"},{__name:"ModalDialog",props:{show:{type:Boolean,required:!0},title:{type:String,default:""},content:{type:String,default:""},type:{type:String,default:"normal"},closeButtonText:{type:String,default:"关闭"},confirmButtonText:{type:String,default:"确认"},cancelButtonText:{type:String,default:"取消"},closeOnBackdrop:{type:Boolean,default:!0},large:{type:Boolean,default:!1}},emits:["close","confirm","cancel"],setup:function(e,t){var n=t.emit,r=e,a=n,o=function(){a("close")},s=function(){a("confirm"),o()},l=function(){a("cancel"),o()};return(0,c.wB)((function(){return r.show}),(function(e){document.body.style.overflow=e?"hidden":""})),(0,c.xo)((function(){document.body.style.overflow=""})),function(t,n){return(0,c.uX)(),(0,c.Wv)(i.eB,{name:"modal-fade"},{default:(0,c.k6)((function(){return[e.show?((0,c.uX)(),(0,c.CE)("div",{key:0,class:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50",onClick:n[0]||(n[0]=(0,i.D$)((function(t){return e.closeOnBackdrop&&l()}),["self"]))},[(0,c.Lk)("div",{class:(0,u.C4)(["modal-content",["w-full bg-white rounded-xl shadow-tech-lg transform transition-opacity-transform duration-300","flex flex-col max-h-[90vh]",e.large?"max-w-4xl":"confirm"===e.type?"max-w-md":"max-w-2xl"]])},[(0,c.Lk)("h2",p,(0,u.v_)(e.title),1),(0,c.Lk)("div",d,[(0,c.Lk)("div",{class:"prose prose-tech max-w-none",innerHTML:e.content},null,8,h)]),(0,c.Lk)("div",g,[(0,c.Lk)("div",{class:(0,u.C4)(["flex gap-4","confirm"===e.type?"justify-center":"justify-end"])},[(0,c.RG)(t.$slots,"buttons",{},(function(){return["confirm"===e.type?((0,c.uX)(),(0,c.CE)(c.FK,{key:0},[(0,c.Lk)("button",{class:"px-6 py-2.5 text-white bg-tech-primary hover:bg-tech-accent rounded-lg transition-colors duration-200 min-w-[120px]",onClick:s},(0,u.v_)(e.confirmButtonText),1),(0,c.Lk)("button",{class:"px-6 py-2.5 text-tech-secondary bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors duration-200 min-w-[120px]",onClick:l},(0,u.v_)(e.cancelButtonText),1)],64)):((0,c.uX)(),(0,c.CE)("button",{key:1,class:"px-6 py-2.5 text-tech-secondary bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors duration-200 min-w-[120px]",onClick:o},(0,u.v_)(e.closeButtonText),1))]}))],2)])],2)])):(0,c.Q3)("",!0)]})),_:3})}}});var m=n(6262);const v=(0,m.A)(f,[["__scopeId","data-v-61bb1210"]]),b=v;n(4782),n(8940),n(7495),n(1761),n(6031);var y=n(4119),k=(n(8706),n(1629),n(2062),n(4114),n(6910),n(9432),n(6099),n(6034),n(4864),n(7465),n(7745),n(8781),n(7764),n(5440),n(375),n(3500),n(2953),n(9410)),x=(0,l.KR)({terms:{}}),w=(0,l.KR)({colors:{}}),S=function(){var e=(0,o.A)((0,a.A)().mark((function e(){var t,n;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.prev=0,console.log("开始加载术语配置..."),console.log("当前环境:",{NODE_ENV:"production",VUE_APP_DEPLOY_TARGET:{NODE_ENV:"production",BASE_URL:"/vue/"}.VUE_APP_DEPLOY_TARGET,IS_ITCH:"itch"==={NODE_ENV:"production",BASE_URL:"/vue/"}.VUE_APP_DEPLOY_TARGET}),t="lang/terms_explanations_zh-CN.json",console.log("尝试加载文件:",t),e.prev=5,e.next=8,k.u.loadJSON(t);case 8:n=e.sent,console.log("加载到的原始数据:",n),n&&"object"===(0,y.A)(n)?(console.log("数据是一个对象"),n.terms?(console.log("数据包含 terms 属性"),console.log("terms 内容示例:",Object.keys(n.terms).slice(0,3)),x.value=n):(console.error("数据缺少 terms 属性:",n),x.value={terms:{}})):(console.error("无效的数据格式:",{isNull:null===n,type:(0,y.A)(n),data:n}),x.value={terms:{}}),e.next=17;break;case 13:throw e.prev=13,e.t0=e["catch"](5),console.error("加载过程中出错:",{error:e.t0,message:e.t0.message,stack:e.t0.stack}),e.t0;case 17:e.next=23;break;case 19:e.prev=19,e.t1=e["catch"](0),console.error("加载术语配置失败:",{error:e.t1,message:e.t1.message,stack:e.t1.stack}),x.value={terms:{}};case 23:return e.next=25,C();case 25:case"end":return e.stop()}}),e,null,[[0,19],[5,13]])})));return function(){return e.apply(this,arguments)}}(),E=function(){var e=(0,o.A)((0,a.A)().mark((function e(){var t,n;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.prev=0,console.log("开始加载颜色配置..."),t="config/colors.json",console.log("尝试加载文件:",t),e.next=6,k.u.loadJSON(t);case 6:n=e.sent,console.log("加载到的颜色数据:",n),n&&"object"===(0,y.A)(n)&&n.colors?(w.value=n,console.log("颜色配置加载成功")):(console.error("无效的颜色数据格式:",n),w.value={colors:{}}),e.next=15;break;case 11:e.prev=11,e.t0=e["catch"](0),console.error("加载颜色配置失败:",{error:e.t0,message:e.t0.message,stack:e.t0.stack}),w.value={colors:{}};case 15:case"end":return e.stop()}}),e,null,[[0,11]])})));return function(){return e.apply(this,arguments)}}();function A(e){var t=e.replace("#",""),n=parseInt(t.substr(0,2),16),r=parseInt(t.substr(2,2),16),a=parseInt(t.substr(4,2),16),o=.299*n+.587*r+.114*a;return o<128}function _(e){var t,n,r,a,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";if(!e||null===(t=x.value)||void 0===t||!t.terms||null===(n=w.value)||void 0===n||!n.colors)return console.warn("Missing required data for highlighting:",{hasText:!!e,hasTerms:!(null===(r=x.value)||void 0===r||!r.terms),hasColors:!(null===(a=w.value)||void 0===a||!a.colors)}),e||"";var i=x.value.terms,s=w.value.colors,c=[],l=2,u={};return Object.keys(i).forEach((function(t){if(t!==o){var n,r=s[i[t].color]||i[t].color,a=new RegExp(t,"g");while(null!==(n=a.exec(e)))if(u[t]=(u[t]||0)+1,u[t]<=l){var p=A(r),d=p?"-1px -1px 2px #222, 1px -1px 2px #222, -1px 1px 2px #222, 1px 1px 2px #222":"-1px -1px 2px #000, 1px -1px 2px #000, -1px 1px 2px #000, 1px 1px 2px #000";c.push({term:t,start:n.index,end:n.index+t.length,color:r,textShadow:d})}}})),c.sort((function(e,t){return t.start-e.start})),c.forEach((function(t){e=e.slice(0,t.start)+'<span class="special-term-wrapper"><span class="special-term" \n        style="font-weight: bold; color: '.concat(t.color,"; text-shadow: ").concat(t.textShadow,'; text-decoration: underline;" \n        data-term="').concat(t.term,'">').concat(t.term,"</span></span>")+e.slice(t.end)})),e}function C(){return T.apply(this,arguments)}function T(){return T=(0,o.A)((0,a.A)().mark((function e(){var t,n,r,o,i,s,c=arguments;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:t=c.length>0&&void 0!==c[0]?c[0]:5,n=c.length>1&&void 0!==c[1]?c[1]:1e3,r=[],Object.values(x.value.terms).forEach((function(e){e.imageUrl&&r.push(e.imageUrl)})),o=0;case 5:if(!(o<r.length)){e.next=22;break}return i=r.slice(o,o+t),s=i.map((function(e){return k.u.preloadImage(e)})),e.prev=8,e.next=11,Promise.all(s);case 11:e.next=16;break;case 13:e.prev=13,e.t0=e["catch"](8),console.error("Error preloading images:",e.t0);case 16:if(!(o+t<r.length)){e.next=19;break}return e.next=19,new Promise((function(e){return setTimeout(e,n)}));case 19:o+=t,e.next=5;break;case 22:case"end":return e.stop()}}),e,null,[[8,13]])}))),T.apply(this,arguments)}function I(e){var t=e.term,n=e.event,r=e.termConfig;return{show:!0,description:r.description,imageUrl:r.imageUrl,term:t,event:n}}function L(){return{show:!1,description:"",imageUrl:"",term:"",event:null}}function R(e){var t=x.value.terms,n=t[e];return null!==n&&void 0!==n&&n.imageUrl?k.u.getImageUrl(n.imageUrl):null}var N={class:"flex flex-col space-y-2"},M=["innerHTML"],P={key:0,class:"w-full overflow-hidden"},O=["src"];const D={__name:"TermTooltip",props:{show:Boolean,description:String,imageUrl:String,term:String,event:Object},emits:["term-clicked"],setup:function(e,t){var n=t.emit,r=null,a=(0,l.KR)(null),o=(0,l.KR)({top:"0px",left:"0px"}),p=e,d=n,h=(0,c.EW)((function(){return(0,s.A)({position:"fixed",display:p.show?"block":"none",width:"min(95vw, 36.375rem)",zIndex:1e3},o.value)}));function g(){if(!p.event||!p.show)return{};var e=document.documentElement.clientWidth,t=document.documentElement.clientHeight,n=a.value;if(n){var r=n.offsetWidth,o=n.offsetHeight,i=p.event.clientY+10,s=p.event.clientX+10;return p.event.clientY+o+10>t&&(i=p.event.clientY-o-10),p.event.clientX+r+10>e&&(s=p.event.clientX-r-10),i=Math.max(10,i),s=Math.max(10,s),{top:"".concat(i,"px"),left:"".concat(s,"px")}}}function f(){var e=g();e.top===o.value.top&&e.left===o.value.left||(o.value=e),r=setTimeout((function(){p.show&&requestAnimationFrame(f)}),33)}(0,c.wB)((function(){return p.show}),(function(e){e?(o.value=g(),f()):r&&(clearTimeout(r),r=null)}));var m=(0,c.EW)((function(){return _(p.description,p.term)})),v=(0,c.EW)((function(){return p.imageUrl?k.u.getImageUrl(p.imageUrl):null})),b=function(e){var t=e.target.closest(".special-term-wrapper");if(t){var n,r=null===(n=t.querySelector(".special-term"))||void 0===n?void 0:n.getAttribute("data-term");r&&d("term-clicked",r)}};(0,c.xo)((function(){r&&(clearTimeout(r),r=null)}));var y=(0,c.EW)((function(){var e=x.value.terms[p.term];if(e){var t=w.value.colors[e.color]||e.color,n=!!t.match(/#[0-9A-F]{6}/i)&&parseInt(t.slice(1),16)<8421504,r=n?"-1px -1px 2px #222, 1px -1px 2px #222, -1px 1px 2px #222, 1px 1px 2px #222":"-1px -1px 2px #000, 1px -1px 2px #000, -1px 1px 2px #000, 1px 1px 2px #000";return{color:t,textShadow:r}}return{color:"#1a1a1a"}}));return function(t,n){return(0,c.bo)(((0,c.uX)(),(0,c.CE)("div",{id:"term-tooltip",ref_key:"tooltipElementRef",ref:a,style:(0,u.Tr)(h.value),onClick:(0,i.D$)(b,["stop"]),class:"term-tooltip bg-white rounded-lg shadow-lg border border-gray-200"},[(0,c.Lk)("div",N,[(0,c.Lk)("h3",{class:"text-xl font-semibold",style:(0,u.Tr)(y.value)},(0,u.v_)(e.term),5),(0,c.Lk)("div",{class:"text-gray-600",innerHTML:m.value},null,8,M),e.imageUrl?((0,c.uX)(),(0,c.CE)("div",P,[(0,c.Lk)("img",{src:v.value,class:"w-full h-auto object-contain",alt:"术语图片",onLoad:f},null,40,O)])):(0,c.Q3)("",!0)])],4)),[[i.aG,e.show]])}}},j=(0,m.A)(D,[["__scopeId","data-v-1da47620"]]),U=j;var G=n(4305),V=function(){var e=[G];e.forEach((function(e){var t=document.createElement("link");t.rel="preload",t.as="font",t.type="font/otf",t.href=e,t.crossOrigin="anonymous",document.head.appendChild(t)}))},B=function(){var e=(0,o.A)((0,a.A)().mark((function e(t){return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,document.fonts.load('1em "'.concat(t,'"'));case 3:return e.abrupt("return",!0);case 6:return e.prev=6,e.t0=e["catch"](0),console.error("Font loading failed: ".concat(t),e.t0),e.abrupt("return",!1);case 10:case"end":return e.stop()}}),e,null,[[0,6]])})));return function(t){return e.apply(this,arguments)}}(),K=n(6278),F=n(5220),H=(n(5086),n(2010),n(6992)),z={key:0,class:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50"},W={class:"w-full max-w-[64rem] bg-gradient-to-r from-tech-light to-white rounded-xl shadow-tech-lg transform transition-opacity-transform duration-300 flex flex-col max-h-[calc(100vh-2rem)] my-safe"},X={class:"flex-none p-6 border-b border-gray-100"},J={class:"flex items-center gap-4"},q={class:"text-2xl font-bold text-tech-primary"},Q={class:"text-tech-secondary mt-1"},Y={class:"flex-1 overflow-y-auto overflow-x-hidden px-4 custom-scrollbar min-h-0"},$={class:"space-y-4 py-4"},Z={class:"flex flex-col"},ee={class:"flex items-start gap-4"},te={class:"flex-shrink-0 w-10 h-10 rounded-lg bg-tech-light flex items-center justify-center text-responsive-lg"},ne={class:"flex-grow min-w-0"},re={class:"text-responsive font-semibold text-tech-primary truncate"},ae={class:"text-responsive-sm text-tech-secondary mt-1"},oe={class:"flex-shrink-0 flex flex-col items-end gap-2"},ie={class:"flex items-center gap-3"},se={class:"flex items-center gap-2"},ce={class:"text-responsive-sm text-tech-secondary"},le={class:"flex items-center gap-2"},ue={class:"text-responsive-sm text-tech-secondary"},pe={key:0},de={key:0,class:"mt-6 mx-0 p-4 bg-yellow-50 rounded-xl border border-yellow-200"},he={class:"flex-none p-6 border-t border-gray-100"},ge={class:"flex justify-center gap-4"};const fe={__name:"TimelineInfluenceModal",setup:function(e){var t=(0,K.Pj)(),n=(0,H.s9)(),r=n.t,a=(0,c.EW)((function(){return t.state.game.timelineInfluenceModal.show})),o=(0,c.EW)((function(){return t.state.game.timelineInfluenceModal.timePoint})),s=(0,c.EW)((function(){return t.state.game.timelineInfluenceModal.influences})),p=(0,c.EW)((function(){return s.value.some((function(e){return e.oldValue!==e.newValue}))})),d=function(){var e=t.state.game.timelineInfluenceModal.onConfirm;e&&e()},h=function(){var e=t.state.game.timelineInfluenceModal.onCancel;e&&e()},g=function(e){return e.defaultValue===e.newValue&&e.display.hideDefault&&e.display.defaultAlternateName?e.display.defaultAlternateName:e.display.name},f=function(e){return e.defaultValue===e.newValue&&e.display.hideDefault&&e.display.defaultAlternateDesc?e.display.defaultAlternateDesc:e.display.description};return function(e,t){return(0,c.uX)(),(0,c.Wv)(i.eB,{name:"modal-fade"},{default:(0,c.k6)((function(){return[a.value?((0,c.uX)(),(0,c.CE)("div",z,[(0,c.Lk)("div",W,[(0,c.Lk)("div",X,[(0,c.Lk)("div",J,[t[0]||(t[0]=(0,c.Lk)("div",{class:"flex-shrink-0 w-12 h-12 bg-tech-primary rounded-full flex items-center justify-center"},[(0,c.Lk)("svg",{xmlns:"http://www.w3.org/2000/svg",class:"w-6 h-6 text-white",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[(0,c.Lk)("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"})])],-1)),(0,c.Lk)("div",null,[(0,c.Lk)("h3",q,(0,u.v_)(o.value.name),1),(0,c.Lk)("p",Q,(0,u.v_)(o.value.timeDesc),1)])])]),(0,c.Lk)("div",Y,[(0,c.Lk)("div",$,[(0,c.bF)(i.F,{name:"influence-item",tag:"div",class:"space-y-4"},{default:(0,c.k6)((function(){return[((0,c.uX)(!0),(0,c.CE)(c.FK,null,(0,c.pI)(s.value,(function(e){return(0,c.uX)(),(0,c.CE)("div",{key:e.id,class:"bg-white rounded-xl p-6 shadow-tech hover:shadow-tech-lg transition-all duration-300 transform hover:scale-[1.02] mx-0"},[(0,c.Lk)("div",Z,[(0,c.Lk)("div",ee,[(0,c.Lk)("div",te,(0,u.v_)(e.display.icon),1),(0,c.Lk)("div",ne,[(0,c.Lk)("h4",re,(0,u.v_)(g(e)),1),(0,c.Lk)("p",ae,(0,u.v_)(f(e)),1)]),(0,c.Lk)("div",oe,[(0,c.Lk)("div",ie,[(0,c.Lk)("div",se,[(0,c.Lk)("span",{class:(0,u.C4)(["w-2 h-2 rounded-full",e.oldValue?"bg-green-500":"bg-red-500"])},null,2),(0,c.Lk)("span",ce,(0,u.v_)(e.oldValue?"是":"否"),1)]),t[1]||(t[1]=(0,c.Lk)("svg",{xmlns:"http://www.w3.org/2000/svg",class:"w-4 h-4 text-tech-secondary",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[(0,c.Lk)("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M9 5l7 7-7 7"})],-1)),(0,c.Lk)("div",le,[(0,c.Lk)("span",{class:(0,u.C4)(["w-2 h-2 rounded-full",e.newValue?"bg-green-500":"bg-red-500"])},null,2),(0,c.Lk)("span",ue,(0,u.v_)(e.newValue?"是":"否"),1)])]),e.oldValue!==e.newValue?((0,c.uX)(),(0,c.CE)("div",pe,[(0,c.Lk)("span",{class:(0,u.C4)(["px-2 py-1 text-responsive-sm rounded-full text-sm",e.newValue===e.defaultValue?"bg-green-100 text-green-700":"bg-yellow-100 text-yellow-700"])},(0,u.v_)(e.newValue===e.defaultValue?"恢复原状":"产生变化"),3)])):(0,c.Q3)("",!0)])])])])})),128))]})),_:1})]),p.value?((0,c.uX)(),(0,c.CE)("div",de,t[2]||(t[2]=[(0,c.Lk)("div",{class:"flex gap-3"},[(0,c.Lk)("svg",{xmlns:"http://www.w3.org/2000/svg",class:"w-6 h-6 text-yellow-600",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[(0,c.Lk)("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})]),(0,c.Lk)("p",{class:"text-responsive-sm text-yellow-700"},[(0,c.Lk)("span",{class:"font-semibold"},"注意："),(0,c.eW)(" 确认后将覆盖该时间点的原有影响记录，此操作不可撤销。 ")])],-1)]))):(0,c.Q3)("",!0)]),(0,c.Lk)("div",he,[(0,c.Lk)("div",ge,[(0,c.Lk)("button",{class:"px-6 py-2.5 text-white bg-tech-primary hover:bg-tech-accent rounded-lg transition-colors duration-200 min-w-[7.5rem]",onClick:d},(0,u.v_)((0,l.R1)(r)("common.confirm")),1),(0,c.Lk)("button",{class:"px-6 py-2.5 text-tech-secondary bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors duration-200 min-w-[7.5rem]",onClick:h},(0,u.v_)((0,l.R1)(r)("common.cancel")),1)])])])])):(0,c.Q3)("",!0)]})),_:1})}}},me=(0,m.A)(fe,[["__scopeId","data-v-449eb37e"]]),ve=me,be=Object.assign({name:"AppRoot"},{__name:"App",setup:function(e,t){var n=t.expose,r=(0,l.KR)(!1),u=(0,l.KR)(""),p=(0,l.KR)(""),d=(0,l.KR)(""),h=(0,l.KR)(null),g=(0,l.KR)({}),f=(0,l.KR)(null);(0,c.sV)((0,o.A)((0,a.A)().mark((function e(){var t,n;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return t=(0,K.Pj)(),e.next=3,t.dispatch("settings/initializeSave");case 3:return t.getters["settings/hasValidApiKey"]||(console.log("尝试自动配置游戏节 Key"),t.dispatch("settings/useAgentlandFestival2025Key")["catch"]((function(e){return console.error("自动配置游戏节 Key 失败:",e)}))),S(),E(),V(),e.next=9,B("Unifont");case 9:n=e.sent,n&&document.documentElement.classList.add("fonts-loaded");case 11:case"end":return e.stop()}}),e)}))));var m=function(e){var t=e.touches?e.touches[0]:e;if(e.target.classList.contains("special-term")){var n=e.target.getAttribute("data-term"),a=x.value.terms[n];u.value=a.description,p.value=a.imageUrl,d.value=n,h.value={pageX:t.pageX,pageY:t.pageY,clientX:t.clientX,clientY:t.clientY},r.value=!0}else e.target.closest("#term-tooltip")||(r.value=!1)};(0,c.sV)((function(){document.addEventListener("click",m),document.addEventListener("touchstart",m)})),(0,c.hi)((function(){document.removeEventListener("click",m),document.removeEventListener("touchstart",m)}));var v=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};g.value[e]=(0,s.A)((0,s.A)({},t),{},{show:!0})},y=function(e){g.value[e]&&(g.value[e].show=!1,delete g.value[e])},k=function(e){var t=x.value.terms[e];t&&(u.value=t.description,p.value=t.imageUrl,d.value=e,r.value=!0)},w=(0,F.rd)();(0,c.sV)((function(){w.afterEach((function(){window.scrollTo({top:0,behavior:"instant"})}))}));var A=function(e){e.style.position="absolute",e.style.width="100%"},_=function(e){e.style.position="absolute",e.style.width="100%"},C=function(e){e.style.position="",e.style.width=""},T=function(){var e=window.innerWidth,t=window.innerHeight,n=1024,r=640,a=Math.min(e/n,t/r,1);document.documentElement.style.fontSize="".concat(16*a,"px")};return(0,c.sV)((function(){T(),window.addEventListener("resize",T)})),(0,c.hi)((function(){window.removeEventListener("resize",T)})),n({showModal:v,hideModal:y}),function(e,t){var n=(0,c.g2)("router-view");return(0,c.uX)(),(0,c.CE)("div",{id:"app",class:"landscape-container overflow-hidden",ref_key:"appContainer",ref:f},[(0,c.bF)(n,null,{default:(0,c.k6)((function(e){var t=e.Component,n=e.route;return[(0,c.bF)(i.eB,{name:n.meta.transition||"page",mode:"out-in",onBeforeLeave:A,onEnter:_,onAfterEnter:C},{default:(0,c.k6)((function(){return[((0,c.uX)(),(0,c.Wv)((0,c.$y)(t)))]})),_:2},1032,["name"])]})),_:1}),((0,c.uX)(!0),(0,c.CE)(c.FK,null,(0,c.pI)(g.value,(function(e,t){return(0,c.uX)(),(0,c.Wv)(b,(0,c.v6)({key:t,ref_for:!0},e,{onClose:function(e){return y(t)}}),null,16,["onClose"])})),128)),(0,c.bF)(U,{show:r.value,description:u.value,imageUrl:p.value,term:d.value,event:h.value,onTermClicked:k},null,8,["show","description","imageUrl","term","event"]),(0,c.bF)(ve)],512)}}}),ye=be,ke=ye;var xe={BASE_PATH:function(){if(console.log("Deploy Target:",{NODE_ENV:"production",BASE_URL:"/vue/"}.VUE_APP_DEPLOY_TARGET),console.log("NODE_ENV:","production"),"itch"==={NODE_ENV:"production",BASE_URL:"/vue/"}.VUE_APP_DEPLOY_TARGET)return console.log("Using itch.io base path"),".";var e="/vue/";return console.log("Using path:",e),e}(),ASSETS_PREFIX:function(){return"itch"==={NODE_ENV:"production",BASE_URL:"/vue/"}.VUE_APP_DEPLOY_TARGET?"./assets":"/vue/assets"}()},we={class:"min-h-screen bg-gradient-to-r from-white to-tech-light overflow-hidden"},Se={class:"fixed inset-0 bg-cover bg-center z-10"},Ee={class:"fixed inset-0 z-20 flex overflow-hidden"},Ae={class:"flex-1 relative"},_e=["src"],Ce=["src"],Te=["title"],Ie={class:"flex-none py-8 flex flex-col items-center space-y-4"},Le={class:"text-responsive-title font-bold text-tech-primary scale-y-95"},Re={class:"text-responsive-subtitle font-medium text-tech-secondary cjk-text"},Ne={key:0,class:"text-sm text-tech-secondary/80 font-medium"},Me={class:"flex-1 overflow-y-auto overflow-x-hidden px-2 custom-scrollbar"},Pe={class:"grid grid-cols-1 gap-4"},Oe={class:"space-y-4"},De={class:"space-y-2"},je=["disabled"],Ue={class:"text-lg font-medium"},Ge={key:0,class:"text-center text-sm text-tech-secondary"},Ve=["disabled"],Be={class:"text-lg font-medium"},Ke=["disabled"],Fe={class:"text-lg font-medium"},He=["disabled"],ze={class:"text-lg font-medium"},We={class:"grid grid-cols-2 gap-4"},Xe={class:"relative"},Je={key:0,class:"absolute -top-2 -right-2 w-3 h-3 bg-red-500 rounded-full animate-pulse"},qe={class:"grid grid-cols-2 gap-4"},Qe={class:"flex-none py-4 flex flex-col items-center space-y-2"},Ye={class:"text-responsive-sm text-tech-secondary hover:text-tech-primary transition-colors duration-300"},$e={href:"https://qm.qq.com/q/XW4FGxWPGa",target:"_blank",class:"flex items-center space-x-2"},Ze=["title"],et={key:0,class:"mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-xl"},tt={class:"text-sm text-yellow-700 text-center"};const nt=Object.assign({name:"HomeView"},{__name:"HomeView",setup:function(e){var t=(0,K.Pj)(),n=(0,F.rd)(),r=(0,l.KR)(null),i=(0,c.WQ)("$modal"),s=(0,H.s9)(),p=s.t,d=(0,c.EW)((function(){return j.value&&t.getters["save/hasSave"]})),h=(0,c.EW)((function(){return t.getters["settings/hasValidApiKey"]})),g=(0,l.KR)(""),f=(0,l.KR)(!1),m=(0,l.KR)(!1),v=(0,l.KR)("-30%"),b=function(){f.value&&(m.value=!m.value)},y=function(){var e=(0,o.A)((0,a.A)().mark((function e(){return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(h.value){e.next=3;break}return i.show("error",{title:p("error"),content:p("settings.noApiKey"),type:"normal",onClose:function(){n.push("/settings")}}),e.abrupt("return");case 3:return e.prev=3,console.log("开始新游戏..."),localStorage.setItem("hasStartedGame","true"),j.value=!0,e.next=9,t.dispatch("save/clearSave");case 9:n.push("/scenario-select"),e.next=16;break;case 12:e.prev=12,e.t0=e["catch"](3),console.error("开始新游戏失败:",e.t0),i.show("error",{title:p("error"),content:p("startGameError"),type:"normal"});case 16:case"end":return e.stop()}}),e,null,[[3,12]])})));return function(){return e.apply(this,arguments)}}(),x=function(){var e=(0,o.A)((0,a.A)().mark((function e(){return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(h.value){e.next=3;break}return i.show("error",{title:p("error"),content:p("settings.noApiKey"),type:"normal",onClose:function(){n.push("/settings")}}),e.abrupt("return");case 3:return e.prev=3,e.next=6,t.dispatch("save/loadSave");case 6:n.push("/scenario-select"),e.next=13;break;case 9:e.prev=9,e.t0=e["catch"](3),console.error("继续游戏失败:",e.t0),i.show("error",{title:p("error"),content:p("loadSaveError"),type:"normal"});case 13:case"end":return e.stop()}}),e,null,[[3,9]])})));return function(){return e.apply(this,arguments)}}(),w=function(){n.push("/settings")},S=function(){var e=(0,o.A)((0,a.A)().mark((function e(n){var r;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(r=n.target.files[0],r){e.next=3;break}return e.abrupt("return");case 3:return e.prev=3,e.next=6,t.dispatch("save/importSave",r);case 6:i.show("success",{title:p("success"),content:p("importSuccess"),type:"normal"}),location.reload(),e.next=13;break;case 10:e.prev=10,e.t0=e["catch"](3),i.show("error",{title:p("error"),content:e.t0.message,type:"normal"});case 13:return e.prev=13,n.target.value="",e.finish(13);case 16:case"end":return e.stop()}}),e,null,[[3,10,13,16]])})));return function(t){return e.apply(this,arguments)}}(),E=function(){i.show("creators-message",{title:p("menu.creatorsMessageTitle"),content:p("menu.creatorsMessageContent"),closeButtonText:p("common.close"),large:!0,type:"normal"})},A=function(){i.show("update-log",{title:p("menu.updateLogTitle"),content:p("menu.updateLogContent"),closeButtonText:p("common.close"),large:!0,type:"normal"})},_=function(){d.value?i.show("confirm",{title:p("game.confirmNewGameTitle"),content:p("game.confirmNewGame"),type:"confirm",onConfirm:y}):y()},C=function(){i.show("game-tutorial",{title:p("menu.gameTutorial.title"),content:p("menu.gameTutorial.content"),closeButtonText:p("common.close"),large:!0,type:"normal"})};console.log("HomeView script setup executing"),(0,c.sV)((0,o.A)((0,a.A)().mark((function e(){var n,r;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return console.log("HomeView mounted"),e.prev=1,e.next=4,t.dispatch("save/loadSave");case 4:n=e.sent,console.log("Save data loaded:",n),e.next=12;break;case 8:e.prev=8,e.t0=e["catch"](1),console.error("加载存档失败:",e.t0),i.show("error",{title:"错误",content:"加载存档失败: "+e.t0.message,type:"normal"});case 12:return e.prev=12,e.next=15,k.u.loadConfig("version.json");case 15:r=e.sent,g.value=r.version,console.log("Version loaded:",g.value),e.next=23;break;case 20:e.prev=20,e.t1=e["catch"](12),console.error("加载版本号失败:",e.t1);case 23:return e.next=25,L();case 25:case"end":return e.stop()}}),e,null,[[1,8],[12,20]])}))));var T=(0,l.KR)(!1),I=(0,l.KR)(!1),L=function(){var e=(0,o.A)((0,a.A)().mark((function e(){return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,k.u.preloadVideo("videos/homeView_background.mp4");case 3:T.value=!0,e.next=10;break;case 6:e.prev=6,e.t0=e["catch"](0),console.error("背景视频加载失败:",e.t0),I.value=!0;case 10:case"end":return e.stop()}}),e,null,[[0,6]])})));return function(){return e.apply(this,arguments)}}(),R=function(){T.value=!0},N=function(){f.value=!0},M=(0,c.EW)((function(){return t.getters["save/getCurrentGameInfo"]})),P=function(){var e=(0,o.A)((0,a.A)().mark((function e(){return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(h.value){e.next=3;break}return i.show("error",{title:p("error"),content:p("settings.noApiKey"),type:"normal",onClose:function(){n.push("/settings")}}),e.abrupt("return");case 3:return e.prev=3,e.next=6,t.dispatch("save/loadSave");case 6:n.push("/sections"),e.next=13;break;case 9:e.prev=9,e.t0=e["catch"](3),console.error("继续游戏失败:",e.t0),i.show("error",{title:p("error"),content:p("loadSaveError"),type:"normal"});case 13:case"end":return e.stop()}}),e,null,[[3,9]])})));return function(){return e.apply(this,arguments)}}(),O=(0,c.EW)((function(){return k.u.getVideoUrl("videos/homeView_background.mp4")})),D=(0,c.EW)((function(){return k.u.getImageUrl("images/TitleShow.png")})),j=(0,l.KR)("true"===localStorage.getItem("hasStartedGame"));return function(e,t){return(0,c.uX)(),(0,c.CE)("div",we,[t[17]||(t[17]=(0,c.Lk)("div",{class:"fixed inset-0 bg-white z-0"},[(0,c.Lk)("div",{class:"absolute inset-0 bg-gradient-to-r from-white to-tech-light opacity-50"})],-1)),(0,c.Lk)("div",Se,[(0,c.Lk)("div",{class:"absolute inset-0 bg-cover bg-center",style:(0,u.Tr)({backgroundImage:"url(".concat(D.value,")")})},null,4),t[2]||(t[2]=(0,c.Lk)("div",{class:"absolute inset-0 bg-gradient-to-r from-transparent to-white/90"},null,-1))]),(0,c.Lk)("div",Ee,[(0,c.Lk)("div",Ae,[(0,c.Lk)("img",{src:D.value,alt:"主视觉图",class:(0,u.C4)(["h-full w-full object-cover transition-transform duration-500 ease-tech",{"translate-x-[-8.75%]":!m.value}]),onLoad:N},null,42,_e),I.value?(0,c.Q3)("",!0):((0,c.uX)(),(0,c.CE)("video",{key:0,class:(0,u.C4)(["absolute inset-0 w-[130%] h-full object-cover transition-all duration-500 ease-tech origin-left",{"translate-x-[-8.75%]":!m.value}]),style:(0,u.Tr)({opacity:T.value?1:0,transform:m.value?"translateX(0)":"translateX(".concat(v.value.value,")")}),src:O.value,autoplay:"",loop:"",muted:"",playsinline:"",onLoadeddata:R,onError:t[0]||(t[0]=function(e){return I.value=!0})},null,46,Ce))]),(0,c.Lk)("div",{class:(0,u.C4)(["w-[35%] h-full flex flex-col px-8 bg-white transition-transform duration-500 ease-tech absolute right-0",{"translate-x-full":m.value}])},[m.value?(0,c.Q3)("",!0):((0,c.uX)(),(0,c.CE)("button",{key:0,onClick:b,class:"absolute left-0 top-4 -translate-x-full bg-white hover:bg-gray-50 p-2 rounded-l-xl shadow-lg transition-colors",title:(0,l.R1)(p)("game.hideMenu")},t[3]||(t[3]=[(0,c.Lk)("svg",{class:"w-5 h-5 text-tech-primary",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[(0,c.Lk)("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M9 5l7 7-7 7"})],-1)]),8,Te)),(0,c.Lk)("div",Ie,[(0,c.Lk)("h1",Le,(0,u.v_)((0,l.R1)(p)("menu.mainTitle")),1),(0,c.Lk)("h2",Re,(0,u.v_)((0,l.R1)(p)("menu.subTitle")),1),g.value?((0,c.uX)(),(0,c.CE)("div",Ne," v"+(0,u.v_)(g.value),1)):(0,c.Q3)("",!0)]),(0,c.Lk)("div",Me,[(0,c.Lk)("div",Pe,[(0,c.Lk)("div",Oe,[d.value?((0,c.uX)(),(0,c.CE)(c.FK,{key:0},[(0,c.Lk)("div",De,[(0,c.Lk)("button",{onClick:P,disabled:!h.value,class:(0,u.C4)(["w-full p-4 bg-tech-primary hover:bg-tech-primary/90 text-white rounded-xl shadow-tech transition-all duration-300 hover:scale-[1.02] flex items-center justify-center space-x-3",{"opacity-50 cursor-not-allowed":!h.value}])},[t[4]||(t[4]=(0,c.Lk)("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[(0,c.Lk)("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"}),(0,c.Lk)("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})],-1)),(0,c.Lk)("span",Ue,(0,u.v_)((0,l.R1)(p)("game.continueGame")),1)],10,je),M.value?((0,c.uX)(),(0,c.CE)("div",Ge,(0,u.v_)((0,l.R1)(p)("game.currentGameInfo",{scenario:M.value.scenarioName,character:M.value.characterName})),1)):(0,c.Q3)("",!0)]),(0,c.Lk)("button",{onClick:x,disabled:!h.value,class:(0,u.C4)(["w-full p-4 bg-white hover:bg-gray-50 text-tech-primary border-2 border-tech-primary rounded-xl shadow-tech transition-all duration-300 hover:scale-[1.02] flex items-center justify-center space-x-3",{"opacity-50 cursor-not-allowed":!h.value}])},[t[5]||(t[5]=(0,c.Lk)("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[(0,c.Lk)("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"})],-1)),(0,c.Lk)("span",Be,(0,u.v_)((0,l.R1)(p)("game.selectScenario")),1)],10,Ve),(0,c.Lk)("button",{onClick:_,disabled:!h.value,class:(0,u.C4)(["w-full p-4 bg-white hover:bg-gray-50 text-tech-primary/80 border-2 border-tech-primary/20 rounded-xl shadow-tech transition-all duration-300 hover:scale-[1.02] flex items-center justify-center space-x-3",{"opacity-50 cursor-not-allowed":!h.value}])},[t[6]||(t[6]=(0,c.Lk)("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[(0,c.Lk)("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 6v6m0 0v6m0-6h6m-6 0H6"})],-1)),(0,c.Lk)("span",Fe,(0,u.v_)((0,l.R1)(p)("game.newGame")),1)],10,Ke)],64)):((0,c.uX)(),(0,c.CE)("button",{key:1,onClick:y,disabled:!h.value,class:(0,u.C4)(["w-full p-4 bg-tech-primary hover:bg-tech-primary/90 text-white rounded-xl shadow-tech transition-all duration-300 hover:scale-[1.02] flex items-center justify-center space-x-3",{"opacity-50 cursor-not-allowed":!h.value}])},[t[7]||(t[7]=(0,c.Lk)("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[(0,c.Lk)("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 6v6m0 0v6m0-6h6m-6 0H6"})],-1)),(0,c.Lk)("span",ze,(0,u.v_)((0,l.R1)(p)("game.newGame")),1)],10,He))]),(0,c.Lk)("div",We,[(0,c.Lk)("button",{onClick:w,class:(0,u.C4)(["menu-card-button",{"animate-pulse ring-2 ring-tech-primary":!h.value}])},[(0,c.Lk)("div",Xe,[t[8]||(t[8]=(0,c.Lk)("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[(0,c.Lk)("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"}),(0,c.Lk)("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M15 12a3 3 0 11-6 0 3 3 0 016 0z"})],-1)),h.value?(0,c.Q3)("",!0):((0,c.uX)(),(0,c.CE)("div",Je))]),(0,c.Lk)("span",null,(0,u.v_)((0,l.R1)(p)("settings.text")),1)],2),(0,c.Lk)("button",{onClick:C,class:"menu-card-button"},[t[9]||(t[9]=(0,c.Lk)("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[(0,c.Lk)("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"})],-1)),(0,c.Lk)("span",null,(0,u.v_)((0,l.R1)(p)("menu.gameTutorial.text")),1)])]),(0,c.Lk)("div",qe,[(0,c.Lk)("button",{onClick:E,class:"menu-card-button"},[t[10]||(t[10]=(0,c.Lk)("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[(0,c.Lk)("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"})],-1)),(0,c.Lk)("span",null,(0,u.v_)((0,l.R1)(p)("menu.creatorsMessage")),1)]),(0,c.Lk)("button",{onClick:A,class:"menu-card-button"},[t[11]||(t[11]=(0,c.Lk)("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[(0,c.Lk)("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"})],-1)),(0,c.Lk)("span",null,(0,u.v_)((0,l.R1)(p)("menu.updateLog")),1)]),(0,c.Q3)("",!0),(0,c.Q3)("",!0),(0,c.Q3)("",!0)])])]),(0,c.Lk)("div",Qe,[(0,c.Lk)("div",Ye,[(0,c.Lk)("a",$e,[t[15]||(t[15]=(0,c.Lk)("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[(0,c.Lk)("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a1.994 1.994 0 01-1.414-.586m0 0L11 14h4a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2v4l.586-.586z"})],-1)),(0,c.Lk)("span",null,(0,u.v_)((0,l.R1)(p)("menu.footer.qqGroup"))+": 1028122611（母港）",1)])])])],2),m.value?((0,c.uX)(),(0,c.CE)("button",{key:0,onClick:b,class:"fixed right-0 top-4 bg-white hover:bg-gray-50 p-2 rounded-l-xl shadow-lg transition-colors z-20",title:(0,l.R1)(p)("game.showMenu")},t[16]||(t[16]=[(0,c.Lk)("svg",{class:"w-5 h-5 text-tech-primary",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[(0,c.Lk)("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M15 19l-7-7 7-7"})],-1)]),8,Ze)):(0,c.Q3)("",!0)]),(0,c.Lk)("input",{ref_key:"fileInput",ref:r,type:"file",class:"hidden",accept:".savegame",onChange:S},null,544),h.value?(0,c.Q3)("",!0):((0,c.uX)(),(0,c.CE)("div",et,[(0,c.Lk)("p",tt,(0,u.v_)((0,l.R1)(p)("settings.needApiKeyNotice")),1)]))])}}}),rt=nt,at=rt;n(2008),n(1688),n(3288),n(3296),n(7208),n(8408),n(4603),n(7566),n(8721);var ot=n(5026),it=n(9492),st=(n(739),n(3110),function(){function e(){(0,ot.A)(this,e),this._modal=null}return(0,it.A)(e,[{key:"setModal",value:function(e){this._modal=e}},{key:"getModal",value:function(){return this._modal}}])}()),ct=new st,lt=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";(0,ot.A)(this,e),this.debugMode=t,this.moduleName=n}return(0,it.A)(e,[{key:"getPrefix",value:function(){return this.moduleName?"[".concat(this.moduleName,"]"):""}},{key:"log",value:function(e){}},{key:"warn",value:function(e){}},{key:"error",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;console.error("[ERROR]".concat(this.getPrefix()," ").concat(e),t);var n=ct.getModal();n&&n.show("error",{title:"错误",content:"".concat(e).concat(t?"\n".concat(JSON.stringify(t)):""),type:"normal"})}}])}(),ut=new lt(!0,"ImageUtils"),pt=function(){var e=(0,o.A)((0,a.A)().mark((function e(t){var n,r,o;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.prev=0,ut.log("开始下载图片:",t),e.next=4,fetch(t);case 4:return n=e.sent,e.next=7,n.blob();case 7:return r=e.sent,o=URL.createObjectURL(r),ut.log("图片下载完成，创建本地URL:",o),e.abrupt("return",o);case 13:throw e.prev=13,e.t0=e["catch"](0),ut.error("图片下载失败:",e.t0),e.t0;case 17:case"end":return e.stop()}}),e,null,[[0,13]])})));return function(t){return e.apply(this,arguments)}}(),dt=(n(9089),n(6033),n(1415),n(7642),n(8004),n(3853),n(5876),n(2475),n(5024),n(1698),n(7380)),ht=(0,dt.A)(),gt=function(){function e(){(0,ot.A)(this,e),this.characters=new Map,this.defaultMaxValues={health:10,mana:10},this.enabledCharacters=new Set,this.nonAbilityUsers=new Set,this.debugMode=!1,this.logger=new lt(this.debugMode,"ValueManager"),this.effectDuration=5e3,this.effectCounter=0}return(0,it.A)(e,[{key:"initializeCharacter",value:function(e,t){if(this.logger.log("初始化角色数值",{characterName:e,valueConfig:t}),t){var n,r,a,o,i={health:{current:null!==(n=t.initialHealth)&&void 0!==n?n:this.defaultMaxValues.health,max:null!==(r=t.maxHealth)&&void 0!==r?r:this.defaultMaxValues.health},mana:{current:null!==(a=t.initialMana)&&void 0!==a?a:null,max:null!==(o=t.maxMana)&&void 0!==o?o:null}};return this.characters.set(e,i),this.enabledCharacters.add(e),null===i.mana.current&&this.nonAbilityUsers.add(e),this.logger.log("角色 ".concat(e," 数值系统已启用"),i),i}return this.logger.log("角色 ".concat(e," 未配置数值系统")),null}},{key:"getCharacterValues",value:function(e){if(!this.enabledCharacters.has(e))return this.logger.log("获取角色数值失败：".concat(e," 未启用数值系统")),null;var t=this.characters.get(e);return this.logger.log("获取角色 ".concat(e," 数值"),t),t}},{key:"getValueStatus",value:function(e){if(!this.enabledCharacters.has(e))return this.logger.log("获取状态失败：".concat(e," 未启用数值系统")),null;var t=this.getCharacterValues(e);if(!t)return this.logger.warn("获取状态失败：找不到角色 ".concat(e," 的数值")),null;var n=this._getStatusText(t.health.current,t.health.max,"health"),r=this.nonAbilityUsers.has(e)?"不是异能者":this._getStatusText(t.mana.current,t.mana.max,"mana"),a={text:"生命: ".concat(n,", ").concat(this.nonAbilityUsers.has(e)?"状态":"灵力",": ").concat(r),health:{current:t.health.current,max:t.health.max,status:n},mana:{current:t.mana.current,max:t.mana.max,isAbilityUser:!this.nonAbilityUsers.has(e),status:r}};return this.logger.log("获取角色 ".concat(e," 状态"),a),a}},{key:"isCharacterEnabled",value:function(e){return this.enabledCharacters.has(e)}},{key:"applyValueChanges",value:function(e,t){var n=this;this.logger.log("准备应用数值变化",{characterName:e,changes:t});var r=this.getCharacterValues(e);return r?(t.forEach((function(t){var a=n._getChangeAmount(t.amount),o="health"===t.type?r.health.current:r.mana.current,i={characterName:e,type:"health"===t.type?a>0?"damage":"heal":"mana",level:t.amount,timestamp:Date.now()};n.triggerEffect(i),"health"===t.type?(r.health.current=Math.max(0,r.health.current-a),n.logger.log("生命值变化",{character:e,reason:t.reason,from:o,to:r.health.current,change:a})):"mana"===t.type&&(r.mana.current=Math.max(0,r.mana.current-a),n.logger.log("灵力值变化",{character:e,reason:t.reason,from:o,to:r.mana.current,change:a}))})),this.characters.set(e,r),!0):(this.logger.warn("应用数值变化失败：找不到角色 ".concat(e," 的数值")),!1)}},{key:"_getStatusText",value:function(e,t,n){var r=e/t;return"health"===n?r>=.7?"状态良好":r>=.5?"略有受伤":r>=.1?"伤痕累累":r<=0?"失去意识":"奄奄一息":"mana"===n?r>=.7?"灵力充沛":r>=.5?"灵力充足":r>=.1?"灵力有余":"灵力枯竭":void 0}},{key:"_getChangeAmount",value:function(e){switch(e){case"minor":return 2;case"medium":return 3;case"major":return 4;default:return 0}}},{key:"isInCriticalCondition",value:function(e){var t=this.getCharacterValues(e);if(!t)return!1;var n=t.health.current/t.health.max;return n<=.1}},{key:"triggerEffect",value:function(e){var t=(0,s.A)((0,s.A)({},e),{},{duration:this.effectDuration});ht.emit("value-effect",t)}}])}(),ft=(n(2892),n(6280),n(6918),n(5276),n(1392),function(){function e(){(0,ot.A)(this,e),this.loadedImages=new Set,this.loading=new Map}return(0,it.A)(e,[{key:"getFullUrl",value:function(e){return e.startsWith("http")?e:k.u.getImageUrl(e)}},{key:"preloadImage",value:function(){var e=(0,o.A)((0,a.A)().mark((function e(t){var n,r,o=this;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(n=this.getFullUrl(t),!this.loadedImages.has(n)){e.next=3;break}return e.abrupt("return",n);case 3:if(!this.loading.has(n)){e.next=5;break}return e.abrupt("return",this.loading.get(n));case 5:return r=fetch(n).then((function(e){if(!e.ok)throw new Error("Failed to load image: ".concat(n));return o.loadedImages.add(n),o.loading["delete"](n),n}))["catch"]((function(e){throw o.loading["delete"](n),e})),this.loading.set(n,r),e.abrupt("return",r);case 8:case"end":return e.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()},{key:"preloadBatch",value:function(){var e=(0,o.A)((0,a.A)().mark((function e(t){var n,r,o,i,s,c,l,u,p=this,d=arguments;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:for(n=d.length>1&&void 0!==d[1]?d[1]:3,r=d.length>2&&void 0!==d[2]?d[2]:1e3,o=[],i=0;i<t.length;i+=n)s=t.slice(i,i+n),o.push(s);c=0,l=o;case 5:if(!(c<l.length)){e.next=21;break}return u=l[c],e.prev=7,e.next=10,Promise.all(u.map((function(e){return p.preloadImage(e)})));case 10:if(!(o.indexOf(u)<o.length-1)){e.next=13;break}return e.next=13,new Promise((function(e){return setTimeout(e,r)}));case 13:e.next=18;break;case 15:e.prev=15,e.t0=e["catch"](7),console.warn("Failed to preload image batch:",e.t0);case 18:c++,e.next=5;break;case 21:case"end":return e.stop()}}),e,null,[[7,15]])})));function t(t){return e.apply(this,arguments)}return t}()},{key:"isImageLoaded",value:function(e){var t=this.getFullUrl(e);return this.loadedImages.has(t)}}])}()),mt=new ft,vt={key:0,class:"loading-indicator"},bt={class:"loader"},yt={class:"progress-text"},kt={class:"loading-bar"};const xt={__name:"LoadingIndicator",props:{show:Boolean,progressText:String,progress:Number},setup:function(e){return function(t,n){return e.show?((0,c.uX)(),(0,c.CE)("div",vt,[(0,c.Lk)("div",bt,[n[0]||(n[0]=(0,c.Lk)("div",{class:"loader-spin"},null,-1)),(0,c.Lk)("div",yt,(0,u.v_)(e.progressText),1),(0,c.Lk)("div",kt,[(0,c.Lk)("div",{class:"progress",style:(0,u.Tr)({width:e.progress+"%"})},null,4)])])])):(0,c.Q3)("",!0)}}},wt=(0,m.A)(xt,[["__scopeId","data-v-0e57e4e0"]]),St=wt;var Et=["src","alt"],At={key:0,class:"image-placeholder"};const _t={__name:"LazyImage",props:{src:{type:String,required:!0},alt:{type:String,default:""},containerClass:{type:[String,Object,Array],default:""},imageClass:{type:[String,Object,Array],default:""},aspectRatio:{type:[Number,String],default:"1"},objectFit:{type:String,default:"cover"}},emits:["load","error"],setup:function(e,t){var n=t.emit,r=e,i=n,s=(0,c.EW)((function(){return mt.getFullUrl(r.src)})),p=(0,l.KR)(mt.isImageLoaded(r.src)),d=(0,c.EW)((function(){return{paddingBottom:"".concat(1/Number(r.aspectRatio)*100,"%")}})),h=(0,c.EW)((function(){return{objectFit:r.objectFit}}));(0,c.sV)((0,o.A)((0,a.A)().mark((function e(){return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(p.value){e.next=14;break}return e.prev=1,e.next=4,mt.preloadImage(r.src);case 4:p.value=!0,i("load"),e.next=12;break;case 8:e.prev=8,e.t0=e["catch"](1),console.error("图片加载失败:",e.t0),i("error",e.t0);case 12:e.next=15;break;case 14:i("load");case 15:case"end":return e.stop()}}),e,null,[[1,8]])}))));var g=function(){p.value=!0,i("load")},f=function(e){console.error("Image load error:",r.src),i("error",e)};return function(t,n){return(0,c.uX)(),(0,c.CE)("div",{class:(0,u.C4)(["lazy-image-container",e.containerClass])},[(0,c.Lk)("div",{class:"image-wrapper",style:(0,u.Tr)(d.value)},[(0,c.Lk)("img",(0,c.v6)({src:p.value?s.value:"",alt:e.alt,class:["lazy-image",[{"is-loaded":p.value},e.imageClass]],style:h.value,onLoad:g,onError:f},t.$attrs),null,16,Et),p.value?(0,c.Q3)("",!0):((0,c.uX)(),(0,c.CE)("div",At,[(0,c.bF)(St)]))],4)],2)}}},Ct=(0,m.A)(_t,[["__scopeId","data-v-0e1f1ca0"]]),Tt=Ct;n(4423),n(1699);var It={key:0,class:"music-player"},Lt=["src"],Rt=["src"];const Nt={__name:"MusicPlayer",props:{musicUrl:{type:String,required:!0}},setup:function(e){var t=e,n=(0,c.EW)((function(){return t.musicUrl.includes("bilibili.com")})),r=(0,c.EW)((function(){return t.musicUrl.includes("music.163.com")})),a=(0,c.EW)((function(){return t.musicUrl?t.musicUrl.replace("http://","https://"):""}));return function(t,o){return e.musicUrl?((0,c.uX)(),(0,c.CE)("div",It,[n.value?((0,c.uX)(),(0,c.CE)("iframe",{key:0,src:e.musicUrl,scrolling:"no",border:"0",frameborder:"no",framespacing:"0",allowfullscreen:"false",class:"bilibili-player"},null,8,Lt)):r.value?((0,c.uX)(),(0,c.CE)("iframe",{key:1,src:a.value,scrolling:"no",border:"0",frameborder:"no",framespacing:"0",allowfullscreen:"false",class:"netease-player"},null,8,Rt)):(0,c.Q3)("",!0)])):(0,c.Q3)("",!0)}}},Mt=(0,m.A)(Nt,[["__scopeId","data-v-3dd28e7a"]]),Pt=Mt;n(2762);var Ot={class:"game-interaction"},Dt={key:0,class:"suggestions-container"},jt={class:"text-sm text-gray-500"},Ut={class:"suggestions-content"},Gt=["onClick"],Vt={class:"suggestion-text"},Bt={key:1,class:"interaction-stage"},Kt={class:"controls"},Ft=["placeholder","disabled"],Ht=["disabled"],zt={key:2,class:"validation-error-modal"},Wt={class:"validation-error-content"};const Xt={__name:"GameInteraction",setup:function(e){var t=(0,K.Pj)(),n=(0,l.KR)(""),r=(0,l.KR)(!1),s=(0,c.EW)((function(){return t.state.conversation.suggestions})),p=(0,c.EW)((function(){return t.state.interaction.interactionStage})),d=(0,c.EW)((function(){return t.getters["game/isInputEnabled"]})),h=(0,c.EW)((function(){return t.state.game.isSectionEnded})),g=(0,c.EW)((function(){return t.state.interaction.validationError})),f=function(){var e,n=t.state.game.selectedCharacter;if(!n)return null;var r=null===(e=t.state.game.gameManager)||void 0===e||null===(e=e.moderator)||void 0===e?void 0:e.valueManager;return null!==r&&void 0!==r&&r.isCharacterEnabled(n)?r.getValueStatus(n):null},m=(0,c.EW)((function(){if(h.value)return"本桥段已结束...";var e=f(),t=e?"[".concat(e.text,"] "):"";return d.value?"".concat(t," 轮到你行动了，请输入你想做的事..."):"".concat(t," 请等待其他角色行动...")})),v=(0,c.EW)((function(){return h.value?"已结束":d.value?t.state.interaction.isProcessing?"处理中...":"确定":"等待中..."})),b=function(){r.value=!r.value},y=function(){var e=(0,o.A)((0,a.A)().mark((function e(){var r;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(r=n.value.trim(),r&&d.value){e.next=3;break}return e.abrupt("return");case 3:return e.prev=3,e.next=6,t.dispatch("interaction/handleUserInput",r);case 6:n.value="",e.next=12;break;case 9:e.prev=9,e.t0=e["catch"](3),console.error("处理用户输入时出错:",e.t0);case 12:case"end":return e.stop()}}),e,null,[[3,9]])})));return function(){return e.apply(this,arguments)}}(),k=function(){t.dispatch("interaction/hideValidationError")},x=function(e){n.value=e};return function(e,t){return(0,c.uX)(),(0,c.CE)("div",Ot,[s.value.length?((0,c.uX)(),(0,c.CE)("div",Dt,[(0,c.Lk)("div",{class:"suggestions-header",onClick:b},[(0,c.Lk)("span",jt,(0,u.v_)(r.value?"收起建议":"点击查看".concat(s.value.length,"条建议")),1),((0,c.uX)(),(0,c.CE)("svg",{class:(0,u.C4)(["w-4 h-4 text-gray-400 transition-transform",{"rotate-180":r.value}]),fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},t[1]||(t[1]=[(0,c.Lk)("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 9l-7 7-7-7"},null,-1)]),2))]),(0,c.bo)((0,c.Lk)("div",Ut,[((0,c.uX)(!0),(0,c.CE)(c.FK,null,(0,c.pI)(s.value,(function(e,t){return(0,c.uX)(),(0,c.CE)("div",{key:t,class:"suggestion",onClick:function(t){return x(e)}},[(0,c.Lk)("span",Vt,"建议："+(0,u.v_)(e),1)],8,Gt)})),128))],512),[[i.aG,r.value]])])):(0,c.Q3)("",!0),p.value.visible?((0,c.uX)(),(0,c.CE)("div",Bt,[(0,c.Lk)("p",null,(0,u.v_)(p.value.stage)+": "+(0,u.v_)(p.value.info),1)])):(0,c.Q3)("",!0),(0,c.Lk)("div",Kt,[(0,c.bo)((0,c.Lk)("input",{type:"text","onUpdate:modelValue":t[0]||(t[0]=function(e){return n.value=e}),maxlength:"200",placeholder:m.value,onKeydown:(0,i.jR)(y,["enter"]),autocomplete:"off",disabled:!d.value||h.value,class:(0,u.C4)({"section-ended":h.value})},null,42,Ft),[[i.Jo,n.value]]),(0,c.Lk)("button",{class:"button",onClick:y,disabled:!d.value||h.value},(0,u.v_)(v.value),9,Ht)]),g.value?((0,c.uX)(),(0,c.CE)("div",zt,[(0,c.Lk)("div",Wt,[t[2]||(t[2]=(0,c.Lk)("h3",null,"行动无效",-1)),(0,c.Lk)("p",null,(0,u.v_)(g.value),1),(0,c.Lk)("button",{onClick:k},"确定")])])):(0,c.Q3)("",!0)])}}},Jt=(0,m.A)(Xt,[["__scopeId","data-v-87109b7a"]]),qt=Jt;var Qt=n(6083),Yt=(n(113),{class:"absolute top-4vh left-1/2 transform -translate-x-1/2"}),$t={class:"text-white text-[1.8vh] bg-black/50 px-4vh py-2vh rounded-full"},Zt={class:"relative w-full h-full"},en={class:"absolute inset-0 flex items-center justify-center"},tn={key:0,class:"text-white text-[2vh]"},nn={class:"relative w-full h-full flex items-center justify-center"},rn=["src"],an={class:"absolute bottom-0 w-full"},on={key:0,class:"absolute bottom-0 left-0 h-[38.2vh]"},sn=["src","alt"],cn={class:"absolute bottom-4vh left-1/2 -translate-x-1/2 whitespace-nowrap"},ln={class:"text-white text-[2vh] font-medium bg-black/50 px-4vh py-2vh rounded-full"},un={class:"absolute left-0 right-0",style:{bottom:"100%","padding-bottom":"2vh"}},pn={key:0,class:"text-white text-[2vh] font-medium bg-black/50 px-4vh py-2vh rounded-full block text-center mx-auto",style:{width:"100%","word-break":"break-word"}},dn={key:1,class:"absolute bottom-0 right-0 h-[38.2vh]"},hn=["src","alt"],gn={class:"absolute bottom-4vh left-1/2 -translate-x-1/2 whitespace-nowrap"},fn={class:"text-white text-[2vh] font-medium bg-black/50 px-4vh py-2vh rounded-full"},mn={class:"absolute left-0 right-0",style:{bottom:"100%","padding-bottom":"2vh"}},vn={key:0,class:"text-white text-[2vh] font-medium bg-black/50 px-4vh py-2vh rounded-full block text-center mx-auto",style:{width:"100%","word-break":"break-word"}};const bn={__name:"CGDisplay",props:{displayInfo:{type:Object,required:!0}},emits:["close"],setup:function(e,t){var n=t.emit,r=new lt(!0,"CGDisplay"),s=e,p=(0,l.KR)(!1),d=(0,l.KR)(!0),h=(0,l.KR)(""),g=(0,l.KR)(!0),f=null,m=null,v=function(e){var t;if(null===(t=s.displayInfo)||void 0===t||!t.textEffects)return null;var n=s.displayInfo.textEffects.find((function(t){return t.characterChineseName===e}));return null===n||void 0===n?void 0:n.effects},b=function(e){return null!==e&&void 0!==e&&e.name?R(e.name):null};(0,c.wB)((function(){return s.displayInfo}),function(){var e=(0,o.A)((0,a.A)().mark((function e(t){var n,o,i,s,c,l;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(r.log("收到新的displayInfo:",t),null===t||void 0===t||!t.imageUrl){e.next=29;break}return d.value=!0,p.value=!1,g.value=!0,e.prev=5,e.next=8,pt(t.imageUrl);case 8:i=e.sent,h.value=i,null!==(n=t.leftCharacter)&&void 0!==n&&n.name&&(s=b(t.leftCharacter),s&&(t.leftCharacter.imageUrl=s)),null!==(o=t.rightCharacter)&&void 0!==o&&o.name&&(c=b(t.rightCharacter),c&&(t.rightCharacter.imageUrl=c)),d.value=!1,p.value=!0,f&&clearTimeout(f),m&&clearTimeout(m),l=t.displayDuration||3e3,m=setTimeout((function(){r.log("禁用CG交互"),g.value=!1}),l),f=setTimeout((function(){r.log("CG显示超时，准备关闭"),p.value=!1,y("close")}),l),e.next=27;break;case 21:e.prev=21,e.t0=e["catch"](5),r.error("处理图片失败:",e.t0),p.value=!1,g.value=!1,y("close");case 27:e.next=32;break;case 29:p.value=!1,g.value=!1,h.value&&(URL.revokeObjectURL(h.value),h.value="");case 32:case"end":return e.stop()}}),e,null,[[5,21]])})));return function(t){return e.apply(this,arguments)}}(),{deep:!0});var y=n;(0,c.hi)((function(){r.log("组件卸载，清理资源"),f&&clearTimeout(f),m&&clearTimeout(m),h.value&&URL.revokeObjectURL(h.value)}));var k=function(){var e=(0,o.A)((0,a.A)().mark((function e(){var t,n,o,i;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(e.prev=0,null!==(t=s.displayInfo)&&void 0!==t&&t.imageUrl){e.next=3;break}return e.abrupt("return");case 3:window.open(h.value,"_blank"),n=(new Date).toISOString().replace(/[:.]/g,"-"),o="BeyondBooks_CG_".concat(n,".png"),i=document.createElement("a"),i.href=h.value,i.download=o,document.body.appendChild(i),i.click(),document.body.removeChild(i),r.log("CG下载成功:",o),e.next=18;break;case 15:e.prev=15,e.t0=e["catch"](0),r.error("CG下载失败:",e.t0);case 18:case"end":return e.stop()}}),e,null,[[0,15]])})));return function(){return e.apply(this,arguments)}}();return function(t,n){return(0,c.uX)(),(0,c.Wv)(i.eB,{"enter-active-class":"transition-all duration-1000 ease-out","leave-active-class":"transition-all duration-1000 ease-in","enter-from-class":"opacity-0","enter-to-class":"opacity-100","leave-from-class":"opacity-100","leave-to-class":"opacity-0"},{default:(0,c.k6)((function(){var t,r,a;return[p.value&&null!==(t=e.displayInfo)&&void 0!==t&&t.imageUrl?((0,c.uX)(),(0,c.CE)("div",{key:0,class:"fixed inset-0 z-50 flex items-center justify-center bg-black/90",onClick:n[0]||(n[0]=function(e){return g.value&&k}),style:(0,u.Tr)({cursor:g.value?"pointer":"default"})},[(0,c.Lk)("div",Yt,[(0,c.Lk)("span",$t,(0,u.v_)(g.value?"点击画面下载CG":""),1)]),(0,c.Lk)("div",Zt,[(0,c.Lk)("div",en,[d.value?((0,c.uX)(),(0,c.CE)("div",tn,"加载中...")):(0,c.Q3)("",!0),(0,c.bo)((0,c.Lk)("div",nn,[(0,c.Lk)("img",{src:h.value,alt:"CG Scene",class:"w-full h-full object-contain"},null,8,rn),(0,c.Lk)("div",an,[null!==(r=e.displayInfo.leftCharacter)&&void 0!==r&&r.imageUrl?((0,c.uX)(),(0,c.CE)("div",on,[(0,c.Lk)("img",{src:e.displayInfo.leftCharacter.imageUrl,alt:e.displayInfo.leftCharacter.name,class:"h-full w-auto object-contain relative"},null,8,sn),(0,c.Lk)("div",cn,[(0,c.Lk)("span",ln,(0,u.v_)(e.displayInfo.leftCharacter.name),1)]),(0,c.Lk)("div",un,[v(e.displayInfo.leftCharacter.name)?((0,c.uX)(),(0,c.CE)("span",pn,(0,u.v_)(v(e.displayInfo.leftCharacter.name)),1)):(0,c.Q3)("",!0)])])):(0,c.Q3)("",!0),null!==(a=e.displayInfo.rightCharacter)&&void 0!==a&&a.imageUrl?((0,c.uX)(),(0,c.CE)("div",dn,[(0,c.Lk)("img",{src:e.displayInfo.rightCharacter.imageUrl,alt:e.displayInfo.rightCharacter.name,class:"h-full w-auto object-contain relative"},null,8,hn),(0,c.Lk)("div",gn,[(0,c.Lk)("span",fn,(0,u.v_)(e.displayInfo.rightCharacter.name),1)]),(0,c.Lk)("div",mn,[v(e.displayInfo.rightCharacter.name)?((0,c.uX)(),(0,c.CE)("span",vn,(0,u.v_)(v(e.displayInfo.rightCharacter.name)),1)):(0,c.Q3)("",!0)])])):(0,c.Q3)("",!0)])],512),[[i.aG,!d.value]])])])],4)):(0,c.Q3)("",!0)]})),_:1})}}},yn=bn,kn=yn;var xn={class:"absolute inset-0 pointer-events-none"},wn={class:"relative h-[40vh] group animate-value-float"},Sn=["src","alt"],En={key:1,class:"h-full aspect-[3/4] bg-gray-200/80 rounded-xl backdrop-blur-sm flex items-center justify-center transition-transform duration-800 group-hover:scale-105"},An={class:"absolute inset-0"},_n={class:"absolute top-1/2 left-full -translate-y-1/2 ml-4 transform transition-all duration-400 group-hover:scale-110"};const Cn={__name:"ValueEffectDisplay",props:{effect:{type:Object,default:null}},setup:function(e){var t=e,n=(0,c.EW)((function(){var e,t,n=10,r=90,a=85,o=Math.random();return o<.25?(e=Math.random()*(r/2-n)+n,t=Math.random()*(a/2-n)+n):o<.5?(e=Math.random()*(r/2-n)+n,t=Math.random()*(a/2-n)+a/2):o<.75?(e=Math.random()*(r/2-n)+r/2,t=Math.random()*(a/2-n)+n):(e=Math.random()*(r/2-n)+r/2,t=Math.random()*(a/2-n)+a/2),{top:"".concat(e,"vh"),left:"".concat(t,"vw")}})),r=function(e){var t={damage:"bg-gradient-radial from-red-500/60 via-red-600/40 to-transparent",heal:"bg-gradient-radial from-emerald-400/60 via-emerald-500/40 to-transparent",mana:"bg-gradient-radial from-blue-400/60 via-blue-500/40 to-transparent"};return t[e]||""},a=function(e){var t={damage:"bg-red-500/30",heal:"bg-emerald-500/30",mana:"bg-blue-500/30"};return t[e]||""},o=function(e){var t={damage:"bg-gradient-conic from-red-500/0 via-red-500/30 to-red-500/0",heal:"bg-gradient-conic from-emerald-500/0 via-emerald-500/30 to-emerald-500/0",mana:"bg-gradient-conic from-blue-500/0 via-blue-500/30 to-blue-500/0"};return t[e]||""},s=function(e){var t={damage:"bg-[radial-gradient(circle,_var(--red-sparkle)_1px,_transparent_1px)] bg-[length:20px_20px]",heal:"bg-[radial-gradient(circle,_var(--emerald-sparkle)_1px,_transparent_1px)] bg-[length:20px_20px]",mana:"bg-[radial-gradient(circle,_var(--blue-sparkle)_1px,_transparent_1px)] bg-[length:20px_20px]"};return t[e]||""},l=function(e){var t={damage:"bg-red-500/70",heal:"bg-emerald-500/70",mana:"bg-blue-500/70"};return t[e]||""},p=(0,c.EW)((function(){var e;return null!==(e=t.effect)&&void 0!==e&&e.characterName?R(t.effect.characterName):null})),d=function(e){if(!e)return"";var t={minor:"轻微",medium:"中等",major:"严重"},n={damage:"受伤",heal:"恢复",mana:"灵力损耗"};return"".concat(t[e.level]).concat(n[e.type])};return function(t,h){return(0,c.uX)(),(0,c.CE)("div",xn,[(0,c.bF)(i.eB,{"enter-active-class":"transition-all duration-1000 ease-out","leave-active-class":"transition-all duration-1000 ease-tech will-change-value","enter-from-class":"opacity-0 scale-0","enter-to-class":"opacity-100 scale-100","leave-to-class":"opacity-0 scale-75 translate-y-30"},{default:(0,c.k6)((function(){return[e.effect?((0,c.uX)(),(0,c.CE)("div",{key:0,style:(0,u.Tr)(n.value),class:"absolute flex items-center will-change-transform origin-center"},[(0,c.Lk)("div",wn,[(0,c.Lk)("div",{class:(0,u.C4)(["absolute inset-0 rounded-full blur-2xl opacity-50 animate-pulse-slow",a(e.effect.type)])},null,2),p.value?((0,c.uX)(),(0,c.CE)("img",{key:0,src:p.value,alt:e.effect.characterName,class:"h-full w-auto object-contain filter drop-shadow-xl transition-transform duration-800 group-hover:scale-105"},null,8,Sn)):((0,c.uX)(),(0,c.CE)("div",En,h[0]||(h[0]=[(0,c.Lk)("div",{class:"text-gray-400 text-8xl font-bold"},"?",-1)]))),(0,c.Lk)("div",An,[(0,c.Lk)("div",{class:(0,u.C4)(["absolute inset-0 animate-value-pulse transition-opacity duration-400",r(e.effect.type)])},null,2),(0,c.Lk)("div",{class:(0,u.C4)(["absolute inset-0 animate-spin-slow opacity-75",o(e.effect.type)])},null,2),(0,c.Lk)("div",{class:(0,u.C4)(["absolute inset-0 animate-sparkle",s(e.effect.type)])},null,2)]),(0,c.Lk)("div",_n,[(0,c.Lk)("div",{class:(0,u.C4)(["px-4 py-2 text-white text-lg md:text-2xl font-bold rounded-xl shadow-lg backdrop-blur-sm","animate-value-float border-2 border-white/20",l(e.effect.type)])},(0,u.v_)(d(e.effect)),3)])])],4)):(0,c.Q3)("",!0)]})),_:1})])}}},Tn=Cn,In=Tn;var Ln={class:"min-h-screen w-screen bg-white relative overflow-hidden"},Rn={class:"flex h-screen relative z-10"},Nn={class:"fixed inset-0 pointer-events-none z-50"},Mn={class:"absolute inset-0"},Pn={class:"absolute inset-0 bg-gray-100 flex items-center justify-center overflow-hidden"},On={key:1,class:"w-full h-full flex items-center justify-center"},Dn={class:"text-gray-400 text-responsive"},jn=["title"],Un={class:"flex-none flex items-center justify-between px-6 py-4 border-b"},Gn={class:"flex-1"},Vn={class:"text-responsive-lg font-bold text-tech-primary"},Bn={class:"text-responsive-sm text-gray-500 mt-1"},Kn={class:"flex-1 flex flex-col overflow-hidden"},Fn={class:"py-6 space-y-4"},Hn=["innerHTML"],zn={key:0,class:"flex items-center justify-center p-4"},Wn={class:"text-tech-primary text-responsive"},Xn={key:1,class:"flex justify-center mt-4"},Jn={class:"flex-none border-t bg-white"},qn=["title"];const Qn=Object.assign({name:"StoryView"},{__name:"StoryView",setup:function(e){var t=(0,K.Pj)(),n=(0,F.rd)(),r=(0,H.s9)(),p=r.t,d=(0,l.KR)(null),h=(0,l.KR)(!1),g=(0,l.KR)(!1),f=0,m=(0,c.EW)((function(){return t.state.sections.currentSection})),v=(0,c.EW)((function(){return t.state.game.isLoading})),b=(0,c.EW)((function(){return t.state.conversation.conversationHistory})),y=(0,c.EW)((function(){return t.state.conversation.currentCG})),k=(0,c.EW)((function(){return t.state.game.isSectionEnded})),x=(0,l.KR)([]),w=0,S=(0,l.KR)(!1),E=function(){S.value=!0},A=function(){S.value&&(h.value=!h.value,g.value=h.value)},C=function(){var e=window.scrollY;g.value=e>f,f=e},T=function(e){if(!e||!e.content)return"";var t=e.content;t=t.replace(/\n/g,"<br>");var n={user:"text-gray-600",info:"text-tech-secondary",system:"text-tech-primary",assistant:"text-gray-800",attempt:"text-gray-400 italic"};return"user"!==e.role&&(t=_(t)),t='<div class="'.concat(n[e.role]||"",'">').concat(t,"</div>"),t},I=(0,c.WQ)("$modal"),L=function(){k.value?n.push("/sections"):I.show("confirm",{title:p("game.confirmReturnTitle"),content:p("game.confirmReturnToSections"),type:"confirm",onConfirm:function(){n.push("/sections")}})},R=function(e){var n=e.target.closest(".special-term-wrapper");if(n){var r,a=null===(r=n.querySelector(".special-term"))||void 0===r?void 0:r.getAttribute("data-term");a&&t.dispatch("story/showTermTooltip",{term:a,event:e})}},N=function(){var e;"background"===(null===(e=y.value)||void 0===e?void 0:e.displayMode)&&t.commit("sections/UPDATE_SECTION_IMAGE",{sectionId:m.value.id,imageUrl:y.value.imageUrl}),t.dispatch("conversation/clearCurrentCG")},M=function(){var e=(0,o.A)((0,a.A)().mark((function e(){var t,n,r,o;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(m.value.image){e.next=2;break}return e.abrupt("return");case 2:return e.prev=2,e.next=5,pt(m.value.image);case 5:t=e.sent,window.open(t,"_blank"),n=(new Date).toISOString().replace(/[:.]/g,"-"),r="BeyondBooks_CG_".concat(n,".png"),o=document.createElement("a"),o.href=t,o.download=r,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(t),e.next=21;break;case 18:e.prev=18,e.t0=e["catch"](2),console.error("CG下载失败:",e.t0);case 21:case"end":return e.stop()}}),e,null,[[2,18]])})));return function(){return e.apply(this,arguments)}}();(0,c.wB)((function(){return m.value.image}),(function(){S.value=!1})),(0,c.sV)((function(){window.addEventListener("scroll",C),d.value&&(d.value.scrollTop=0),ht.on("value-effect",P)})),(0,c.hi)((function(){window.removeEventListener("scroll",C),ht.off("value-effect",P)}));var P=function(e){var t=(0,s.A)((0,s.A)({},e),{},{id:"effect-".concat(w++)});x.value.push(t),setTimeout((function(){x.value=x.value.filter((function(e){return e.id!==t.id}))}),e.duration||5e3)};return function(e,t){return(0,c.uX)(),(0,c.CE)("div",Ln,[t[3]||(t[3]=(0,c.Lk)("div",{class:"fixed inset-0 bg-white z-0"},[(0,c.Lk)("div",{class:"absolute inset-0 bg-gradient-to-r from-white to-gray-50 opacity-50"})],-1)),(0,c.Lk)("div",Rn,[(0,c.Lk)("div",Nn,[(0,c.bF)(i.F,{"enter-active-class":"transition-all duration-800 ease-out","leave-active-class":"transition-all duration-600 ease-in"},{default:(0,c.k6)((function(){return[((0,c.uX)(!0),(0,c.CE)(c.FK,null,(0,c.pI)(x.value,(function(e){return(0,c.uX)(),(0,c.Wv)(In,{key:e.id,effect:e},null,8,["effect"])})),128))]})),_:1})]),(0,c.Lk)("div",Mn,[(0,c.Lk)("div",Pn,[m.value.image?((0,c.uX)(),(0,c.Wv)(Tt,{key:0,src:m.value.image,alt:m.value.title,"aspect-ratio":1.5,"object-fit":"cover",class:"w-full h-full cursor-pointer","container-class":["transition-transform duration-500 ease-tech",{"translate-x-[-8.75%]":!h.value,"translate-x-0":h.value}],onLoad:E,onClick:M},null,8,["src","alt","container-class"])):((0,c.uX)(),(0,c.CE)("div",On,[(0,c.Lk)("span",Dn,(0,u.v_)((0,l.R1)(p)("common.noImage")),1)]))]),m.value.musicUrl?((0,c.uX)(),(0,c.CE)("div",{key:0,class:(0,u.C4)(["fixed left-[1.5rem] bottom-[1.5rem] transition-transform duration-300",{"translate-y-[150%]":g.value}])},[(0,c.bF)(Pt,{"music-url":m.value.musicUrl},null,8,["music-url"])],2)):(0,c.Q3)("",!0)]),(0,c.Lk)("div",{class:(0,u.C4)(["w-[35%] flex flex-col h-screen bg-white shadow-xl relative ml-auto z-10 transition-transform duration-500 ease-tech",{"translate-x-full":h.value}])},[h.value?(0,c.Q3)("",!0):((0,c.uX)(),(0,c.CE)("button",{key:0,onClick:A,class:"absolute left-0 top-4 -translate-x-full bg-white hover:bg-gray-50 p-2 rounded-l-xl shadow-lg transition-colors",title:(0,l.R1)(p)("game.hideStory")},t[0]||(t[0]=[(0,c.Lk)("svg",{class:"w-5 h-5 text-tech-primary",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[(0,c.Lk)("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M9 5l7 7-7 7"})],-1)]),8,jn)),(0,c.Lk)("div",Un,[(0,c.Lk)("div",Gn,[(0,c.Lk)("h2",Vn,(0,u.v_)(m.value.title),1),(0,c.Lk)("p",Bn,(0,u.v_)(m.value.description),1)]),(0,c.bF)(Qt.A,{type:"ghost",onClick:L,class:"min-w-[6.25rem] text-responsive"},{default:(0,c.k6)((function(){return[(0,c.eW)((0,u.v_)((0,l.R1)(p)("game.returnToSections")),1)]})),_:1})]),(0,c.Lk)("div",Kn,[(0,c.Lk)("div",{ref_key:"storyContentRef",ref:d,onClick:R,class:"flex-1 overflow-y-auto bg-gray-50 px-6"},[(0,c.Lk)("div",Fn,[((0,c.uX)(!0),(0,c.CE)(c.FK,null,(0,c.pI)(b.value,(function(e){return(0,c.uX)(),(0,c.CE)("div",{key:e.id,class:(0,u.C4)({"bg-white shadow-sm rounded-lg p-4":"user"!==e.role&&"attempt"!==e.role,"pl-4 border-l-4 border-tech-primary/20":"user"===e.role,"pl-4 text-sm":"attempt"===e.role})},[(0,c.Lk)("div",{class:"prose prose-tech max-w-none text-responsive",innerHTML:T(e)},null,8,Hn)],2)})),128)),v.value?((0,c.uX)(),(0,c.CE)("div",zn,[t[1]||(t[1]=(0,c.Lk)("svg",{class:"animate-spin h-5 w-5 text-tech-primary mr-3",viewBox:"0 0 24 24"},[(0,c.Lk)("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4",fill:"none"}),(0,c.Lk)("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})],-1)),(0,c.Lk)("span",Wn,(0,u.v_)((0,l.R1)(p)("common.loading")),1)])):(0,c.Q3)("",!0),k.value?((0,c.uX)(),(0,c.CE)("div",Xn,[(0,c.bF)(Qt.A,{type:"primary",onClick:L,class:"min-w-[12rem] text-responsive"},{default:(0,c.k6)((function(){return[(0,c.eW)((0,u.v_)((0,l.R1)(p)("game.returnToSections")),1)]})),_:1})])):(0,c.Q3)("",!0)])],512),(0,c.Lk)("div",Jn,[(0,c.bF)(qt,{class:"p-6"})])])],2),h.value?((0,c.uX)(),(0,c.CE)("button",{key:0,onClick:A,class:"fixed right-0 top-4 bg-white hover:bg-gray-50 p-2 rounded-l-xl shadow-lg transition-colors z-20",title:(0,l.R1)(p)("game.showStory")},t[2]||(t[2]=[(0,c.Lk)("svg",{class:"w-5 h-5 text-tech-primary",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[(0,c.Lk)("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M15 19l-7-7 7-7"})],-1)]),8,qn)):(0,c.Q3)("",!0)]),y.value?((0,c.uX)(),(0,c.Wv)(kn,{key:0,"display-info":y.value,onClose:N},null,8,["display-info"])):(0,c.Q3)("",!0)])}}}),Yn=(0,m.A)(Qn,[["__scopeId","data-v-375f7b78"]]),$n=Yn;n(9449);var Zn={class:"min-h-screen bg-gradient-to-r from-white to-tech-light overflow-hidden"},er={class:"relative z-10 flex h-screen overflow-hidden"},tr={class:"w-[65%] h-full"},nr=["src"],rr={class:"w-[35%] h-full flex flex-col px-8"},ar={class:"flex-none py-8 flex items-center justify-between"},or={class:"text-responsive-title font-bold text-tech-primary scale-y-95"},ir={class:"flex items-center gap-4"},sr={class:"flex-1 overflow-y-auto overflow-x-hidden space-y-4 custom-scrollbar"},cr={class:"bg-white/80 backdrop-blur-sm rounded-xl shadow-tech-lg p-8 space-y-8"},lr={class:"space-y-3"},ur={for:"api-key",class:"block text-responsive font-medium text-tech-secondary"},pr=["placeholder"],dr={class:"space-y-3"},hr={for:"api-url",class:"block text-responsive font-medium text-tech-secondary"},gr=["placeholder"],fr={class:"grid grid-cols-1 gap-6"},mr={class:"space-y-3"},vr={for:"advanced-model",class:"block text-responsive font-medium text-tech-secondary"},br={value:"gpt-4o-mini"},yr={value:"deepseek-chat"},kr={class:"space-y-3"},xr={for:"basic-model",class:"block text-responsive font-medium text-tech-secondary"},wr={value:"gpt-4o-mini"},Sr={value:"deepseek-chat"},Er={class:"flex flex-col gap-4 pt-4"},Ar={class:"space-y-2"},_r={class:"text-sm text-center mt-1"},Cr={href:"https://itch.io/jam/agentland-festival-2025",target:"_blank",rel:"noopener noreferrer",class:"text-tech-primary/75 hover:text-tech-primary hover:underline inline-flex items-center space-x-1"},Tr={class:"space-y-2"},Ir={class:"space-y-2"};const Lr=Object.assign({name:"SettingsView"},{__name:"SettingsView",setup:function(e){var t=(0,K.Pj)(),n=(0,F.rd)(),r=(0,H.s9)(),p=r.t,d=(0,c.WQ)("$modal"),h=(0,l.KR)({apiKey:"",apiUrl:"",advancedModel:"",basicModel:"",isPublicKey:!1}),g=(0,l.KR)(""),f=(0,l.KR)("success"),m=(0,c.EW)((function(){return{apiKey:t.state.settings.apiKey,apiUrl:t.state.settings.apiUrl,advancedModel:t.state.settings.advancedModel,basicModel:t.state.settings.basicModel,isPublicKey:t.state.settings.isPublicKey}})),v=(0,c.EW)((function(){return k.u.getImageUrl("images/MotherTree.png")})),b=function(){h.value=(0,s.A)((0,s.A)({},m.value),{},{apiKey:""})},y=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"success";g.value=e,f.value=t,setTimeout((function(){g.value=""}),3e3)},x=function(){var e=(0,o.A)((0,a.A)().mark((function e(){var r;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.prev=0,r=(0,s.A)((0,s.A)({},m.value),{},{apiKey:h.value.apiKey||m.value.apiKey,apiUrl:h.value.apiUrl}),r.apiUrl.endsWith("/")||(r.apiUrl+="/"),e.next=5,t.dispatch("settings/saveSettings",r);case 5:y(p("settings.savedMessage")),t.getters["settings/hasValidSettings"]?n.back():y(p("settings.invalidSettings"),"error"),e.next=13;break;case 9:e.prev=9,e.t0=e["catch"](0),console.error("保存设置失败:",e.t0),y(p("settings.saveError"),"error");case 13:case"end":return e.stop()}}),e,null,[[0,9]])})));return function(){return e.apply(this,arguments)}}(),w=function(){var e=(0,o.A)((0,a.A)().mark((function e(){return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(!confirm(p("settings.confirmReset"))){e.next=5;break}return e.next=3,t.dispatch("settings/resetSettings");case 3:b(),y(p("settings.resetMessage"));case 5:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),S=function(){d.show("settings-help",{title:p("settings.helpTitle"),content:p("settings.helpContent"),closeButtonText:p("common.close"),type:"normal"})},E=function(){d.show("confirm",{title:p("settings.confirmExitTitle"),content:p("settings.confirmExit"),type:"confirm",onConfirm:function(){n.back()}})},A=function(){h.value.apiUrl="https://api.deepseek.com/v1/",h.value.advancedModel="deepseek-chat",h.value.basicModel="deepseek-chat",h.value.apiKey="",h.value.isPublicKey=!1,y(p("settings.deepseekSetMessage"))},_=function(){var e=(0,o.A)((0,a.A)().mark((function e(){return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,t.dispatch("settings/useAgentlandFestival2025Key");case 3:y(p("settings.AgentlandFestival2025KeySetMessage")),e.next=9;break;case 6:e.prev=6,e.t0=e["catch"](0),y(p("settings.AgentlandFestival2025KeyError"),"error");case 9:case"end":return e.stop()}}),e,null,[[0,6]])})));return function(){return e.apply(this,arguments)}}();return(0,c.sV)((function(){t.dispatch("settings/loadSettings"),b()})),function(e,t){return(0,c.uX)(),(0,c.CE)("div",Zn,[t[7]||(t[7]=(0,c.Lk)("div",{class:"fixed inset-0 bg-white z-0"},null,-1)),(0,c.Lk)("div",er,[(0,c.Lk)("div",tr,[(0,c.Lk)("img",{src:v.value,alt:"背景",class:"h-full w-full object-cover"},null,8,nr)]),(0,c.Lk)("div",rr,[(0,c.Lk)("div",ar,[(0,c.Lk)("h2",or,(0,u.v_)((0,l.R1)(p)("settings.title")),1),(0,c.Lk)("div",ir,[(0,c.bF)(Qt.A,{onClick:x,type:"primary",class:"min-w-[7.5rem] text-responsive"},{default:(0,c.k6)((function(){return[(0,c.eW)((0,u.v_)((0,l.R1)(p)("settings.saveButton")),1)]})),_:1}),(0,c.bF)(Qt.A,{type:"ghost",onClick:E,class:"min-w-[7.5rem] text-responsive"},{icon:(0,c.k6)((function(){return t[4]||(t[4]=[(0,c.Lk)("svg",{xmlns:"http://www.w3.org/2000/svg",class:"w-5 h-5",viewBox:"0 0 20 20",fill:"currentColor"},[(0,c.Lk)("path",{"fill-rule":"evenodd",d:"M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z","clip-rule":"evenodd"})],-1)])})),default:(0,c.k6)((function(){return[(0,c.eW)(" "+(0,u.v_)((0,l.R1)(p)("common.return")),1)]})),_:1})])]),(0,c.Lk)("div",sr,[(0,c.Lk)("div",cr,[(0,c.Lk)("div",lr,[(0,c.Lk)("label",ur,(0,u.v_)((0,l.R1)(p)("settings.apiKeyLabel")),1),(0,c.bo)((0,c.Lk)("input",{type:"password",id:"api-key","onUpdate:modelValue":t[0]||(t[0]=function(e){return h.value.apiKey=e}),placeholder:(0,l.R1)(p)("settings.apiKeyPlaceholder"),autocomplete:"off",class:"w-full px-4 py-3 rounded-lg border-2 border-gray-200 focus:border-tech-primary focus:ring-0 transition-colors duration-300 text-responsive bg-white/50"},null,8,pr),[[i.Jo,h.value.apiKey]])]),(0,c.Lk)("div",dr,[(0,c.Lk)("label",hr,(0,u.v_)((0,l.R1)(p)("settings.apiUrlLabel")),1),(0,c.bo)((0,c.Lk)("input",{type:"text",id:"api-url","onUpdate:modelValue":t[1]||(t[1]=function(e){return h.value.apiUrl=e}),placeholder:(0,l.R1)(p)("settings.apiUrlPlaceholder"),class:"w-full px-4 py-3 rounded-lg border-2 border-gray-200 focus:border-tech-primary focus:ring-0 transition-colors duration-300 text-responsive bg-white/50"},null,8,gr),[[i.Jo,h.value.apiUrl]])]),(0,c.Lk)("div",fr,[(0,c.Lk)("div",mr,[(0,c.Lk)("label",vr,(0,u.v_)((0,l.R1)(p)("settings.advancedModelLabel")),1),(0,c.bo)((0,c.Lk)("select",{id:"advanced-model","onUpdate:modelValue":t[2]||(t[2]=function(e){return h.value.advancedModel=e}),class:"w-full px-4 py-3 rounded-lg border-2 border-gray-200 focus:border-tech-primary focus:ring-0 transition-colors duration-300 text-responsive bg-white/50"},[(0,c.Lk)("option",br,(0,u.v_)((0,l.R1)(p)("settings.modelOptions.gpt-4o-mini")),1),(0,c.Lk)("option",yr,(0,u.v_)((0,l.R1)(p)("settings.modelOptions.deepseek-chat")),1)],512),[[i.u1,h.value.advancedModel]])]),(0,c.Lk)("div",kr,[(0,c.Lk)("label",xr,(0,u.v_)((0,l.R1)(p)("settings.basicModelLabel")),1),(0,c.bo)((0,c.Lk)("select",{id:"basic-model","onUpdate:modelValue":t[3]||(t[3]=function(e){return h.value.basicModel=e}),class:"w-full px-4 py-3 rounded-lg border-2 border-gray-200 focus:border-tech-primary focus:ring-0 transition-colors duration-300 text-responsive bg-white/50"},[(0,c.Lk)("option",wr,(0,u.v_)((0,l.R1)(p)("settings.modelOptions.gpt-4o-mini")),1),(0,c.Lk)("option",Sr,(0,u.v_)((0,l.R1)(p)("settings.modelOptions.deepseek-chat")),1)],512),[[i.u1,h.value.basicModel]])])]),(0,c.Lk)("div",Er,[(0,c.bF)(Qt.A,{onClick:S,type:"ghost",class:"text-responsive w-full"},{default:(0,c.k6)((function(){return[(0,c.eW)((0,u.v_)((0,l.R1)(p)("settings.helpButton")),1)]})),_:1}),(0,c.Lk)("div",Ar,[(0,c.bF)(Qt.A,{onClick:_,type:"secondary",class:"text-responsive w-full"},{default:(0,c.k6)((function(){return[(0,c.eW)((0,u.v_)((0,l.R1)(p)("settings.useAgentlandFestival2025KeyButton")),1)]})),_:1}),(0,c.Lk)("div",_r,[(0,c.Lk)("a",Cr,[t[5]||(t[5]=(0,c.Lk)("svg",{class:"w-4 h-4",fill:"currentColor",viewBox:"0 0 20 20"},[(0,c.Lk)("path",{d:"M10 2a8 8 0 100 16 8 8 0 000-16zM4.46 14.12l1.41-1.41a6 6 0 018.49-8.49l1.41-1.41A8 8 0 004.46 14.12zM15.54 5.88l-1.41 1.41a6 6 0 01-8.49 8.49l-1.41 1.41A8 8 0 0015.54 5.88z"})],-1)),(0,c.Lk)("span",null,(0,u.v_)((0,l.R1)(p)("settings.sponsorAgentlandFestival2025")),1)])])]),(0,c.Lk)("div",Tr,[(0,c.bF)(Qt.A,{onClick:A,type:"secondary",class:"text-responsive w-full"},{default:(0,c.k6)((function(){return[(0,c.eW)((0,u.v_)((0,l.R1)(p)("settings.useDeepSeekButton")),1)]})),_:1})]),(0,c.Lk)("div",Ir,[(0,c.bF)(Qt.A,{type:"secondary",class:"text-responsive w-full opacity-50 cursor-not-allowed",disabled:""},{default:(0,c.k6)((function(){return[(0,c.eW)((0,u.v_)((0,l.R1)(p)("settings.publicKeyButton")),1)]})),_:1}),t[6]||(t[6]=(0,c.Lk)("div",{class:"space-y-1 text-sm italic px-2"},[(0,c.Lk)("p",{class:"text-tech-secondary/75"},[(0,c.eW)(" 检测到目前无公共密钥在线，您可以前往 "),(0,c.Lk)("a",{href:"https://www.deepseek.com/",target:"_blank",rel:"noopener noreferrer",class:"text-tech-primary hover:underline"}," DeepSeek 官网 "),(0,c.eW)(" 获取 API 密钥 ")]),(0,c.Lk)("p",{class:"text-tech-primary/75"}," DeepSeek 是一个优秀的*国产*大语言模型，不输gpt-4o，响应速度快效果好，开发者表示无脑吹！ ")],-1))]),(0,c.bF)(Qt.A,{onClick:w,type:"danger",class:"text-responsive w-full"},{default:(0,c.k6)((function(){return[(0,c.eW)((0,u.v_)((0,l.R1)(p)("settings.resetButton")),1)]})),_:1})]),g.value?((0,c.uX)(),(0,c.CE)("div",{key:0,class:(0,u.C4)(["message text-responsive p-4 rounded-lg transition-all duration-300 mt-4",{"bg-green-50 text-green-700":"success"===f.value,"bg-red-50 text-red-700":"error"===f.value}])},(0,u.v_)(g.value),3)):(0,c.Q3)("",!0)])])])])])}}}),Rr=(0,m.A)(Lr,[["__scopeId","data-v-1b86cc2b"]]),Nr=Rr;n(4346);var Mr=n(5246);const Pr={__name:"GameTag",props:{type:{type:String,default:"default",validator:function(e){return["combat","wits","story","puzzle","persuade","romance","default"].includes(e)}},size:{type:String,default:"default",validator:function(e){return["sm","default"].includes(e)}}},setup:function(e){var t={sm:"text-xs px-1.5 py-0.5 h-5",default:"text-xs px-2 py-1 h-6"},n={combat:"bg-tech-tag-combat-bg text-tech-tag-combat-text",wits:"bg-tech-tag-wits-bg text-tech-tag-wits-text",story:"bg-tech-tag-story-bg text-tech-tag-story-text",puzzle:"bg-tech-tag-puzzle-bg text-tech-tag-puzzle-text",persuade:"bg-tech-tag-persuade-bg text-tech-tag-persuade-text",romance:"bg-tech-tag-romance-bg text-tech-tag-romance-text",default:"bg-tech-tag-default-bg text-tech-tag-default-text"};return function(r,a){return(0,c.uX)(),(0,c.CE)("span",{class:(0,u.C4)(["inline-flex items-center justify-center rounded-full",[t[e.size],n[e.type]||n["default"]]])},[(0,c.RG)(r.$slots,"default")],2)}}},Or=Pr,Dr=Or;function jr(e){var t=(0,K.Pj)(),n=(0,c.EW)((function(){if(!e.value)return k.u.getImageUrl("default-section.jpg");var n=t.getters["sections/getSectionThumbnailPath"](e.value);return k.u.getImageUrl(n)}));return{sectionImagePath:n}}var Ur={class:"relative"},Gr={key:0,class:"bg-white rounded-lg p-4 space-y-3 border border-gray-200 hover:border-tech-primary transition-colors duration-300 h-full"},Vr={class:"flex flex-col gap-4"},Br={class:"relative w-full aspect-ratio-container"},Kr=["src","alt"],Fr={class:"flex-1"},Hr={class:"flex items-center justify-between"},zr={class:"font-medium text-gray-500"},Wr={class:"text-sm text-tech-primary opacity-75"},Xr={class:"flex flex-wrap gap-2 mt-2"},Jr={class:"text-sm text-gray-500 mt-2"},qr={key:1,class:"bg-white rounded-lg p-4 space-y-3 border border-gray-200 hover:border-tech-primary transition-colors duration-300 h-full"},Qr={key:0,class:"absolute inset-0 z-10 pointer-events-none rounded-lg overflow-hidden unlock-animation"},Yr={class:"flex flex-col gap-4"},$r={class:"relative w-full aspect-ratio-container"},Zr=["src","alt"],ea={class:"flex-1"},ta={class:"font-medium text-tech-primary"},na={class:"flex flex-wrap gap-2 mt-2 mb-4"},ra={class:"text-sm text-gray-500 mb-4"},aa={class:"flex gap-3"},oa={key:2,class:"bg-gray-100 rounded-lg p-4 space-y-3 border border-gray-200 h-full flex flex-col justify-center items-center"},ia={class:"font-medium text-gray-500 text-lg"},sa={class:"text-sm text-gray-400"};const ca={__name:"SectionCard",props:{section:{type:Object,required:!0},isUnlocked:{type:Boolean,default:!1},isCompleted:{type:Boolean,default:!1},showUnlockAnimation:{type:Boolean,default:!1}},emits:["start","replay","skip"],setup:function(e){var t=e,n=(0,K.Pj)(),r=(0,H.s9)(),a=r.t,o=(0,c.EW)((function(){return t.section.image})),i=jr(o),s=i.sectionImagePath,p=(0,c.EW)((function(){return t.section.tags||[]})),d=function(e){return n.getters["sections/getSectionTypeText"](e)};return function(t,n){return(0,c.uX)(),(0,c.CE)("div",Ur,[e.isCompleted?((0,c.uX)(),(0,c.CE)("div",Gr,[(0,c.Lk)("div",Vr,[(0,c.Lk)("div",Br,[(0,c.Lk)("img",{src:(0,l.R1)(s),alt:e.section.title,class:"absolute inset-0 w-full h-full object-cover rounded-lg shadow-sm border border-gray-200"},null,8,Kr)]),(0,c.Lk)("div",Fr,[(0,c.Lk)("div",Hr,[(0,c.Lk)("h4",zr,(0,u.v_)(e.section.title),1),(0,c.Lk)("span",Wr,(0,u.v_)((0,l.R1)(a)("game.completed")),1)]),(0,c.Lk)("div",Xr,[(0,c.bF)(Dr,{type:e.section.type||"default",size:"default"},{default:(0,c.k6)((function(){return[(0,c.eW)((0,u.v_)(e.section.type?d(e.section.type):(0,l.R1)(a)("game.typeNone")),1)]})),_:1},8,["type"]),p.value.length>0?((0,c.uX)(!0),(0,c.CE)(c.FK,{key:0},(0,c.pI)(p.value,(function(e){return(0,c.uX)(),(0,c.Wv)(Dr,{key:e,type:e,size:"sm"},{default:(0,c.k6)((function(){return[(0,c.eW)((0,u.v_)(d(e)),1)]})),_:2},1032,["type"])})),128)):(0,c.Q3)("",!0)]),(0,c.Lk)("p",Jr,(0,u.v_)(e.section.description),1)])]),(0,c.bF)(Qt.A,{type:"secondary",class:"w-full min-h-[2.5rem]",onClick:n[0]||(n[0]=function(n){return t.$emit("replay",e.section.file)})},{icon:(0,c.k6)((function(){return n[3]||(n[3]=[(0,c.Lk)("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor"},[(0,c.Lk)("path",{"fill-rule":"evenodd",d:"M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z","clip-rule":"evenodd"})],-1)])})),default:(0,c.k6)((function(){return[(0,c.eW)(" "+(0,u.v_)((0,l.R1)(a)("game.replay")),1)]})),_:1})])):e.isUnlocked?((0,c.uX)(),(0,c.CE)("div",qr,[e.showUnlockAnimation?((0,c.uX)(),(0,c.CE)("div",Qr,n[4]||(n[4]=[(0,c.Fv)('<div class="absolute inset-0 bg-gradient-to-r from-tech-primary/20 to-tech-accent/20 animate-pulse" data-v-a084c32c></div><div class="absolute inset-0 shine-effect" data-v-a084c32c></div><div class="absolute top-2 right-2 text-tech-primary animate-bounce" data-v-a084c32c><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" data-v-a084c32c><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z" data-v-a084c32c></path></svg></div>',3)]))):(0,c.Q3)("",!0),(0,c.Lk)("div",Yr,[(0,c.Lk)("div",$r,[(0,c.Lk)("img",{src:(0,l.R1)(s),alt:e.section.title,class:"absolute inset-0 w-full h-full object-cover rounded-lg shadow-sm border border-gray-200"},null,8,Zr)]),(0,c.Lk)("div",ea,[(0,c.Lk)("h4",ta,(0,u.v_)(e.section.title),1),(0,c.Lk)("div",na,[(0,c.bF)(Dr,{type:e.section.type||"default",size:"default"},{default:(0,c.k6)((function(){return[(0,c.eW)((0,u.v_)(e.section.type?d(e.section.type):(0,l.R1)(a)("game.typeNone")),1)]})),_:1},8,["type"]),p.value.length>0?((0,c.uX)(!0),(0,c.CE)(c.FK,{key:0},(0,c.pI)(p.value,(function(e){return(0,c.uX)(),(0,c.Wv)(Dr,{key:e,type:e,size:"sm"},{default:(0,c.k6)((function(){return[(0,c.eW)((0,u.v_)(d(e)),1)]})),_:2},1032,["type"])})),128)):(0,c.Q3)("",!0)]),(0,c.Lk)("p",ra,(0,u.v_)(e.section.description),1),(0,c.Lk)("div",aa,[(0,c.bF)(Qt.A,{type:"primary",class:"flex-[2]",onClick:n[1]||(n[1]=function(n){return t.$emit("start",e.section.file)})},{icon:(0,c.k6)((function(){return n[5]||(n[5]=[(0,c.Lk)("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor"},[(0,c.Lk)("path",{"fill-rule":"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z","clip-rule":"evenodd"})],-1)])})),default:(0,c.k6)((function(){return[(0,c.eW)(" "+(0,u.v_)((0,l.R1)(a)("game.start")),1)]})),_:1}),(0,c.bF)(Qt.A,{type:"ghost",class:"flex-1",onClick:n[2]||(n[2]=function(n){return t.$emit("skip",e.section.file)})},{icon:(0,c.k6)((function(){return n[6]||(n[6]=[(0,c.Lk)("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor"},[(0,c.Lk)("path",{"fill-rule":"evenodd",d:"M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z","clip-rule":"evenodd"})],-1)])})),default:(0,c.k6)((function(){return[(0,c.eW)(" "+(0,u.v_)((0,l.R1)(a)("game.skip")),1)]})),_:1})])])])])):((0,c.uX)(),(0,c.CE)("div",oa,[n[7]||(n[7]=(0,c.Lk)("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-16 w-16 text-gray-300 mb-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[(0,c.Lk)("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"})],-1)),(0,c.Lk)("h4",ia,(0,u.v_)(e.section.title),1),(0,c.Lk)("span",sa,(0,u.v_)((0,l.R1)(a)("game.locked")),1)]))])}}},la=(0,m.A)(ca,[["__scopeId","data-v-a084c32c"]]),ua=la;var pa={class:"min-h-screen bg-gradient-to-r from-white to-tech-light overflow-hidden"},da={class:"relative z-10 flex h-screen overflow-hidden"},ha={class:"w-[65%] h-full"},ga=["src"],fa={class:"w-[35%] h-full flex flex-col px-8"},ma={class:"flex-none py-8 flex items-center justify-between"},va={class:"text-responsive-title font-bold text-tech-primary"},ba={class:"flex-1 overflow-y-auto overflow-x-hidden custom-scrollbar"},ya={class:"space-y-8"},ka={class:"text-responsive-lg font-semibold text-tech-secondary border-b pb-2"},xa={class:"grid gap-4 2xl:grid-cols-2"};const wa=Object.assign({name:"SectionsView"},{__name:"SectionsView",setup:function(e){var t=(0,K.Pj)(),n=(0,F.rd)(),r=(0,H.s9)(),i=r.t,s=(0,c.EW)((function(){return t.state.save.saveIndex.currentScenario||"silver_moon"})),p=(0,c.EW)((function(){return t.state.sections.chapters})),d=function(e){return t.getters["sections/isSectionUnlocked"](e)},h=function(e){var n,r=t.getters["save/getSaveData"];return!0===(null===r||void 0===r||null===(n=r.progress)||void 0===n||null===(n=n.sectionResults)||void 0===n||null===(n=n[e])||void 0===n?void 0:n.objective)},g=function(){var e=(0,o.A)((0,a.A)().mark((function e(r){return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,t.dispatch("sections/loadSection",r);case 3:n.push("/story"),e.next=10;break;case 6:e.prev=6,e.t0=e["catch"](0),console.error("加载章节失败:",e.t0),(0,Mr.dj)().error(i("game.loadSectionError"));case 10:case"end":return e.stop()}}),e,null,[[0,6]])})));return function(t){return e.apply(this,arguments)}}(),f=function(){var e=(0,o.A)((0,a.A)().mark((function e(r){return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,t.dispatch("sections/loadSection",r);case 2:n.push("/story");case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),m=function(){var e=(0,o.A)((0,a.A)().mark((function e(n){return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,t.dispatch("sections/skipSection",n);case 2:(0,Mr.dj)().success(i("game.sectionSkipped"));case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),v=function(){n.push("/")},b=(0,l.KR)(new Set);(0,c.wB)((function(){return t.state.sections.unlockedSections}),(function(e,t){if(t){var n=e.filter((function(e){return!t.includes(e)}));n.forEach((function(e){b.value.add(e),setTimeout((function(){b.value["delete"](e)}),3e3)}))}}),{deep:!0});var y=(0,c.EW)((function(){return k.u.getImageUrl("scenarios/".concat(s.value,"/background.png"))}));return(0,c.sV)((0,o.A)((0,a.A)().mark((function e(){var n;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,t.dispatch("save/loadSave");case 3:if(0!==p.value.length){e.next=6;break}return e.next=6,t.dispatch("sections/loadSectionsIndex");case 6:n=t.getters["save/getSaveData"],n&&Array.isArray(n.unlockedSections)?n.unlockedSections.forEach((function(e){t.dispatch("sections/unlockSection",e)})):(console.log("没有找到已解锁章节数据，使用默认值"),t.dispatch("sections/unlockSection",21)),e.next=14;break;case 10:e.prev=10,e.t0=e["catch"](0),console.error("初始化章节视图失败:",e.t0),(0,Mr.dj)().error(i("game.initError"));case 14:case"end":return e.stop()}}),e,null,[[0,10]])})))),function(e,t){return(0,c.uX)(),(0,c.CE)("div",pa,[t[1]||(t[1]=(0,c.Lk)("div",{class:"fixed inset-0 bg-white z-0"},null,-1)),(0,c.Lk)("div",da,[(0,c.Lk)("div",ha,[(0,c.Lk)("img",{src:y.value,alt:"主视觉图",class:"h-full w-full object-cover"},null,8,ga)]),(0,c.Lk)("div",fa,[(0,c.Lk)("div",ma,[(0,c.Lk)("h2",va,(0,u.v_)((0,l.R1)(i)("game.chooseSection")),1),(0,c.bF)(Qt.A,{type:"ghost",onClick:v,class:"min-w-[7.5rem] text-responsive"},{icon:(0,c.k6)((function(){return t[0]||(t[0]=[(0,c.Lk)("svg",{xmlns:"http://www.w3.org/2000/svg",class:"w-5 h-5",viewBox:"0 0 20 20",fill:"currentColor"},[(0,c.Lk)("path",{"fill-rule":"evenodd",d:"M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z","clip-rule":"evenodd"})],-1)])})),default:(0,c.k6)((function(){return[(0,c.eW)(" "+(0,u.v_)((0,l.R1)(i)("common.returnToMenu")),1)]})),_:1})]),(0,c.Lk)("div",ba,[(0,c.Lk)("div",ya,[((0,c.uX)(!0),(0,c.CE)(c.FK,null,(0,c.pI)(p.value,(function(e){return(0,c.uX)(),(0,c.CE)("div",{key:e.title,class:"bg-white rounded-lg shadow-tech p-6 space-y-4"},[(0,c.Lk)("h3",ka,(0,u.v_)(e.title),1),(0,c.Lk)("div",xa,[((0,c.uX)(!0),(0,c.CE)(c.FK,null,(0,c.pI)(e.sections,(function(e){return(0,c.uX)(),(0,c.Wv)(ua,{key:e.id,section:e,"is-unlocked":d(e.id),"is-completed":h(e.id),"show-unlock-animation":b.value.has(e.id),onStart:g,onReplay:f,onSkip:m},null,8,["section","is-unlocked","is-completed","show-unlock-animation"])})),128))])])})),128))])])])])])}}}),Sa=(0,m.A)(wa,[["__scopeId","data-v-7ee15bc4"]]),Ea=Sa;var Aa=[{path:"/",name:"home",component:at,meta:{transition:"page"}},{path:"/sections",name:"sections",component:Ea,meta:{transition:"page"}},{path:"/story",name:"Story",component:$n},{path:"/settings",name:"Settings",component:Nr},{path:"/review",name:"Review",component:function(){return n.e(9640).then(n.bind(n,9640))},meta:{title:"reviewTitle"}},{path:"/character-select",name:"CharacterSelect",component:function(){return n.e(7213).then(n.bind(n,7213))}},{path:"/scenario-select",name:"ScenarioSelect",component:function(){return n.e(4545).then(n.bind(n,4545))}}],_a=(0,F.aE)({history:(0,F.Bt)(xe.BASE_PATH),routes:Aa});_a.beforeEach((function(e,t,n){console.log("Route change:",{from:t.path,to:e.path}),n()}));const Ca=_a;var Ta=n(3604),Ia=n(8676),La=n(3772),Ra=(n(2712),n(5506),n(8598),{formatMainReport:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,a="🔍 影响检查处理报告\n========================\n";return t.forEach((function(t){a+=e.formatCheckResult(t)})),a+="\n\n📋 最终影响说明：",n.length>0?a+="\n"+n.map((function(e){return"• ".concat(e)})).join("\n"):a+=" 无",r&&(a+="\n\n⏰ 当前桥段时间点：".concat(r)),a+="\n========================",a},formatCheckResult:function(e){return"\n📋 检查条件组：\n- 类型：".concat("all"===e.type?"需要满足所有条件":"满足任一条件即可","\n- 条件列表：\n").concat(e.conditions.map((function(e){return"  • ".concat(e.id,": ").concat(e.value?"需要为真":"需要为假").concat(e.operator?" (操作者: ".concat(e.operator,")"):"")})).join("\n"),"\n✨ 检查结果：").concat(e.result?"✅ 满足条件":"❌ 不满足条件","\n").concat(e.effects?"📝 触发效果：\n"+e.effects.map((function(e){return"  • ".concat(e)})).join("\n"):"")},formatTimelineCheck:function(e){return"\n🔍 时间线影响检查\n========================\n⏰ 检查时间点：".concat(e.timePoint,"\n\n📅 相关时间点列表：\n").concat(e.relevantPoints.map((function(e){return"• ".concat(e)})).join("\n"),"\n\n📝 存档中的影响记录：\n").concat(this.formatInfluenceRecords(e.influenceRecords),"\n========================")},formatInfluenceResult:function(e){return"\n💫 影响点最终状态\n========================\n• ID：".concat(e.id,"\n• 时间点：").concat(e.timePoint||"original_time","\n• 状态：").concat(e.value?"激活":"未激活","\n• 数据来源：").concat(e.source,"\n========================")},formatInfluenceRecords:function(e){if(!e||0===e.length)return"• 暂无记录";var t=e.reduce((function(e,t){return e[t.timePoint]||(e[t.timePoint]=[]),e[t.timePoint].push("  - ".concat(t.id,": ").concat(t.value?"激活":"未激活")),e}),{});return Object.entries(t).map((function(e){var t=(0,Ia.A)(e,2),n=t[0],r=t[1];return"• ".concat(n,":\n").concat(r.join("\n"))})).join("\n")}}),Na=new lt(!1,"gameState"),Ma=function(){return{currentSectionId:null,completedSections:[],unlockedSections:[],globalInfluencePoints:[],isGameInitialized:!1,selectedCharacter:null,turnCount:0,plotTriggers:[],currentSection:null,currentIsReplay:!1,storyTitle:"",storyContent:"",availableCharacters:[],sectionResults:{},influenceNotes:[],sectionTimePoint:null}},Pa={SET_CURRENT_SECTION_ID:function(e,t){e.currentSectionId=t},SET_COMPLETED_SECTIONS:function(e,t){e.completedSections=t},SET_UNLOCKED_SECTIONS:function(e,t){e.unlockedSections=t},SET_GLOBAL_INFLUENCE_POINTS:function(e,t){e.globalInfluencePoints=t},SET_CURRENT_SECTION:function(e,t){e.currentSection=t},SET_CURRENT_IS_REPLAY:function(e,t){e.currentIsReplay=t},SET_STORY_TITLE:function(e,t){e.storyTitle=t},SET_STORY_CONTENT:function(e,t){e.storyContent=t},INCREMENT_TURN_COUNT:function(e){e.turnCount++},SET_PLOT_TRIGGERS:function(e,t){e.plotTriggers=t},SET_SELECTED_CHARACTER:function(e,t){e.selectedCharacter=t},RESET_STATE:function(e){e.currentSectionId=null,e.completedSections=[],e.unlockedSections=[1],e.globalInfluencePoints=[],e.currentSection=null,e.currentIsReplay=!1,e.turnCount=0,e.plotTriggers=[],e.storyTitle="",e.storyContent="",e.isGameInitialized=!1,e.influenceNotes=[],e.sectionTimePoint=null},SET_AVAILABLE_CHARACTERS:function(e,t){e.availableCharacters=t},SET_SECTION_RESULT:function(e,t){var n=t.sectionId,r=t.result;e.sectionResults=(0,s.A)((0,s.A)({},e.sectionResults),{},(0,La.A)({},n,r))},SET_INFLUENCE_NOTES:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];e.influenceNotes=t},SET_SECTION_TIME_POINT:function(e,t){e.sectionTimePoint=t}},Oa={initializeGameState:function(e){var t=e.commit,n=e.dispatch,r=e.rootState,a=n("save/loadSave",null,{root:!0});if(a)t("SET_CURRENT_SECTION_ID",a.currentSectionId),t("SET_COMPLETED_SECTIONS",a.completedSections),t("SET_UNLOCKED_SECTIONS",a.unlockedSections),t("SET_GLOBAL_INFLUENCE_POINTS",a.globalInfluencePoints),t("SET_SELECTED_CHARACTER",a.selectedCharacter);else{var o,i=(null===(o=r.sections.scenarioConfig)||void 0===o||null===(o=o.characters.find((function(e){return e.isDefault})))||void 0===o?void 0:o.name)||"罗伯特";t("SET_SELECTED_CHARACTER",i)}},updateGameState:function(e,t){var n=e.state,r=e.dispatch,a=t.sectionId;r("save/saveSave",{currentSectionId:a,completedSections:n.completedSections,unlockedSections:n.unlockedSections,globalInfluencePoints:n.globalInfluencePoints},{root:!0})},createPlayerInfo:function(e){var t=e.state,n=e.rootGetters,r=n["sections/getCurrentSectionData"];if(!r||!t.availableCharacters.length)return console.error("Section未定义或没有可用角色"),"";var a=t.availableCharacters.find((function(e){return!e.isAI}));if(!a)return console.warn("未找到可用的玩家角色"),"";var o="<b>你的角色：".concat(a.name,"</b>\n    ").concat(a.description);if(a.characterTags&&t.gameManager){var i=a.characterTags.reduce((function(e,n){var r=t.gameManager.getCharacterTag(n);return r&&(e+="<br>- ".concat(n,": ").concat(r)),e}),"");o+=i}return o},resetState:function(e){var t=e.commit;t("RESET_STATE"),t("SET_SELECTED_CHARACTER",null)},updateAvailableCharacters:function(e){var t,n=e.commit,r=e.state,a=e.rootState;if(null!==(t=a.gameManager)&&void 0!==t&&t.gameManager){var o=a.gameManager.gameManager.getFilteredCharacters(r.turnCount);n("SET_AVAILABLE_CHARACTERS",o)}},SET_GLOBAL_INFLUENCE_POINTS:function(e,t){var n=e.commit;n("SET_GLOBAL_INFLUENCE_POINTS",t)},SET_SECTION_RESULT:function(e,t){var n=e.commit;Object.entries(t).forEach((function(e){var t=(0,Ia.A)(e,2),r=t[0],a=t[1];n("SET_SECTION_RESULT",{sectionId:r,result:a})}))},SET_SELECTED_CHARACTER:function(e,t){var n=e.commit;n("SET_SELECTED_CHARACTER",t)},changeCharacter:function(e,t){return(0,o.A)((0,a.A)().mark((function n(){var r;return(0,a.A)().wrap((function(n){while(1)switch(n.prev=n.next){case 0:return r=e.dispatch,n.prev=1,n.next=4,r("SET_SELECTED_CHARACTER",t);case 4:return n.next=6,r("save/updateSaveData",{path:"player.selectedCharacter",value:t},{root:!0});case 6:return n.abrupt("return",!0);case 9:throw n.prev=9,n.t0=n["catch"](1),console.error("切换角色失败:",n.t0),n.t0;case 13:case"end":return n.stop()}}),n,null,[[1,9]])})))()},processInfluenceChecks:function(e,t){return(0,o.A)((0,a.A)().mark((function n(){var r,o,i,s,c,l,u,p,d,h,g,f,m,v;return(0,a.A)().wrap((function(n){while(1)switch(n.prev=n.next){case 0:if(r=e.commit,o=e.dispatch,i=e.rootState,t.sectionTimePoint&&r("SET_SECTION_TIME_POINT",t.sectionTimePoint),!(t.influences&&t.influences.length>0)){n.next=8;break}return s=t.sectionTimePoint,c=t.influences.map((function(e){return{id:e.id,value:e["default"],defaultValue:e["default"]}})),l=i.timelineInfluence.timelineInfluences.filter((function(e){return e.timePoint===s})),n.next=8,o("game/showTimelineInfluenceModal",{timePoint:s,influences:c,existingInfluences:l},{root:!0});case 8:if(!t.influenceChecks){n.next=35;break}u=[],p=[],d=(0,Ta.A)(t.influenceChecks),n.prev=12,d.s();case 14:if((h=d.n()).done){n.next=25;break}return g=h.value,n.next=18,o("timelineInfluence/checkInfluences",{conditions:g.conditions,type:g.type},{root:!0});case 18:f=n.sent,m=[],v=f?g.effects["true"]:g.effects["false"],v&&(v.appendBackgroundInfo&&(t.backgroundInfo=t.backgroundInfo+v.appendBackgroundInfo,m.push("添加了新的背景信息")),v.appendStartEvent&&(t.startEvent=t.startEvent+v.appendStartEvent,m.push("添加了新的开始事件")),v.influenceNotes&&(u.push(v.influenceNotes),m.push("添加了影响说明：「".concat(v.influenceNotes,"」")))),p.push({type:g.type,conditions:g.conditions,result:f,effects:m});case 23:n.next=14;break;case 25:n.next=30;break;case 27:n.prev=27,n.t0=n["catch"](12),d.e(n.t0);case 30:return n.prev=30,d.f(),n.finish(30);case 33:Na.log(Ra.formatMainReport(p,u,t.sectionTimePoint)),r("SET_INFLUENCE_NOTES",u);case 35:case"end":return n.stop()}}),n,null,[[12,27,30,33]])})))()}},Da={hasSave:function(e){return null!==e.currentSectionId},currentSection:function(e){return e.currentSection},selectedCharacter:function(e){return e.selectedCharacter},turnCount:function(e){return e.turnCount},plotTriggers:function(e){return e.plotTriggers},isGameInitialized:function(e){return e.isGameInitialized},storyContent:function(e){return e.storyContent},availableCharacters:function(e){return e.availableCharacters}};const ja={namespaced:!0,state:Ma,mutations:Pa,actions:Oa,getters:Da};n(4554);var Ua=function(){return{conversationHistory:[],optimizedConversationHistory:[],suggestions:[],streamingMessageId:null,isCompressing:!1,compressionThreshold:4,compressionBatchSize:4,preserveRecentMessages:2,currentCG:{imageUrl:null,leftCharacter:null,rightCharacter:null,textEffects:[],displayMode:"temporary"}}},Ga={ADD_TO_CONVERSATION_HISTORY:function(e,t){var n=(0,s.A)((0,s.A)({},t),{},{id:Date.now().toString()});e.conversationHistory.push(n),"info"!==t.role&&"user"!==t.role&&"attempt"!==t.role&&e.optimizedConversationHistory.push((0,s.A)({},n))},SET_SUGGESTIONS:function(e,t){e.suggestions=t},RESET_CONVERSATION:function(e){e.conversationHistory=[],e.optimizedConversationHistory=[],e.suggestions=[]},SET_STREAMING_MESSAGE_ID:function(e,t){e.streamingMessageId=t},UPDATE_STREAMING_MESSAGE:function(e,t){var n=t.id,r=t.content,a=e.conversationHistory.find((function(e){return e.id===n})),o=e.optimizedConversationHistory.find((function(e){return e.id===n}));a&&(a.content=r),o&&(o.content=r)},SET_COMPRESSING_STATUS:function(e,t){e.isCompressing=t},REPLACE_OPTIMIZED_MESSAGES:function(e,t){var n=t.startIndex,r=t.endIndex,a=t.compressedMessage;e.optimizedConversationHistory.splice(n,r-n+1,{id:"compressed_".concat(Date.now()),role:"system",content:a,isCompressed:!0})},REMOVE_LAST_USER_MESSAGE:function(e){for(var t=e.conversationHistory.length-1;t>=0;t--)if("user"===e.conversationHistory[t].role){e.conversationHistory.splice(t,1);break}for(var n=e.optimizedConversationHistory.length-1;n>=0;n--)if("user"===e.optimizedConversationHistory[n].role){e.optimizedConversationHistory.splice(n,1);break}},SET_INITIAL_SUGGESTIONS:function(e,t){e.suggestions=t},SET_CURRENT_CG:function(e,t){e.currentCG=t?{imageUrl:t.imageUrl,leftCharacter:t.leftCharacter||null,rightCharacter:t.rightCharacter||null,textEffects:t.textEffects||[],displayMode:t.displayMode||"temporary"}:{imageUrl:null,leftCharacter:null,rightCharacter:null,textEffects:[],displayMode:"temporary"}}},Va={addUserMessage:function(e,t){return(0,o.A)((0,a.A)().mark((function n(){var r;return(0,a.A)().wrap((function(n){while(1)switch(n.prev=n.next){case 0:r=e.commit,r("ADD_TO_CONVERSATION_HISTORY",{role:"user",content:t});case 2:case"end":return n.stop()}}),n)})))()},clearConversation:function(e){var t=e.commit;t("RESET_CONVERSATION"),t("SET_STREAMING_MESSAGE_ID",null),t("SET_SUGGESTIONS",[]),t("SET_COMPRESSING_STATUS",!1)},startNewMessage:function(e,t){var n=e.commit,r=t.role,a=t.initialContent,o=void 0===a?"":a,i=Date.now().toString();return n("ADD_TO_CONVERSATION_HISTORY",{role:r,content:o,id:i}),n("SET_STREAMING_MESSAGE_ID",i),i},updateStreamingMessage:function(e,t){var n=e.commit,r=t.id,a=t.content;n("UPDATE_STREAMING_MESSAGE",{id:r,content:a})},finishStreamingMessage:function(e,t){var n=e.commit,r=e.state;r.streamingMessageId===t&&n("SET_STREAMING_MESSAGE_ID",null)},checkAndTriggerCompression:function(e){return(0,o.A)((0,a.A)().mark((function t(){var n,r,i,s;return(0,a.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(n=e.state,r=e.commit,i=e.dispatch,console.log("checkAndTriggerCompression"),!(n.isCompressing||n.optimizedConversationHistory.length<n.compressionThreshold)){t.next=4;break}return t.abrupt("return");case 4:if(s=n.optimizedConversationHistory[n.optimizedConversationHistory.length-1],!s||"user"!==s.role){t.next=7;break}return t.abrupt("return");case 7:r("SET_COMPRESSING_STATUS",!0),setTimeout((0,o.A)((0,a.A)().mark((function e(){var t,o,s,c,l,u,p;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(e.prev=0,t=n.streamingMessageId?n.optimizedConversationHistory.length-2:n.optimizedConversationHistory.length-1,o=t-n.preserveRecentMessages,s=0,!(s>=o)){e.next=7;break}return r("SET_COMPRESSING_STATUS",!1),e.abrupt("return");case 7:return c=n.optimizedConversationHistory.slice(s,o+1).filter((function(e){return"info"!==e.role})).map((function(e){return"".concat(e.role,": ").concat(e.content)})).join("\n"),l={type:"object",properties:{keyPoints:{type:"array",items:{type:"object",additionalProperties:!1,properties:{event_time:{type:"string",description:"事件发生的相对时间点"},character_states:{type:"array",items:{type:"object",additionalProperties:!1,properties:{name:{type:"string"},health_status:{type:"string"},power_status:{type:"string"},mental_state:{type:"string"}},required:["name","health_status","power_status","mental_state"]},description:"相关角色的状态，包括健康状况、异能状态、精神状态等"},character_actions:{type:"array",items:{type:"object",additionalProperties:!1,properties:{actor:{type:"string"},action:{type:"string"},target:{type:"string"}},required:["actor","action","target"]},description:"角色的具体行动"},item_states:{type:"array",items:{type:"object",additionalProperties:!1,properties:{name:{type:"string"},condition:{type:"string"},usage_status:{type:"string"}},required:["name","condition","usage_status"]},description:"相关物品的状态"},significance:{type:"string",description:"这个关键点对剧情的重要性"}},required:["event_time","character_states","character_actions","item_states","significance"]}},compressedSummary:{type:"string",description:"压缩后的剧情总结，包含所有关键信息"}},required:["keyPoints","compressedSummary"],additionalProperties:!1},u="分析并压缩以下游戏剧情内容。这些剧情包含了角色互动、状态变化和物品使用情况。\n\n        对话内容：\n        ".concat(c,"\n\n        请注意记录以下要素：\n        1. 角色状态变化：\n           - 健康状况（受伤程度、体力等）\n           - 异能状态（使用程度、剩余能量等）\n           - 精神状态（情绪、意志等）\n        \n        2. 角色行动：\n           - 具体做了什么\n           - 对谁做的\n           - 行动的结果\n        \n        3. 物品状态：\n           - 武器/装备的损坏程度\n           - 消耗品的使用情况\n           - 载具的状态\n        \n        4. 事件重要性：\n           - 对后续剧情的影响\n           - 对角色关系的影响\n           - 对整体任务的影响\n      \n        请按照指定的JSON格式返回，确保每个关键时间点都包含：\n        1. event_time: 事件发生的相对时间\n        2. character_states: 相关角色的状态数组\n        3. character_actions: 具体行动数组\n        4. item_states: 相关物品状态数组\n        5. significance: 事件重要性说明\n        \n        同时提供一个 compressedSummary 作为整体概述包含各个要点，我们只会保存这个综述，前面的可以简短一点，你自己看得懂就行。"),e.next=12,i("api/callLargeLanguageModelWithSchema",{prompt:u,schema:l,module:"compression"},{root:!0});case 12:p=e.sent,r("REPLACE_OPTIMIZED_MESSAGES",{startIndex:s,endIndex:o,compressedMessage:p.compressedSummary}),e.next=19;break;case 16:e.prev=16,e.t0=e["catch"](0),console.error("压缩消息时出错:",e.t0);case 19:return e.prev=19,r("SET_COMPRESSING_STATUS",!1),e.finish(19);case 22:case"end":return e.stop()}}),e,null,[[0,16,19,22]])}))),0);case 9:case"end":return t.stop()}}),t)})))()},removeLastUserMessage:function(e){var t=e.commit;t("REMOVE_LAST_USER_MESSAGE")},setSuggestions:function(e,t){var n=e.commit;n("SET_INITIAL_SUGGESTIONS",t)},addSystemMessage:function(e,t){var n=e.commit,r=t.content;n("ADD_TO_CONVERSATION_HISTORY",{role:"system",content:r})},addCGToHistory:function(e,t){var n=e.commit;n("SET_CURRENT_CG",t)},clearCurrentCG:function(e){var t=e.commit;t("SET_CURRENT_CG",null)}},Ba={getLastRound:function(e){var t=e.conversationHistory.slice(-3);return t.map((function(e){return"".concat(e.role,": ").concat(e.content)})).join("\n")},conversationHistory:function(e){return e.conversationHistory},optimizedConversationHistory:function(e){return e.optimizedConversationHistory},suggestions:function(e){return e.suggestions},currentStreamingMessage:function(e){return e.streamingMessageId?e.conversationHistory.find((function(t){return t.id===e.streamingMessageId})):null},getCurrentStreamingMessage:function(e){return e.streamingMessageId?e.conversationHistory.find((function(t){return t.id===e.streamingMessageId})):null},getAllMessages:function(e){return e.conversationHistory}};const Ka={namespaced:!0,state:Ua,mutations:Ga,actions:Va,getters:Ba},Fa={title:"设置",apiKeyLabel:"API Key",apiKeyPlaceholder:"输入你的API Key",apiUrlLabel:"API URL",apiUrlPlaceholder:"输入API URL",advancedModelLabel:"进阶模型 (用于桥段总结)",basicModelLabel:"基本模型 (用于其他操作)",saveButton:"保存设置",publicKeyButton:"获取公共key",resetButton:"恢复默认设置",helpButton:"这是什么？",savedMessage:"设置已保存",saveError:"保存设置失败，请重试",publicKeyFetched:"公共 Key 已成功获取并保存",publicKeyFetchFailed:"获取公共 Key 失败，请检查网络连接或稍后再试",resetMessage:"设置已恢复默认",confirmReset:"确定要恢复默认设置吗？这将清除所有自定义设置。",confirmExit:"确定要退出吗？未保存的更改将会丢失。你可以用保存设置按钮返回主菜单。",confirmExitTitle:"确认退出",helpTitle:"帮助信息",helpContent:"\n    <p>本游戏<strong>基于</strong>可访问<strong>大语言模型</strong>的接口API进行，您可自行寻找相关API服务，默认API地址不构成推荐建议</p>\n    <p>第一次打开游戏网页时会自动尝试获取游戏节key，所以您可能直接开始游戏就可以游玩了。</p>\n    <p>公共key如果有的话，是作者买来给大家玩的</p>\n  ",apiKeyDisabled:"API Key 已被禁用，因为正在使用公共 Key",text:"设置",exitButton:"返回主菜单",modelOptions:{"gpt-4o-mini":"gpt-4o-mini (最初支持的模型)","deepseek-chat":"deepseek-chat (已专门做支持)"},useDeepSeekButton:"使用 DeepSeek 模型",noPublicKeyAvailable:"检测到目前无公共密钥在线，您可以前往 DeepSeek 官网获取 API 密钥",publicKeyDisabled:"公共密钥服务暂时关闭",deepseekSetMessage:"已设置为 DeepSeek 模型配置，游戏已针对该模型进行了优化",needApiKeyNotice:'请先配置 API Key 才能开始游戏。点击上方的"设置"按钮进行配置。',useAgentlandFestival2025KeyButton:"使用 AgentlandFestival2025 提供的游戏节 Key",sponsorAgentlandFestival2025:"了解 Agentland Festival 2025",AgentlandFestival2025KeySetMessage:"已成功设置 AgentlandFestival2025 提供的游戏节 Key",AgentlandFestival2025KeyError:"设置游戏节 Key 失败，请稍后再试",invalidSettings:"设置无效，请检查 API Key 和 API URL"},Ha={title:"游戏教程",close:"关闭",understand:"我明白了",raw:{content:'\n      <p>你可以把本游戏理解为<strong>跑团（DND或COC）</strong>、<strong>语C</strong>、<strong>剧本杀</strong>或<strong>过家家</strong>🧑‍🤝‍🧑。本游戏制作时面向的玩家是<strong>喜欢剧情向游戏</strong>，愿意<strong>认真扮演角色</strong>🎭  的语C、跑团玩家👥。</p>\n      <ol>\n        <li>📝 <strong>目标</strong>：在每一个桥段里，你需要完成<strong>桥段目标</strong>🎯，目标可能是<strong>沟通</strong>💬、<strong>战斗</strong>⚔️、<strong>解密</strong>🧩等。</li>\n        <li>🎮 <strong>操作</strong>：根据你的人设和起始事件，在对话框中打字输入以<strong>你的角色的角度</strong>进行的行动、说的话🗣️。比如输入"我挥起武器说，与我何干！"，不需要特别注意格式</li>\n        <li>💡 <strong>技巧</strong>：很多角色有<strong>超能力</strong>🔮，比如银月篇主角罗伯特，可以<strong>减缓时间流速</strong>🕰️，你可以接住敌方扔来的飞刀扔回去🗡️，也能准确地瞄准你要攻击的物件🎯，只要你能想到。</li>\n      </ol>\n      <ul>\n        <li>⚠️ <strong>注意</strong>：如果出现输入之后无回复，可以回<strong>主菜单-设置</strong>⚙️里面点"<strong>恢复默认设置</strong>🔄"。一般是初始化的网络问题🌐。</li>\n        <li>🔍 <strong>注意</strong>：高亮有颜色的文字可以点🔗。</li>\n        <li>📜 <strong>注意</strong>：在<strong>桥段剧本</strong>之外，主持人给出的信息不完全保真（比如问队友问题，可能会得到不正确的回复🤔），可以完全取信的是非大模型的<strong>桥段剧本</strong>、<strong>初始事件</strong>、<strong>词条解释</strong>。</li>\n      </ul>\n    '}},za={reviewTitle:"桥段回顾",noReviewRecords:"暂无桥段回顾记录。",rename:"重命名",delete:"删除",viewDetails:"查看详情",reviewDetails:"回顾详情",exportAsHTML:"导出为HTML",exportAsImage:"导出为长图",exportAsMultipleImages:"导出为多图",enterNewTitle:"请输入新的标题",confirmDelete:"您确定要删除这条回顾记录吗？",renameReview:"重命名回顾",confirmDeleteMessage:"确定要删除这条回顾记录吗？"},Wa={newGame:"开始新游戏",continueGame:"继续游戏",reviewRecords:"回顾记录",importSave:"导入存档",exportSave:"导出存档",deleteSave:"删除存档",confirmImport:"您确定要导入并覆盖存档吗？此操作无法撤销。您可以先导出自己的存档进行备份。",importSuccess:"存档已成功导入",returnToSections:"返回桥段选择",chooseSection:"选择桥段",completed:"已完成",replay:"重玩",skip:"跳过",start:"开始",locked:"未解锁",confirmReturn:"确定要返回吗？当前进度将不会保存。",loadSectionError:"加载章节失败",sectionSkipped:"已跳过本章节",confirmNewGame:"确定要开始新游戏吗？当前存档将会被覆盖。",startGameError:"开始新游戏失败",loadSaveError:"加载存档失败",typeCombat:"战斗",typeWits:"智斗",typeStory:"剧情",typePuzzle:"解谜",typePersuade:"说服",typeRomance:"恋爱",typeNone:"无标签",sectionFailed:"章节未完成",sectionSuccess:"章节完成",tryAgain:"重新尝试",hideStory:"隐藏剧情",confirmReturnTitle:"确认返回",confirmReturnToMenu:"确定要返回主菜单吗？",confirmReturnToSections:"确定要返回章节选择吗？本桥段的进度将不会保存。",confirmImportTitle:"确认导入",confirmDeleteTitle:"确认删除",confirmNewGameTitle:"确认新游戏",error:"错误",selectCharacter:"选择角色",selectCharacterDesc:"每个角色对应单独的故事线",startJourney:"开始旅程",characterSelectError:"角色选择失败",selectCharacterFirst:"请先选择角色",characterLocked:"角色未解锁",selectScenario:"选择剧本",currentGameInfo:"{character} - {scenario}"},Xa={success:"成功",error:"错误",confirm:"确认",cancel:"取消",close:"关闭",back:"返回",return:"返回",loading:"加载中...",mainMenu:"主菜单",returnToMenu:"返回主菜单",save:"保存",reset:"重置",help:"帮助",confirmAction:"确定要执行此操作吗？",actionSuccess:"操作成功",actionFailed:"操作失败",networkError:"网络错误",pleaseWait:"请稍候...",retry:"重试",skip:"跳过",next:"下一步",previous:"上一步",finish:"完成",continue:"继续",exit:"退出"},Ja={mainTitle:"不止于纸上的故事",subTitle:"Beyond Books",gameDescription:"一个由AI(gpt4o-mini)驱动的异能战斗/交涉/聊天文字剧本杀",creatorsMessage:"制作者的话",creatorsMessageTitle:"💌 制作者的话",creatorsMessageContent:'\n    <div class="space-y-6">\n      <div class="bg-tech-light/50 p-4 rounded-lg">\n        <p class="text-lg">《不止于纸上的故事》曾经是我在2015年主导创作的纸上游戏、桌上剧团 <b>"BB"</b>，到了大学我翻遍字典，找到了 <b>Beyond Books</b> 这两个词。我很荣幸能将其搬到电子游戏中，终于能与大家分享我的故事。 📚✨</p>\n      </div>\n\n      <div class="bg-tech-light/50 p-4 rounded-lg">\n        <p>🤖 现代的大型语言模型可以帮我把大纲和细节演出的生动而充满意外，我不胜感激这个新时代。一个人做测试难免不周到，出bug还请多多海涵。 🙏</p>\n      </div>\n\n      <div class="bg-tech-light/50 p-4 rounded-lg">\n        <p>📖 目前的故事进行到了<strong class="text-tech-primary">银月篇罗伯特线的完结部分</strong>，接下来打算更新其他人在银月篇的线！罗伯特线里面实际上有大量未解答的东西，到其他人的视角中也许就真相大白了~ 我追求其他人的线不与旧线重复，重复部分略过。 🌙</p>\n      </div>\n\n      <div class="space-y-4">\n        <div class="border-l-4 border-tech-primary/20 pl-4">\n          <h3 class="text-tech-primary font-bold mb-2">🤝 鸣谢与我交流的玩家们：</h3>\n          <p>小沃里 · 佚名 · 裴冬柚 · shangui · Hecean · 洛海 · 机旅策划 · H2Oovo</p>\n        </div>\n\n        <div class="border-l-4 border-tech-primary/20 pl-4">\n          <h3 class="text-tech-primary font-bold mb-2">💫 致谢朋友们：</h3>\n          <p>TOLINIA · Tourswen · 镜子 · Crystal · 琼 · 玉米</p>\n        </div>\n\n        <div class="border-l-4 border-tech-primary/20 pl-4">\n          <h3 class="text-tech-primary font-bold mb-2">🌊 敬谢大自然：</h3>\n          <p>海南之海 · 灵界之海</p>\n        </div>\n\n        <div class="border-l-4 border-tech-primary/20 pl-4">\n          <h3 class="text-tech-primary font-bold mb-2">✍️ 作者：</h3>\n          <p>tobenot</p>\n        </div>\n      </div>\n    </div>\n  ',updateLog:"更新日志 25.01.05",updateLogTitle:"更新日志",updateLogContent:'\n    <div class="space-y-6">\n      <div class="bg-tech-light/50 p-4 rounded-lg">\n        <p class="text-tech-secondary">主要更新记录</p>\n      </div>\n\n      <div class="space-y-4">\n        <div class="bg-white/80 p-4 rounded-lg shadow-tech hover:shadow-tech-lg transition-all duration-300">\n          <h3 class="text-tech-primary font-bold flex items-center gap-2 mb-2">\n            <span class="bg-tech-tag-combat/10 text-tech-tag-combat/90 px-2 py-1 rounded">2025年1月</span>\n          </h3>\n          <ul class="space-y-2">\n            <li class="flex items-start gap-2">\n              <span class="text-tech-accent">05日</span>\n              <p>18段结局段正式配置 · Agentland Festival 2025 key实装 · 全面优化界面体验</p>\n            </li>\n            <li class="flex items-start gap-2">\n              <span class="text-tech-accent">04日</span>\n              <p>大规模bug修复 · 13-17段正式配置 · 桥段时间线影响配置(1-12段)</p>\n            </li>\n            <li class="flex items-start gap-2">\n              <span class="text-tech-accent">03日</span>\n              <p>桥段时间线影响系统</p>\n            </li>\n            <li class="flex items-start gap-2">\n              <span class="text-tech-accent">02日</span>\n              <p>修复itch加载CG问题 · 第12段新配置</p>\n            </li>\n            <li class="flex items-start gap-2">\n              <span class="text-tech-accent">01日</span>\n              <p>直达继续游戏功能 · 专门的建议系统 · 第10/11段新配置</p>\n            </li>\n          </ul>\n        </div>\n\n        <div class="bg-white/80 p-4 rounded-lg shadow-tech hover:shadow-tech-lg transition-all duration-300">\n          <h3 class="text-tech-primary font-bold flex items-center gap-2 mb-2">\n            <span class="bg-tech-tag-story/10 text-tech-tag-story/90 px-2 py-1 rounded">2024年12月</span>\n          </h3>\n          <ul class="space-y-2">\n            <li class="flex items-start gap-2">\n              <span class="text-tech-accent">31日</span>\n              <p>开头CG · 银月篇罗伯特线第八九段多Agent配置</p>\n            </li>\n            <li class="flex items-start gap-2">\n              <span class="text-tech-accent">30日</span>\n              <p>战斗数值系统实装 · 血蓝条优化</p>\n            </li>\n            <li class="flex items-start gap-2">\n              <span class="text-tech-accent">29日</span>\n              <p>剧本和人物选择系统</p>\n            </li>\n            <li class="flex items-start gap-2">\n              <span class="text-tech-accent">22日</span>\n              <p>重构项目，想上Agentland Festival 2025 · 横屏排版 · 界面动画优化</p>\n            </li>\n          </ul>\n        </div>\n\n        <div class="bg-white/80 p-4 rounded-lg shadow-tech hover:shadow-tech-lg transition-all duration-300">\n          <h3 class="text-tech-primary font-bold flex items-center gap-2 mb-2">\n            <span class="bg-tech-tag-wits/10 text-tech-tag-wits/90 px-2 py-1 rounded">历史更新</span>\n          </h3>\n          <ul class="space-y-2">\n            <li class="flex items-start gap-2">\n              <span class="text-tech-accent">2024年11月</span>\n              <p>迁移至Vue3 · 界面美化 · 剧本结构重构 · CG实时生成</p>\n            </li>\n            <li class="flex items-start gap-2">\n              <span class="text-tech-accent">2024年10月</span>\n              <p>多Agent系统实验成功</p>\n            </li>\n            <li class="flex items-start gap-2">\n              <span class="text-tech-accent">2024.07.02</span>\n              <p>银月篇罗伯特线完结！</p>\n            </li>\n            <li class="flex items-start gap-2">\n              <span class="text-tech-accent">2024.06.03</span>\n              <p>快毕业上班了，想做个简单点的大模型剧本杀项目，开坑！</p>\n            </li>\n          </ul>\n        </div>\n      </div>\n    </div>\n  ',gameTutorial:{text:"游戏教程",title:"🎮 游戏教程",content:'\n      <div class="space-y-8">\n        \x3c!-- 介绍部分 --\x3e\n        <div class="bg-tech-light/50 p-4 rounded-lg">\n          <p class="text-lg">\n            你可以把本游戏理解为 \n            <span class="inline-flex gap-2 flex-wrap">\n              <strong class="bg-white/80 px-2 py-0.5 rounded">跑团(DND/COC)</strong>\n              <strong class="bg-white/80 px-2 py-0.5 rounded">语C</strong>\n              <strong class="bg-white/80 px-2 py-0.5 rounded">剧本杀</strong>\n              <strong class="bg-white/80 px-2 py-0.5 rounded">过家家</strong>\n              <strong class="bg-white/80 px-2 py-0.5 rounded">桌上剧团</strong>\n            </span>\n            🧑‍🤝‍🧑\n          </p>\n          <p class="mt-2">\n            本游戏面向<strong class="text-tech-primary">喜欢剧情向游戏</strong>，愿意<strong class="text-tech-primary">认真扮演角色</strong>的语C、跑团玩家 🎭\n          </p>\n        </div>\n\n        \x3c!-- 核心玩法 --\x3e\n        <div class="space-y-4">\n          <h3 class="text-lg font-bold text-tech-primary flex items-center gap-2">\n            <span class="bg-tech-primary/10 p-2 rounded-lg">🎯</span>\n            核心玩法\n          </h3>\n          <div class="grid gap-4 md:grid-cols-2">\n            <div class="bg-white/80 p-4 rounded-lg shadow-sm">\n              <h4 class="font-bold text-tech-primary mb-2">📝 游戏目标</h4>\n              <p>在每个桥段中完成<strong>特定目标</strong>，可能包括：</p>\n              <div class="mt-2 flex gap-2 flex-wrap">\n                <span class="bg-tech-tag-combat/10 text-tech-tag-combat/90 px-2 py-0.5 rounded">战斗 ⚔️</span>\n                <span class="bg-tech-tag-persuade/10 text-tech-tag-persuade/90 px-2 py-0.5 rounded">沟通 💬</span>\n                <span class="bg-tech-tag-puzzle/10 text-tech-tag-puzzle/90 px-2 py-0.5 rounded">解密 🧩</span>\n              </div>\n              <p>你在一个剧本中的某个桥段的行动可能会影响到其他桥段甚至其他剧本的桥段。</p>\n            </div>\n            <div class="bg-white/80 p-4 rounded-lg shadow-sm">\n              <h4 class="font-bold text-tech-primary mb-2">🎮 基本操作</h4>\n              <p>在对话框中输入你的角色的：</p>\n              <ul class="mt-2 space-y-1 list-disc list-inside">\n                <li>对话内容 🗣️</li>\n                <li>行动描述 🏃‍♂️</li>\n              </ul>\n              <p>你可以展开建议并点击来快速输入</p>\n            </div>\n          </div>\n        </div>\n\n        \x3c!-- 特色系统 --\x3e\n        <div class="space-y-4">\n          <h3 class="text-lg font-bold text-tech-primary flex items-center gap-2">\n            <span class="bg-tech-primary/10 p-2 rounded-lg">💫</span>\n            特色系统\n          </h3>\n          <div class="bg-white/80 p-4 rounded-lg shadow-sm">\n            <h4 class="font-bold text-tech-primary mb-2">🔮 超能力系统</h4>\n            <p class="mb-2">许多角色都拥有独特的超能力，例如：</p>\n            <div class="bg-tech-light/50 p-3 rounded-lg">\n              <p class="text-tech-primary"><strong>罗伯特</strong>的时间停止能力：</p>\n              <ul class="mt-1 space-y-1 list-disc list-inside text-sm">\n                <li>接住并把敌人的飞刀扔回去 🗡️</li>\n                <li>精确瞄准攻击目标 🎯</li>\n                <li>在危险中从容应对 ⏱️</li>\n              </ul>\n            </div>\n          </div>\n        </div>\n\n        \x3c!-- 注意事项 --\x3e\n        <div class="space-y-4">\n          <h3 class="text-lg font-bold text-tech-primary flex items-center gap-2">\n            <span class="bg-tech-primary/10 p-2 rounded-lg">⚠️</span>\n            注意事项\n          </h3>\n          <div class="space-y-2">\n            <div class="bg-tech-tag-combat/10 p-3 rounded-lg">\n              <p>🔄 如遇<strong>无响应</strong>，请前往<strong>设置</strong>点击"恢复默认设置"</p>\n            </div>\n            <div class="bg-tech-tag-story/10 p-3 rounded-lg">\n              <p>🔍 带有颜色的文字可以点击查看详细信息</p>\n            </div>\n            <div class="bg-tech-tag-wits/10 p-3 rounded-lg">\n              <p>📜 大模型会产生不真实的信息，完全可信的信息来源有：<strong>桥段剧本</strong>、<strong>初始事件</strong>、<strong>词条解释</strong></p>\n            </div>\n          </div>\n        </div>\n      </div>\n    '},footer:{qqGroup:"QQ群",bilibili:"B站",welcomeMessage:"欢迎讨论剧情/私信留言等~"}},qa={library:"剧本库",selectTitle:"选择剧本",selectDesc:"请选择要游玩的剧本",start:"开始游戏",author:"作者",version:"版本",contentWarning:"内容警告",noContentWarning:"本剧本无特殊内容警告",categories:{main:"主线剧本",side:"支线剧本",extra:"额外内容",custom:"自定义剧本"},returnToMenu:"返回主菜单",lastUpdate:"最近更新",updateNotes:"更新内容",contentTags:"可能包含以下内容",contentTagTypes:{romance:"恋爱剧情",lgbt:"同性感情",furry:"兽化要素",violence:"暴力内容",mystery:"悬疑要素"}},Qa={settings:Fa,tutorial:Ha,review:za,game:Wa,common:Xa,menu:Ja,scenario:qa};var Ya=(0,H.hU)({legacy:!1,locale:"zh-CN",fallbackLocale:"zh-CN",messages:{"zh-CN":Qa},globalInjection:!0});function $a(e){e.use(Ya)}var Za=function(){return{showTutorial:!1,tutorialContent:{title:"",content:""}}},eo={SET_SHOW_TUTORIAL:function(e,t){e.showTutorial=t},SET_TUTORIAL_CONTENT:function(e,t){e.tutorialContent=t},HIDE_TUTORIAL:function(e){e.showTutorial=!1}},to={showGameTutorial:function(e){var t=e.commit;t("SET_TUTORIAL_CONTENT",{title:r["default"].global.t("tutorial.title"),content:r["default"].global.t("tutorial.content")}),t("SET_SHOW_TUTORIAL",!0)},hideTutorial:function(e){var t=e.commit;t("HIDE_TUTORIAL")},showCustomTutorial:function(e,t){var n=e.commit,r=t.title,a=t.content;n("SET_TUTORIAL_CONTENT",{title:r,content:a}),n("SET_SHOW_TUTORIAL",!0)}},no={isShowingTutorial:function(e){return e.showTutorial},tutorialContent:function(e){return e.tutorialContent}};const ro={namespaced:!0,state:Za,mutations:eo,actions:to,getters:no};var ao=n(9258),oo=(n(9868),n(3921),n(1396)),io=n.n(oo),so={ADVANCED:"advanced",BASIC:"basic"},co=(0,La.A)((0,La.A)({},so.ADVANCED,"gpt-4o-mini"),so.BASIC,"gpt-4o-mini"),lo="settings",uo={NODE_ENV:"production",BASE_URL:"/vue/"}.VUE_APP_AGENT_NIGHT_KEY||"",po="YourEncryptionKey",ho={ADVANCED:"advanced",BASIC:"basic"};function go(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:ho.BASIC,t=JSON.parse(localStorage.getItem("settings"));return t&&t[e]||co[e]}var fo={apiKey:"",apiUrl:"https://api.deepbricks.ai/v1/",advancedModel:"gpt-4o",basicModel:"gpt-4o-mini",isPublicKey:!1,isAgentlandFestival2025Key:!1},mo={setSettings:function(e,t){t.apiKey&&(e.apiKey=t.apiKey),t.apiUrl&&(e.apiUrl=t.apiUrl),e.advancedModel=t.advancedModel,e.basicModel=t.basicModel,e.isPublicKey=t.isPublicKey,this.commit("api/SET_API_KEY",e.apiKey),this.commit("api/SET_API_URL",e.apiUrl)},SET_PUBLIC_KEY:function(e,t){e.apiKey=t,e.isPublicKey=!0,this.commit("api/SET_API_KEY",t)},SET_AGENT_NIGHT_KEY:function(e){try{var t=uo;t&&(e.apiKey=t,e.apiUrl="https://api.deepseek.com/v1/",e.advancedModel="deepseek-chat",e.basicModel="deepseek-chat",e.isPublicKey=!0,e.isAgentlandFestival2025Key=!0),console.log("设置游戏节 Key 成功")}catch(n){console.error("Failed to set AgentlandFestival2025 key:",n)}}},vo={loadSettings:function(e){return(0,o.A)((0,a.A)().mark((function t(){var n,r;return(0,a.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:return n=e.commit,t.next=3,bo();case 3:r=t.sent,n("setSettings",r);case 5:case"end":return t.stop()}}),t)})))()},saveSettings:function(e,t){return(0,o.A)((0,a.A)().mark((function n(){var r;return(0,a.A)().wrap((function(n){while(1)switch(n.prev=n.next){case 0:return r=e.commit,n.next=3,yo(t);case 3:r("setSettings",t);case 4:case"end":return n.stop()}}),n)})))()},getPublicKey:function(e){return(0,o.A)((0,a.A)().mark((function t(){var n,r;return(0,a.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:return n=e.commit,t.prev=1,t.next=4,xo();case 4:if(r=t.sent,r){t.next=7;break}throw new Error("Invalid public key");case 7:return n("SET_PUBLIC_KEY",r),t.abrupt("return",!0);case 11:return t.prev=11,t.t0=t["catch"](1),console.error("获取公钥失败:",t.t0),t.abrupt("return",!1);case 15:case"end":return t.stop()}}),t,null,[[1,11]])})))()},resetSettings:function(e){return(0,o.A)((0,a.A)().mark((function t(){var n,r;return(0,a.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:return n=e.commit,r=ko(),t.next=4,yo(r);case 4:n("setSettings",r);case 5:case"end":return t.stop()}}),t)})))()},initializeSave:function(e){return(0,o.A)((0,a.A)().mark((function t(){var n;return(0,a.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:return n=e.dispatch,t.next=3,n("loadSettings");case 3:case"end":return t.stop()}}),t)})))()},useAgentlandFestival2025Key:function(e){return(0,o.A)((0,a.A)().mark((function t(){var n;return(0,a.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:return n=e.commit,n("SET_AGENT_NIGHT_KEY"),t.next=4,yo(fo);case 4:return t.abrupt("return",!0);case 5:case"end":return t.stop()}}),t)})))()}};function bo(){var e=localStorage.getItem(lo);return e?JSON.parse(e):ko()}function yo(e){localStorage.setItem(lo,JSON.stringify(e))}function ko(){return{apiKey:"",apiUrl:"https://api.deepseek.com/v1/",advancedModel:"deepseek-chat",basicModel:"deepseek-chat",isPublicKey:!1}}function xo(){return wo.apply(this,arguments)}function wo(){return wo=(0,o.A)((0,a.A)().mark((function e(){var t,n,r;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,fetch("https://tobenot.top/storage/keyb.txt");case 3:if(t=e.sent,t.ok){e.next=6;break}throw new Error("Network response was not ok");case 6:return e.next=8,t.text();case 8:if(n=e.sent,r=So(n,po),r){e.next=12;break}throw new Error("Decryption failed");case 12:return e.abrupt("return",r);case 15:throw e.prev=15,e.t0=e["catch"](0),console.error("Error fetching or decrypting public key:",e.t0),e.t0;case 19:case"end":return e.stop()}}),e,null,[[0,15]])}))),wo.apply(this,arguments)}function So(e,t){var n=io().AES.decrypt(e,t);return n.toString(io().enc.Utf8)}var Eo={hasValidSettings:function(e){return!!e.apiKey&&!!e.apiUrl},hasValidApiKey:function(e){return!!e.apiKey}};const Ao={namespaced:!0,state:fo,mutations:mo,actions:vo,getters:Eo};var _o=new lt(!1,"API"),Co={prompt:.712,completion:2.848};function To(e){return e.replace(/\r?\n\s*/g," ").replace(/\s+/g," ").trim()}var Io=function(){return{apiKey:"",apiUrl:"",isLoading:!1,tokenStats:{standard:{},streaming:{},ratios:{prompt:.6,completion:.8},samples:0}}},Lo={SET_API_KEY:function(e,t){e.apiKey=t},SET_API_URL:function(e,t){e.apiUrl=t},SET_LOADING:function(e,t){e.isLoading=t},UPDATE_TOKEN_STATS:function(e,t){var n=t.module,r=t.type,a=t.data;"standard"===r?(e.tokenStats.standard[n]||(e.tokenStats.standard[n]={promptTokens:0,completionTokens:0,totalTokens:0}),e.tokenStats.standard[n].promptTokens+=a.promptTokens,e.tokenStats.standard[n].completionTokens+=a.completionTokens,e.tokenStats.standard[n].totalTokens+=a.promptTokens+a.completionTokens):(e.tokenStats.streaming[n]||(e.tokenStats.streaming[n]={promptLength:0,completionLength:0}),e.tokenStats.streaming[n].promptLength+=a.promptLength,e.tokenStats.streaming[n].completionLength+=a.completionLength);var o={},i={promptTokens:0,completionTokens:0,totalTokens:0},c=new Set([].concat((0,ao.A)(Object.keys(e.tokenStats.standard)),(0,ao.A)(Object.keys(e.tokenStats.streaming))));c.forEach((function(t){var n=e.tokenStats.standard[t]||{promptTokens:0,completionTokens:0,totalTokens:0},r=e.tokenStats.streaming[t]||{promptLength:0,completionLength:0},a=Math.ceil((r.promptLength||0)*e.tokenStats.ratios.prompt),s=Math.ceil((r.completionLength||0)*e.tokenStats.ratios.completion),c={promptTokens:n.promptTokens+a,completionTokens:n.completionTokens+s,totalTokens:n.totalTokens+a+s};i.promptTokens+=c.promptTokens,i.completionTokens+=c.completionTokens,i.totalTokens+=c.totalTokens,o[t]={standard:n,streaming:r,calculated:{streamingPromptTokens:a,streamingCompletionTokens:s},total:c}})),_o.log("Token 使用统计:",{moduleStats:o,总计:(0,s.A)((0,s.A)({},i),{},{cost:No(e)+" 元"})})},UPDATE_TOKEN_RATIOS:function(e,t){var n=t.promptLength,r=t.completionLength,a=t.promptTokens,o=t.completionTokens,i=Math.min(e.tokenStats.samples,100)/(Math.min(e.tokenStats.samples,100)+1),s=a/n,c=o/r;e.tokenStats.ratios.prompt=e.tokenStats.ratios.prompt*i+s*(1-i),e.tokenStats.ratios.completion=e.tokenStats.ratios.completion*i+c*(1-i),e.tokenStats.samples++,_o.log("Token比例更新:",{prompt:e.tokenStats.ratios.prompt,completion:e.tokenStats.ratios.completion,samples:e.tokenStats.samples})}},Ro={handleApiResponse:function(e,t){return(0,o.A)((0,a.A)().mark((function e(){var n;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(t.ok){e.next=6;break}return e.next=3,t.json();case 3:throw n=e.sent,console.error("错误响应内容:",n),new Error("HTTP error! status: ".concat(t.status));case 6:return e.next=8,t.json();case 8:return e.abrupt("return",e.sent);case 9:case"end":return e.stop()}}),e)})))()},processStreamingResponse:function(e,t){return(0,o.A)((0,a.A)().mark((function n(){var r,o,i,s,c,l,u,p,d,h,g,f,m,v,b,y,k,x,w,S,E,A,_;return(0,a.A)().wrap((function(n){while(1)switch(n.prev=n.next){case 0:return r=e.state,o=e.commit,i=t.prompt,s=t.updateCallback,c=t.module,l=void 0===c?"default":c,u=r.apiUrl.includes("deepseek.com"),p=To(i),_o.log("发送流式请求:",{prompt:p}),d={method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(r.apiKey),Accept:"text/event-stream"},body:JSON.stringify({model:u?"deepseek-chat":go(ho.BASIC),messages:[{role:"user",content:p}],max_tokens:1e3,stream:!0,temperature:1})},n.prev=6,o("SET_LOADING",!0),n.next=10,fetch(r.apiUrl+"chat/completions",d);case 10:if(h=n.sent,h.ok){n.next=13;break}throw new Error("HTTP error! status: ".concat(h.status));case 13:g=h.body.getReader(),f=new TextDecoder,m="",v="",b=!1;case 18:if(b){n.next=43;break}return n.next=21,g.read();case 21:if(y=n.sent,k=y.done,x=y.value,!k){n.next=26;break}return n.abrupt("break",43);case 26:m+=f.decode(x,{stream:!0}),w=m.split("\n"),S=0;case 29:if(!(S<w.length-1)){n.next=40;break}if(E=w[S],!E.startsWith("data: ")){n.next=37;break}if(A=E.slice(6),"[DONE]"!==A){n.next=36;break}return b=!0,n.abrupt("break",40);case 36:try{_=JSON.parse(A),_.choices&&_.choices[0].delta.content&&(v+=_.choices[0].delta.content,s(v))}catch(a){console.error("JSON解析错误:",a)}case 37:S++,n.next=29;break;case 40:m=w[w.length-1],n.next=18;break;case 43:return o("UPDATE_TOKEN_STATS",{module:l,type:"streaming",data:{promptLength:i.length,completionLength:v.length}}),_o.log("流式响应完成:",{result:v,lengths:{prompt:i.length,completion:v.length},estimatedTokens:{prompt:Math.ceil(i.length*r.tokenStats.ratios.prompt),completion:Math.ceil(v.length*r.tokenStats.ratios.prompt)}}),n.abrupt("return",v);case 48:throw n.prev=48,n.t0=n["catch"](6),console.error("流式请求错误:",n.t0),n.t0;case 52:return n.prev=52,o("SET_LOADING",!1),n.finish(52);case 55:case"end":return n.stop()}}),n,null,[[6,48,52,55]])})))()},callLargeLanguageModelWithSchema:function(e,t){return(0,o.A)((0,a.A)().mark((function n(){var r,o,i,c,l,u,p,d,h,g,f,m,v,b,y,k,x;return(0,a.A)().wrap((function(n){while(1)switch(n.prev=n.next){case 0:return r=e.state,o=e.commit,i=t.prompt,c=t.schema,l=t.module,u=void 0===l?"default":l,p=r.apiUrl.includes("deepseek.com"),d=To(i),h=p?"".concat(d,"\n请按照以下 JSON Schema 格式回复：\n").concat(JSON.stringify(c,null,2)):d,g=(0,s.A)((0,s.A)({model:p?"deepseek-chat":go(ho.BASIC),messages:[{role:"user",content:h}]},p?{response_format:{type:"json_object"}}:{response_format:{type:"json_schema",json_schema:{name:"moderator_response",schema:c,strict:!0}}}),{},{max_tokens:1e3,temperature:1}),_o.log("发送API请求:",{url:r.apiUrl+"chat/completions",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(r.apiKey.substring(0,8),"..."),Accept:"application/json"},body:g}),f={method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(r.apiKey),Accept:"application/json"},body:JSON.stringify(g)},n.prev=8,n.next=11,fetch(r.apiUrl+"chat/completions",f);case 11:if(m=n.sent,m.ok){n.next=18;break}return n.next=15,m.text();case 15:throw v=n.sent,_o.error("API错误响应:",{status:m.status,statusText:m.statusText,headers:Object.fromEntries(m.headers.entries()),body:v}),new Error("HTTP error! status: ".concat(m.status,", message: ").concat(v));case 18:return n.next=20,m.json();case 20:return b=n.sent,_o.log("API响应数据:",b),b.usage&&(y=i.length,k=b.choices[0].message.content.length,o("UPDATE_TOKEN_RATIOS",{promptLength:y,completionLength:k,promptTokens:b.usage.prompt_tokens,completionTokens:b.usage.completion_tokens}),o("UPDATE_TOKEN_STATS",{module:u,type:"standard",data:{promptTokens:b.usage.prompt_tokens,completionTokens:b.usage.completion_tokens}})),x=JSON.parse(b.choices[0].message.content),_o.log("API响应:",{content:x}),n.abrupt("return",x);case 28:throw n.prev=28,n.t0=n["catch"](8),_o.error("API请求错误:",n.t0),n.t0;case 32:case"end":return n.stop()}}),n,null,[[8,28]])})))()}};function No(e){var t=0,n=0;Object.values(e.tokenStats.standard).forEach((function(e){t+=e.promptTokens,n+=e.completionTokens})),Object.values(e.tokenStats.streaming).forEach((function(r){t+=Math.ceil(r.promptLength*e.tokenStats.ratios.prompt),n+=Math.ceil(r.completionLength*e.tokenStats.ratios.prompt)}));var r=t/1e6*Co.prompt,a=n/1e6*Co.completion,o=1,i=(r+a)*o;return Number(i.toFixed(2))}var Mo={isLoading:function(e){return e.isLoading},hasApiKey:function(e){return!!e.apiKey},tokenStats:function(e){return e.tokenStats},totalTokensUsed:function(e){var t=0;return Object.values(e.tokenStats.standard).forEach((function(e){t+=e.totalTokens})),Object.values(e.tokenStats.streaming).forEach((function(n){var r=Math.ceil(n.promptLength*e.tokenStats.ratios.prompt),a=Math.ceil(n.completionLength*e.tokenStats.ratios.prompt);t+=r+a})),t},totalCost:function(e){return No(e)}};const Po={namespaced:!0,state:Io,mutations:Lo,actions:Ro,getters:Mo};n(8431);var Oo="ReadingThisIsASpoilerForYourself";function Do(e,t){var n=io().AES.decrypt(e,t),r=n.toString(io().enc.Utf8);try{return JSON.parse(r)}catch(a){throw console.error("解析JSON时出错:",a.message),a}}function jo(e){return Uo.apply(this,arguments)}function Uo(){return Uo=(0,o.A)((0,a.A)().mark((function e(t){var n,r,o;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(e.prev=0,console.log("加载章节文件:",t),t.includes("/characters/")){e.next=4;break}throw new Error("无效的章节路径: 必须从角色目录加载");case 4:return n=t.startsWith("scenarios/")?t:"scenarios/".concat(t),console.log("规范化的文件路径:",n),e.next=8,k.u.loadText(n);case 8:return r=e.sent,o=Do(r,Oo),console.log("解密后的章节数据:",o),o.image&&!o.image.startsWith("scenarios/")&&(console.log("处理前的图片路径:",o.image),o.image=o.image.startsWith("/")?o.image.slice(1):o.image,console.log("处理后的图片路径:",o.image)),o.background&&!o.background.startsWith("scenarios/")&&(o.background=o.background.startsWith("/")?o.background.slice(1):o.background),e.abrupt("return",o);case 16:throw e.prev=16,e.t0=e["catch"](0),console.error("加载章节数据失败:",e.t0),e.t0;case 20:case"end":return e.stop()}}),e,null,[[0,16]])}))),Uo.apply(this,arguments)}function Go(e){return Vo.apply(this,arguments)}function Vo(){return Vo=(0,o.A)((0,a.A)().mark((function e(t){var n;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.prev=0,n="scenarios/".concat(t,"/config.json"),e.next=4,k.u.loadJSON(n);case 4:return e.abrupt("return",e.sent);case 7:throw e.prev=7,e.t0=e["catch"](0),console.error("加载场景配置失败:",e.t0),e.t0;case 11:case"end":return e.stop()}}),e,null,[[0,7]])}))),Vo.apply(this,arguments)}var Bo=new lt(!1,"sections"),Ko=function(){return{currentScenario:null,scenarioConfig:null,chapters:[],unlockedSections:[],currentSection:null,currentSectionData:null}},Fo={SET_CHAPTERS:function(e,t){e.chapters=t},SET_UNLOCKED_SECTIONS:function(e,t){e.unlockedSections=t},SET_CURRENT_SECTION:function(e,t){e.currentSection=t},SET_CURRENT_SECTION_DATA:function(e,t){e.currentSectionData=t},SET_SCENARIO_CONFIG:function(e,t){e.scenarioConfig=t},SET_CURRENT_SCENARIO:function(e,t){e.currentScenario=t},UPDATE_SECTION_IMAGE:function(e,t){var n=t.sectionId,r=t.imageUrl;e.currentSection&&e.currentSection.id===n&&(e.currentSection.image=r)}},Ho={initialize:function(e){return(0,o.A)((0,a.A)().mark((function t(){var n,r,o;return(0,a.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:n=e.commit,r=e.rootState,o=r.save.saveIndex.currentScenario||"silver_moon",n("SET_CURRENT_SCENARIO",o);case 3:case"end":return t.stop()}}),t)})))()},loadScenarioConfig:function(e){return(0,o.A)((0,a.A)().mark((function t(){var n,r,o,i,s;return(0,a.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(n=e.commit,r=e.state,o=e.dispatch,t.prev=1,r.currentScenario){t.next=5;break}return t.next=5,o("initialize");case 5:if(i=r.currentScenario,i){t.next=8;break}throw new Error("初始化失败：无法获取剧本ID");case 8:return t.next=10,Go(i);case 10:return s=t.sent,n("SET_SCENARIO_CONFIG",s),t.abrupt("return",s);case 15:throw t.prev=15,t.t0=t["catch"](1),Bo.error("加载剧本配置失败:",t.t0),t.t0;case 19:case"end":return t.stop()}}),t,null,[[1,15]])})))()},loadSectionsIndex:function(e){return(0,o.A)((0,a.A)().mark((function t(){var n,r,o,i,s,c,l,u,p,d;return(0,a.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:return n=e.commit,r=e.state,o=e.dispatch,i=e.rootState,t.prev=1,t.next=4,o("loadScenarioConfig");case 4:return l=i.gameState.selectedCharacter,u=(null===(s=r.scenarioConfig.characters.find((function(e){return e.name===l})))||void 0===s?void 0:s.id)||"robert",t.prev=6,t.next=9,k.u.loadJSON("scenarios/".concat(r.currentScenario,"/characters/").concat(u,"/sections.json"));case 9:p=t.sent,t.next=16;break;case 12:throw t.prev=12,t.t0=t["catch"](6),console.error("无法加载角色特定的章节索引:",t.t0),new Error("找不到角色 ".concat(l," 的章节索引文件"));case 16:if(p&&p.chapters){t.next=18;break}throw new Error("章节索引数据无效");case 18:return n("SET_CHAPTERS",p.chapters),d=(null===(c=r.scenarioConfig)||void 0===c?void 0:c.initialSection)||21,n("SET_UNLOCKED_SECTIONS",[d]),t.abrupt("return",p);case 24:throw t.prev=24,t.t1=t["catch"](1),console.error("加载章节索引失败:",t.t1),t.t1;case 28:case"end":return t.stop()}}),t,null,[[1,24],[6,12]])})))()},loadSection:function(e,t){return(0,o.A)((0,a.A)().mark((function n(){var r,o,i,s,c,l,u,p,d,h;return(0,a.A)().wrap((function(n){while(1)switch(n.prev=n.next){case 0:return r=e.commit,o=e.dispatch,i=e.state,s=e.rootState,c=e.rootGetters,n.prev=1,n.next=4,o("conversation/clearConversation",null,{root:!0});case 4:return n.next=6,o("gameState/resetState",null,{root:!0});case 6:return n.next=8,o("game/resetState",null,{root:!0});case 8:return u=s.gameState.selectedCharacter,p=(null===(l=i.scenarioConfig.characters.find((function(e){return e.name===u})))||void 0===l?void 0:l.id)||"robert",d="scenarios/".concat(i.currentScenario,"/characters/").concat(p,"/sections/").concat(t),n.next=13,jo(d);case 13:if(h=n.sent,h){n.next=16;break}throw new Error("章节数据加载失败: ".concat(t," 返回空数据"));case 16:if(h.startEvent){n.next=18;break}throw new Error("章节数据格式错误: ".concat(t," 缺少 startEvent 属性"));case 18:if(!h.image){n.next=22;break}return h.image=c["sections/getSectionThumbnailPath"](h.image),n.next=22,mt.preloadImage(h.image);case 22:if(!h.background){n.next=26;break}return h.background=c["sections/getSectionThumbnailPath"](h.background),n.next=26,mt.preloadImage(h.background);case 26:if(!h.initialSuggestions||!Array.isArray(h.initialSuggestions)){n.next=29;break}return n.next=29,o("conversation/setSuggestions",h.initialSuggestions,{root:!0});case 29:return r("SET_CURRENT_SECTION",h),r("SET_CURRENT_SECTION_DATA",h),n.next=33,o("game/initializeGame",null,{root:!0});case 33:return n.abrupt("return",h);case 36:throw n.prev=36,n.t0=n["catch"](1),Bo.error("加载章节失败:",n.t0),n.t0;case 40:case"end":return n.stop()}}),n,null,[[1,36]])})))()},unlockSection:function(e,t){return(0,o.A)((0,a.A)().mark((function n(){var r,o,i,s,c;return(0,a.A)().wrap((function(n){while(1)switch(n.prev=n.next){case 0:if(r=e.commit,o=e.state,i=e.dispatch,s=Number(t),!isNaN(s)){n.next=4;break}return n.abrupt("return");case 4:if(o.unlockedSections.includes(s)){n.next=12;break}return c=(0,ao.A)(new Set([].concat((0,ao.A)(o.unlockedSections),[s]))),r("SET_UNLOCKED_SECTIONS",c),n.next=9,i("save/updateSaveData",{path:"unlockedSections",value:c},{root:!0});case 9:return n.next=11,i("save/saveSave",null,{root:!0});case 11:i("checkUnlockConditions");case 12:case"end":return n.stop()}}),n)})))()},completeSection:function(e){return(0,o.A)((0,a.A)().mark((function t(){var n;return(0,a.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:return n=e.dispatch,t.next=3,n("checkUnlockConditions");case 3:case"end":return t.stop()}}),t)})))()},skipSection:function(e,t){return(0,o.A)((0,a.A)().mark((function n(){var r,o,i,s,c,l,u,p,d;return(0,a.A)().wrap((function(n){while(1)switch(n.prev=n.next){case 0:return r=e.dispatch,o=e.state,i=e.rootState,n.prev=1,c=i.gameState.selectedCharacter,l=(null===(s=o.scenarioConfig.characters.find((function(e){return e.name===c})))||void 0===s?void 0:s.id)||"robert",u="scenarios/".concat(o.currentScenario,"/characters/").concat(l,"/sections/").concat(t),n.next=7,jo(u);case 7:if(p=n.sent,p&&p.id){n.next=10;break}throw new Error("无效的章节数据");case 10:return d={objective:!0,influencePoints:[],objective_judge:"章节已跳过",summary:"章节已跳过"},n.next=13,r("save/loadSave",null,{root:!0});case 13:return n.next=15,r("save/updateSaveData",{path:"progress.sectionResults.".concat(p.id),value:d},{root:!0});case 15:return n.next=17,r("unlockSection",p.id);case 17:return n.next=19,r("checkUnlockConditions");case 19:n.next=25;break;case 21:throw n.prev=21,n.t0=n["catch"](1),Bo.error("跳过章节失败:",n.t0),n.t0;case 25:case"end":return n.stop()}}),n,null,[[1,21]])})))()},preloadSectionImages:function(e){return(0,o.A)((0,a.A)().mark((function t(){var n,r;return(0,a.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:return n=e.state,r=[],n.chapters.forEach((function(e){e.sections.forEach((function(e){e.image&&r.push(k.u.getImageUrl(e.image))}))})),t.next=5,mt.preloadBatch(r);case 5:case"end":return t.stop()}}),t)})))()},checkUnlockConditions:function(e){var t,n=e.state,r=e.dispatch,a=e.rootState;if(null!==(t=a.save)&&void 0!==t&&null!==(t=t.currentScenarioSave)&&void 0!==t&&null!==(t=t.saveData)&&void 0!==t&&t.progress){var o=a.save.currentScenarioSave.saveData.progress.sectionResults||{},i=a.save.currentScenarioSave.saveData.progress.globalInfluencePoints||[],s=n.chapters;s.forEach((function(e){e.sections.forEach((function(e){if(!n.unlockedSections.includes(e.id)&&e.preconditions&&Array.isArray(e.preconditions)){var t=e.preconditions.every((function(e){if(e.sectionId){var t=o[e.sectionId];return!(null===t||void 0===t||!t.objective)&&("objective"===e.condition?t.objective===e.result:!e.condition||t.influencePoints.some((function(t){return t.id===e.condition&&t.influence===e.result})))}if(e.global){var n=i.find((function(t){return t.id===e.condition}));return(null===n||void 0===n?void 0:n.influence)===e.result}return!1}));t&&r("unlockSection",e.id)}}))}))}},SET_UNLOCKED_SECTIONS:function(e,t){var n=e.commit;n("SET_UNLOCKED_SECTIONS",t)},SET_CURRENT_SCENARIO:function(e,t){var n=e.commit;n("SET_CURRENT_SCENARIO",t)}},zo={isSectionUnlocked:function(e){return function(t){return e.unlockedSections.includes(t)}},isSectionCompleted:function(e,t,n){return function(e){var t,r=n.save.saveData.progress.sectionResults||{};return!0===(null===(t=r[e])||void 0===t?void 0:t.objective)}},getCurrentSection:function(e){return e.currentSection},getCurrentSectionData:function(e){return e.currentSectionData},getSectionTypeText:function(){return function(e){var t=Ya.global.t;if(!e)return t("game.typeNone");var n={combat:t("game.typeCombat"),wits:t("game.typeWits"),story:t("game.typeStory"),puzzle:t("game.typePuzzle"),persuade:t("game.typePersuade"),romance:t("game.typeRomance")};return n[e]||t("game.typeNone")}},getSectionThumbnailPath:function(e,t,n){return function(t){var r;if(!t)return"default-section.jpg";var a=(null===(r=e.scenarioConfig)||void 0===r||null===(r=r.characters.find((function(e){return e.name===n.gameState.selectedCharacter})))||void 0===r?void 0:r.id)||"robert";if(t.startsWith("scenarios/"))return t;var o=t.replace(/^section_thumbnail\//,"").replace(/^\/section_thumbnail\//,"");return t.startsWith("/")?"scenarios/".concat(e.currentScenario,"/characters/").concat(a).concat(t):"scenarios/".concat(e.currentScenario,"/characters/").concat(a,"/section_thumbnail/").concat(o)}},isCharacterUnlocked:function(e,t,n){return function(e){var t,r;if(!e||e.isDefault)return!0;if(!e.unlockConditions)return!0;var a=e.unlockConditions.requiredSectionId,o=(null===(t=n.save)||void 0===t||null===(t=t.currentScenarioSave)||void 0===t||null===(t=t.saveData)||void 0===t||null===(t=t.progress)||void 0===t?void 0:t.sectionResults)||{};return!0===(null===(r=o[a])||void 0===r?void 0:r.objective)}},getCharacterUnlockDescription:function(){return function(e){return e.isDefault||!e.unlockConditions?null:e.unlockConditions.description}}};const Wo={namespaced:!0,state:Ko,mutations:Fo,actions:Ho,getters:zo};var Xo=function(){return{tooltipInfo:{show:!1,description:"",imageUrl:"",term:"",event:null}}},Jo={SET_TOOLTIP_INFO:function(e,t){e.tooltipInfo=t}},qo={showTermTooltip:function(e,t){var n=e.commit,r=t.term,a=t.event,o=x.value.terms[r];if(o){o.description&&(o.description=o.description.replace(/\n/g,"<br>"));var i=I({term:r,event:a,termConfig:o});n("SET_TOOLTIP_INFO",i)}},hideTermTooltip:function(e){var t=e.commit,n=L();t("SET_TOOLTIP_INFO",n)}};const Qo={namespaced:!0,state:Xo,mutations:Jo,actions:qo};var Yo=function(){return{isProcessing:!1,interactionStage:{stage:"",info:"",visible:!1},validationError:""}},$o={SET_PROCESSING:function(e,t){e.isProcessing=t},SET_INTERACTION_STAGE:function(e,t){var n=t.stage,r=t.info;e.interactionStage={stage:n,info:r?r.replace(/\\n/g,"\n"):"",visible:!0}},HIDE_INTERACTION_STAGE:function(e){e.interactionStage.visible=!1},SET_VALIDATION_ERROR:function(e,t){e.validationError=t},HIDE_VALIDATION_ERROR:function(e){e.validationError=""}},Zo={handleUserInput:function(e,t){return(0,o.A)((0,a.A)().mark((function n(){var r,o;return(0,a.A)().wrap((function(n){while(1)switch(n.prev=n.next){case 0:if(r=e.commit,o=e.dispatch,t.trim()){n.next=3;break}return n.abrupt("return");case 3:return r("SET_PROCESSING",!0),n.prev=4,n.next=7,o("conversation/addUserMessage",t,{root:!0});case 7:n.next=12;break;case 9:n.prev=9,n.t0=n["catch"](4),console.error("处理用户输入时出错:",n.t0);case 12:return n.prev=12,r("SET_PROCESSING",!1),n.finish(12);case 15:case"end":return n.stop()}}),n,null,[[4,9,12,15]])})))()},updateInteractionStage:function(e,t){var n=e.commit,r=t.stage,a=t.info;n("SET_INTERACTION_STAGE",{stage:r,info:a})},hideInteractionStage:function(e){var t=e.commit;t("HIDE_INTERACTION_STAGE")},showValidationError:function(e,t){var n=e.commit;n("SET_VALIDATION_ERROR",t)},hideValidationError:function(e){var t=e.commit;t("HIDE_VALIDATION_ERROR")}},ei={isProcessing:function(e){return e.isProcessing},interactionStage:function(e){return e.interactionStage},isInputDisabled:function(e){return e.isProcessing},validationError:function(e){return e.validationError}};const ti={namespaced:!0,state:Yo,mutations:$o,actions:Zo,getters:ei};var ni="beyondBooksSaveData",ri="beyondBooksSaveIndex",ai="YourExportSecretKey",oi="YourReviewKey",ii=function(e){return"".concat(ni,"_").concat(e)},si=function(){return{currentScenario:"silver_moon",scenarios:{silver_moon:{name:"不止于纸上的故事：银月篇",lastSaveTime:(new Date).toISOString(),startTime:(new Date).toISOString()}}}},ci=function(e){var t,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return{scenarioId:e,scenarioConfig:n,saveData:{currentSectionId:null,unlockedSections:[n.initialSection||21],progress:{globalInfluencePoints:[],sectionResults:{},plotTriggers:[],turnCount:0},player:{selectedCharacter:(null===(t=n.characters)||void 0===t||null===(t=t.find((function(e){return e.isDefault})))||void 0===t?void 0:t.name)||"罗伯特"},extensions:{}}}},li=function(){return{saveIndex:si(),currentScenarioSave:null,hasSave:!1}},ui={SET_SAVE_INDEX:function(e,t){e.saveIndex=t},SET_CURRENT_SCENARIO_SAVE:function(e,t){e.currentScenarioSave=t,e.hasSave=!0},UPDATE_SCENARIO_SAVE:function(e,t){for(var n=t.path,r=t.value,a=n.split("."),o=e.currentScenarioSave.saveData,i=0;i<a.length-1;i++)o=o[a[i]];o[a[a.length-1]]=r},CLEAR_CURRENT_SAVE:function(e){e.currentScenarioSave=null,e.hasSave=!1}},pi={initializeSaveIndex:function(e){return(0,o.A)((0,a.A)().mark((function t(){var n,r,o;return(0,a.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:return n=e.commit,r=localStorage.getItem(ri),o=r?JSON.parse(r):si(),n("SET_SAVE_INDEX",o),t.abrupt("return",o);case 5:case"end":return t.stop()}}),t)})))()},loadScenarioSave:function(e,t){return(0,o.A)((0,a.A)().mark((function n(){var r,o,i,s,c,l,u,p;return(0,a.A)().wrap((function(n){while(1)switch(n.prev=n.next){case 0:return r=e.commit,o=e.dispatch,i=e.state,n.prev=1,c=ii(t),l=localStorage.getItem(c),n.next=6,o("sections/SET_CURRENT_SCENARIO",t,{root:!0});case 6:return n.next=8,o("sections/loadScenarioConfig",null,{root:!0});case 8:return u=n.sent,l?(p=JSON.parse(l),p.saveData.progress||(console.warn("修复存档数据结构：添加缺失的progress对象"),p.saveData.progress={globalInfluencePoints:[],sectionResults:{},plotTriggers:[],turnCount:0})):p=ci(t,u),console.log("加载的存档数据:",p),console.log("progress对象:",p.saveData.progress),r("SET_CURRENT_SCENARIO_SAVE",p),n.next=15,Promise.all([o("sections/SET_UNLOCKED_SECTIONS",p.saveData.unlockedSections,{root:!0}),o("gameState/SET_GLOBAL_INFLUENCE_POINTS",p.saveData.progress.globalInfluencePoints,{root:!0}),o("gameState/SET_SECTION_RESULT",p.saveData.progress.sectionResults,{root:!0})]);case 15:return n.next=17,o("sections/checkUnlockConditions",null,{root:!0});case 17:if(null===(s=p.saveData.player)||void 0===s||!s.selectedCharacter){n.next=20;break}return n.next=20,o("gameState/SET_SELECTED_CHARACTER",p.saveData.player.selectedCharacter,{root:!0});case 20:if(!p.saveData.timelineInfluences){n.next=23;break}return n.next=23,o("timelineInfluence/loadInfluencesFromSave",p.saveData.timelineInfluences,{root:!0});case 23:return n.next=25,o("timelineInfluence/loadTimelineData",null,{root:!0});case 25:return n.abrupt("return",p);case 28:throw n.prev=28,n.t0=n["catch"](1),console.error("加载剧本存档失败:",n.t0,"存档数据结构:",i.currentScenarioSave),n.t0;case 32:case"end":return n.stop()}}),n,null,[[1,28]])})))()},saveCurrentScenario:function(e){return(0,o.A)((0,a.A)().mark((function t(){var n,r,o,i,c;return(0,a.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(n=e.commit,r=e.state,t.prev=1,r.currentScenarioSave){t.next=4;break}return t.abrupt("return");case 4:return o=r.currentScenarioSave.scenarioId,i=ii(o),c=(0,s.A)((0,s.A)({},r.saveIndex),{},{currentScenario:o,scenarios:(0,s.A)((0,s.A)({},r.saveIndex.scenarios),{},(0,La.A)({},o,(0,s.A)((0,s.A)({},r.saveIndex.scenarios[o]),{},{lastSaveTime:(new Date).toISOString()})))}),localStorage.setItem(ri,JSON.stringify(c)),localStorage.setItem(i,JSON.stringify(r.currentScenarioSave)),n("SET_SAVE_INDEX",c),t.abrupt("return",r.currentScenarioSave);case 13:throw t.prev=13,t.t0=t["catch"](1),console.error("保存剧本失败:",t.t0),t.t0;case 17:case"end":return t.stop()}}),t,null,[[1,13]])})))()},exportSave:function(e){return(0,o.A)((0,a.A)().mark((function t(){var n,r,o,i,s,c,l,u,p,d,h;return(0,a.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(n=e.state,r=n.currentScenarioSave,r){t.next=4;break}return t.abrupt("return");case 4:o=JSON.stringify({scenarioId:r.scenarioId,saveData:r.saveData}),i=localStorage.getItem(oi)||"{}",s=JSON.stringify({gameData:io().AES.encrypt(o,ai).toString(),reviewData:io().AES.encrypt(i,ai).toString()}),c=new Blob([s],{type:"application/octet-stream"}),l=URL.createObjectURL(c),u=new Date,p=u.toISOString().replace(/[:.]/g,"-").slice(0,19),d="BeyondBooks存档_".concat(r.scenarioId,"_").concat(p,".savegame"),h=document.createElement("a"),h.href=l,h.download=d,h.click(),URL.revokeObjectURL(l);case 17:case"end":return t.stop()}}),t)})))()},loadSave:function(e){return(0,o.A)((0,a.A)().mark((function t(){var n,r,o;return(0,a.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(n=e.dispatch,r=e.state,r.saveIndex.scenarios){t.next=4;break}return t.next=4,n("initializeSaveIndex");case 4:return o=r.saveIndex.currentScenario,t.abrupt("return",n("loadScenarioSave",o));case 6:case"end":return t.stop()}}),t)})))()},saveSave:function(e){return(0,o.A)((0,a.A)().mark((function t(){var n;return(0,a.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:return n=e.dispatch,t.abrupt("return",n("saveCurrentScenario"));case 2:case"end":return t.stop()}}),t)})))()},updateSaveData:function(e,t){return(0,o.A)((0,a.A)().mark((function n(){var r,o,i,s,c,l,u,p,d,h;return(0,a.A)().wrap((function(n){while(1)switch(n.prev=n.next){case 0:if(i=e.commit,s=e.dispatch,c=e.state,l=t.path,u=t.value,console.log("更新存档数据:",{path:l,value:u}),console.log("当前存档状态:",null===(r=c.currentScenarioSave)||void 0===r?void 0:r.saveData),c.currentScenarioSave){n.next=8;break}return console.warn("存档未初始化，尝试加载存档"),n.next=8,s("loadSave");case 8:for(null!==(o=c.currentScenarioSave)&&void 0!==o&&null!==(o=o.saveData)&&void 0!==o&&o.progress||(console.warn("修复存档数据结构"),c.currentScenarioSave.saveData||(c.currentScenarioSave.saveData={}),c.currentScenarioSave.saveData.progress={globalInfluencePoints:[],sectionResults:{},plotTriggers:[],turnCount:0}),p=l.split("."),d=c.currentScenarioSave.saveData,"progress"!==p[0]||d.progress||(d.progress={globalInfluencePoints:[],sectionResults:{},plotTriggers:[],turnCount:0}),h=0;h<p.length-1;h++)d[p[h]]||("sectionResults"===p[h]?d[p[h]]={}:["globalInfluencePoints","plotTriggers"].includes(p[h])?d[p[h]]=[]:d[p[h]]={}),d=d[p[h]];return i("UPDATE_SCENARIO_SAVE",{path:l,value:u}),n.abrupt("return",s("saveCurrentScenario"));case 15:case"end":return n.stop()}}),n)})))()},clearSave:function(e){var t,n=e.commit,r=e.state,a=null===(t=r.currentScenarioSave)||void 0===t?void 0:t.scenarioId;a&&localStorage.removeItem(ii(a)),n("CLEAR_CURRENT_SAVE")},importSave:function(e,t){return(0,o.A)((0,a.A)().mark((function n(){var r,i,c;return(0,a.A)().wrap((function(n){while(1)switch(n.prev=n.next){case 0:return r=e.commit,i=e.dispatch,c=e.state,n.abrupt("return",new Promise((function(e,n){var l=new FileReader;l.onload=function(){var t=(0,o.A)((0,a.A)().mark((function t(o){var l,u,p,d,h,g,f,m,v;return(0,a.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(t.prev=0,l=JSON.parse(o.target.result),u=io().AES.decrypt(l.gameData,ai).toString(io().enc.Utf8),p=JSON.parse(u),d=JSON.parse(io().AES.decrypt(l.reviewData,ai).toString(io().enc.Utf8)),h=p.scenarioId,g=p.saveData,h){t.next=8;break}throw new Error("存档文件缺少剧本ID");case 8:return t.next=10,i("sections/loadScenarioConfig",h,{root:!0});case 10:return f=t.sent,m={scenarioId:h,scenarioConfig:f,saveData:g},localStorage.setItem(ii(h),JSON.stringify(m)),v=(0,s.A)((0,s.A)({},c.saveIndex),{},{currentScenario:h,scenarios:(0,s.A)((0,s.A)({},c.saveIndex.scenarios),{},(0,La.A)({},h,{name:f.name||h,lastSaveTime:(new Date).toISOString(),startTime:(new Date).toISOString()}))}),localStorage.setItem(ri,JSON.stringify(v)),localStorage.setItem(oi,JSON.stringify(d)),r("SET_SAVE_INDEX",v),r("SET_CURRENT_SCENARIO_SAVE",m),t.next=20,i("sections/checkUnlockConditions",null,{root:!0});case 20:e(),t.next=26;break;case 23:t.prev=23,t.t0=t["catch"](0),n(new Error("入失败，密钥不匹配或数据损坏"));case 26:case"end":return t.stop()}}),t,null,[[0,23]])})));return function(e){return t.apply(this,arguments)}}(),l.onerror=function(){return n(new Error("读取文件失败"))},l.readAsText(t)})));case 2:case"end":return n.stop()}}),n)})))()},setCurrentScenario:function(e,t){return(0,o.A)((0,a.A)().mark((function n(){var r,o,i;return(0,a.A)().wrap((function(n){while(1)switch(n.prev=n.next){case 0:return r=e.commit,o=e.dispatch,i=(0,s.A)((0,s.A)({},li.saveIndex),{},{currentScenario:t}),localStorage.setItem(ri,JSON.stringify(i)),r("SET_SAVE_INDEX",i),n.next=6,o("sections/SET_CURRENT_SCENARIO",t,{root:!0});case 6:case"end":return n.stop()}}),n)})))()}},di={getSaveData:function(e){var t;return(null===(t=e.currentScenarioSave)||void 0===t?void 0:t.saveData)||ci().saveData},hasSave:function(e){return e.hasSave},getCurrentScenarioSave:function(e){return e.currentScenarioSave},getSaveIndex:function(e){return e.saveIndex},getCurrentGameInfo:function(e){var t,n;return e.currentScenarioSave?{scenarioName:null===(t=e.currentScenarioSave.scenarioConfig)||void 0===t?void 0:t.name,characterName:null===(n=e.currentScenarioSave.saveData)||void 0===n||null===(n=n.player)||void 0===n?void 0:n.selectedCharacter,scenarioId:e.currentScenarioSave.scenarioId}:null}};const hi={namespaced:!0,state:li,mutations:ui,actions:pi,getters:di};n(8980);var gi=function(){return{reviewRecords:[]}},fi={SET_REVIEW_RECORDS:function(e,t){e.reviewRecords=t},ADD_REVIEW_RECORD:function(e,t){e.reviewRecords.push(t)},DELETE_REVIEW_RECORD:function(e,t){e.reviewRecords=e.reviewRecords.filter((function(e){return e.id!==t}))},UPDATE_REVIEW_RECORD:function(e,t){var n=e.reviewRecords.findIndex((function(e){return e.id===t.id}));-1!==n&&e.reviewRecords.splice(n,1,t)}},mi={loadReviewRecords:function(e){var t=e.commit,n=localStorage.getItem("reviewRecords"),r=n?JSON.parse(n):[];t("SET_REVIEW_RECORDS",r)},saveReviewRecord:function(e,t){var n=e.commit,r=e.state;n("ADD_REVIEW_RECORD",t),localStorage.setItem("reviewRecords",JSON.stringify(r.reviewRecords))},deleteReviewRecord:function(e,t){var n=e.commit,r=e.state;n("DELETE_REVIEW_RECORD",t),localStorage.setItem("reviewRecords",JSON.stringify(r.reviewRecords))},updateReviewRecord:function(e,t){var n=e.commit,r=e.state;n("UPDATE_REVIEW_RECORD",t),localStorage.setItem("reviewRecords",JSON.stringify(r.reviewRecords))}},vi={getReviewRecords:function(e){return e.reviewRecords}};const bi={namespaced:!0,state:gi,mutations:fi,actions:mi,getters:vi};var yi=function(){return{currentView:"menu"}},ki={SET_CURRENT_VIEW:function(e,t){e.currentView=t}},xi={initializeUI:function(e){var t=e.commit;t("SET_CURRENT_VIEW","menu")},showSettings:function(e){var t=e.commit;t("SET_CURRENT_VIEW","settings")},hideSettings:function(e){var t=e.commit;t("SET_CURRENT_VIEW","menu")}};const wi={namespaced:!0,state:yi,mutations:ki,actions:xi};var Si=function(){function e(t,n,r,a,o,i){(0,ot.A)(this,e),this.name=t.name,this.description=t.description,this.personality=t.personality,this.goals=t.goals,this.sectionGuidance=a,this.debugMode=!1,this.commonKnowledge=n,this.startEvent=r,this.privateMemory=[],this.maxPrivateMemoryLength=5,this.logger=new lt(this.debugMode,"角色 ".concat(this.name)),this.characterTags=this.loadCharacterTag(t.characterTags,o),this.gameManager=i}return(0,it.A)(e,[{key:"log",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;this.logger&&this.logger.log(e,t)}},{key:"loadCharacterTag",value:function(e,t){return e&&t?(this.log("加载角色标签",{tagKeys:e,globalCharacterTagBase:t}),e.reduce((function(e,n){return t[n]?e[n]=t[n]:console.warn("标签键未找到: ".concat(n)),e}),{})):{}}},{key:"createPrompt",value:function(e){var t,n,r=this,a=Hi.state.conversation.optimizedConversationHistory.map((function(e){return"".concat(e.role,": ").concat(e.content)})).join("\n"),o=this.privateMemory.map((function(e){return"想法: ".concat(e)})).join("\n"),i=Object.entries(this.characterTags).map((function(e){var t=(0,Ia.A)(e,2),n=t[0],r=t[1];return"".concat(n,"：").concat(r)})).join("\n"),s=null!==(t=this.gameManager)&&void 0!==t&&null!==(t=t.battleEnvironmentManager)&&void 0!==t&&t.enabled?this.gameManager.battleEnvironmentManager.getSimpleCurrentEnvironmentDescription():null,c=this.gameManager.moderator.valueManager.isCharacterEnabled(this.name)?this.gameManager.moderator.valueManager.getValueStatus(this.name):null,l=(null===(n=this.gameManager)||void 0===n||null===(n=n.turnManager)||void 0===n?void 0:n.currentTurn)||1,u=Hi.state.gameState.influenceNotes||[],p=u.filter((function(e){var t=(Hi.state.timelineInfluence.globalInfluences||[]).find((function(t){return t.influenceNotes&&t.influenceNotes.includes(e)}));if(!t||!t.visibility)return!0;switch(t.visibility.level){case"public":return!0;case"group":return r.characterTags&&r.characterTags.some((function(e){return t.visibility.knownBy.includes(e)}));case"personal":return t.visibility.knownBy.includes(r.name);case"hidden":return!1;default:return!1}})),d="你是".concat(this.name,"。").concat(this.description,"。\n性格：").concat(this.personality,"\n").concat(i,"\n目标：").concat(this.goals.join(", "),"\n公共信息：").concat(this.commonKnowledge,"\n桥段指导：").concat(this.sectionGuidance,"\n\n当前是第").concat(l,"回合\n\n").concat(s?"当前环境：\n".concat(s,"\n"):"","\n\n").concat(p.length>0?"更多背景信息：\n".concat(p.join("\n"),"\n"):"","\n\n目前已经发生的事情：\n").concat(a,"\n\n你最近的私人想法：\n").concat(o,"\n").concat(c?"你的当前状态：".concat(c.text,"\n"):"","\n\n再次强调你的角色是").concat(this.name,"。\n\n请用JSON格式回复，包括以下字段：\n1. activeAbilities：明确当前有什么异能正在发动过程中。分析并给出原因。\n2. checkCanAct：解释并判断你能否行动。注意这是'能否行动'，而不是'要不要行动'。\n3. canAct：布尔值，表示是否能够行动。\n4. thoughts：数组，包含你的思考过程。每个思考步骤应包含思考阶段和内容。思考过程：\n   a. 分析当前情况：目前已经发生了什么，仔细考虑你当前的状态，你在哪，你在做什么，别人在对你做什么。\n   b. 回顾个人目标：思考你的角色目标，以及制订计划，一个积极一个撤退。\n   c. 我上一句话是什么：你上一次的动作和说的话是什么。\n   d. 考虑可能的行动：列出几个可能的行动方案，包括可能推动剧情发展的合理的行动。\n   e. 随机选择一个：随机选择一个行动，避免进入对峙。哪怕是满足敌人的目标也行。\n5. action：你的最终行动和说的话。\n\n当前情况：\n").concat(e);return this.log("生成提示词",{optimizedHistory:a,recentPrivateMemory:o,characterTagText:i,situation:e,influenceNotes:p,fullPrompt:d}),d}},{key:"updateMemory",value:function(e,t){var n,r=null!==(n=t.thoughts)&&void 0!==n&&n.length?t.thoughts.filter((function(e,t){return 1===t})).map((function(e){return"".concat(e.step,": ").concat(e.content)})).join("; "):"";this.privateMemory.push(r),this.privateMemory.length>this.maxPrivateMemoryLength&&this.privateMemory.shift(),this.log("更新私有记忆",{situation:e,response:t,summarizedThoughts:r,currentPrivateMemory:this.privateMemory,memoryLength:this.privateMemory.length})}},{key:"addPrivateThought",value:function(e){this.privateMemory.push(e),this.privateMemory.length>this.maxPrivateMemoryLength&&this.privateMemory.shift(),this.log("添加私人想法",{thought:e,currentPrivateMemory:this.privateMemory,memoryLength:this.privateMemory.length})}},{key:"getResponse",value:function(){var e=(0,o.A)((0,a.A)().mark((function e(t){var n,r,o,i;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return n={type:"object",properties:{activeAbilities:{type:"string"},checkCanAct:{type:"string"},canAct:{type:"boolean"},thoughts:{type:"array",items:{type:"object",properties:{step:{type:"string"},content:{type:"string"}},required:["step","content"],additionalProperties:!1}},action:{type:"string"}},required:["activeAbilities","checkCanAct","canAct","thoughts","action"],additionalProperties:!1},this.log("准备获取AI响应",{action:t,schema:n}),r=this.createPrompt(t),e.prev=3,e.next=6,Hi.dispatch("api/callLargeLanguageModelWithSchema",{prompt:r,schema:n,module:"aiPlayer"});case 6:return o=e.sent,this.log("AI 响应",{parsedResponse:o}),!1===o.canAct&&(o.action=o.checkCanAct,o.thoughts=[{step:"无法思考",content:"来不及思考"}],this.log("AI无法行动",o)),this.updateMemory(t,o),i={action:o.action},this.log("AI 最终动作",i),e.abrupt("return",i);case 15:throw e.prev=15,e.t0=e["catch"](3),this.logger.error("Error in AI response:",e.t0),e.t0;case 19:case"end":return e.stop()}}),e,this,[[3,15]])})));function t(t){return e.apply(this,arguments)}return t}()}])}(),Ei=function(){function e(){(0,ot.A)(this,e),this.decoder=new TextDecoder("utf-8"),this.buffer=""}return(0,it.A)(e,[{key:"handleStream",value:function(){var e=(0,o.A)((0,a.A)().mark((function e(t,n){var r,o,i,s,c,l,u,p,d,h,g;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:r=t.body.getReader(),o="",i=!0;case 3:if(!i){e.next=28;break}return e.next=6,r.read();case 6:if(s=e.sent,c=s.done,l=s.value,!c){e.next=11;break}return e.abrupt("break",28);case 11:this.buffer+=this.decoder.decode(l,{stream:!0}),u=this.buffer.split("\n"),p=0;case 14:if(!(p<u.length-1)){e.next=25;break}if(d=u[p],!d.startsWith("data: ")){e.next=22;break}if(h=d.slice(6),"[DONE]"!==h){e.next=21;break}return i=!1,e.abrupt("break",25);case 21:try{g=JSON.parse(h),g.choices&&g.choices[0].delta.content&&(o+=g.choices[0].delta.content,n(o))}catch(a){console.error("JSON解析错误:",a)}case 22:p++,e.next=14;break;case 25:this.buffer=u[u.length-1],e.next=3;break;case 28:return e.abrupt("return",o);case 29:case"end":return e.stop()}}),e,this)})));function t(t,n){return e.apply(this,arguments)}return t}()},{key:"fetchStream",value:function(){var e=(0,o.A)((0,a.A)().mark((function e(t,n,r){var o;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,fetch(t,(0,s.A)((0,s.A)({},n),{},{headers:(0,s.A)((0,s.A)({},n.headers),{},{Accept:"text/event-stream"})}));case 3:if(o=e.sent,o.ok){e.next=6;break}throw new Error("HTTP error! status: ".concat(o.status));case 6:return e.next=8,this.handleStream(o,r);case 8:return e.abrupt("return",e.sent);case 11:throw e.prev=11,e.t0=e["catch"](0),console.error("流式请求错误:",e.t0),e.t0;case 15:case"end":return e.stop()}}),e,this,[[0,11]])})));function t(t,n,r){return e.apply(this,arguments)}return t}()}])}(),Ai=function(){function e(){(0,ot.A)(this,e),this.baseUrl="https://image.pollinations.ai"}return(0,it.A)(e,[{key:"generateImageUrl",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:512,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:512,r=Math.floor(1e9*Math.random())+1,a="".concat(this.baseUrl,"/prompt/").concat(encodeURIComponent(e),"?width=").concat(t,"&height=").concat(n,"&seed=").concat(r,"&nologo=true&model=flux");return console.log("生成图片 - ".concat((new Date).toLocaleString()),{prompt:e,width:t,height:n,seed:r,url:a}),a}}])}(),_i=(0,it.A)((function e(t){var n=t.imageUrl,r=t.imagePrompt,a=t.imageNote,o=t.textEffects,i=t.displayMode,s=void 0===i?"temporary":i,c=t.displayDuration,l=void 0===c?3e3:c;(0,ot.A)(this,e),this.imageUrl=n,this.imagePrompt=r,this.imageNote=a,this.textEffects=o,this.displayMode=s,this.displayDuration=l,o&&o.length>0&&(this.leftCharacter={name:o[0].characterChineseName},o.length>1&&(this.rightCharacter={name:o[1].characterChineseName}))})),Ci=function(){function e(){(0,ot.A)(this,e),this.imageGenerator=new Ai,this.logger=new lt(!0,"CGGenerator"),this.STYLE_PREFIX="anime style, masterpiece, ",this.SPECIAL_EFFECT={zh:{effect:"灵能裂纹体现身体皮肤、衣服上有的发淡蓝光的冰层裂纹",keywords:["灵能盾","异能盾","灵能防护","异能防护"]},en:{effect:"psychic cracks manifesting as light blue glowing ice cracks on body skin and clothes",keywords:["灵能盾","异能盾","灵能防护","异能防护"]}},this.SCENE_LABELS={zh:{characterCount:"人物数量",relationship:"人物关系",positions:"位置和动作",background:"背景是",atmosphere:"氛围"},en:{characterCount:"character count",relationship:"character relationship",positions:"positions and actions",background:"background",atmosphere:"atmosphere"}},this.WIDTH=1280,this.HEIGHT=768,this.charactersConfig={characters:{}},this.loadCharactersConfig(),this.language="en",this.CG_DESCRIPTION_SCHEMA={type:"object",properties:{imageDescription:{type:"object",properties:{characterCount:{type:"number"},relationship:{type:"string"},characterPositions:{type:"object",properties:{positions:{type:"string"},distance:{type:"string"},actions:{type:"string"}},required:["positions","distance","actions"],additionalProperties:!1},atmosphere:{type:"string"},dramaticMoment:{type:"string"}},required:["characterCount","relationship","characterPositions","atmosphere","dramaticMoment"],additionalProperties:!1},textEffects:{type:"array",items:{type:"object",properties:{characterChineseName:{type:"string"},effects:{type:"string"}},required:["characterChineseName","effects"],additionalProperties:!1}}},required:["imageDescription","textEffects"],additionalProperties:!1}}return(0,it.A)(e,[{key:"loadCharactersConfig",value:function(){var e=(0,o.A)((0,a.A)().mark((function e(){var t;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,k.u.loadJSON("config/characterAppearance.json");case 3:t=e.sent,this.charactersConfig=t,this.logger.log("角色配置加载成功:",this.charactersConfig),e.next=12;break;case 8:e.prev=8,e.t0=e["catch"](0),this.logger.error("加载角色配置文件时出错:",e.t0),this.charactersConfig={characters:{}};case 12:case"end":return e.stop()}}),e,this,[[0,8]])})));function t(){return e.apply(this,arguments)}return t}()},{key:"generateCGDescription",value:function(){var e=(0,o.A)((0,a.A)().mark((function e(t){var n,r;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return n="en"===this.language?"Please analyze the following story segment and capture the most dramatic moment to generate a scene description:\n\n".concat(t,"\n\nPlease describe in the following format:\n1. Image Description:\n   - Number of characters in the scene (maximum 2 people, as our image generation tool can only accurately draw two people's appearances, please focus on the most dramatic moment)\n   - Character relationship (brief description: e.g. friends/enemies/strangers)\n   - Character position information:\n     * Position relative to the frame (left/right/center/front/back)\n     * Distance from frame (foreground/middle ground/background)\n     * Specific action description (don't describe who they're facing, only relationship to frame)\n   - Scene atmosphere\n   - Detailed description of the dramatic moment\n\n2. Generate text effects for each character:\n   - Use emojis and onomatopoeia, just a few concise words\n   - Reflect current state and emotions\n\nPlease ensure the description has strong visual impact, focusing on the most dramatic moment."):"请分析以下故事片段，捕捉最精彩、最戏剧性的瞬间，生成场景描述：\n\n".concat(t,"\n\n请按照以下格式描述：\n1. 图片描述：\n   - 场景中的人物数量（最多2人，因为我们的生成图片的工具只能画准确两个人的外观，请你聚焦于最精彩的一刻。）\n   - 人物关系（简单描述：如朋友/敌对/陌生人）\n   - 人物位置信息：\n     * 相对于画面的位置（左/右/中/前/后）\n     * 与画面的距离（前景/中景/远景）\n     * 具体动作描写（不要描述朝向谁，只描述与画面的关系）\n   - 场景氛围\n   - 戏剧性时刻的详细描写\n\n2. 为每个人物生成文本特效：\n   - 使用emoji和拟音词，精简的几个字就好\n   - 反映当前状态和情绪\n\n请确保描述具有强烈的视觉冲击力，专注于最精彩的瞬间。"),e.prev=1,e.next=4,this.callLargeLanguageModel(n,this.CG_DESCRIPTION_SCHEMA);case 4:return r=e.sent,e.abrupt("return",r);case 8:throw e.prev=8,e.t0=e["catch"](1),this.logger.error("生成CG描述失败",e.t0),e.t0;case 12:case"end":return e.stop()}}),e,this,[[1,8]])})));function t(t){return e.apply(this,arguments)}return t}()},{key:"generateCG",value:function(){var e=(0,o.A)((0,a.A)().mark((function e(t,n){var r,o,i,s,c,l,u,p,d,h,g=this;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return this.logger.log("en"===this.language?"Starting CG generation...":"开始生成CG..."),e.prev=1,e.next=4,this.generateCGDescription(t);case 4:return r=e.sent,o=(r.textEffects||[]).map((function(e){var t=g.charactersConfig.characters[e.characterChineseName];if(!t)return null;var n="en"===g.language?t.englishPrompt:t.chinesePrompt;return n?"en"===g.language?"".concat(e.characterChineseName,"'s appearance: ").concat(n,"."):"".concat(e.characterChineseName,"的外观是").concat(n,"。"):null})).filter((function(e){return e})).join("en"===this.language?", ":"，"),i=this.SCENE_LABELS[this.language],s=["".concat(i.characterCount,": ").concat(r.imageDescription.characterCount),"".concat(i.relationship,": ").concat(r.imageDescription.relationship),"".concat(i.positions,": ").concat(r.imageDescription.characterPositions.positions),r.imageDescription.characterPositions.distance,r.imageDescription.characterPositions.actions,"".concat(i.atmosphere,": ").concat(r.imageDescription.atmosphere)].join(", "),c=this.SPECIAL_EFFECT[this.language],l=c.keywords.some((function(e){return t.includes(e)})),u=l?", ".concat(c.effect):"",p="".concat(this.STYLE_PREFIX).concat(s,", ").concat(i.background," ").concat(n,", ")+"".concat(r.imageDescription.dramaticMoment).concat(u,", ").concat(o),d=this.imageGenerator.generateImageUrl(p,this.WIDTH,this.HEIGHT),h=new _i({imageUrl:d,imagePrompt:p,imageNote:r.imageDescription.atmosphere,textEffects:r.textEffects||[],displayMode:"background"}),this.logger.log("en"===this.language?"CG generation completed: ".concat(d):"CG生成完成: ".concat(d)),this.logger.log("en"===this.language?"Preparing to return displayInfo:":"准备返回displayInfo:",h),e.abrupt("return",h);case 19:throw e.prev=19,e.t0=e["catch"](1),this.logger.error("en"===this.language?"CG generation failed":"CG生成失败",e.t0),e.t0;case 23:case"end":return e.stop()}}),e,this,[[1,19]])})));function t(t,n){return e.apply(this,arguments)}return t}()},{key:"callLargeLanguageModel",value:function(){var e=(0,o.A)((0,a.A)().mark((function e(t,n){return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Hi.dispatch("api/callLargeLanguageModelWithSchema",{prompt:t,schema:n,module:"cgGenerator"});case 3:return e.abrupt("return",e.sent);case 6:throw e.prev=6,e.t0=e["catch"](0),console.error("API调用失败:",e.t0),e.t0;case 10:case"end":return e.stop()}}),e,null,[[0,6]])})));function t(t,n){return e.apply(this,arguments)}return t}()},{key:"setLanguage",value:function(e){this.language="en"===e?"en":"zh"}}])}(),Ti=function(){function e(t,n){(0,ot.A)(this,e),this.moderator=t,this.gameManager=n,this.currentTurn=0,this.mainActor=null,this.logger=new lt(!0,"TurnManager"),this.recentMainActors=[],this.maxHistoryLength=5,this.cgGenerator=new Ci}return(0,it.A)(e,[{key:"startNewTurn",value:function(){var e=(0,o.A)((0,a.A)().mark((function e(){var t,n,r,o,i,s,c,l,u,p,d,h,g,f,m=this;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return this.currentTurn++,this.logger.log("开始第 ".concat(this.currentTurn," 回合")),e.next=4,this.gameManager.updateAvailableCharacters();case 4:return e.next=6,this.determineMainActor();case 6:return this.mainActor=e.sent,this.logger.log("主行动者: ".concat(this.mainActor)),this.logger.log("开始收集行动"),e.next=11,this.collectActions();case 11:return i=e.sent,s=[{character:this.mainActor,action:i.mainAction}].concat((0,ao.A)(Object.entries(i.reactions).map((function(e){var t=(0,Ia.A)(e,2),n=t[0],r=t[1];return{character:n,action:r.action}})))),this.logger.log("收集到的行动:",s),e.next=16,Hi.dispatch("interaction/updateInteractionStage",{stage:"总结",info:"那么究竟是..."});case 16:if(c=null,null===(t=this.gameManager.battleEnvironmentManager)||void 0===t||!t.enabled){e.next=21;break}return e.next=20,this.gameManager.battleEnvironmentManager.analyzeActionEnvironmentEffects(s);case 20:c=e.sent;case 21:return this.logger.log("主持人总结中..."),e.next=24,this.moderator.summarizeActions(s,this.gameManager.plotTriggers,this.currentTurn,c);case 24:if(l=e.sent,this.logger.log("主持人总结:",l),u=null,null===(n=this.gameManager.battleEnvironmentManager)||void 0===n||!n.enabled){e.next=31;break}return e.next=30,this.gameManager.battleEnvironmentManager.updateEnvironmentState(l);case 30:u=e.sent;case 31:return p=this.gameManager.updateTriggeredPlots(l.triggerChecks),this.logger.log("准备输出..."),e.next=35,this.moderator.prepareForOutput(l,p,u);case 35:return d=e.sent,this.logger.log("准备输出完成:",d),e.next=39,Hi.dispatch("interaction/updateInteractionStage",{stage:"叙述",info:"所以说..."});case 39:return this.logger.log("生成回合叙述..."),e.next=42,this.moderator.generateFinalResult(d,p);case 42:if(h=e.sent,this.logger.log("回合叙述完成"),this.generateCGIfPossible(h),null===(r=this.gameManager.battleEnvironmentManager)||void 0===r||!r.enabled){e.next=48;break}return e.next=48,this.gameManager.battleEnvironmentManager.updateEnvironmentFromNarrationOverwrite(h);case 48:if(null===(o=this.gameManager.battleEnvironmentManager)||void 0===o||!o.enabled){e.next=53;break}if(g=this.gameManager.battleEnvironmentManager.getCurrentEnvironmentDescription(),!g){e.next=53;break}return e.next=53,Hi.dispatch("conversation/startNewMessage",{role:"info",initialContent:g});case 53:if(d.criticalHealthFlag&&(l.endReasons.push({condition:"玩家生命值危急",according:"玩家失去意识，无法继续战斗",isMet:!0}),l.endSectionFlag=!0),!l.endSectionFlag){e.next=58;break}return e.next=57,Hi.dispatch("interaction/hideInteractionStage");case 57:return e.abrupt("return",{summary:l,narration:h,triggeredPlots:this.gameManager.updateTriggeredPlots(l.triggerChecks),endSectionFlag:!0});case 58:return e.next=60,Hi.dispatch("interaction/updateInteractionStage",{stage:"决定下一步",info:"接下来，谁该行动呢..."});case 60:return e.next=62,this.determineNextMainActor(l,h);case 62:return f=e.sent,this.logger.log("下一回合主行动者: ".concat(f)),e.next=66,Hi.dispatch("interaction/hideInteractionStage");case 66:return e.next=68,Hi.dispatch("conversation/checkAndTriggerCompression");case 68:return this.moderator.generateSuggestions(h).then((function(e){return m.logger.log("收到行动建议:",e),Hi.dispatch("conversation/setSuggestions",e.suggestions)}))["catch"]((function(e){m.logger.error("获取建议时出错:",e)})),e.abrupt("return",{summary:l,narration:h,nextMainActor:f,triggeredPlots:this.gameManager.updateTriggeredPlots(l.triggerChecks),endSectionFlag:!1});case 70:case"end":return e.stop()}}),e,this)})));function t(){return e.apply(this,arguments)}return t}()},{key:"collectActions",value:function(){var e=(0,o.A)((0,a.A)().mark((function e(){var t,n,r,o,i,s,c,l,u=this;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return t={mainAction:"",reactions:{}},this.logger.log("收集主行动者 ".concat(this.mainActor," 的行动")),e.next=4,this.collectActionFromCharacter(this.mainActor);case 4:return n=e.sent,t.mainAction=n.action,this.logger.log("收集到主行动: ".concat(this.mainActor," => ").concat(t.mainAction)),e.next=9,Hi.dispatch("interaction/updateInteractionStage",{stage:"收集反应",info:"让我们看看其他人的反应..."});case 9:if(r=Hi.state.gameState.availableCharacters.filter((function(e){return e.name!==u.mainActor})),this.logger.log("开始收集其他角色反应:",r.map((function(e){return e.name})).join(", ")),o=Hi.state.game.selectedCharacter,o===this.mainActor){e.next=18;break}return e.next=15,this.collectActionFromCharacter(o,t.mainAction);case 15:i=e.sent,t.reactions[o]={action:i.action,character:o},this.logger.log("收集到玩家反应: ".concat(o," => ").concat(i.action));case 18:return s=r.filter((function(e){return e.name!==o})),c=s.map((function(e){return u.collectActionFromCharacter(e.name,t.mainAction).then((function(t){return{name:e.name,response:t}}))})),e.next=22,Promise.all(c);case 22:return l=e.sent,l.forEach((function(e){var n=e.name,r=e.response;t.reactions[n]={action:r.action,character:n},u.logger.log("收集到反应: ".concat(n," => ").concat(r.action))})),this.logger.log("本回合所有行动:",{mainActor:"".concat(this.mainActor,": ").concat(t.mainAction),reactions:Object.entries(t.reactions).map((function(e){var t=(0,Ia.A)(e,2),n=t[0],r=t[1];return"".concat(n,": ").concat(r.action)}))}),e.abrupt("return",t);case 26:case"end":return e.stop()}}),e,this)})));function t(){return e.apply(this,arguments)}return t}()},{key:"collectActionFromCharacter",value:function(){var e=(0,o.A)((0,a.A)().mark((function e(t){var n,r,o,i,s,c,l,u,p=arguments;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(n=p.length>1&&void 0!==p[1]?p[1]:"",r=t===Hi.state.game.selectedCharacter,!r){e.next=37;break}o=null;case 4:if(o){e.next=34;break}return i=n?"轮到你行动了，".concat(t,"！\n\n").concat(this.mainActor,"已行动：").concat(n):"轮到你行动了，".concat(t,"！"),e.next=8,Hi.dispatch("interaction/updateInteractionStage",{stage:"等待玩家",info:i});case 8:return this.logger.log("等待玩家 ".concat(t," 输入...")),e.next=11,this.waitForPlayerInput();case 11:return s=e.sent,this.logger.log("收到玩家输入:",s),e.next=15,Hi.dispatch("interaction/updateInteractionStage",{stage:"验证行动",info:"让我想想，这样做可行吗..."});case 15:return e.next=17,this.moderator.validateAction(s);case 17:if(c=e.sent,!c.isValid){e.next=27;break}return o=c.specificAction,this.logger.log("玩家行动验证通过:",o),e.next=23,Hi.dispatch("conversation/startNewMessage",{role:"attempt",initialContent:"尝试：".concat(c.specificAction)});case 23:return e.next=25,Hi.dispatch("conversation/setSuggestions",[]);case 25:e.next=32;break;case 27:return this.logger.log("玩家行动验证失败:",c.reason),e.next=30,Hi.dispatch("interaction/updateInteractionStage",{stage:"行动无效",info:"这样做似乎不太可能..."});case 30:return e.next=32,Hi.dispatch("interaction/showValidationError",c.reason);case 32:e.next=4;break;case 34:return e.abrupt("return",{action:o,character:t});case 37:return e.next=39,Hi.dispatch("interaction/updateInteractionStage",{stage:"AI思考中",info:"正在思考..."});case 39:return this.logger.log("获取AI ".concat(t," 的响应...")),l=this.createSituationForAI(n),e.next=43,this.gameManager.aiPlayers[t].getResponse(l);case 43:return u=e.sent,this.logger.log("AI响应:",u),e.next=47,Hi.dispatch("interaction/updateInteractionStage",{stage:"AI行动",info:"提交行动..."});case 47:if(n){e.next=52;break}return e.next=50,new Promise((function(e){return setTimeout(e,3e3)}));case 50:e.next=54;break;case 52:return e.next=54,new Promise((function(e){return setTimeout(e,2e3)}));case 54:return e.abrupt("return",{action:u.action,character:t});case 55:case"end":return e.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()},{key:"determineMainActor",value:function(){var e=(0,o.A)((0,a.A)().mark((function e(){var t;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(1!==this.currentTurn){e.next=4;break}return t=Hi.state.game.selectedCharacter,this.recentMainActors.push(t),e.abrupt("return",t);case 4:return e.abrupt("return",this.mainActor);case 5:case"end":return e.stop()}}),e,this)})));function t(){return e.apply(this,arguments)}return t}()},{key:"waitForPlayerInput",value:function(){var e=(0,o.A)((0,a.A)().mark((function e(){var t=this;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return this.logger.log("等待玩家输入..."),e.abrupt("return",new Promise((function(e){var n=Hi.subscribe((function(r){"conversation/ADD_TO_CONVERSATION_HISTORY"===r.type&&"user"===r.payload.role&&(t.logger.log("检测到玩家输入:",r.payload.content),n(),e(r.payload.content))}))})));case 2:case"end":return e.stop()}}),e,this)})));function t(){return e.apply(this,arguments)}return t}()},{key:"createSituationForAI",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",t=[];return e&&t.push("主行动者".concat(this.mainActor,"的行动：").concat(e)),t.join("\n")}},{key:"determineNextMainActor",value:function(){var e=(0,o.A)((0,a.A)().mark((function e(t,n){var r,o,i,s,c,l,u,p,d,h,g,f,m=this;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return r={type:"object",properties:{thoughts:{type:"array",items:{type:"object",properties:{step:{type:"string"},reasoning:{type:"string"}},required:["step","reasoning"],additionalProperties:!1}},reason:{type:"string",description:"选择该角色作为主行动者的原因"},nextActor:{type:"string",description:"下一回合的主行动者名字"}},required:["thoughts","reason","nextActor"],additionalProperties:!1},o=Hi.state.gameState.availableCharacters,i=this.gameManager.sectionData,s=t.triggerChecks.filter((function(e){return e.isTriggered})).map((function(e){var t=m.gameManager.plotTriggers.find((function(t){return t.id===e.id}));return t?t.content:null})).filter(Boolean),c=t.nextTurnTriggers.map((function(e){return"[预告] ".concat(e.content)})).filter(Boolean),l="作为游戏主持人，请分析当前场景并决定下一回合谁最适合作为主要行动者。\n\n背景信息：\n".concat(i.backgroundInfo,"\n\n当回合的小说化描述：\n").concat(n,"\n\n可选角色：\n").concat(o.map((function(e){return"- ".concat(e.name)})).join("\n"),"\n\n主行动者不能是主持人助手这样子的辅助角色。也不能是隐身或者未出场的角色，比如杰瑞斯。\n最近的主行动者历史：").concat(this.recentMainActors.join("，"),"\n\n回合触发的特殊剧情：\n").concat(s.length>0?s.join("\n"):"无","\n\n下一回合会触发的剧情：\n").concat(c.length>0?c.join("\n"):"无","\n请按照以下步骤思考：\n1. 你自己想\n2. 你自己想\n3. 检查技能使用情况:\n   - 查看是否有角色使用了迅捷类技能\n   - 查看是否有角色使用了时间系技能\n   - 如有则这些角色必然是下一回合的主行动者，不用管前面的步骤和剧情，如果他们不是主行动者，其他人就会出现无法行动的问题，因为他们会检测到这些迅捷角色，会让他们认为他们无法反应。\n\n请用JSON格式回复，包含：\n1. thoughts: 思考过程数组，每步包含step(步骤)和reasoning(推理过程)\n2. reason: 总结原因\n3. nextActor: 下一回合的主行动者名字"),e.prev=6,e.next=9,Hi.dispatch("api/callLargeLanguageModelWithSchema",{prompt:l,schema:r,module:"determineNextMainActor"});case 9:return u=e.sent,this.logger.log("AI建议的下一回合主行动者:",u),p=u.nextActor,d=Object.keys(this.gameManager.aiPlayers).includes(p),h=Hi.state.game.selectedCharacter,g=d?p:h,d||this.logger.log("警告: AI返回的角色 ".concat(p," 无效，改用玩家角色 ").concat(h)),this.recentMainActors.push(g),this.recentMainActors.length>this.maxHistoryLength&&this.recentMainActors.shift(),e.abrupt("return",g);case 21:return e.prev=21,e.t0=e["catch"](6),this.logger.error("确定主行动者失败:",e.t0),f=Hi.state.game.selectedCharacter,this.logger.log("错误恢复：使用玩家角色 ".concat(f," 作为下一个主行动者")),e.abrupt("return",f);case 27:case"end":return e.stop()}}),e,this,[[6,21]])})));function t(t,n){return e.apply(this,arguments)}return t}()},{key:"generateCGIfPossible",value:function(e){var t=this;this.logger.log("准备生成CG...");var n=this.gameManager.getLocationDescription();this.logger.log("当前场景地点描述:",n),n?this.cgGenerator.generateCG(e,n).then((function(e){Hi.dispatch("conversation/addCGToHistory",e)}))["catch"]((function(e){t.logger.error("CG生成失败，但不影响主流程继续:",e)})):this.logger.warn("CG生成失败：无法获取有效的地点描述")}},{key:"cleanup",value:function(){this.moderator=null,this.gameManager=null,this.mainActor=null,this.recentMainActors=[],this.cgGenerator=null}}])}(),Ii=function(){function e(t,n,r,a,o,i,s){(0,ot.A)(this,e),this.startEvent=t,this.commonKnowledge=n,this.GMDetails=r,this.playerInfo=a,this.sectionObjective=o,this.endConditions=i,this.streamHandler=new Ei,this.endSectionFlag=!1,this.store=Hi,this.eventBus=(0,dt.A)(),this.gameManager=s,this.valueManager=new gt}return(0,it.A)(e,[{key:"initializeCharacterValues",value:function(e){var t=this;e.characters&&e.characters.forEach((function(e){t.valueManager.initializeCharacter(e.name,e.valueConfig)}))}},{key:"updatePlayerInfo",value:function(e){this.playerInfo=e}},{key:"validateAction",value:function(){var e=(0,o.A)((0,a.A)().mark((function e(t){var n,r,o,i,c,l;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return r=null!==(n=this.gameManager)&&void 0!==n&&null!==(n=n.battleEnvironmentManager)&&void 0!==n&&n.enabled?this.gameManager.battleEnvironmentManager.getSimpleCurrentEnvironmentDescription():null,o=this.valueManager.getValueStatus(this.store.state.game.selectedCharacter),i={type:"object",properties:{reason:{type:"string"},suggestion:{type:"string"},isValid:{type:"boolean"},usesPower:{type:"boolean"},specificAction:{type:"string"}},required:["reason","suggestion","isValid","usesPower","specificAction"],additionalProperties:!1},c="作为游戏主持人，请评估玩家是否有能力进行他描述的行动，背景：\n\n开始事件：".concat(this.startEvent,"\n公共知识：").concat(this.commonKnowledge,"\nGM细节：").concat(this.GMDetails,"\n\n").concat(r?"当前环境：\n".concat(r,"\n"):"","\n\n玩家信息：\n").concat(this.playerInfo,"\n\n角色当前状态：").concat(null===o||void 0===o?void 0:o.text,"\n\n上一回合：\n").concat(this.getLastRound(),"\n\n本回合玩家行动：").concat(t,"\n注意，玩家的行为可以胡闹，你主要判断可行性，只要有能力做到，就可以做。\n玩家的超能力仅限写出来的部分，以及覆盖在体表的灵能盾，玩家释放其他的超能力你要拒绝。\n请用JSON格式回答，包含以下字段：\n- reason: 解释玩家行动是否可行的原因\n- suggestion: 如果行动不可行，给出的建议。如果可行，则留空。\n- isValid: 玩家行动是否可行的结论（布尔值）\n- usesPower: 玩家是否主动使用了异能（布尔值）。只有当玩家明确表示要使用异能时才为true。\n- specificAction: 请具体描述玩家实际做的事情和说得话，避免歧义，同时也尽量保留原话，最重要的是具体化对象。例如，如果玩家说'你好'，可以描述为'向在场的人问好'，或者判断到是向谁问好。如果不可行，可以留空。如果玩家使用了特殊能力或技能，请具体说明使用的是哪个能力，对能力的效果至少要有一句描写。注意，使用能力必须要是玩家主动发动，因为会耗灵力的，如果玩家没有明说，就不要发动能力。写行动，不要直接写结果，主持人会进一步判断结果。"),e.next=6,this.callLargeLanguageModel(c,i,"moderator_validate");case 6:if(l=e.sent,l.isValid){e.next=10;break}return e.next=10,this.store.dispatch("conversation/removeLastUserMessage");case 10:return e.abrupt("return",(0,s.A)((0,s.A)({},l),{},{suggestions:l.isValid?[]:[l.suggestion].filter(Boolean)}));case 11:case"end":return e.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()},{key:"summarizeActions",value:function(){var e=(0,o.A)((0,a.A)().mark((function e(t,n,r,o){var i,c,l,u,p,d,h,g,f,m,v=this;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return c={type:"object",properties:{triggerChecks:{type:"array",items:{type:"object",properties:{id:{type:"string"},triggerCondition:{type:"string"},currentProgress:{type:"string"},isTriggered:{type:"boolean"}},required:["id","triggerCondition","currentProgress","isTriggered"],additionalProperties:!1}},collision:{type:"string"},summary:{type:"array",items:{type:"object",properties:{name:{type:"string"},note:{type:"string"},successProbability:{type:"string",enum:["impossible","unlikely","possible","likely","certain"],description:"行动成功的可能性"}},required:["name","note","successProbability"],additionalProperties:!1}},endReasons:{type:"array",items:{type:"object",properties:{condition:{type:"string"},according:{type:"string"},isMet:{type:"boolean"}},required:["condition","according","isMet"],additionalProperties:!1}},endSectionFlag:{type:"boolean"}},required:["triggerChecks","endReasons","endSectionFlag","collision","summary"],additionalProperties:!1},l=this.getOptimizedHistory(),u=t.map((function(e){return{character:e.character,status:v.valueManager.getValueStatus(e.character)}})),p="请考虑以下背景信息和优化后的对话历史：\n\n公共信息：".concat(this.commonKnowledge,"\n主持人信息：").concat(this.GMDetails,"\n结束条件：\n").concat(this.endConditions.map((function(e,t){return"".concat(t+1,". ").concat(e)})).join("\n"),"\n\n").concat(o?"环境分析：\n".concat(JSON.stringify(o,null,2),"\n"):"","\n\n").concat((null===(i=this.sectionData)||void 0===i||null===(i=i.influenceNotes)||void 0===i?void 0:i.length)>0?"更多背景信息：\n".concat(this.sectionData.influenceNotes.join("\n"),"\n"):"","\n\n优化后的对话历史：\n").concat(l,"\n\n本桥段目标：").concat(this.sectionObjective,"\n\n本回合各角色的行动：\n").concat(t.map((function(e){return"".concat(e.character,"：").concat(e.action)})).join("\n"),"\n各角色当前状态：\n").concat(u.map((function(e){var t;return"".concat(e.character,": ").concat(null===(t=e.status)||void 0===t?void 0:t.text)})).join("\n"),"\n\n当前回合数：").concat(r,"\n\n剧情触发器列表：\n").concat(n.filter((function(e){return!e.consumed&&!e.triggerCondition.startsWith("第")})).map((function(e){return"- ID: ".concat(e.id,", 触发条件: ").concat(e.triggerCondition)})).join("\n"),'\n\n请按照指定的JSON格式回复，包括以下字段：\n- triggerChecks: 一个数组，包含每个剧情触发器的以下信息：\n    触发器列表为空的时候留空数组。\n  - id: 触发器ID\n  - triggerCondition: 触发条件\n  - currentProgress: 当前触发进度的简单描述\n  - isTriggered: 布尔值，表示该触发器是否在这个回合被触发\n- collision: 角色之间行动的冲突，哪个角色做的可能让另一个角色达不到最终的效果\n- summary: 一个数组，包含每个角色的名字、行动结果注释和成功可能性。不要漏了助手类角色，它们可能不在游戏中，但是它们可以提醒主持人注意事项。\n  - name: 角色名字\n  - note: 对该行动的结论性判定，例如"攻击"、"防御"、"行动"等，只简单写行动类型，不写成败。\n  - successProbability: 行动成功的可能性，必须是以下五个选项之一："impossible"（不可能）、"unlikely"（不太能）、"possible"（可能）、"likely"（很可能）、"certain"必然）。如果异能用对了方法，那就是certain，但是越连续使用异能，成功率越掉一级。\n- endReasons: 一个数组,包含每个结束条件及其是否满足的布尔值:\n  - condition: 结束条件\n  - according: 依据目前剧情是否满足结束条件\n  - isMet: 布尔值,表示该条件是否准确满足了\n- endSectionFlag: 布尔值,是否结束该桥段'),e.next=6,this.callLargeLanguageModel(p,c,"moderator_summarize");case 6:return d=e.sent,d.triggerChecks=d.triggerChecks.map((function(e){var t=n.find((function(t){return t.id===e.id}));return(0,s.A)((0,s.A)({},e),{},{content:t?t.content:null})})),h=t.reduce((function(e,t){return e[t.character]=t.action,e}),{}),g=new Set(d.summary.map((function(e){return e.name}))),f=t.filter((function(e){return!g.has(e.character)})),f.forEach((function(e){var t=e.character.includes("助手");d.summary.push({name:e.character,note:t?"主持人助手的提醒，主持人请高度重视":"行动被总结器遗漏，谨慎注意此行动的可行性",successProbability:t?"certain":"possible"})})),d.summary=d.summary.map((function(e){var t;switch(e.successProbability){case"impossible":t=0;break;case"unlikely":t=.3;break;case"possible":t=.6;break;case"likely":t=.8;break;case"certain":t=.95;break;default:t=.5}var n,r=Math.random(),a=r<t;if(a)n=r<=.2*t?"criticalSuccess":"normalSuccess";else{var o=Math.min(t+.8*(1-t),.95);n=r>=o?"criticalFailure":"normalFailure"}return(0,s.A)((0,s.A)({},e),{},{originalAction:h[e.name],isSuccessful:a,resultLevel:n,diceRoll:r})})),n.forEach((function(e){if(e.triggerCondition.startsWith("第")&&e.triggerCondition.endsWith("回合开始")){var t=parseInt(e.triggerCondition.replace(/[^0-9]/g,""));r===t&&d.triggerChecks.push({id:e.id,triggerCondition:e.triggerCondition,currentProgress:"当前是第".concat(r,"回合"),isTriggered:!0})}})),d.endSectionFlag=d.endReasons.some((function(e){return e.isMet})),this.endSectionFlag=d.endSectionFlag,e.next=18,this.getNextTurnTriggers(r);case 18:return m=e.sent,d.nextTurnTriggers=m,e.abrupt("return",d);case 21:case"end":return e.stop()}}),e,this)})));function t(t,n,r,a){return e.apply(this,arguments)}return t}()},{key:"generateFinalResult",value:function(){var e=(0,o.A)((0,a.A)().mark((function e(t,n){var r,o,i,s,c,l;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return o=t.thisTurnActions.map((function(e){return"".concat(e.name,": ").concat(e.actionAndSpeak)})).join("\n\n"),i=this.getOptimizedHistory(),s="罗伯特"===this.store.state.game.selectedCharacter,c=s?'\n关于罗伯特的异能【苍穹缝隙】时间停止能力的描写要求：\n1. 时间停止时的表现是所有人和物体都完全静止\n2. 罗伯特在时停中的特权只有罗伯特可以自由移动和行动\n3. 时停的开始和结束：\n   - 开始：描写世界突然失去所有动态\n   - 结束：描写被停止的动作突然继续\n   - 其他人对时停毫无察觉，对他们来说时间是连续的\n4. 注意事项：\n   - 严格遵守"其他人完全静止"的设定\n   - 不要让任何其他角色在时停中有反应或动作，有特例，琼可以在停滞的时间中动眼睛看东西。\n   - 时停结束后，其他人会继续之前的动作，仿佛无事发生，如果当回合罗伯特没有要求一直维持，那他这回合做完他的所有行动后会解除能力，其他人可以继续在罗伯特行动的基础之上行动。让他的攻击完成！\n':"",l="请根据以下角色的行动描述和主持人笔记，生成本回合的最终的输出：\n公共信息：".concat(this.commonKnowledge,"\n主持人信息：").concat(this.GMDetails,"\n\n").concat((null===(r=this.sectionData)||void 0===r||null===(r=r.influenceNotes)||void 0===r?void 0:r.length)>0?"更多背景信息：\n".concat(this.sectionData.influenceNotes.join("\n"),"\n"):"","\n\n过去回合历史：\n").concat(i,"\n\n").concat(c,"\n\n1. 小说化地描述新的回合结果，快速推进剧情。\n2. 包括每个角色的对话和动作\n3. 使用第三人称描写\n4. 回复会直接展示为小说内容，不要写前导前缀提示\n5. 不要写太多内容，三个自然段即可\n6. 确保内容连贯且符合逻辑\n7. 非常重要！不要写形容词和氛围描写、心理描写，我们通过动作和对话自然地展示情节\n错误例子：他无力地放下手。\n好的例子：他手一松，手里的东西掉在了地上。\n就是少些形容词，多些动作。多一些细节描写。\n\n请你续写小说。请注意不要替任何角色多做任何行动。我们就是把已经发生的行动描述收敛起来。因为接下来还有新的内容的，不是直接就完结了。\n请书写新的内容，你在上面看到的都不用重复写了，已经给玩家看过了。下面是你要重点书写的本回合的内容：\n本回合角色行动描述：\n").concat(o,"\n\n本回合主持人笔记：\n").concat(t.thisTurnNotes,"\n\nThe plot triggers triggered in this round:\n    ").concat(n.map((function(e){return e.content})).join("\n"),"\n"),e.next=7,this.callLargeLanguageModelStream(l,"moderator_generate_result");case 7:return e.abrupt("return",e.sent);case 8:case"end":return e.stop()}}),e,this)})));function t(t,n){return e.apply(this,arguments)}return t}()},{key:"getOptimizedHistory",value:function(){var e=this.store.state.conversation.optimizedConversationHistory;return e&&Array.isArray(e)&&e.map((function(e){return"".concat(e.role,": ").concat(e.content)})).join("\n")||""}},{key:"getSelectedCharacter",value:function(){return this.store.state.game.selectedCharacter||""}},{key:"callLargeLanguageModel",value:function(){var e=(0,o.A)((0,a.A)().mark((function e(t,n){var r,o=arguments;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return r=o.length>2&&void 0!==o[2]?o[2]:"mainGame",e.prev=1,e.next=4,this.store.dispatch("api/callLargeLanguageModelWithSchema",{prompt:t,schema:n,module:r});case 4:return e.abrupt("return",e.sent);case 7:throw e.prev=7,e.t0=e["catch"](1),console.error("API调用失败:",e.t0),e.t0;case 11:case"end":return e.stop()}}),e,this,[[1,7]])})));function t(t,n){return e.apply(this,arguments)}return t}()},{key:"callLargeLanguageModelStream",value:function(){var e=(0,o.A)((0,a.A)().mark((function e(t){var n,r,i,s,c=this,l=arguments;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return n=l.length>1&&void 0!==l[1]?l[1]:"mainGame",e.prev=1,e.next=4,this.store.dispatch("conversation/startNewMessage",{role:"assistant",initialContent:""});case 4:return r=e.sent,i=function(){var e=(0,o.A)((0,a.A)().mark((function e(t){return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,c.store.dispatch("conversation/updateStreamingMessage",{id:r,content:t});case 2:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),e.next=8,this.store.dispatch("api/processStreamingResponse",{prompt:t,updateCallback:i,module:n});case 8:return s=e.sent,e.next=11,this.store.dispatch("conversation/finishStreamingMessage",r);case 11:return e.abrupt("return",s);case 14:throw e.prev=14,e.t0=e["catch"](1),console.error("流式处理出错:",e.t0),e.t0;case 18:case"end":return e.stop()}}),e,this,[[1,14]])})));function t(t){return e.apply(this,arguments)}return t}()},{key:"getLastRound",value:function(){return this.store.getters["conversation/getLastRound"]}},{key:"getNextTurnTriggers",value:function(){var e=(0,o.A)((0,a.A)().mark((function e(t){var n,r;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return n=t+1,r=[],this.store.state.gameState.plotTriggers.filter((function(e){return!e.consumed})).forEach((function(e){if(e.triggerCondition.startsWith("第")&&e.triggerCondition.endsWith("回合开始")){var t=parseInt(e.triggerCondition.replace(/[^0-9]/g,""));t===n&&r.push({id:e.id,triggerCondition:e.triggerCondition,content:e.content,currentProgress:"下一回合将是第".concat(n,"回合")})}})),e.abrupt("return",r);case 4:case"end":return e.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()},{key:"prepareForOutput",value:function(){var e=(0,o.A)((0,a.A)().mark((function e(t,n,r){var o,i,c,l,u,p,d,h,g=this;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return i={type:"object",properties:{thisTurnAnalysis:{type:"string"},thisTurnActions:{type:"array",items:{type:"object",properties:{name:{type:"string"},actionAndSpeak:{type:"string"}},required:["name","actionAndSpeak"],additionalProperties:!1}},valueChanges:{type:"array",items:{type:"object",properties:{event:{type:"string"},effects:{type:"array",items:{type:"object",properties:{type:{type:"string",enum:["health","mana"]},amount:{type:"string",enum:["minor","medium","major"]},targetName:{type:"string"}},required:["type","amount","targetName"],additionalProperties:!1}}},required:["event","effects"],additionalProperties:!1}},thisTurnNotes:{type:"string"}},required:["thisTurnAnalysis","thisTurnActions","valueChanges","thisTurnNotes"],additionalProperties:!1},c=this.getOptimizedHistory(),l=t.summary.map((function(e){var t;switch(e.resultLevel){case"criticalSuccess":t="戏剧性的大成功";break;case"normalSuccess":t="成功";break;case"normalFailure":t="失败";break;case"criticalFailure":t="戏剧性的大失败";break;default:t="未知"}return"".concat(e.name,":").concat(e.originalAction,"\n判定: ").concat(t)})).join("\n"),u="你是一个主持人助手，请根据以下背景信息和总结内容，生成每个角色的行动描述，并提供主持人笔记：\n    public information: ".concat(this.commonKnowledge,"\n    GM information: ").concat(this.GMDetails,"\n\n    ").concat((null===(o=this.sectionData)||void 0===o||null===(o=o.influenceNotes)||void 0===o?void 0:o.length)>0?"更多背景信息：\n".concat(this.sectionData.influenceNotes.join("\n"),"\n"):"","\n\n    The things that have happened so far:\n    ").concat(c,'\n\n特别的，【苍穹缝隙】作为时间停止异能，它会导致在他行动过程中，其他的所有人和物都是静止的。你可以恰当描写开启和结束这个异能的时机，然后其他人和物才可以动。\n\n    1. 请确保结果在逻辑上合理。\n    2. 成功或失败只是一个骰子点数，你需要仔细思考这个人是否在场以及他们是否真的能做到。描述应该自然地包含每个角色的原始动作。但是角色们的行动是会互相影响的，你的任务是梳理好他们。\n    3. 触发的剧情触发器和环境变化必须反映在你的描述中。这是高优先级的,除非这一轮无法做某些事情,比如一个人失去意识而无法说出他们应该说的台词，或者角色不在场。\n    4. 如果一个人没有采取任何行动,你不应该为他们添加行动。你应该专注于当前信息,收敛到实际发生的事情。\n    5. 非常重要!请注意你不应该总结过去发生的事情。你应该总结这一轮发生了什么。\n    6. 你必须描述每个动作的结果和影响。不要只写动作的过程,要写出动作带来的具体效果和改变,而且要非常显著，这样剧情才能向前推进。比如"他挥出一拳"不够好,应该是"他挥出一拳,打中了对方的下巴,对方踉跄后退了两步，倒在了地上"。\n    7. 关于数值变化(valueChanges)：\n       - 被打中的人一定会减少血量health，灵能盾防住了也会受伤\n       - 用异能的人一定会减少蓝量mana\n       \n       先写事件，再写影响，targetName要具体不能泛指。比如：\n       - event: "艾米异能拳打中约翰"\n       - effects: [\n         {\n           type: "health",\n           amount: "medium",\n           targetName: "约翰"\n         },\n         {\n           type: "mana",\n           amount: "minor",\n           targetName: "艾米"\n         }\n       ]\n\n    Please generate the following:\n    - thisTurnAnalysis: A summary of this round. What is likely to happen based on your analysis.\n    - thisTurnActions: Descriptions of the actions taken by each character, including the character\'s name and actionAndSpeak.\n    - valueChanges: Array of value changes that occurred this turn, each with reason, type, amount and targetName.\n    - thisTurnNotes: GM notes, focusing on objective facts and plot triggers.\n    \n    The actions and results of each character in this round:\n    ').concat(l,"\n\n    ").concat(r?"Environmental changes: \n".concat(r,"\n"):"","\n\n    The plot triggers triggered in this round:\n    ").concat(n.map((function(e){return e.content})).join("\n"),"\n    "),e.next=6,this.callLargeLanguageModel(u,i,"moderator_prepare_output");case 6:if(p=e.sent,d=!1,!(p.valueChanges&&p.valueChanges.length>0)){e.next=15;break}if(p.valueChanges.forEach((function(e){e.effects.forEach((function(t){g.valueManager.applyValueChanges(t.targetName,[(0,s.A)({reason:e.event},t)])}))})),h=this.store.state.game.selectedCharacter,!this.valueManager.isInCriticalCondition(h)){e.next=15;break}return d=!0,e.next=15,this.store.dispatch("conversation/addSystemMessage",{content:"但是你的意识开始模糊，无法继续战斗...",type:"warning"});case 15:return e.abrupt("return",(0,s.A)((0,s.A)({},p),{},{criticalHealthFlag:d}));case 16:case"end":return e.stop()}}),e,this)})));function t(t,n,r){return e.apply(this,arguments)}return t}()},{key:"generateSuggestions",value:function(){var e=(0,o.A)((0,a.A)().mark((function e(t){var n,r,o,i,s,c,l,u,p,d,h,g,f,m,v=this;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return i={type:"object",properties:{thoughts:{type:"array",items:{type:"object",properties:{step:{type:"string"},content:{type:"string"}},required:["step","content"],additionalProperties:!1}},suggestions:{type:"array",items:{type:"string",additionalProperties:!1}}},required:["thoughts","suggestions"],additionalProperties:!1},s=this.store.state.game.selectedCharacter,c=this.gameManager.sectionData.characters.find((function(e){return e.name===s})),l=null===c||void 0===c||null===(n=c.characterTags)||void 0===n?void 0:n.map((function(e){return v.gameManager.getCharacterTag(e)})).filter(Boolean).join("\n"),u=this.valueManager.getValueStatus(s),p=this.getOptimizedHistory(),d="".concat(p,"\n\n最新发生：\n").concat(t),h=null!==(r=this.gameManager)&&void 0!==r&&null!==(r=r.battleEnvironmentManager)&&void 0!==r&&r.enabled?this.gameManager.battleEnvironmentManager.getSimpleCurrentEnvironmentDescription():null,g="","罗伯特"===s&&(g="\n特殊指导：\n- 你的【苍穹缝隙】异能可以让时间停止一会,但只有你自己可以在时停中行动\n- 这个异能是公开的,大部分人都知道你有这个能力\n- 在时停状态下,你不能带动其他人移动，其他人无法在时停中看到听到也无法行动,但是你可以带动物品。所以时停但是保留两人能动是不可行的。"),f="你是".concat(s,"。").concat((null===c||void 0===c?void 0:c.description)||"","\n\n角色信息：\n").concat(l?"特性：\n".concat(l,"\n"):"","\n").concat(null!==c&&void 0!==c&&c.personality?"性格：".concat(c.personality,"\n"):"","\n").concat(null!==c&&void 0!==c&&c.goals?"目标：".concat(c.goals.join(", "),"\n"):"","\n").concat(null!==c&&void 0!==c&&c.sectionGuidance?"指导：".concat(c.sectionGuidance,"\n"):"","\n").concat(g,"\n\n背景信息：\n公共信息：").concat(this.commonKnowledge,"\n本桥段目标：").concat(this.sectionObjective,"\n\n当前状况：\n角色状态：").concat(null===u||void 0===u?void 0:u.text,"\n").concat(h?"当前环境：\n".concat(h,"\n"):"","\n\n剧情发展：\n").concat(d,"\n\n请按照以下步骤思考并提供行动建议：\n\n1. 思考过程（thoughts数组）：\n   a. 分析当前情况：我在哪里，正在发生什么，其他人在做什么\n   b. 回顾个人目标：思考我的角色目标，以及当前最重要的事\n   c. 考虑限制条件：我的状态、环境限制、其他角色的影响\n   d. 分析可能性：列举可能的行动方向，包括主动、被动、友好、对抗等\n   ").concat(h?"e. 环境利用：思考如何利用当前环境来达成目标，比如利用地形、掩体或特殊物品\n":"",'\n\n2. 行动建议（suggestions数组）：\n   提供1-3个具体的行动建议，要求：\n   - 用第一人称"我"的形式，包含具体的动作和对话\n   - 每个建议都要考虑当前的场景和角色关系\n   - 建议要符合你的角色身份、性格和能力范围\n   - 建议要有戏剧性和趣味性\n   - 建议要考虑当前的环境和其他角色的可能反应\n   - 聚焦于当下，不要展望未来\n   ').concat(h?"- 建议要考虑如何利用环境优势\n":"","\n\n格式：\n- thoughts: 每个思考步骤包含step和content\n- suggestions: 每个建议用一句话描述，例如：\n  \"我微笑着说：'你好啊'，然后向前走了两步\"\n  \"我举起长棍说：'让我们切磋一下吧！'，摆出战斗姿势\""),e.next=13,this.callLargeLanguageModel(f,i,"moderator_suggestions");case 13:return m=e.sent,null===(o=this.logger)||void 0===o||o.log("建议系统的思考过程:",m.thoughts),e.abrupt("return",m);case 16:case"end":return e.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()}])}();function Li(e,t){var n=(0,l.KR)(!1),r=function(e,t,n){return"\n      请基于以下对话历史，对完成度做出总结。\n      对话历史：\n      ".concat(t.map((function(e){return"".concat(e.role,": ").concat(e.content)})).join("\n"),"\n      以上是对话历史。\n      本桥段目标：").concat(e.objective,"\n      影响点：\n      ").concat(n,'\n      请按照以下JSON格式回复：\n      {\n        "objective": "是否达成了桥段目标，布尔值",\n        "influencePoints": [\n          {"id": 影响点英文别名, "influence": "是否，布尔值"}\n        ],\n        "summary": "总结的内容，单个字符串，可以写详细一点，不写影响点相关的内容，包括对玩家行为的评价。",\n        "objective_judge":"只写出对于判断桥段目标是否达成的解释，不写影响点相关的内容。请称玩家角色为\'你\'。"\n      }\n      如果有好感度的影响点，记住好感度的上升必须是基于玩家的非常非常积极主动的行为，而且也得到了很好的回应。\n    ')},i=function(e){var n=t.state.timelineInfluence.globalInfluences||[];return console.log("开始格式化影响点:",e),console.log("全局影响点配置:",n),e.filter((function(e){return e.id&&"undefined"!==e.id})).map((function(e){if(console.log("处理影响点:",e),"objective"===e.id)return console.log("处理objective影响点:",e.description),"objective：".concat(e.description);var t=n.find((function(t){return t.id===e.id}));if(!t)return console.warn("未找到影响点配置: ".concat(e.id)),"".concat(e.id,"（未知影响）");if(!t.display)return console.warn("影响点 ".concat(e.id," 缺少 display 配置")),"".concat(e.id,"（配置错误）");var r=t.display,a=r.id,o=void 0===a?"未知名称":a,i=r.description,s=void 0===i?"未知描述":i;return console.log("影响点 ".concat(e.id," 格式化结果:"),{id:o,description:s}),"".concat(o,"（").concat(e.id,"）：").concat(s)})).join("\n")},s=function(){var e=(0,o.A)((0,a.A)().mark((function e(n,o){var s,c,l,u;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return s=i(n.influencePoints),c=r(n,o,s),e.prev=2,l={type:"object",additionalProperties:!1,properties:{objective:{type:"boolean"},influencePoints:{type:"array",items:{type:"object",additionalProperties:!1,properties:{id:{type:"string"},influence:{type:"boolean"}},required:["id","influence"]}},summary:{type:"string"},objective_judge:{type:"string"}},required:["objective","influencePoints","summary","objective_judge"]},e.next=6,t.dispatch("api/callLargeLanguageModelWithSchema",{prompt:c,schema:l,module:"sectionEnd"});case 6:return u=e.sent,e.abrupt("return",u);case 10:throw e.prev=10,e.t0=e["catch"](2),console.error("获取章节总结失败:",e.t0),e.t0;case 14:case"end":return e.stop()}}),e,null,[[2,10]])})));return function(t,n){return e.apply(this,arguments)}}(),c=function(){var r=(0,o.A)((0,a.A)().mark((function r(o){var i,c,l,u,p,d,h,g,f,m,v,b,y,k;return(0,a.A)().wrap((function(r){while(1)switch(r.prev=r.next){case 0:if(i=o.section,!n.value){r.next=3;break}return r.abrupt("return");case 3:return r.prev=3,n.value=!0,t.dispatch("game/setInputEnabled",!1),c=t.state.conversation.optimizedConversationHistory,r.next=9,s(i,c);case 9:if(l=r.sent,!l.influencePoints||!Array.isArray(l.influencePoints)){r.next=40;break}if(u=i.sectionTimePoint,p=t.state.sections.currentScenario,d=t.state.timelineInfluence.globalInfluences||[],h=l.influencePoints.filter((function(e){return"objective"!==e.id})).filter((function(e){var t=d.some((function(t){return t.id===e.id}));return t||console.warn("检测到无效的影响点ID: ".concat(e.id)),t})),g=h.map((function(t){var n,r=i.influencePoints.find((function(e){return e.id===t.id})),a=null!==(n=null===r||void 0===r?void 0:r["default"])&&void 0!==n&&n;return{id:t.id,value:t.influence,defaultValue:a,operator:e,timePoint:u,scenario:p,section:i.id}})),f=t.getters["timelineInfluence/getInfluencesByTimePoint"](u),m=g.map((function(e){var t,n;return{id:e.id,value:null!==(t=null===(n=f[e.id])||void 0===n?void 0:n.value)&&void 0!==t&&t,defaultValue:e.defaultValue,timePoint:u}})),!(g.length>0)){r.next=40;break}return r.next=21,t.dispatch("game/showTimelineInfluenceModal",{timePoint:u,influences:g,existingInfluences:m});case 21:if(v=r.sent,!v){r.next=40;break}b=(0,Ta.A)(g),r.prev=24,b.s();case 26:if((y=b.n()).done){r.next=32;break}return k=y.value,r.next=30,t.dispatch("timelineInfluence/recordInfluence",k);case 30:r.next=26;break;case 32:r.next=37;break;case 34:r.prev=34,r.t0=r["catch"](24),b.e(r.t0);case 37:return r.prev=37,b.f(),r.finish(37);case 40:return r.next=42,t.dispatch("conversation/addSystemMessage",{content:"桥段总结：\n".concat(l.summary,"\n\n目标完成情况：\n").concat(l.objective_judge)});case 42:return r.next=44,t.dispatch("save/updateSaveData",{path:"progress.sectionResults.".concat(i.id),value:l});case 44:return r.next=46,t.dispatch("save/updateSaveData",{path:"timelineInfluences",value:t.state.timelineInfluence.timelineInfluences});case 46:if(!l.objective){r.next=51;break}return r.next=49,t.dispatch("sections/completeSection",i.id);case 49:return r.next=51,t.dispatch("save/saveSave");case 51:return r.abrupt("return",l);case 54:throw r.prev=54,r.t1=r["catch"](3),console.error("处理章节结束时出错:",r.t1),r.t1;case 58:return r.prev=58,n.value=!1,r.finish(58);case 61:case"end":return r.stop()}}),r,null,[[3,54,58,61],[24,34,37,40]])})));return function(e){return r.apply(this,arguments)}}();return{handleSectionEnd:c,isProcessing:n}}var Ri=function(){function e(t){var n;(0,ot.A)(this,e),this.enabled=(null===(n=t.battleConfig)||void 0===n?void 0:n.enabled)||!1,this.enabled&&(this.logger=new lt(!0,"BattleEnvironmentManager"),this.environmentDescription=t.battleConfig.environmentDescription||"",this.environmentRules=t.battleConfig.environmentRules||[],this.characterPositions=t.battleConfig.initialPositions||{},this.dynamicEffects=[],this.logger.log("初始化战斗环境管理器",{enabled:this.enabled,description:this.environmentDescription,rules:this.environmentRules,positions:this.characterPositions}))}return(0,it.A)(e,[{key:"getCurrentEnvironmentDescription",value:function(){if(!this.enabled)return null;var e=this.environmentDescription+"\n\n";return e+="当前位置：\n",Object.entries(this.characterPositions).forEach((function(t){var n=(0,Ia.A)(t,2),r=n[0],a=n[1];e+="".concat(r,"：").concat(a,"\n")})),this.dynamicEffects.length>0&&(e+="\n当前环境效果：\n",this.dynamicEffects.forEach((function(t){e+="- ".concat(t.description,"\n")}))),e}},{key:"getSimpleCurrentEnvironmentDescription",value:function(){return this.enabled?this.environmentDescription:null}},{key:"analyzeActionEnvironmentEffects",value:function(e){if(!this.enabled)return null;var t={type:"object",properties:{effects:{type:"array",items:{type:"object",properties:{character:{type:"string"},effect:{type:"string"}},required:["character","effect"],additionalProperties:!1}}},required:["effects"],additionalProperties:!1},n="作为战斗环境分析器，请简要分析当前环境对各个角色行动的影响。\n\n环境描述：\n".concat(this.environmentDescription,"\n\n环境规则：\n").concat(this.environmentRules.join("\n"),"\n\n当前角色位置：\n").concat(Object.entries(this.characterPositions).map((function(e){var t=(0,Ia.A)(e,2),n=t[0],r=t[1];return"".concat(n,"：").concat(r)})).join("\n"),"\n\n当前动态效果：\n").concat(this.dynamicEffects.map((function(e){return"- ".concat(e.description)})).join("\n"),"\n\n本回合行动：\n").concat(e.map((function(e){return"".concat(e.character,"：").concat(e.action)})).join("\n"),"\n\n请用一句话描述环境对每个角色行动的影响。\n返回JSON格式，包含：\neffects: 数组，每个角色受到的环境影响（一句话描述）");return Hi.dispatch("api/callLargeLanguageModelWithSchema",{prompt:n,schema:t,module:"battleEnvironment"})}},{key:"updateEnvironmentState",value:function(){var e=(0,o.A)((0,a.A)().mark((function e(t){var n,r,o;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(this.enabled){e.next=2;break}return e.abrupt("return",null);case 2:return n={type:"object",properties:{environmentalChanges:{type:"string",description:"环境变化的描述"}},required:["environmentalChanges"],additionalProperties:!1},r="作为战斗环境管理器，请分析本回合行动对环境的影响。\n\n当前环境：\n".concat(this.environmentDescription,"\n\n环境规则：\n").concat(this.environmentRules.join("\n"),"\n\n当前角色位置：\n").concat(Object.entries(this.characterPositions).map((function(e){var t=(0,Ia.A)(e,2),n=t[0],r=t[1];return"".concat(n,"：").concat(r)})).join("\n"),"\n\n当前动态效果：\n").concat(this.dynamicEffects.map((function(e){return"- [".concat(e.id,"] ").concat(e.description)})).join("\n"),"\n\n本回合行动结果：\n").concat(t.summary.map((function(e){return"".concat(e.name,"：").concat(e.originalAction," (").concat(e.isSuccessful?"成功":"失败",") - ").concat(e.resultLevel)})).join("\n"),"\n\n请简要描述环境的变化，返回JSON格式：\nenvironmentalChanges: 字符串，包含环境变化（当前动态效果必须产生影响）、角色位置变化、动态效果变化（产生火球，产生风暴等）"),e.prev=4,e.next=7,Hi.dispatch("api/callLargeLanguageModelWithSchema",{prompt:r,schema:n,module:"battleEnvironment"});case 7:return o=e.sent,this.logger.log("环境状态分析完成",o),e.abrupt("return",o.environmentalChanges);case 12:throw e.prev=12,e.t0=e["catch"](4),this.logger.error("分析环境状态失败:",e.t0),e.t0;case 16:case"end":return e.stop()}}),e,this,[[4,12]])})));function t(t){return e.apply(this,arguments)}return t}()},{key:"updateEnvironmentFromNarration",value:function(){var e=(0,o.A)((0,a.A)().mark((function e(t){var n,r,o,i,s=this;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(this.enabled){e.next=2;break}return e.abrupt("return",null);case 2:return n={type:"object",properties:{movementReasoning:{type:"string"},updatedDescription:{type:"string"},positionUpdates:{type:"object",properties:{},additionalProperties:{type:"string"}},effectUpdates:{type:"object",properties:{add:{type:"array",items:{type:"object",properties:{id:{type:"string"},description:{type:"string"},rules:{type:"array",items:{type:"string"}}},required:["id","description","rules"],additionalProperties:!1}},remove:{type:"array",items:{type:"string"}}},required:["add","remove"],additionalProperties:!1}},required:["movementReasoning","positionUpdates","effectUpdates","updatedDescription"],additionalProperties:!1},r="作为战斗环境管理器，请根据叙述更新环境状态。\n\n当前环境总体描述：\n".concat(this.environmentDescription,"\n\n上一回合角色位置：\n").concat(Object.entries(this.characterPositions).map((function(e){var t=(0,Ia.A)(e,2),n=t[0],r=t[1];return"".concat(n,"：").concat(r)})).join("\n"),"\n\n本回合叙述：\n").concat(t,"\n\n当前动态效果：\n").concat(this.dynamicEffects.map((function(e){return"- [".concat(e.id,"] ").concat(e.description)})).join("\n"),"\n\n请先分析每个角色的运动情况，考虑：\n1. 叙述中提到的移动细节\n2. 角色之间的相对位置关系\n然后更新位置，再维护动态效果。\n最后更新环境状态。注意：\n1. 环境描述需要让所有角色都能清楚地理解所以能被看到的东西\n2. 包含所有重要的可以被利用的环境特征\n3. 需要反映环境的变化，但不要过于详细描述变化过程\n4. 保持客观，不要带有角色视角\n5. 不要写任何角色，专注于环境本身的描写，不要写氛围是什么样的，专注于实物描写。\n\n请用JSON格式回复：\n1. movementReasoning: 字符串，详细解释所有角色的移动推理过程\n2. positionUpdates: 对象，描述有运动的角色的新位置，中文名字做key\n3. effectUpdates: 对象，包含：\n   - add: 数组，新增的环境效果，比如火球，风暴等，需要包含id，描述，交互规则，比如火球烧东西，风暴推东\n   西。多描述性质。\n   - remove: 数组，需要移除的效果ID，你需要多移除已经结束/已经进入下一阶段的效果，不然会堆积太多分散\n   注意力。这很重要！\n4. updatedDescription: 新的环境总体描述。"),e.prev=4,e.next=7,Hi.dispatch("api/callLargeLanguageModelWithSchema",{prompt:r,schema:n,module:"battleEnvironment"});case 7:i=e.sent,Object.entries(i.positionUpdates).forEach((function(e){var t=(0,Ia.A)(e,2),n=t[0],r=t[1];s.characterPositions[n]=r})),this.dynamicEffects=this.dynamicEffects.filter((function(e){return!i.effectUpdates.remove.includes(e.id)})),(o=this.dynamicEffects).push.apply(o,(0,ao.A)(i.effectUpdates.add)),i.updatedDescription!==this.environmentDescription&&(this.environmentDescription=i.updatedDescription),this.logger.log("环境状态已从叙述更新",{movementReasoning:i.movementReasoning,positionUpdates:i.positionUpdates,effectUpdates:i.effectUpdates,currentEffects:this.dynamicEffects,newDescription:i.updatedDescription}),e.next=19;break;case 15:throw e.prev=15,e.t0=e["catch"](4),this.logger.error("从叙述更新环境状态失败:",e.t0),e.t0;case 19:case"end":return e.stop()}}),e,this,[[4,15]])})));function t(t){return e.apply(this,arguments)}return t}()},{key:"updateEnvironmentFromNarrationOverwrite",value:function(){var e=(0,o.A)((0,a.A)().mark((function e(t){var n,r,o;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(this.enabled){e.next=2;break}return e.abrupt("return",null);case 2:return n={type:"object",properties:{movementReasoning:{type:"string"},updatedDescription:{type:"string"},positions:{type:"object",properties:{},additionalProperties:{type:"string"}},effects:{type:"array",items:{type:"object",properties:{id:{type:"string"},description:{type:"string"},rules:{type:"array",items:{type:"string"}}},required:["id","description","rules"],additionalProperties:!1},required:["id","description","rules"],additionalProperties:!1}},required:["movementReasoning","positions","effects","updatedDescription"],additionalProperties:!1},r="作为战斗环境管理器，请根据叙述更新整个环境状态。\n\n当前环境总体描述：\n".concat(this.environmentDescription,"\n\n上一回合角色位置：\n").concat(Object.entries(this.characterPositions).map((function(e){var t=(0,Ia.A)(e,2),n=t[0],r=t[1];return"".concat(n,"：").concat(r)})).join("\n"),"\n\n本回合叙述：\n").concat(t,"\n\n当前动态效果：\n").concat(this.dynamicEffects.map((function(e){return"- [".concat(e.id,"] ").concat(e.description)})).join("\n"),"\n\n请先分析每个角色的运动情况，考虑：\n1. 叙述中提到的移动细节\n2. 角色之间的相对位置关系\n然后更新位置，再维护动态效果。\n最后更新环境状态。注意：\n1. 环境描述需要让所有角色都能清楚地理解所以能被看到的东西\n2. 包含所有重要的可以被利用的环境特征\n3. 需要反映环境的变化，但不要过于详细描述变化过程\n4. 保持客观，不要带有角色视角\n5. 不要写任何角色，专注于环境本身的描写，不要写氛围是什么样的，专注于实物描写。\n\n请用JSON格式回复：\n1. movementReasoning: 字符串，详细解释所有角色的移动推理过程\n2. positions: 对象，所有角色的最新位置（包括未移动的角色）\n3. effects: 数组，所有当前有效的环境效果，每个效果需要包含：\n   - id: 效果的唯一标识符\n   - description: 效果的描述\n   - rules: 数组，效果的交互规则，比如火球烧东西，风暴推东西等\n4. updatedDescription: 新的环境总体描述"),e.prev=4,e.next=7,Hi.dispatch("api/callLargeLanguageModelWithSchema",{prompt:r,schema:n,module:"battleEnvironment"});case 7:return o=e.sent,this.characterPositions=o.positions,this.dynamicEffects=o.effects,this.environmentDescription=o.updatedDescription,this.logger.log("环境状态已全量更新",{movementReasoning:o.movementReasoning,positions:o.positions,effects:o.effects,newDescription:o.updatedDescription}),e.abrupt("return",o);case 15:throw e.prev=15,e.t0=e["catch"](4),this.logger.error("全量更新环境状态失败:",e.t0),e.t0;case 19:case"end":return e.stop()}}),e,this,[[4,15]])})));function t(t){return e.apply(this,arguments)}return t}()},{key:"cleanup",value:function(){var e;this.enabled=!1,this.environmentDescription="",this.environmentRules=[],this.characterPositions={},this.dynamicEffects=[],null===(e=this.logger)||void 0===e||e.log("战斗环境管理器已清理")}}])}(),Ni=function(){function e(t,n){(0,ot.A)(this,e),this.gameState=t,this.aiPlayers={},this.streamHandler=new Ei,this.characterTagBase=null,this.playerInfo=null,this.turnCount=0,this.plotTriggers=[],this.sectionData=n,this.store=Hi,this.turnManager=null,this.moderator=null,this.battleEnvironmentManager=new Ri(n),this.isRunning=!1,this.logger=new lt(!0,"GameManager")}return(0,it.A)(e,[{key:"loadCharacterTags",value:function(){var e=(0,o.A)((0,a.A)().mark((function e(){var t;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,k.u.loadJSON("config/characterTagBase.json");case 3:return t=e.sent,console.log("Character tags loaded:",t),this.characterTagBase=t,e.abrupt("return",t);case 9:return e.prev=9,e.t0=e["catch"](0),console.error("加载角色标签库时出错:",e.t0),this.characterTagBase={tags:{}},e.abrupt("return",{tags:{}});case 14:case"end":return e.stop()}}),e,this,[[0,9]])})));function t(){return e.apply(this,arguments)}return t}()},{key:"setupGame",value:function(){var e=(0,o.A)((0,a.A)().mark((function e(){var t,n,r,o=this;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,Hi.commit("game/SET_SECTION_ENDED",!1);case 2:if(this.isRunning=!0,this.characterTagBase){e.next=6;break}return e.next=6,this.loadCharacterTags();case 6:if(n=this.sectionData,n){e.next=9;break}throw new Error("无法获取章节数据");case 9:return this.aiPlayers={},n.characters.forEach((function(e){e.isAI?o.aiPlayers[e.name]=new Si(e,n.commonKnowledge,n.startEvent,e.sectionGuidance,o.characterTagBase,o):o.mainPlayer=e})),this.initializePlotTriggers(n.plotTriggers),this.playerInfo=this.createPlayerInfo(this.mainPlayer),this.moderator=new Ii(n.startEvent,n.commonKnowledge,n.GMDetails,this.playerInfo,n.objective,n.endConditions,this),this.logger.log("开始初始化角色数值系统"),this.moderator.initializeCharacterValues(n),this.turnManager=new Ti(this.moderator,this),e.next=19,this.setupInitialContent(n);case 19:return e.next=21,this.updateAvailableCharacters();case 21:if(this.processTurns(),null===(t=this.battleEnvironmentManager)||void 0===t||!t.enabled){e.next=27;break}if(r=this.battleEnvironmentManager.getCurrentEnvironmentDescription(),!r){e.next=27;break}return e.next=27,this.store.dispatch("conversation/startNewMessage",{role:"info",initialContent:r});case 27:case"end":return e.stop()}}),e,this)})));function t(){return e.apply(this,arguments)}return t}()},{key:"setupInitialContent",value:function(){var e=(0,o.A)((0,a.A)().mark((function e(t){var n,r;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return r="<h2>".concat(t.title,"</h2><p><b>目标：").concat(t.objective,"</b></p><p>").concat(t.backgroundInfo,"</p>"),e.next=3,this.store.dispatch("conversation/startNewMessage",{role:"system",initialContent:r});case 3:return e.next=5,this.createPlayerInfo(this.mainPlayer);case 5:return this.playerInfo=e.sent,e.next=8,this.store.dispatch("conversation/startNewMessage",{role:"info",initialContent:this.playerInfo});case 8:return e.next=10,this.store.dispatch("conversation/startNewMessage",{role:"assistant",initialContent:t.startEvent});case 10:if(null===(n=t.initialSuggestions)||void 0===n||!n.length){e.next=13;break}return e.next=13,this.store.dispatch("conversation/setSuggestions",t.initialSuggestions);case 13:case"end":return e.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()},{key:"createPlayerInfo",value:function(e){var t=this,n="<b>你的角色：".concat(e.name,"</b>\n    ").concat(e.description);if(e.characterTags){var r=e.characterTags.reduce((function(e,n){var r=t.getCharacterTag(n);return r&&(e+="<br>- ".concat(n,": ").concat(r)),e}),"");n+=r}return n}},{key:"handleSectionEnd",value:function(){var e=(0,o.A)((0,a.A)().mark((function e(){var t,n,r,o,i;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return n=null===(t=this.mainPlayer)||void 0===t?void 0:t.name,r=Li(n,this.store),o=r.handleSectionEnd,e.prev=2,e.next=5,o({section:this.sectionData});case 5:return i=e.sent,e.next=8,this.store.dispatch("interaction/updateInteractionStage",{stage:"收尾",info:"本桥段已结束..."});case 8:return e.next=10,this.store.commit("game/SET_SECTION_ENDED",!0);case 10:return e.abrupt("return",i);case 13:throw e.prev=13,e.t0=e["catch"](2),console.error("处理章节结束失败:",e.t0),e.t0;case 17:case"end":return e.stop()}}),e,this,[[2,13]])})));function t(){return e.apply(this,arguments)}return t}()},{key:"processTurns",value:function(){var e=(0,o.A)((0,a.A)().mark((function e(){var t;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(!this.isRunning){e.next=23;break}return e.prev=1,e.next=4,this.turnManager.startNewTurn();case 4:return t=e.sent,e.next=7,Hi.dispatch("gameState/updateGameState",{summary:t.summary,narration:t.narration});case 7:if(!t.endSectionFlag&&this.isRunning){e.next=13;break}if(!t.endSectionFlag){e.next=11;break}return e.next=11,this.handleSectionEnd();case 11:return this.isRunning=!1,e.abrupt("break",23);case 13:this.turnManager.mainActor=t.nextMainActor,e.next=21;break;case 16:throw e.prev=16,e.t0=e["catch"](1),console.error("处理回合时出错:",e.t0),this.isRunning=!1,e.t0;case 21:e.next=0;break;case 23:case"end":return e.stop()}}),e,this,[[1,16]])})));function t(){return e.apply(this,arguments)}return t}()},{key:"updateAvailableCharacters",value:function(){var e=(0,o.A)((0,a.A)().mark((function e(){var t;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return t=this.getFilteredCharacters(this.turnCount),e.next=3,this.store.commit("gameState/SET_AVAILABLE_CHARACTERS",t);case 3:case"end":return e.stop()}}),e,this)})));function t(){return e.apply(this,arguments)}return t}()},{key:"initializePlotTriggers",value:function(e){this.plotTriggers=e.map((function(e){return(0,s.A)((0,s.A)({},e),{},{consumed:!1,memoryCharacter:e.memoryCharacter||null})}))}},{key:"getCharacterTag",value:function(e){return this.characterTagBase?this.characterTagBase[e]:null}},{key:"updateTriggeredPlots",value:function(e){var t=this,n=[];return e.forEach((function(e){var r=t.plotTriggers.find((function(t){return t.id===e.id}));r&&e.isTriggered&&!r.consumed&&(r.consumed=!0,n.push(r),r.memoryCharacter&&t.aiPlayers[r.memoryCharacter]&&t.aiPlayers[r.memoryCharacter].addPrivateThought(r.content))})),n}},{key:"getFilteredCharacters",value:function(e){if(!this.sectionData||!this.sectionData.characters)return console.warn("No section data or characters found"),[];var t=this.plotTriggers.filter((function(t){if(t.triggerCondition.startsWith("第")){var n=parseInt(t.triggerCondition.replace(/[^0-9]/g,""));return e>=n}return t.consumed})),n=this.sectionData.characters.filter((function(n){if(n.sectionGuidance){var r=n.sectionGuidance.match(/前(\d+)回合.*不在/);if(r){var a=parseInt(r[1]);if(e<=a)return!1}}var o=t.find((function(e){return e.content&&(e.content.includes("".concat(n.name,"退场"))||e.content.includes("".concat(n.name,"离开"))||e.content.includes("".concat(n.name,"不在场")))}));return!o}));return n}},{key:"getAvailableAICharacters",value:function(e){return this.getFilteredCharacters(e).filter((function(e){return e.isAI}))}},{key:"getAvailablePlayerCharacters",value:function(e){return this.getFilteredCharacters(e).filter((function(e){return!e.isAI}))}},{key:"cleanup",value:function(){this.isRunning=!1,this.turnManager&&(this.turnManager.cleanup(),this.turnManager=null),this.moderator&&(this.moderator=null),this.battleEnvironmentManager&&(this.battleEnvironmentManager.cleanup(),this.battleEnvironmentManager=null),Object.values(this.aiPlayers).forEach((function(e){e.cleanup&&e.cleanup()})),this.aiPlayers={}}},{key:"getLocationDescription",value:function(){var e;if(!this.sectionData)return this.logger.warn("无法获取地点描述：sectionData 不存在"),null;var t=null===(e=this.sectionData.cgLocationDescriptions)||void 0===e?void 0:e["default"];return t||(this.logger.warn("无法获取地点描述：cgLocationDescriptions.default 不存在"),null)}}])}(),Mi=function(){return{isLoading:!1,isSubmitting:!1,isCooldown:!1,showTutorial:!1,tutorialContent:{title:"",content:""},selectedCharacter:"罗伯特",currentIsReplay:!1,turnCount:0,inputEnabled:!0,gameManager:null,isSectionEnded:!1,timelineInfluenceModal:{show:!1,timePoint:null,influences:[],onConfirm:null,onCancel:null}}},Pi={SET_LOADING:function(e,t){e.isLoading=t},SET_SUBMITTING:function(e,t){e.isSubmitting=t},SET_COOLDOWN:function(e,t){e.isCooldown=t},SET_SHOW_TUTORIAL:function(e,t){e.showTutorial=t},SET_TUTORIAL_CONTENT:function(e,t){e.tutorialContent=t},SET_SELECTED_CHARACTER:function(e,t){e.selectedCharacter=t},SET_CURRENT_IS_REPLAY:function(e,t){e.currentIsReplay=t},INCREMENT_TURN_COUNT:function(e){e.turnCount++},SET_INPUT_ENABLED:function(e,t){e.inputEnabled=t},SET_GAME_MANAGER:function(e,t){e.gameManager=t},RESET_STATE:function(e){e.gameManager&&e.gameManager.cleanup(),e.isSubmitting=!1,e.isCooldown=!1,e.currentIsReplay=!1,e.turnCount=0,e.inputEnabled=!0,e.isLoading=!1,e.showTutorial=!1,e.tutorialContent={title:"",content:""},e.gameManager=null,e.isSectionEnded=!1,this.commit("conversation/SET_CURRENT_CG",null)},SET_SECTION_ENDED:function(e,t){e.isSectionEnded=t},SHOW_TIMELINE_INFLUENCE_MODAL:function(e,t){var n=t.timePoint,r=t.influences,a=t.onConfirm,o=t.onCancel;e.timelineInfluenceModal={show:!0,timePoint:n,influences:r,onConfirm:a,onCancel:o}},HIDE_TIMELINE_INFLUENCE_MODAL:function(e){e.timelineInfluenceModal={show:!1,timePoint:null,influences:[],onConfirm:null,onCancel:null}}},Oi={initializeGame:function(e){return(0,o.A)((0,a.A)().mark((function t(){var n,r,o,i,s;return(0,a.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(n=e.commit,r=e.dispatch,o=e.rootState,n("SET_LOADING",!0),t.prev=2,i=o.sections.currentSection,i){t.next=6;break}throw new Error("无法获取章节数据");case 6:return t.next=8,r("gameState/processInfluenceChecks",i,{root:!0});case 8:return s=new Ni(o.gameState,i),n("SET_GAME_MANAGER",s),t.next=12,s.setupGame();case 12:return t.prev=12,n("SET_LOADING",!1),t.finish(12);case 15:case"end":return t.stop()}}),t,null,[[2,,12,15]])})))()},showGameTutorial:function(e){var t=e.commit;t("SET_TUTORIAL_CONTENT",{title:r["default"].global.t("tutorial.title"),content:r["default"].global.t("tutorial.content")}),t("SET_SHOW_TUTORIAL",!0)},setInputEnabled:function(e,t){var n=e.commit;n("SET_INPUT_ENABLED",t)},resetState:function(e){var t=e.commit,n=e.state;n.gameManager&&n.gameManager.cleanup(),t("RESET_STATE")},handleSectionEnd:function(e){return(0,o.A)((0,a.A)().mark((function t(){var n,r,o;return(0,a.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(n=e.commit,r=e.state,t.prev=1,r.gameManager){t.next=4;break}throw new Error("GameManager not initialized");case 4:return n("SET_SECTION_ENDED",!0),n("SET_INPUT_ENABLED",!1),t.next=8,r.gameManager.handleSectionEnd();case 8:return o=t.sent,t.abrupt("return",o);case 12:throw t.prev=12,t.t0=t["catch"](1),console.error("处理桥段结束时出错:",t.t0),t.t0;case 16:case"end":return t.stop()}}),t,null,[[1,12]])})))()},cleanup:function(e){var t=e.state;t.gameManager&&t.gameManager.cleanup()},showTimelineInfluenceModal:function(e,t){return(0,o.A)((0,a.A)().mark((function n(){var r,o,i,s,c,l;return(0,a.A)().wrap((function(n){while(1)switch(n.prev=n.next){case 0:return r=e.commit,o=e.rootState,i=t.timePoint,s=t.influences,c=t.existingInfluences,l=void 0===c?[]:c,n.abrupt("return",new Promise((function(e){var t=o.timelineInfluence.timelinePoints.find((function(e){return e.id===i})),n=s.map((function(e){var t,n,r=o.timelineInfluence.globalInfluences.find((function(t){return t.id===e.id})),a=l.find((function(t){return t.id===e.id})),i=null!==(t=e.defaultValue)&&void 0!==t&&t;return{id:e.id,display:r.display,oldValue:null!==(n=null===a||void 0===a?void 0:a.value)&&void 0!==n?n:i,newValue:e.value,defaultValue:i}})),a=function(){r("HIDE_TIMELINE_INFLUENCE_MODAL"),e(!0)},c=function(){r("HIDE_TIMELINE_INFLUENCE_MODAL"),e(!1)};r("SHOW_TIMELINE_INFLUENCE_MODAL",{timePoint:t,influences:n,onConfirm:a,onCancel:c})})));case 3:case"end":return n.stop()}}),n)})))()}},Di={isSubmitting:function(e){return e.isSubmitting},isCooldown:function(e){return e.isCooldown},selectedCharacter:function(e){return e.selectedCharacter},currentIsReplay:function(e){return e.currentIsReplay},turnCount:function(e){return e.turnCount},isInputEnabled:function(e,t,n){var r="等待玩家"===n.interaction.interactionStage.stage;return r&&!e.isSubmitting&&!e.isCooldown},gameManager:function(e){return e.gameManager}};const ji={namespaced:!0,state:Mi,mutations:Pi,actions:Oi,getters:Di};n(4490);var Ui=new lt(!1,"timelineInfluence"),Gi=function(){return{timelinePoints:[],influenceTypes:[],globalInfluences:[],timelineInfluences:[]}},Vi={SET_TIMELINE_POINTS:function(e,t){e.timelinePoints=t},SET_INFLUENCE_TYPES:function(e,t){e.influenceTypes=t},SET_GLOBAL_INFLUENCES:function(e,t){e.globalInfluences=t},ADD_TIMELINE_INFLUENCE:function(e,t){e.timelineInfluences.push(t)},UPDATE_TIMELINE_INFLUENCE:function(e,t){var n=e.timelineInfluences.findIndex((function(e){return e.id===t.id}));-1!==n&&e.timelineInfluences.splice(n,1,t)},SET_TIMELINE_INFLUENCES:function(e,t){e.timelineInfluences=t}},Bi={loadTimelineData:function(e){return(0,o.A)((0,a.A)().mark((function t(){var n,r,o,i,s,c;return(0,a.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:return n=e.commit,t.prev=1,t.next=4,Promise.all([k.u.loadJSON("config/timeline_points.json"),k.u.loadJSON("config/influence_types.json"),k.u.loadJSON("config/global_influences.json")]);case 4:r=t.sent,o=(0,Ia.A)(r,3),i=o[0],s=o[1],c=o[2],n("SET_TIMELINE_POINTS",i.points),n("SET_INFLUENCE_TYPES",s.types),n("SET_GLOBAL_INFLUENCES",c.influences),Ui.log("时间线数据加载成功"),t.next=19;break;case 15:throw t.prev=15,t.t0=t["catch"](1),Ui.error("加载时间线数据失败:",t.t0),t.t0;case 19:case"end":return t.stop()}}),t,null,[[1,15]])})))()},recordInfluence:function(e,t){var n=e.commit,r=e.state;if("objective"!==t.id&&t.id&&"undefined"!==t.id){var a=r.timelineInfluences.find((function(e){return e.id===t.id&&e.timePoint===t.timePoint}));a?(n("UPDATE_TIMELINE_INFLUENCE",t),Ui.log("更新影响记录: ".concat(t.id," 在 ").concat(t.timePoint))):(n("ADD_TIMELINE_INFLUENCE",t),Ui.log("新增影响记录: ".concat(t.id," 在 ").concat(t.timePoint)))}else Ui.log("跳过记录影响点: ".concat(t.id))},loadInfluencesFromSave:function(e,t){var n=e.commit;n("SET_TIMELINE_INFLUENCES",t),Ui.log("从存档加载影响记录")},checkInfluenceVisibility:function(e,t){var n=t.influence,r=t.character,a=t.characterTags;if(!n.visibility)return!0;switch(n.visibility.level){case"public":return!0;case"group":return a.some((function(e){return n.visibility.knownBy.includes(e)}));case"personal":return n.visibility.knownBy.includes(r);case"hidden":return!1;default:return!1}},getVisibleInfluenceNotes:function(e,t){return(0,o.A)((0,a.A)().mark((function n(){var r,o,i,s,c,l,u,p,d,h;return(0,a.A)().wrap((function(n){while(1)switch(n.prev=n.next){case 0:r=e.rootState,o=e.state,i=e.dispatch,s=t.character,c=t.characterTags,l=r.gameState.influenceNotes||[],u=[],p=(0,Ta.A)(l),n.prev=5,h=(0,a.A)().mark((function e(){var t,n,r;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(t=d.value,n=(o.globalInfluences||[]).find((function(e){return e.influenceNotes&&e.influenceNotes.includes(t)})),n){e.next=5;break}return u.push(t),e.abrupt("return",1);case 5:return e.next=7,i("checkInfluenceVisibility",{influence:n,character:s,characterTags:c});case 7:r=e.sent,r&&u.push(t);case 9:case"end":return e.stop()}}),e)})),p.s();case 8:if((d=p.n()).done){n.next=14;break}return n.delegateYield(h(),"t0",10);case 10:if(!n.t0){n.next=12;break}return n.abrupt("continue",12);case 12:n.next=8;break;case 14:n.next=19;break;case 16:n.prev=16,n.t1=n["catch"](5),p.e(n.t1);case 19:return n.prev=19,p.f(),n.finish(19);case 22:return n.abrupt("return",u);case 23:case"end":return n.stop()}}),n,null,[[5,16,19,22]])})))()},checkInfluences:function(e,t){return(0,o.A)((0,a.A)().mark((function n(){var r,i,s,c,l,u,p;return(0,a.A)().wrap((function(n){while(1)switch(n.prev=n.next){case 0:if(r=e.state,i=e.getters,s=e.rootState,c=t.conditions,l=t.type,c&&Array.isArray(c)&&0!==c.length){n.next=4;break}return n.abrupt("return",!1);case 4:return u=s.gameState.sectionTimePoint,Ui.log("🎯 检查影响条件:",{传入的条件:c,条件类型:l||"all",当前桥段时间点:u,时间点列表:r.timelinePoints.map((function(e){return e.id}))}),n.next=8,Promise.all(c.map(function(){var e=(0,o.A)((0,a.A)().mark((function e(t){var n,o,s,c;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return n=t.timePoint||u||"original_time",Ui.log("📌 处理条件 ".concat(t.id,":"),{指定时间点:t.timePoint,桥段时间点:u,最终使用时间点:n,触发者:t.operator||"任意"}),o=i.getInfluencesByTimePoint(n,[t.id])[t.id],s=(null===o||void 0===o?void 0:o.value)===t.value,s&&t.operator&&(c=r.timelineInfluences.find((function(e){return e.id===t.id&&e.timePoint===o.timePoint})),s=!(!c||!c.operator)&&c.operator===t.operator),e.abrupt("return",s);case 6:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 8:return p=n.sent,n.abrupt("return","any"===l?p.some((function(e){return e})):p.every((function(e){return e})));case 10:case"end":return n.stop()}}),n)})))()}},Ki={getInfluenceById:function(e){return function(t){return e.globalInfluences.find((function(e){return e.id===t}))}},getInfluencesByTimePoint:function(e){return function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=(0,ao.A)(e.timelinePoints),a=r.findIndex((function(e){return e.id===t}));if(-1===a)return Ui.warn("时间点 ".concat(t," 未找到，可用时间点: ").concat(r.map((function(e){return e.id})).join(", "))),{};var o=r.slice(0,a+1).reverse(),i=e.timelineInfluences.filter((function(e){return!n||n.includes(e.id)}));Ui.log(Ra.formatTimelineCheck({timePoint:t,relevantPoints:o.map((function(e){return e.id})),influenceRecords:i.map((function(e){return{id:e.id,timePoint:e.timePoint,value:e.value}}))}));var s={},c=n?e.globalInfluences.filter((function(e){return n.includes(e.id)})):e.globalInfluences;return c.forEach((function(t){var n,r=t.id,a=null,i=null,c="默认值",l=(0,Ta.A)(o);try{var u,p=function(){var o,s=n.value,l=e.timelineInfluences.find((function(e){return e.id===r&&e.timePoint===s.id}));if(l)return a=l.value,i=s.id,c="玩家记录",0;var u=null===(o=t.defaults)||void 0===o?void 0:o.find((function(e){return e.timePoint===s.id}));return u&&!i?(a=u.value,i=s.id,c="时间点默认值",0):void 0};for(l.s();!(n=l.n()).done;)if(u=p(),0===u)break}catch(f){l.e(f)}finally{l.f()}if(null===a){var d,h,g=null===(d=t.defaults)||void 0===d?void 0:d.find((function(e){return"original_time"===e.timePoint}));a=null!==(h=null===g||void 0===g?void 0:g.value)&&void 0!==h&&h,c="original_time默认值"}s[r]={value:a,display:t.display,timePoint:i||"original_time"},Ui.log(Ra.formatInfluenceResult({id:r,timePoint:i,value:a,source:c}))})),s}},isInfluenceActive:function(e,t){return function(e,n){var r,a,o=t.getInfluencesByTimePoint(n,[e]),i=null!==(r=null===(a=o[e])||void 0===a?void 0:a.value)&&void 0!==r&&r;return Ui.log("\n✨ 影响点状态查询\n========================\n• ID：".concat(e,"\n• 时间点：").concat(n,"\n• 当前状态：").concat(i?"激活":"未激活","\n========================")),i}}};const Fi={namespaced:!0,state:Gi,mutations:Vi,actions:Bi,getters:Ki},Hi=(0,K.y$)({modules:{gameState:ja,conversation:Ka,tutorial:ro,api:Po,sections:Wo,story:Qo,interaction:ti,save:hi,review:bi,settings:Ao,ui:wi,game:ji,timelineInfluence:Fi}});var zi={install:function(e){var t=(0,l.KR)({show:!1,title:"",content:"",closeButtonText:"关闭",buttons:[],large:!1}),n={show:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};t.value=(0,s.A)((0,s.A)({},t.value),{},{show:!0},n)},hide:function(){t.value.show=!1}};e.provide("$modal",n);var r=(0,i.Ef)({setup:function(){return function(){return(0,c.h)(b,(0,s.A)((0,s.A)({},t.value),{},{"onUpdate:show":function(e){return t.value.show=e},onClose:function(){return n.hide()}}))}}}),a=document.createElement("div");document.body.appendChild(a),r.mount(a)}};const Wi=zi;console.log("Starting app initialization..."),console.log("Environment:",{NODE_ENV:"production",VUE_APP_DEPLOY_TARGET:{NODE_ENV:"production",BASE_URL:"/vue/"}.VUE_APP_DEPLOY_TARGET,BASE_URL:"/vue/"});var Xi=(0,i.Ef)(ke),Ji=new lt(!1);function qi(){return Qi.apply(this,arguments)}function Qi(){return Qi=(0,o.A)((0,a.A)().mark((function e(){return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.prev=0,console.log("Loading settings..."),e.next=4,bo();case 4:console.log("Mounting app..."),Xi.mount("#app"),console.log("App mounted successfully"),ct.setModal(Xi.config.globalProperties.$modal),e.next=14;break;case 10:e.prev=10,e.t0=e["catch"](0),console.error("初始化失败:",e.t0),document.querySelector(".test-text").textContent="初始化失败: "+e.t0.message;case 14:case"end":return e.stop()}}),e,null,[[0,10]])}))),Qi.apply(this,arguments)}Xi.config.errorHandler=function(e,t,n){console.error("Vue Error:",e),console.log("Component:",t),console.log("Error Info:",n);var r=document.createElement("div");r.style.cssText="\n    position: fixed;\n    top: 50%;\n    left: 50%;\n    transform: translate(-50%, -50%);\n    background: white;\n    padding: 20px;\n    border-radius: 8px;\n    box-shadow: 0 2px 8px rgba(0,0,0,0.1);\n    z-index: 10000;\n    max-width: 80%;\n    word-break: break-word;\n  ",r.innerHTML="\n    <h3>Error:</h3>\n    <pre>".concat(e.stack||e.message,"</pre>\n  "),document.body.appendChild(r)},$a(Xi),Xi.use(Hi),Xi.use(Ca),Xi.use(Wi),Xi.config.globalProperties.$logger=Ji,qi()},9410:(e,t,n)=>{"use strict";n.d(t,{u:()=>u});var r=n(4048),a=n(388),o=n(5026),i=n(9492),s=(n(6280),n(6918),n(8706),n(2008),n(4346),n(2062),n(6033),n(9432),n(6099),n(7495),n(7764),n(1761),n(5440),n(1392),n(2953),{IS_DEV:!1,IS_ITCH:"itch"==={NODE_ENV:"production",BASE_URL:"/vue/"}.VUE_APP_DEPLOY_TARGET,get BASE_URL(){return this.IS_ITCH?".":this.IS_DEV?"":"/vue"},getAssetPath:function(e){return e?e.startsWith("http")?e:this.IS_ITCH?"./".concat(e):this.IS_DEV?"/".concat(e):"".concat(this.BASE_URL,"/").concat(e):null}});function c(e){return e.replace(/\\/g,"/")}var l=function(){function e(){(0,o.A)(this,e),this.cache=new Map,this.configCache=new Map,this.langCache=new Map,this.imageCache=new Map}return(0,i.A)(e,[{key:"loadJSON",value:function(){var e=(0,a.A)((0,r.A)().mark((function e(t){var n,a,o,i,l,u,p,d,h,g,f;return(0,r.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(n=c(t.replace(/^\/+/,"")),a="json:".concat(n),!this.cache.has(a)){e.next=4;break}return e.abrupt("return",this.cache.get(a));case 4:if(e.prev=4,!s.IS_ITCH){e.next=19;break}return i="assets/".concat(n),l="./".concat(i),e.next=10,fetch(l);case 10:if(u=e.sent,u.ok){e.next=13;break}throw new Error("加载JSON失败: ".concat(u.status," ").concat(u.statusText));case 13:return e.next=15,u.text();case 15:p=e.sent,o=JSON.parse(p),e.next=30;break;case 19:return d="assets/".concat(n),h=s.getAssetPath(d),e.next=23,fetch(h);case 23:if(g=e.sent,g.ok){e.next=26;break}throw new Error("加载JSON失败: ".concat(g.status," ").concat(g.statusText));case 26:return e.next=28,g.text();case 28:f=e.sent,o=JSON.parse(f);case 30:return this.cache.set(a,o),e.abrupt("return",o);case 34:throw e.prev=34,e.t0=e["catch"](4),console.error("JSON加载失败:",{path:n,error:e.t0.message}),e.t0;case 38:case"end":return e.stop()}}),e,this,[[4,34]])})));function t(t){return e.apply(this,arguments)}return t}()},{key:"getImageUrl",value:function(e){if(!e)return null;if(e.startsWith("http"))return e;var t=c(e.replace(/^\/+/,"")),n=t.startsWith("assets/")?t:"assets/".concat(t),r=n.replace(/\/+/g,"/");return s.getAssetPath(r)}},{key:"loadText",value:function(){var e=(0,a.A)((0,r.A)().mark((function e(t){var n,a,o,i,l,u,p,d,h;return(0,r.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(n=c(t.replace(/^\/+/,"")),a="text:".concat(n),!this.cache.has(a)){e.next=4;break}return e.abrupt("return",this.cache.get(a));case 4:if(e.prev=4,!s.IS_ITCH){e.next=18;break}return i="assets/".concat(n),l="./".concat(i),e.next=10,fetch(l);case 10:if(u=e.sent,u.ok){e.next=13;break}throw new Error("加载文本失败: ".concat(u.status," ").concat(u.statusText));case 13:return e.next=15,u.text();case 15:o=e.sent,e.next=28;break;case 18:return p="assets/".concat(n),d=s.getAssetPath(p),e.next=22,fetch(d);case 22:if(h=e.sent,h.ok){e.next=25;break}throw new Error("加载文本失败: ".concat(h.status," ").concat(h.statusText));case 25:return e.next=27,h.text();case 27:o=e.sent;case 28:return this.cache.set(a,o),e.abrupt("return",o);case 32:throw e.prev=32,e.t0=e["catch"](4),console.error("文本加载失败:",{path:n,error:e.t0.message}),e.t0;case 36:case"end":return e.stop()}}),e,this,[[4,32]])})));function t(t){return e.apply(this,arguments)}return t}()},{key:"preloadImage",value:function(){var e=(0,a.A)((0,r.A)().mark((function e(t){var n,a,o,i=this;return(0,r.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(t){e.next=2;break}return e.abrupt("return",null);case 2:if(n=c(t),a="image:".concat(n),!this.imageCache.has(a)){e.next=6;break}return e.abrupt("return",this.imageCache.get(a));case 6:if(e.prev=6,o=this.getImageUrl(n),o){e.next=10;break}throw new Error("无效的图片路径");case 10:return e.abrupt("return",new Promise((function(e,t){var r=new Image;r.onload=function(){i.imageCache.set(a,o),e(o)},r.onerror=function(){return t(new Error("图片加载失败: ".concat(n)))},r.src=o})));case 13:throw e.prev=13,e.t0=e["catch"](6),console.error("预加载图片失败:",{path:n,error:e.t0.message}),e.t0;case 17:case"end":return e.stop()}}),e,this,[[6,13]])})));function t(t){return e.apply(this,arguments)}return t}()},{key:"preloadImages",value:function(){var e=(0,a.A)((0,r.A)().mark((function e(t){var n,a,o=this;return(0,r.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(Array.isArray(t)){e.next=3;break}return console.warn("preloadImages: paths 不是数组"),e.abrupt("return",[]);case 3:return console.log("开始批量预加载图片:",t),n=t.filter((function(e){return e&&"string"===typeof e})).map((function(e){return o.preloadImage(e)["catch"]((function(t){return console.warn("预加载图片失败，继续处理其他图片:",{path:e,error:t.message}),null}))})),e.next=7,Promise.all(n);case 7:return a=e.sent,console.log("批量预加载完成，成功加载:",a.filter(Boolean).length,"张图片"),e.abrupt("return",a.filter(Boolean));case 10:case"end":return e.stop()}}),e)})));function t(t){return e.apply(this,arguments)}return t}()},{key:"clearCache",value:function(){this.cache.clear(),this.configCache.clear(),this.langCache.clear(),this.imageCache.clear(),console.log("已清除所有缓存")}},{key:"loadConfig",value:function(){var e=(0,a.A)((0,r.A)().mark((function e(t){var n;return(0,r.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return console.log("Loading config:",t),e.prev=1,e.next=4,this.loadJSON("config/".concat(t));case 4:return n=e.sent,console.log("Config loaded:",n),e.abrupt("return",n);case 9:throw e.prev=9,e.t0=e["catch"](1),console.error("Failed to load config:",t,e.t0),e.t0;case 13:case"end":return e.stop()}}),e,this,[[1,9]])})));function t(t){return e.apply(this,arguments)}return t}()},{key:"loadLang",value:function(){var e=(0,a.A)((0,r.A)().mark((function e(t){return(0,r.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.abrupt("return",this.loadJSON("lang/".concat(t)));case 1:case"end":return e.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()},{key:"checkImageExists",value:function(e){var t=this;return new Promise((function(n,r){var a=new Image;a.onload=function(){return n(!0)},a.onerror=function(){return r(new Error("Image not found: ".concat(e)))},a.src=t.getImageUrl(e)}))}},{key:"getDirectories",value:function(){var e=(0,a.A)((0,r.A)().mark((function e(){var t,n;return(0,r.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.prev=0,t={}.glob("/src/assets/scenarios/*/config.json",{eager:!0}),n=Object.keys(t).map((function(e){var t=e.match(/\/src\/assets\/scenarios\/(.+)\/config\.json/);return t?t[1]:null})).filter(Boolean),console.log("找到的剧本目录:",n),e.abrupt("return",n);case 7:return e.prev=7,e.t0=e["catch"](0),console.error("获取剧本目录失败:",e.t0),e.abrupt("return",[]);case 11:case"end":return e.stop()}}),e,null,[[0,7]])})));function t(){return e.apply(this,arguments)}return t}()},{key:"loadJson",value:function(){var e=(0,a.A)((0,r.A)().mark((function e(t){var a;return(0,r.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,n(8388)("./".concat(t));case 3:return a=e.sent,e.abrupt("return",a["default"]);case 7:throw e.prev=7,e.t0=e["catch"](0),console.error("加载 JSON 失败:",e.t0),e.t0;case 11:case"end":return e.stop()}}),e,null,[[0,7]])})));function t(t){return e.apply(this,arguments)}return t}()},{key:"getVideoUrl",value:function(e){if(!e)return null;if(e.startsWith("http"))return e;var t=c(e.replace(/^\/+/,"")),n=t.startsWith("assets/")?t:"assets/".concat(t),r=n.replace(/\/+/g,"/");return s.getAssetPath(r)}},{key:"preloadVideo",value:function(){var e=(0,a.A)((0,r.A)().mark((function e(t){var n,a,o,i=this;return(0,r.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(t){e.next=2;break}return e.abrupt("return",null);case 2:if(n=c(t),a="video:".concat(n),!this.cache.has(a)){e.next=6;break}return e.abrupt("return",this.cache.get(a));case 6:if(e.prev=6,o=this.getVideoUrl(n),o){e.next=10;break}throw new Error("无效的视频路径");case 10:return e.abrupt("return",new Promise((function(e,t){var r=document.createElement("video");r.preload="auto",r.onloadeddata=function(){i.cache.set(a,o),e(o)},r.onerror=function(){return t(new Error("视频加载失败: ".concat(n)))},r.src=o})));case 13:throw e.prev=13,e.t0=e["catch"](6),console.error("预加载视频失败:",{path:n,error:e.t0.message}),e.t0;case 17:case"end":return e.stop()}}),e,this,[[6,13]])})));function t(t){return e.apply(this,arguments)}return t}()}])}(),u=new l;s.IS_DEV&&(window._resourceLoader=u)},6083:(e,t,n)=>{"use strict";n.d(t,{A:()=>c});n(4423);var r=n(641),a=["disabled"],o={class:"relative z-10 flex items-center gap-2"};const i={__name:"GameButton",props:{type:{type:String,default:"default",validator:function(e){return["primary","secondary","danger","default","ghost"].includes(e)}},size:{type:String,default:"default",validator:function(e){return["sm","default","lg"].includes(e)}},disabled:{type:Boolean,default:!1}},setup:function(e){var t={sm:"py-1.5 text-sm min-h-[32px]",default:"py-2 text-base min-h-[36px]",lg:"py-3 text-lg min-h-[44px]"},n={primary:"\n    border-2\n    !border-tech-primary/30 \n    hover:!border-tech-primary \n    bg-tech-primary \n    text-white \n    hover:bg-tech-primary/90 \n    shadow-md \n    hover:shadow-lg\n    transition-all\n    duration-300\n  ",secondary:"\n    border-2\n    !border-tech-accent/30 \n    hover:!border-tech-accent \n    bg-tech-accent \n    text-white \n    hover:bg-tech-accent/90 \n    shadow-md \n    hover:shadow-lg\n    transition-all\n    duration-300\n  ",danger:"\n    border-2\n    !border-red-500/30 \n    hover:!border-red-500 \n    bg-red-500 \n    text-white \n    hover:bg-red-600 \n    shadow-md \n    hover:shadow-lg\n    transition-all\n    duration-300\n  ",default:"\n    border-2\n    !border-gray-200 \n    hover:!border-tech-primary \n    bg-white \n    text-tech-primary \n    hover:text-tech-primary/90\n    hover:bg-gray-50\n    shadow-sm \n    hover:shadow-md\n    transition-all\n    duration-300\n  ",ghost:"\n    border-2\n    !border-gray-200\n    hover:!border-tech-primary\n    bg-white \n    text-tech-primary \n    hover:bg-gray-50/50\n    shadow-sm \n    hover:shadow \n    transition-all\n    duration-300\n  "};return function(i,s){return(0,r.uX)(),(0,r.CE)("button",(0,r.v6)({class:["relative overflow-hidden rounded-lg","font-medium tracking-wide flex items-center justify-center gap-2","active:scale-[0.98] transition-all duration-300","min-h-[36px]","px-4","border-2",t[e.size],n[e.type],{"opacity-50 cursor-not-allowed":e.disabled}],disabled:e.disabled},i.$attrs),[(0,r.Lk)("div",o,[(0,r.RG)(i.$slots,"icon"),(0,r.RG)(i.$slots,"default")]),s[0]||(s[0]=(0,r.Lk)("div",{class:"absolute inset-0 opacity-0 hover:opacity-20 transition-opacity duration-300 bg-white"},null,-1))],16,a)}}},s=i,c=s},8388:(e,t,n)=>{var r={"./config/characterAppearance":[8718,1,8718],"./config/characterAppearance.json":[8718,1,8718],"./config/characterTagBase":[5601,1,5601],"./config/characterTagBase.json":[5601,1,5601],"./config/colors":[8213,1,8213],"./config/colors.json":[8213,1,8213],"./config/global_influences":[5651,1,5651],"./config/global_influences.json":[5651,1,5651],"./config/influence_types":[6305,1,8686],"./config/influence_types.json":[6305,1,8686],"./config/timeline_points":[2576,1,2576],"./config/timeline_points.json":[2576,1,2576],"./config/version":[591,1,591],"./config/version.json":[591,1,591],"./fonts/unifont-16.0.01.otf":[4305,1],"./icon/BeyondBooksIcon.ico":[9762,1,9762],"./icon/settings-icon.png":[6764,1,6764],"./images/MotherTree.png":[2937,1,2937],"./images/TitleShow.png":[9163,1,9163],"./lang/terms_explanations_zh-CN":[2448,1,2448],"./lang/terms_explanations_zh-CN.json":[2448,1,2448],"./portrait/airin.png":[8772,1,8772],"./portrait/caspar.png":[7993,1,7993],"./portrait/clement.png":[3627,1,3627],"./portrait/corn.png":[1635,1,1635],"./portrait/jerry.png":[5761,1,5761],"./portrait/joan.png":[109,1,109],"./portrait/norton.png":[1369,1,1369],"./portrait/robert.png":[3781,1,3781],"./portrait/stuart.png":[8288,1,8288],"./portrait/tanaka_ren.png":[1789,1,1789],"./portrait/tours.png":[872,1,872],"./portrait/xinnia.png":[9594,1,9594],"./scenarios/silver_moon/background.png":[6585,1,6585],"./scenarios/silver_moon/characters/robert/section_thumbnail/thumbnail-1.jpg":[5448,1,5448],"./scenarios/silver_moon/characters/robert/section_thumbnail/thumbnail-10.jpg":[1122,1,1122],"./scenarios/silver_moon/characters/robert/section_thumbnail/thumbnail-11.jpg":[2831,1,2831],"./scenarios/silver_moon/characters/robert/section_thumbnail/thumbnail-12.jpg":[5456,1,5456],"./scenarios/silver_moon/characters/robert/section_thumbnail/thumbnail-13.jpg":[349,1,349],"./scenarios/silver_moon/characters/robert/section_thumbnail/thumbnail-14.jpg":[4150,1,4150],"./scenarios/silver_moon/characters/robert/section_thumbnail/thumbnail-15.jpg":[4259,1,4259],"./scenarios/silver_moon/characters/robert/section_thumbnail/thumbnail-16.jpg":[4548,1,4548],"./scenarios/silver_moon/characters/robert/section_thumbnail/thumbnail-17.jpg":[6353,1,6353],"./scenarios/silver_moon/characters/robert/section_thumbnail/thumbnail-18.jpg":[5242,1,5242],"./scenarios/silver_moon/characters/robert/section_thumbnail/thumbnail-2.jpg":[4375,1,4375],"./scenarios/silver_moon/characters/robert/section_thumbnail/thumbnail-21.jpg":[5114,1,5114],"./scenarios/silver_moon/characters/robert/section_thumbnail/thumbnail-3.jpg":[5370,1,5370],"./scenarios/silver_moon/characters/robert/section_thumbnail/thumbnail-4.jpg":[4313,1,4313],"./scenarios/silver_moon/characters/robert/section_thumbnail/thumbnail-5.jpg":[588,1,588],"./scenarios/silver_moon/characters/robert/section_thumbnail/thumbnail-6.jpg":[8283,1,8283],"./scenarios/silver_moon/characters/robert/section_thumbnail/thumbnail-7.jpg":[1822,1,1822],"./scenarios/silver_moon/characters/robert/section_thumbnail/thumbnail-8.jpg":[6829,1,6829],"./scenarios/silver_moon/characters/robert/section_thumbnail/thumbnail-9.jpg":[3376,1,3376],"./scenarios/silver_moon/characters/robert/sections":[5296,1,5296],"./scenarios/silver_moon/characters/robert/sections.json":[5296,1,5296],"./scenarios/silver_moon/characters/robert/sections/hashRecord":[5904,1,5904],"./scenarios/silver_moon/characters/robert/sections/hashRecord.json":[5904,1,5904],"./scenarios/silver_moon/characters/robert/sections/section_1.bbs":[945,1,945],"./scenarios/silver_moon/characters/robert/sections/section_10.bbs":[3625,1,3625],"./scenarios/silver_moon/characters/robert/sections/section_11.bbs":[712,1,712],"./scenarios/silver_moon/characters/robert/sections/section_12.bbs":[5763,1,5763],"./scenarios/silver_moon/characters/robert/sections/section_13.bbs":[4634,1,4634],"./scenarios/silver_moon/characters/robert/sections/section_14.bbs":[589,1,589],"./scenarios/silver_moon/characters/robert/sections/section_15.bbs":[748,1,748],"./scenarios/silver_moon/characters/robert/sections/section_16.bbs":[7175,1,7175],"./scenarios/silver_moon/characters/robert/sections/section_17.bbs":[9150,1,9150],"./scenarios/silver_moon/characters/robert/sections/section_18.bbs":[481,1,481],"./scenarios/silver_moon/characters/robert/sections/section_2.bbs":[7250,1,7250],"./scenarios/silver_moon/characters/robert/sections/section_21.bbs":[3633,1,3633],"./scenarios/silver_moon/characters/robert/sections/section_3.bbs":[5931,1,5931],"./scenarios/silver_moon/characters/robert/sections/section_4.bbs":[4372,1,4372],"./scenarios/silver_moon/characters/robert/sections/section_5.bbs":[4997,1,4997],"./scenarios/silver_moon/characters/robert/sections/section_6.bbs":[6694,1,6694],"./scenarios/silver_moon/characters/robert/sections/section_7.bbs":[3823,1,3823],"./scenarios/silver_moon/characters/robert/sections/section_8.bbs":[2136,1,2136],"./scenarios/silver_moon/characters/robert/sections/section_9.bbs":[4521,1,4521],"./scenarios/silver_moon/config":[4688,1,4688],"./scenarios/silver_moon/config.json":[4688,1,4688],"./scenarios/silver_moon/cover.png":[364,1,364],"./scenarios/silver_moon/thumbnail.png":[1185,1,1185],"./styles/main.css":[3408,9,3408],"./videos/homeView_background.mp4":[9109,1,9109]};function a(e){if(!n.o(r,e))return Promise.resolve().then((()=>{var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}));var t=r[e],a=t[0];return Promise.all(t.slice(2).map(n.e)).then((()=>n.t(a,16|t[1])))}a.keys=()=>Object.keys(r),a.id=8388,e.exports=a},4305:(e,t,n)=>{"use strict";e.exports=n.p+"assets/fonts/unifont-16.0.01.6ebf3f4a.otf"},477:()=>{}},t={};function n(r){var a=t[r];if(void 0!==a)return a.exports;var o=t[r]={exports:{}};return e[r].call(o.exports,o,o.exports,n),o.exports}n.m=e,(()=>{var e=[];n.O=(t,r,a,o)=>{if(!r){var i=1/0;for(u=0;u<e.length;u++){for(var[r,a,o]=e[u],s=!0,c=0;c<r.length;c++)(!1&o||i>=o)&&Object.keys(n.O).every((e=>n.O[e](r[c])))?r.splice(c--,1):(s=!1,o<i&&(i=o));if(s){e.splice(u--,1);var l=a();void 0!==l&&(t=l)}}return t}o=o||0;for(var u=e.length;u>0&&e[u-1][2]>o;u--)e[u]=e[u-1];e[u]=[r,a,o]}})(),(()=>{n.n=e=>{var t=e&&e.__esModule?()=>e["default"]:()=>e;return n.d(t,{a:t}),t}})(),(()=>{var e,t=Object.getPrototypeOf?e=>Object.getPrototypeOf(e):e=>e.__proto__;n.t=function(r,a){if(1&a&&(r=this(r)),8&a)return r;if("object"===typeof r&&r){if(4&a&&r.__esModule)return r;if(16&a&&"function"===typeof r.then)return r}var o=Object.create(null);n.r(o);var i={};e=e||[null,t({}),t([]),t(t)];for(var s=2&a&&r;"object"==typeof s&&!~e.indexOf(s);s=t(s))Object.getOwnPropertyNames(s).forEach((e=>i[e]=()=>r[e]));return i["default"]=()=>r,n.d(o,i),o}})(),(()=>{n.d=(e,t)=>{for(var r in t)n.o(t,r)&&!n.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})}})(),(()=>{n.f={},n.e=e=>Promise.all(Object.keys(n.f).reduce(((t,r)=>(n.f[r](e,t),t)),[]))})(),(()=>{n.u=e=>"assets/js/"+e+"."+{109:"51927aef",349:"e7b9f0f5",364:"98f96dc8",481:"56c6581f",588:"a960c1fa",589:"76fa8de6",591:"4db8abe8",712:"ca9df997",748:"e7969ab9",872:"85cecabc",945:"2d68bc2b",1122:"33e21924",1185:"214ce2a5",1369:"130880d3",1635:"2fc939c4",1789:"da88b53a",1822:"298b6820",2136:"d891f674",2448:"89014da5",2576:"38f7ed5e",2831:"93f0fda6",2937:"0b9e5cba",3376:"06ff16f5",3408:"a57d6f50",3625:"3345c757",3627:"6474e8bb",3633:"072a2455",3781:"d86983dc",3823:"a0dafcde",4150:"afec9119",4259:"ff10a872",4313:"b8ce4d17",4372:"65d09e7c",4375:"960cafb2",4521:"d6ecbc7a",4545:"5d31d696",4548:"761cb0a9",4634:"c89bbbf2",4688:"7772f2f4",4997:"b50d790d",5114:"5a5bf06e",5242:"50f14038",5296:"e34ca1ef",5370:"7684f515",5448:"596010d4",5456:"4ca75211",5601:"4a3500cc",5651:"909bc4a2",5761:"2fdaa200",5763:"596f1486",5904:"ffe6c078",5931:"a7768035",6353:"d2d33d8a",6585:"9b37505e",6694:"9d47afa6",6764:"d389ca4b",6829:"1ba86469",7175:"3742077b",7213:"f4840b7e",7250:"0cfddb16",7993:"fef6108e",8213:"2dea45af",8283:"deff07d3",8288:"355d62cc",8686:"0f42a6f7",8718:"9f73136b",8772:"fba1db24",9109:"e20b53f5",9150:"c801c403",9163:"cb6a21bb",9594:"21faecf6",9640:"3c6d75c7",9762:"e7c42960"}[e]+".js"})(),(()=>{n.miniCssF=e=>"assets/css/"+e+"."+{4545:"d930511e",7213:"e12dcdf2",9640:"da63e35b"}[e]+".css"})(),(()=>{n.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"===typeof window)return window}}()})(),(()=>{n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t)})(),(()=>{var e={},t="beyond-books-vue:";n.l=(r,a,o,i)=>{if(e[r])e[r].push(a);else{var s,c;if(void 0!==o)for(var l=document.getElementsByTagName("script"),u=0;u<l.length;u++){var p=l[u];if(p.getAttribute("src")==r||p.getAttribute("data-webpack")==t+o){s=p;break}}s||(c=!0,s=document.createElement("script"),s.charset="utf-8",s.timeout=120,n.nc&&s.setAttribute("nonce",n.nc),s.setAttribute("data-webpack",t+o),s.src=r),e[r]=[a];var d=(t,n)=>{s.onerror=s.onload=null,clearTimeout(h);var a=e[r];if(delete e[r],s.parentNode&&s.parentNode.removeChild(s),a&&a.forEach((e=>e(n))),t)return t(n)},h=setTimeout(d.bind(null,void 0,{type:"timeout",target:s}),12e4);s.onerror=d.bind(null,s.onerror),s.onload=d.bind(null,s.onload),c&&document.head.appendChild(s)}}})(),(()=>{n.r=e=>{"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}})(),(()=>{n.p="/vue/"})(),(()=>{if("undefined"!==typeof document){var e=(e,t,r,a,o)=>{var i=document.createElement("link");i.rel="stylesheet",i.type="text/css",n.nc&&(i.nonce=n.nc);var s=n=>{if(i.onerror=i.onload=null,"load"===n.type)a();else{var r=n&&n.type,s=n&&n.target&&n.target.href||t,c=new Error("Loading CSS chunk "+e+" failed.\n("+r+": "+s+")");c.name="ChunkLoadError",c.code="CSS_CHUNK_LOAD_FAILED",c.type=r,c.request=s,i.parentNode&&i.parentNode.removeChild(i),o(c)}};return i.onerror=i.onload=s,i.href=t,r?r.parentNode.insertBefore(i,r.nextSibling):document.head.appendChild(i),i},t=(e,t)=>{for(var n=document.getElementsByTagName("link"),r=0;r<n.length;r++){var a=n[r],o=a.getAttribute("data-href")||a.getAttribute("href");if("stylesheet"===a.rel&&(o===e||o===t))return a}var i=document.getElementsByTagName("style");for(r=0;r<i.length;r++){a=i[r],o=a.getAttribute("data-href");if(o===e||o===t)return a}},r=r=>new Promise(((a,o)=>{var i=n.miniCssF(r),s=n.p+i;if(t(i,s))return a();e(r,s,null,a,o)})),a={3524:0};n.f.miniCss=(e,t)=>{var n={4545:1,7213:1,9640:1};a[e]?t.push(a[e]):0!==a[e]&&n[e]&&t.push(a[e]=r(e).then((()=>{a[e]=0}),(t=>{throw delete a[e],t})))}}})(),(()=>{var e={3524:0};n.f.j=(t,r)=>{var a=n.o(e,t)?e[t]:void 0;if(0!==a)if(a)r.push(a[2]);else{var o=new Promise(((n,r)=>a=e[t]=[n,r]));r.push(a[2]=o);var i=n.p+n.u(t),s=new Error,c=r=>{if(n.o(e,t)&&(a=e[t],0!==a&&(e[t]=void 0),a)){var o=r&&("load"===r.type?"missing":r.type),i=r&&r.target&&r.target.src;s.message="Loading chunk "+t+" failed.\n("+o+": "+i+")",s.name="ChunkLoadError",s.type=o,s.request=i,a[1](s)}};n.l(i,c,"chunk-"+t,t)}},n.O.j=t=>0===e[t];var t=(t,r)=>{var a,o,[i,s,c]=r,l=0;if(i.some((t=>0!==e[t]))){for(a in s)n.o(s,a)&&(n.m[a]=s[a]);if(c)var u=c(n)}for(t&&t(r);l<i.length;l++)o=i[l],n.o(e,o)&&e[o]&&e[o][0](),e[o]=0;return n.O(u)},r=self["webpackChunkbeyond_books_vue"]=self["webpackChunkbeyond_books_vue"]||[];r.forEach(t.bind(null,0)),r.push=t.bind(null,r.push.bind(r))})();var r=n.O(void 0,[504],(()=>n(6914)));r=n.O(r)})();