(()=>{var e={402:(e,t,n)=>{"use strict";var r={};n.r(r),n.d(r,{R:()=>Ft,s:()=>Vt});var a=n(4048),o=n(388),i=(n(3792),n(3362),n(9085),n(9391),n(3751)),s=n(1034),c=(n(2675),n(9463),n(641)),u=n(953),l=n(33),p=["innerHTML"],d={class:"button-container"};const g=Object.assign({name:"ModalDialog"},{__name:"ModalDialog",props:{show:{type:Boolean,required:!0},title:{type:String,default:""},content:{type:String,default:""},closeButtonText:{type:String,default:"关闭"},closeOnBackdrop:{type:Boolean,default:!0},large:{type:Boolean,default:!1}},emits:["close"],setup:function(e,t){var n=t.emit,r=e,a=n,o=function(){a("close")};return(0,c.wB)((function(){return r.show}),(function(e){document.body.style.overflow=e?"hidden":""})),(0,c.xo)((function(){document.body.style.overflow=""})),function(t,n){return(0,c.uX)(),(0,c.Wv)(i.eB,{name:"modal-fade"},{default:(0,c.k6)((function(){return[e.show?((0,c.uX)(),(0,c.CE)("div",{key:0,class:"modal",onClick:n[0]||(n[0]=(0,i.D$)((function(t){return e.closeOnBackdrop&&o()}),["self"]))},[(0,c.Lk)("div",{class:(0,l.C4)(["modal-content",{"modal-large":e.large}])},[(0,c.Lk)("h2",null,(0,l.v_)(e.title),1),(0,c.Lk)("div",{class:"modal-scroll",innerHTML:e.content},null,8,p),(0,c.Lk)("div",d,[(0,c.RG)(t.$slots,"buttons",{},(function(){return[(0,c.Lk)("button",{class:"button",onClick:o},(0,l.v_)(e.closeButtonText),1)]}))])],2)])):(0,c.Q3)("",!0)]})),_:3})}}});var h=n(6262);const v=(0,h.A)(g,[["__scopeId","data-v-9985e8d8"]]),f=v;n(8706),n(1392),n(6031),n(6280),n(6918),n(1629),n(2062),n(4114),n(4782),n(6910),n(3288),n(9432),n(6099),n(6034),n(8940),n(4864),n(7465),n(7495),n(7745),n(8781),n(7764),n(5440),n(375),n(3500),n(2953);var m=n(3019),S=(0,u.KR)({terms:{}}),A=(0,u.KR)({colors:{}}),y=function(){var e=(0,o.A)((0,a.A)().mark((function e(){var t,n,r;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.prev=0,t=(0,m.D)(),e.next=4,fetch("".concat(t,"/lang/terms_explanations_zh-CN.json?v=").concat((new Date).getTime()));case 4:return n=e.sent,e.next=7,n.json();case 7:r=e.sent,S.value=r,e.next=14;break;case 11:e.prev=11,e.t0=e["catch"](0),console.error("加载名词配置文件时出错:",e.t0);case 14:x();case 15:case"end":return e.stop()}}),e,null,[[0,11]])})));return function(){return e.apply(this,arguments)}}(),E=function(){var e=(0,o.A)((0,a.A)().mark((function e(){var t,n,r;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.prev=0,t=(0,m.D)(),e.next=4,fetch("".concat(t,"/config/colors.json?v=").concat((new Date).getTime()));case 4:return n=e.sent,e.next=7,n.json();case 7:r=e.sent,A.value=r,e.next=14;break;case 11:e.prev=11,e.t0=e["catch"](0),console.error("加载色盘配置文件时出错:",e.t0);case 14:case"end":return e.stop()}}),e,null,[[0,11]])})));return function(){return e.apply(this,arguments)}}();function b(e){var t=e.replace("#",""),n=parseInt(t.substr(0,2),16),r=parseInt(t.substr(2,2),16),a=parseInt(t.substr(4,2),16),o=.299*n+.587*r+.114*a;return o<128}function w(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",n=S.value.terms,r=A.value.colors,a=[],o=2,i={};return Object.keys(n).forEach((function(s){if(s!==t){var c,u=r[n[s].color]||n[s].color,l=new RegExp(s,"g");while(null!==(c=l.exec(e)))if(i[s]=(i[s]||0)+1,i[s]<=o){var p=b(u),d=p?"-1px -1px 2px #222, 1px -1px 2px #222, -1px 1px 2px #222, 1px 1px 2px #222":"-1px -1px 2px #000, 1px -1px 2px #000, -1px 1px 2px #000, 1px 1px 2px #000";a.push({term:s,start:c.index,end:c.index+s.length,color:u,textShadow:d})}}})),a.sort((function(e,t){return t.start-e.start})),a.forEach((function(t){e=e.slice(0,t.start)+'<span class="special-term-wrapper"><span class="special-term" \n        style="font-weight: bold; color: '.concat(t.color,"; text-shadow: ").concat(t.textShadow,'; text-decoration: underline;" \n        data-term="').concat(t.term,'">').concat(t.term,"</span></span>")+e.slice(t.end)})),e}function x(){return T.apply(this,arguments)}function T(){return T=(0,o.A)((0,a.A)().mark((function e(){var t,n,r,o,i,s,c,u=arguments;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:t=u.length>0&&void 0!==u[0]?u[0]:5,n=u.length>1&&void 0!==u[1]?u[1]:1e3,r=[],o=(0,m.D)(),Object.values(S.value.terms).forEach((function(e){if(e.imageUrl){var t=e.imageUrl.startsWith("http")?e.imageUrl:"".concat(o).concat(e.imageUrl);r.push(t)}})),i=0;case 6:if(!(i<r.length)){e.next=22;break}return s=r.slice(i,i+t),c=s.map((function(e){return new Promise((function(t,n){var r=new Image;r.src=e,r.onload=function(){return t(e)},r.onerror=function(){return n(new Error("Failed to load image: ".concat(e)))}}))})),e.prev=9,e.next=12,Promise.all(c);case 12:e.next=17;break;case 14:e.prev=14,e.t0=e["catch"](9),console.error("Error preloading images:",e.t0);case 17:return e.next=19,new Promise((function(e){return setTimeout(e,n)}));case 19:i+=t,e.next=6;break;case 22:case"end":return e.stop()}}),e,null,[[9,14]])}))),T.apply(this,arguments)}function k(e){var t=e.term,n=e.event,r=e.termConfig;return{show:!0,description:r.description,imageUrl:r.imageUrl,term:t,event:n}}function _(){return{show:!1,description:"",imageUrl:"",term:"",event:null}}var C={class:"term-tooltip-content"},I=["innerHTML"],R=["src"];const N={__name:"TermTooltip",props:{show:Boolean,description:String,imageUrl:String,term:String,event:Object},emits:["term-clicked"],setup:function(e,t){var n=t.emit,r=null,a=(0,u.KR)(null),o=(0,u.KR)({top:"0px",left:"0px"}),p=e,d=n,g=(0,c.EW)((function(){return(0,s.A)({position:"fixed",display:p.show?"block":"none",width:"90vw",maxWidth:"400px",zIndex:1e3,backgroundColor:"#fff",padding:"8px",borderRadius:"4px",boxShadow:"0 1px 4px rgba(0,0,0,0.1)"},o.value)}));function h(){if(!p.event||!p.show)return{};var e=document.documentElement.clientWidth,t=document.documentElement.clientHeight,n=a.value;if(n){var r=n.offsetWidth,o=n.offsetHeight,i=p.event.clientY+10,s=p.event.clientX+10;return p.event.clientY+o+10>t&&(i=p.event.clientY-o-10),p.event.clientX+r+10>e&&(s=p.event.clientX-r-10),i=Math.max(10,i),s=Math.max(10,s),{top:"".concat(i,"px"),left:"".concat(s,"px")}}}function v(){var e=h();e.top===o.value.top&&e.left===o.value.left||(o.value=e),r=setTimeout((function(){p.show&&requestAnimationFrame(v)}),33)}(0,c.wB)((function(){return p.show}),(function(e){e?(o.value=h(),v()):r&&(clearTimeout(r),r=null)}));var f=(0,c.EW)((function(){return w(p.description,p.term)})),S=(0,c.EW)((function(){return p.imageUrl?p.imageUrl.startsWith("http")?p.imageUrl:"".concat((0,m.D)()).concat(p.imageUrl):""})),A=function(e){var t=e.target.closest(".special-term-wrapper");if(t){var n,r=null===(n=t.querySelector(".special-term"))||void 0===n?void 0:n.getAttribute("data-term");r&&d("term-clicked",r)}};return(0,c.xo)((function(){r&&(clearTimeout(r),r=null)})),function(t,n){return(0,c.bo)(((0,c.uX)(),(0,c.CE)("div",{id:"term-tooltip",ref_key:"tooltipElementRef",ref:a,style:(0,l.Tr)(g.value),onClick:(0,i.D$)(A,["stop"]),class:"term-tooltip"},[(0,c.Lk)("div",C,[(0,c.Lk)("span",{innerHTML:f.value},null,8,I),e.imageUrl?((0,c.uX)(),(0,c.CE)("img",{key:0,src:S.value,class:"term-tooltip-image",alt:"术语图片",onLoad:v},null,40,R)):(0,c.Q3)("",!0)])],4)),[[i.aG,e.show]])}}},O=(0,h.A)(N,[["__scopeId","data-v-8d5629d6"]]),L=O,D=n.p+"assets/fonts/unifont-16.0.01.6ebf3f4a.otf";var P=function(){var e=[D];e.forEach((function(e){var t=document.createElement("link");t.rel="preload",t.as="font",t.type="font/otf",t.href=e,t.crossOrigin="anonymous",document.head.appendChild(t)}))},M=function(){var e=(0,o.A)((0,a.A)().mark((function e(t){return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,document.fonts.load('1em "'.concat(t,'"'));case 3:return e.abrupt("return",!0);case 6:return e.prev=6,e.t0=e["catch"](0),console.error("Font loading failed: ".concat(t),e.t0),e.abrupt("return",!1);case 10:case"end":return e.stop()}}),e,null,[[0,6]])})));return function(t){return e.apply(this,arguments)}}(),U=n(6278),j=n(5220),G={id:"app"};const B=Object.assign({name:"AppRoot"},{__name:"App",setup:function(e,t){var n=t.expose,r=(0,u.KR)(!1),i=(0,u.KR)(""),l=(0,u.KR)(""),p=(0,u.KR)(""),d=(0,u.KR)(null),g=(0,u.KR)({});n({showModal:v,hideModal:m}),(0,c.sV)((0,o.A)((0,a.A)().mark((function e(){var t,n;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return t=(0,U.Pj)(),e.next=3,t.dispatch("settings/initializeSave");case 3:return y(),E(),P(),e.next=8,M("Unifont");case 8:n=e.sent,n&&document.documentElement.classList.add("fonts-loaded");case 10:case"end":return e.stop()}}),e)}))));var h=function(e){var t=e.touches?e.touches[0]:e;if(e.target.classList.contains("special-term")){var n=e.target.getAttribute("data-term"),a=S.value.terms[n];i.value=a.description,l.value=a.imageUrl,p.value=n,d.value={pageX:t.pageX,pageY:t.pageY,clientX:t.clientX,clientY:t.clientY},r.value=!0}else e.target.closest("#term-tooltip")||(r.value=!1)};(0,c.sV)((function(){document.addEventListener("click",h),document.addEventListener("touchstart",h)})),(0,c.hi)((function(){document.removeEventListener("click",h),document.removeEventListener("touchstart",h)}));var v=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};g.value[e]=(0,s.A)((0,s.A)({},t),{},{show:!0})},m=function(e){g.value[e]&&(g.value[e].show=!1,delete g.value[e])},A=function(e){var t=S.value.terms[e];t&&(i.value=t.description,l.value=t.imageUrl,p.value=e,r.value=!0)},b=(0,j.rd)();return(0,c.sV)((function(){b.afterEach((function(){window.scrollTo({top:0,behavior:"instant"})}))})),function(e,t){var n=(0,c.g2)("router-view");return(0,c.uX)(),(0,c.CE)("div",G,[(0,c.bF)(n),((0,c.uX)(!0),(0,c.CE)(c.FK,null,(0,c.pI)(g.value,(function(e,t){return(0,c.uX)(),(0,c.Wv)(f,(0,c.v6)({key:t,ref_for:!0},e,{onClose:function(e){return m(t)}}),null,16,["onClose"])})),128)),(0,c.bF)(L,{show:r.value,description:i.value,imageUrl:l.value,term:p.value,event:d.value,onTermClicked:A},null,8,["show","description","imageUrl","term","event"])])}}}),K=B,H=K;var F={BASE_PATH:"/vue/",ASSETS_PREFIX:"/vue/",API_BASE_URL:"/vue/"};const V=n.p+"assets/img/TitleShow.2ba752fd.png",W="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA9klEQVQ4jWNgwA3mAPEfKJ6FRx1OANL4H4r/EFLMAsSmQMwG5UshaYZhEagcSI0VVA8cLIYqegzE/UB8EYsBR4C4DojvQPmLYJrNsSgmFoNcwhCFQ/ISEOdB8WUcahJABrAC8QQg/oummQPJixxohvwC4gYgZkYOh1YkBXkMmCAfSb4OizxDGwkGtCNLsAPxRDQvXEbzAicQX0GS/wv1Nsj7DGkM2APoMtTWfDTNyDgCZIAxmu2kYFuYE6dBBa4BcQ0DJNGgKz4PxL1A/BzKX4ccDoxArA7ETFC+CBYDJKByPEDsjBZGWAFJmQkbmMWAyM4zcSkCACP+g11NunLfAAAAAElFTkSuQmCC";var z=n(6992),X=n(6083),J={class:"min-h-screen bg-white"},Y={class:"container mx-auto px-4 py-8 max-w-2xl",id:"menu"},q={class:"space-y-2 mb-8"},Q={class:"text-5xl font-bold text-center text-tech-primary scale-y-95"},$={class:"text-3xl font-medium text-center text-tech-secondary cjk-text"},Z={id:"gameDescription",class:"text-lg text-center text-gray-600 max-w-xl mx-auto cjk-text"},ee={class:"space-y-8"},te={class:"space-y-4"},ne={class:"grid grid-cols-2 gap-4"},re={class:"grid grid-cols-2 gap-4"},ae={class:"grid grid-cols-2 gap-4"},oe={class:"mt-12 text-center space-y-2 text-gray-600"},ie={class:"space-x-4"},se={href:"http://qm.qq.com/cgi-bin/qm/qr?_wv=1027&k=SQtBxN7VNoPENb1yCzklbdo3GrL0vRq9&authKey=gXOpREY%2BVYh6acsXgpfzZ%2FzZKefgb7OdM92T%2Br46Umr0HNVHi4S1DVxHhyI8Rhm3&noverify=0&group_code=731682071",target:"_blank",class:"text-tech-accent hover:text-tech-primary transition-colors duration-200"},ce={href:"https://space.bilibili.com/23122362",target:"_blank",class:"text-tech-accent hover:text-tech-primary transition-colors duration-200"},ue={class:"text-sm"};const le=Object.assign({name:"HomeView"},{__name:"HomeView",setup:function(e){var t=(0,U.Pj)(),n=(0,j.rd)(),r=(0,u.KR)(null),i=(0,c.WQ)("$modal"),s=(0,z.s9)(),p=s.t,d=(0,c.EW)((function(){return t.getters["save/hasSave"]})),g=function(){var e=(0,o.A)((0,a.A)().mark((function e(){var r,o,s;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.prev=0,console.log("开始新游戏..."),e.next=4,t.dispatch("save/clearSave");case 4:return e.next=6,t.dispatch("save/initializeSaveIndex");case 6:return r=e.sent,console.log("初始化存档索引:",r),o="silver_moon",e.next=11,t.dispatch("sections/SET_CURRENT_SCENARIO",o);case 11:return console.log("设置当前剧本:",o),e.next=14,t.dispatch("sections/loadScenarioConfig");case 14:return s=e.sent,console.log("加载剧本配置:",s),e.next=18,t.dispatch("save/loadScenarioSave",o);case 18:return e.next=20,t.dispatch("sections/loadSectionsIndex");case 20:return e.next=22,t.dispatch("save/saveSave");case 22:return console.log("新游戏初始化完成"),e.next=25,n.push("/sections");case 25:e.next=31;break;case 27:e.prev=27,e.t0=e["catch"](0),console.error("开始新游戏失败:",e.t0),i.show("error",{title:p("error"),content:p("startGameError")});case 31:case"end":return e.stop()}}),e,null,[[0,27]])})));return function(){return e.apply(this,arguments)}}(),h=function(){var e=(0,o.A)((0,a.A)().mark((function e(){return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,t.dispatch("save/loadSave");case 3:n.push("/sections"),e.next=10;break;case 6:e.prev=6,e.t0=e["catch"](0),console.error("继续游戏失败:",e.t0),i.show("error",{title:p("error"),content:p("loadSaveError")});case 10:case"end":return e.stop()}}),e,null,[[0,6]])})));return function(){return e.apply(this,arguments)}}(),v=function(){n.push("/settings")},f=function(){d.value&&!confirm(p("confirmImport"))||r.value.click()},m=function(){var e=(0,o.A)((0,a.A)().mark((function e(n){var r;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(r=n.target.files[0],r){e.next=3;break}return e.abrupt("return");case 3:return e.prev=3,e.next=6,t.dispatch("save/importSave",r);case 6:i.show("success",{title:p("success"),content:p("importSuccess")}),location.reload(),e.next=13;break;case 10:e.prev=10,e.t0=e["catch"](3),i.show("error",{title:p("error"),content:e.t0.message});case 13:return e.prev=13,n.target.value="",e.finish(13);case 16:case"end":return e.stop()}}),e,null,[[3,10,13,16]])})));return function(t){return e.apply(this,arguments)}}(),S=function(){var e=(0,o.A)((0,a.A)().mark((function e(){return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(!confirm(p("confirmDelete"))){e.next=4;break}return e.next=3,t.dispatch("save/clearSave");case 3:location.reload();case 4:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),A=function(){i.show("creators-message",{title:p("menu.creatorsMessageTitle"),content:p("menu.creatorsMessageContent"),closeButtonText:p("common.close")})},y=function(){i.show("update-log",{title:p("menu.updateLogTitle"),content:p("menu.updateLogContent"),closeButtonText:p("common.close")})},E=function(){var e=(0,o.A)((0,a.A)().mark((function e(){return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(!d.value){e.next=6;break}if(!confirm(p("game.confirmNewGame"))){e.next=4;break}return e.next=4,g();case 4:e.next=8;break;case 6:return e.next=8,g();case 8:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}();return(0,c.sV)((0,o.A)((0,a.A)().mark((function e(){var n;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return console.log("HomeView mounted"),e.prev=1,e.next=4,t.dispatch("save/loadSave");case 4:n=e.sent,n&&console.log("存档已加载"),e.next=12;break;case 8:e.prev=8,e.t0=e["catch"](1),console.error("加载存档失败:",e.t0),i.show("error",{title:"错误",content:"加载存档失败"});case 12:case"end":return e.stop()}}),e,null,[[1,8]])})))),function(e,t){return(0,c.uX)(),(0,c.CE)("div",J,[(0,c.Lk)("div",Y,[(0,c.Lk)("div",q,[(0,c.Lk)("h1",Q,(0,l.v_)((0,u.R1)(p)("menu.mainTitle")),1),(0,c.Lk)("h2",$,(0,l.v_)((0,u.R1)(p)("menu.subTitle")),1),(0,c.Lk)("p",Z,(0,l.v_)((0,u.R1)(p)("menu.gameDescription")),1)]),t[1]||(t[1]=(0,c.Lk)("div",{class:"mb-12 flex justify-center items-center"},[(0,c.Lk)("img",{src:V,alt:"游戏展示图片",class:"w-full max-w-[640px] h-auto rounded-lg shadow-lg object-contain"})],-1)),(0,c.Lk)("div",ee,[(0,c.Lk)("div",te,[d.value?((0,c.uX)(),(0,c.CE)(c.FK,{key:0},[(0,c.bF)(X.A,{type:"primary",size:"lg",class:"w-full cjk-text",onClick:h},{default:(0,c.k6)((function(){return[(0,c.eW)((0,l.v_)((0,u.R1)(p)("game.continueGame")),1)]})),_:1}),(0,c.bF)(X.A,{type:"secondary",size:"lg",class:"w-full cjk-text",onClick:E},{default:(0,c.k6)((function(){return[(0,c.eW)((0,l.v_)((0,u.R1)(p)("game.newGame")),1)]})),_:1})],64)):((0,c.uX)(),(0,c.Wv)(X.A,{key:1,type:"primary",size:"lg",class:"w-full cjk-text",onClick:g},{default:(0,c.k6)((function(){return[(0,c.eW)((0,l.v_)((0,u.R1)(p)("game.newGame")),1)]})),_:1}))]),(0,c.Lk)("div",ne,[(0,c.bF)(X.A,{onClick:f,class:"cjk-text"},{default:(0,c.k6)((function(){return[(0,c.eW)((0,l.v_)((0,u.R1)(p)("game.importSave")),1)]})),_:1}),d.value?((0,c.uX)(),(0,c.Wv)(X.A,{key:0,onClick:e.exportSave,class:"cjk-text"},{default:(0,c.k6)((function(){return[(0,c.eW)((0,l.v_)((0,u.R1)(p)("game.exportSave")),1)]})),_:1},8,["onClick"])):(0,c.Q3)("",!0)]),(0,c.Lk)("div",re,[(0,c.bF)(X.A,{onClick:v,type:"ghost",class:"cjk-text"},{icon:(0,c.k6)((function(){return t[0]||(t[0]=[(0,c.Lk)("img",{src:W,alt:"",class:"w-5 h-5"},null,-1)])})),default:(0,c.k6)((function(){return[(0,c.eW)(" "+(0,l.v_)((0,u.R1)(p)("settings.text")),1)]})),_:1}),d.value?((0,c.uX)(),(0,c.Wv)(X.A,{key:0,type:"danger",onClick:S,class:"cjk-text"},{default:(0,c.k6)((function(){return[(0,c.eW)((0,l.v_)((0,u.R1)(p)("game.deleteSave")),1)]})),_:1})):(0,c.Q3)("",!0)]),(0,c.Lk)("div",ae,[(0,c.bF)(X.A,{type:"ghost",onClick:A,class:"cjk-text"},{default:(0,c.k6)((function(){return[(0,c.eW)((0,l.v_)((0,u.R1)(p)("menu.creatorsMessage")),1)]})),_:1}),(0,c.bF)(X.A,{type:"ghost",onClick:y,class:"cjk-text"},{default:(0,c.k6)((function(){return[(0,c.eW)((0,l.v_)((0,u.R1)(p)("menu.updateLog")),1)]})),_:1})])]),(0,c.Lk)("input",{ref_key:"fileInput",ref:r,type:"file",class:"hidden",accept:".savegame",onChange:m},null,544),(0,c.Lk)("div",oe,[(0,c.Lk)("div",ie,[(0,c.Lk)("a",se,(0,l.v_)((0,u.R1)(p)("menu.footer.qqGroup"))+"：731682071 ",1),(0,c.Lk)("a",ce,(0,l.v_)((0,u.R1)(p)("menu.footer.bilibili")),1)]),(0,c.Lk)("p",ue,(0,l.v_)((0,u.R1)(p)("menu.footer.welcomeMessage")),1)])])])}}}),pe=le,de=pe;var ge=n(5026),he=n(9492),ve=(n(5276),n(6033),n(1415),n(7642),n(8004),n(3853),n(5876),n(2475),n(5024),n(1698),function(){function e(){(0,ge.A)(this,e),this.loadedImages=new Set,this.loading=new Map,this.basePath=(0,m.D)()}return(0,he.A)(e,[{key:"getFullUrl",value:function(e){if(e.startsWith("http")||e.startsWith(this.basePath))return e;var t=e.startsWith("/")?e.slice(1):e;return"".concat(this.basePath,"/").concat(t)}},{key:"preloadImage",value:function(){var e=(0,o.A)((0,a.A)().mark((function e(t){var n,r,o=this;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(n=this.getFullUrl(t),!this.loadedImages.has(n)){e.next=3;break}return e.abrupt("return",n);case 3:if(!this.loading.has(n)){e.next=5;break}return e.abrupt("return",this.loading.get(n));case 5:return r=fetch(n).then((function(e){if(!e.ok)throw new Error("Failed to load image: ".concat(n));return o.loadedImages.add(n),o.loading["delete"](n),n}))["catch"]((function(e){throw o.loading["delete"](n),e})),this.loading.set(n,r),e.abrupt("return",r);case 8:case"end":return e.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()},{key:"preloadBatch",value:function(){var e=(0,o.A)((0,a.A)().mark((function e(t){var n,r,o,i,s,c,u,l,p=this,d=arguments;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:for(n=d.length>1&&void 0!==d[1]?d[1]:3,r=d.length>2&&void 0!==d[2]?d[2]:1e3,o=[],i=0;i<t.length;i+=n)s=t.slice(i,i+n),o.push(s);c=0,u=o;case 5:if(!(c<u.length)){e.next=20;break}return l=u[c],e.prev=7,e.next=10,Promise.all(l.map((function(e){return p.preloadImage(e)})));case 10:if(!(o.indexOf(l)<o.length-1)){e.next=13;break}return e.next=13,new Promise((function(e){return setTimeout(e,r)}));case 13:e.next=17;break;case 15:e.prev=15,e.t0=e["catch"](7);case 17:c++,e.next=5;break;case 20:case"end":return e.stop()}}),e,null,[[7,15]])})));function t(t){return e.apply(this,arguments)}return t}()},{key:"isImageLoaded",value:function(e){var t=this.getFullUrl(e);return this.loadedImages.has(t)}}])}()),fe=new ve,me={class:"lazy-image-container"},Se={class:"image-wrapper"},Ae=["src","alt"],ye={key:0,class:"image-placeholder"};const Ee={__name:"LazyImage",props:{src:{type:String,required:!0},alt:{type:String,default:""}},setup:function(e){var t=e,n=(0,c.EW)((function(){return fe.getFullUrl(t.src)})),r=(0,u.KR)(fe.isImageLoaded(t.src));(0,c.sV)((0,o.A)((0,a.A)().mark((function e(){return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(r.value){e.next=10;break}return e.prev=1,e.next=4,fe.preloadImage(t.src);case 4:r.value=!0,e.next=10;break;case 7:e.prev=7,e.t0=e["catch"](1),console.error("图片加载失败:",e.t0);case 10:case"end":return e.stop()}}),e,null,[[1,7]])}))));var i=function(){return r.value=!0},s=function(){return console.error("Image load error:",t.src)};return function(t,a){return(0,c.uX)(),(0,c.CE)("div",me,[(0,c.Lk)("div",Se,[(0,c.Lk)("img",{src:r.value?n.value:"",alt:e.alt,class:(0,l.C4)(["lazy-image",{"is-loaded":r.value}]),onLoad:i,onError:s},null,42,Ae),r.value?(0,c.Q3)("",!0):((0,c.uX)(),(0,c.CE)("div",ye,a[0]||(a[0]=[(0,c.Lk)("span",null,"加载中...",-1)])))])])}}},be=(0,h.A)(Ee,[["__scopeId","data-v-5aeac8d4"]]),we=be;n(4423),n(1699);var xe={key:0,class:"music-player"},Te=["src"],ke=["src"];const _e={__name:"MusicPlayer",props:{musicUrl:{type:String,required:!0}},setup:function(e){var t=e,n=(0,c.EW)((function(){return t.musicUrl.includes("bilibili.com")})),r=(0,c.EW)((function(){return t.musicUrl.includes("music.163.com")}));return function(t,a){return e.musicUrl?((0,c.uX)(),(0,c.CE)("div",xe,[n.value?((0,c.uX)(),(0,c.CE)("iframe",{key:0,src:e.musicUrl,scrolling:"no",border:"0",frameborder:"no",framespacing:"0",allowfullscreen:"false",style:{width:"100%",height:"100%"}},null,8,Te)):r.value?((0,c.uX)(),(0,c.CE)("iframe",{key:1,src:e.musicUrl,scrolling:"no",border:"0",frameborder:"no",framespacing:"0",allowfullscreen:"false",style:{width:"330px",height:"86px"}},null,8,ke)):(0,c.Q3)("",!0)])):(0,c.Q3)("",!0)}}},Ce=(0,h.A)(_e,[["__scopeId","data-v-98bb9a3e"]]),Ie=Ce;n(2762);var Re={class:"game-interaction"},Ne={key:0,class:"suggestions-container"},Oe={key:1,class:"interaction-stage"},Le={class:"controls"},De=["placeholder","disabled"],Pe=["disabled"],Me={key:2,class:"validation-error-modal"},Ue={class:"validation-error-content"};const je={__name:"GameInteraction",setup:function(e){var t=(0,U.Pj)(),n=(0,u.KR)(""),r=(0,c.EW)((function(){return t.state.conversation.suggestions})),s=(0,c.EW)((function(){return t.state.interaction.interactionStage})),p=(0,c.EW)((function(){return t.getters["game/isInputEnabled"]})),d=(0,c.EW)((function(){return t.state.game.isSectionEnded})),g=(0,c.EW)((function(){if(d.value)return"本桥段已结束...";var e=t.state.interaction.interactionStage.stage;return"等待玩家"===e?"轮到你行动了，请输入你想做的事...":"请等待其他角色行动..."})),h=(0,c.EW)((function(){return d.value?"已结束":p.value?t.state.interaction.isProcessing?"处理中...":"确定":"等待中..."})),v=(0,c.EW)((function(){return t.state.interaction.validationError})),f=function(){var e=(0,o.A)((0,a.A)().mark((function e(){var r;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(r=n.value.trim(),r&&p.value){e.next=3;break}return e.abrupt("return");case 3:return e.prev=3,e.next=6,t.dispatch("interaction/handleUserInput",r);case 6:n.value="",e.next=12;break;case 9:e.prev=9,e.t0=e["catch"](3),console.error("处理用户输入时出错:",e.t0);case 12:case"end":return e.stop()}}),e,null,[[3,9]])})));return function(){return e.apply(this,arguments)}}(),m=function(){t.dispatch("interaction/hideValidationError")};return function(e,t){return(0,c.uX)(),(0,c.CE)("div",Re,[r.value.length?((0,c.uX)(),(0,c.CE)("div",Ne,[((0,c.uX)(!0),(0,c.CE)(c.FK,null,(0,c.pI)(r.value,(function(e,t){return(0,c.uX)(),(0,c.CE)("div",{key:t,class:"suggestion"}," 建议："+(0,l.v_)(e),1)})),128))])):(0,c.Q3)("",!0),s.value.visible?((0,c.uX)(),(0,c.CE)("div",Oe,[(0,c.Lk)("p",null,(0,l.v_)(s.value.stage)+": "+(0,l.v_)(s.value.info),1)])):(0,c.Q3)("",!0),(0,c.Lk)("div",Le,[(0,c.bo)((0,c.Lk)("input",{type:"text","onUpdate:modelValue":t[0]||(t[0]=function(e){return n.value=e}),maxlength:"200",placeholder:g.value,onKeydown:(0,i.jR)(f,["enter"]),autocomplete:"off",disabled:!p.value||d.value,class:(0,l.C4)({"section-ended":d.value})},null,42,De),[[i.Jo,n.value]]),(0,c.Lk)("button",{class:(0,l.C4)(["button",{"section-ended":d.value}]),onClick:f,disabled:!p.value||d.value},(0,l.v_)(h.value),11,Pe)]),v.value?((0,c.uX)(),(0,c.CE)("div",Me,[(0,c.Lk)("div",Ue,[t[1]||(t[1]=(0,c.Lk)("h3",null,"行动无效",-1)),(0,c.Lk)("p",null,(0,l.v_)(v.value),1),(0,c.Lk)("button",{onClick:m},"确定")])])):(0,c.Q3)("",!0)])}}},Ge=(0,h.A)(je,[["__scopeId","data-v-31eaf732"]]),Be=Ge;var Ke={class:"min-h-screen bg-white"},He={class:"container mx-auto px-4 py-8 max-w-3xl"},Fe={class:"flex items-center justify-between mb-8"},Ve={class:"text-2xl font-bold text-tech-primary"},We={class:"bg-white rounded-lg shadow-tech p-6"},ze={class:"space-y-8"},Xe={key:1,class:"w-full flex justify-center"},Je={class:"space-y-4"},Ye=["innerHTML"],qe={key:2,class:"flex items-center justify-center p-4 bg-gray-50 rounded-lg"},Qe={class:"text-tech-primary"};const $e=Object.assign({name:"StoryView"},{__name:"StoryView",setup:function(e){var t=(0,U.Pj)(),n=(0,j.rd)(),r=(0,z.s9)(),a=r.t,o=(0,u.KR)(null),i=(0,c.EW)((function(){return t.state.sections.currentSection})),s=(0,c.EW)((function(){return t.state.game.isLoading})),p=(0,c.EW)((function(){return t.state.conversation.conversationHistory})),d=function(e){if(!e||!e.content)return"";var t=e.content;t=t.replace(/\n/g,"<br>");var n={user:"text-gray-600",info:"text-tech-secondary",system:"text-tech-primary",assistant:"text-gray-800"};return"user"!==e.role&&(t=w(t)),t='<div class="'.concat(n[e.role]||"",'">').concat(t,"</div>"),t};(0,c.wB)(p,(function(){o.value&&setTimeout((function(){o.value.scrollTop=o.value.scrollHeight}),100)}),{deep:!0}),(0,c.sV)((function(){o.value&&(o.value.scrollTop=0)})),(0,c.hi)((function(){}));var g=function(){confirm(a("game.confirmReturn"))&&n.push("/sections")},h=function(e){var n=e.target.closest(".special-term-wrapper");if(n){var r,a=null===(r=n.querySelector(".special-term"))||void 0===r?void 0:r.getAttribute("data-term");a&&t.dispatch("story/showTermTooltip",{term:a,event:e})}};return function(e,t){return(0,c.uX)(),(0,c.CE)("div",Ke,[(0,c.Lk)("div",He,[(0,c.Lk)("div",Fe,[(0,c.bF)(X.A,{type:"ghost",onClick:g,class:"min-w-[120px]"},{icon:(0,c.k6)((function(){return t[0]||(t[0]=[(0,c.Lk)("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor"},[(0,c.Lk)("path",{"fill-rule":"evenodd",d:"M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z","clip-rule":"evenodd"})],-1)])})),default:(0,c.k6)((function(){return[(0,c.eW)(" "+(0,l.v_)((0,u.R1)(a)("game.returnToSections")),1)]})),_:1}),(0,c.Lk)("h2",Ve,(0,l.v_)(i.value.title),1)]),(0,c.Lk)("div",We,[(0,c.Lk)("div",ze,[i.value.image?((0,c.uX)(),(0,c.Wv)(we,{key:0,src:i.value.image,alt:i.value.title,class:"w-full aspect-video object-cover rounded-lg shadow-sm"},null,8,["src","alt"])):(0,c.Q3)("",!0),i.value.musicUrl?((0,c.uX)(),(0,c.CE)("div",Xe,[(0,c.bF)(Ie,{"music-url":i.value.musicUrl,class:"w-[280px]"},null,8,["music-url"])])):(0,c.Q3)("",!0),(0,c.Lk)("div",{ref_key:"storyContentRef",ref:o,onClick:h,class:"prose prose-tech max-w-none min-h-[300px] max-h-[600px] overflow-y-auto bg-gray-50 rounded-lg p-6"},[(0,c.Lk)("div",Je,[((0,c.uX)(!0),(0,c.CE)(c.FK,null,(0,c.pI)(p.value,(function(e){return(0,c.uX)(),(0,c.CE)("div",{key:e.id,class:(0,l.C4)(["message-wrapper",{"bg-white shadow-sm rounded-lg p-4":"user"!==e.role,"italic text-gray-600 pl-4 border-l-4 border-tech-primary/20":"user"===e.role}])},[(0,c.Lk)("div",{innerHTML:d(e)},null,8,Ye)],2)})),128))])],512),(0,c.bF)(Be),s.value?((0,c.uX)(),(0,c.CE)("div",qe,[t[1]||(t[1]=(0,c.Lk)("svg",{class:"animate-spin h-5 w-5 text-tech-primary mr-3",viewBox:"0 0 24 24"},[(0,c.Lk)("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4",fill:"none"}),(0,c.Lk)("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})],-1)),(0,c.Lk)("span",Qe,(0,l.v_)((0,u.R1)(a)("common.loading")),1)])):(0,c.Q3)("",!0)])])])])}}}),Ze=$e,et=Ze;n(9449);var tt={class:"min-h-screen bg-white"},nt={class:"container mx-auto px-4 py-8 max-w-2xl"},rt={class:"flex items-center justify-between mb-8"},at={class:"text-2xl font-bold text-tech-primary"},ot={class:"bg-white rounded-lg shadow-tech p-6 space-y-6"},it={class:"space-y-2"},st={for:"api-key",class:"block text-sm font-medium text-tech-secondary"},ct=["placeholder","disabled"],ut={class:"space-y-2"},lt={for:"api-url",class:"block text-sm font-medium text-tech-secondary"},pt=["placeholder"],dt={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},gt={class:"space-y-2"},ht={for:"advanced-model",class:"block text-sm font-medium text-tech-secondary"},vt={class:"space-y-2"},ft={for:"basic-model",class:"block text-sm font-medium text-tech-secondary"},mt={class:"grid grid-cols-2 gap-4 pt-4"};const St=Object.assign({name:"SettingsView"},{__name:"SettingsView",setup:function(e){var t=(0,U.Pj)(),n=(0,j.rd)(),r=(0,c.nI)(),p=r.proxy,d=(0,u.KR)({apiKey:"",apiUrl:"",advancedModel:"",basicModel:"",isPublicKey:!1}),g=(0,u.KR)(""),h=(0,u.KR)("success"),v=(0,c.EW)((function(){return{apiKey:t.state.settings.apiKey,apiUrl:t.state.settings.apiUrl,advancedModel:t.state.settings.advancedModel,basicModel:t.state.settings.basicModel,isPublicKey:t.state.settings.isPublicKey}})),f=function(){d.value=(0,s.A)((0,s.A)({},v.value),{},{apiKey:""})},m=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"success";g.value=e,h.value=t,setTimeout((function(){g.value=""}),3e3)},S=function(){var e=(0,o.A)((0,a.A)().mark((function e(){var r;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.prev=0,r=(0,s.A)((0,s.A)({},v.value),{},{apiKey:d.value.apiKey||v.value.apiKey,apiUrl:d.value.apiUrl}),r.apiUrl.endsWith("/")||(r.apiUrl+="/"),e.next=5,t.dispatch("settings/saveSettings",r);case 5:m(p.$t("settings.savedMessage")),t.getters["settings/hasValidSettings"]&&n.push("/"),e.next=13;break;case 9:e.prev=9,e.t0=e["catch"](0),console.error("保存设置失败:",e.t0),m(p.$t("settings.saveError"),"error");case 13:case"end":return e.stop()}}),e,null,[[0,9]])})));return function(){return e.apply(this,arguments)}}(),A=function(){var e=(0,o.A)((0,a.A)().mark((function e(){var n;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,t.dispatch("settings/getPublicKey");case 3:n=e.sent,n&&(m(p.$t("settings.publicKeyFetched")),f()),e.next=10;break;case 7:e.prev=7,e.t0=e["catch"](0),m(p.$t("settings.publicKeyFetchFailed"),"error");case 10:case"end":return e.stop()}}),e,null,[[0,7]])})));return function(){return e.apply(this,arguments)}}(),y=function(){var e=(0,o.A)((0,a.A)().mark((function e(){return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(!confirm(p.$t("settings.confirmReset"))){e.next=5;break}return e.next=3,t.dispatch("settings/resetSettings");case 3:f(),m(p.$t("settings.resetMessage"));case 5:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),E=function(){p.$modal.show("settings-help",{title:p.$t("settings.helpTitle"),content:p.$t("settings.helpContent")})},b=function(){confirm(p.$t("settings.confirmExit"))&&n.push("/")};return(0,c.sV)((function(){t.dispatch("settings/loadSettings"),f()})),function(e,t){return(0,c.uX)(),(0,c.CE)("div",tt,[(0,c.Lk)("div",nt,[(0,c.Lk)("div",rt,[(0,c.bF)(X.A,{type:"ghost",onClick:b,class:"min-w-[120px]"},{icon:(0,c.k6)((function(){return t[4]||(t[4]=[(0,c.Lk)("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor"},[(0,c.Lk)("path",{"fill-rule":"evenodd",d:"M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z","clip-rule":"evenodd"})],-1)])})),default:(0,c.k6)((function(){return[(0,c.eW)(" "+(0,l.v_)(e.$t("common.return")),1)]})),_:1}),(0,c.Lk)("h2",at,(0,l.v_)(e.$t("settings.title")),1)]),(0,c.Lk)("div",ot,[(0,c.Lk)("div",it,[(0,c.Lk)("label",st,(0,l.v_)(e.$t("settings.apiKeyLabel")),1),(0,c.bo)((0,c.Lk)("input",{type:"password",id:"api-key","onUpdate:modelValue":t[0]||(t[0]=function(e){return d.value.apiKey=e}),placeholder:e.$t("settings.apiKeyPlaceholder"),disabled:d.value.isPublicKey,autocomplete:"off",class:"w-full px-4 py-2 rounded-lg border-2 border-gray-200 focus:border-tech-primary focus:ring-0 transition-colors duration-300"},null,8,ct),[[i.Jo,d.value.apiKey]])]),(0,c.Lk)("div",ut,[(0,c.Lk)("label",lt,(0,l.v_)(e.$t("settings.apiUrlLabel")),1),(0,c.bo)((0,c.Lk)("input",{type:"text",id:"api-url","onUpdate:modelValue":t[1]||(t[1]=function(e){return d.value.apiUrl=e}),placeholder:e.$t("settings.apiUrlPlaceholder"),class:"w-full px-4 py-2 rounded-lg border-2 border-gray-200 focus:border-tech-primary focus:ring-0 transition-colors duration-300"},null,8,pt),[[i.Jo,d.value.apiUrl]])]),(0,c.Lk)("div",dt,[(0,c.Lk)("div",gt,[(0,c.Lk)("label",ht,(0,l.v_)(e.$t("settings.advancedModelLabel")),1),(0,c.bo)((0,c.Lk)("select",{id:"advanced-model","onUpdate:modelValue":t[2]||(t[2]=function(e){return d.value.advancedModel=e}),class:"w-full px-4 py-2 rounded-lg border-2 border-gray-200 focus:border-tech-primary focus:ring-0 transition-colors duration-300"},t[5]||(t[5]=[(0,c.Lk)("option",{value:"gpt-4o-mini"},"gpt-4o-mini",-1)]),512),[[i.u1,d.value.advancedModel]])]),(0,c.Lk)("div",vt,[(0,c.Lk)("label",ft,(0,l.v_)(e.$t("settings.basicModelLabel")),1),(0,c.bo)((0,c.Lk)("select",{id:"basic-model","onUpdate:modelValue":t[3]||(t[3]=function(e){return d.value.basicModel=e}),class:"w-full px-4 py-2 rounded-lg border-2 border-gray-200 focus:border-tech-primary focus:ring-0 transition-colors duration-300"},t[6]||(t[6]=[(0,c.Lk)("option",{value:"gpt-4o-mini"},"gpt-4o-mini",-1)]),512),[[i.u1,d.value.basicModel]])])]),(0,c.Lk)("div",mt,[(0,c.bF)(X.A,{type:"primary",onClick:S,class:"col-span-2"},{default:(0,c.k6)((function(){return[(0,c.eW)((0,l.v_)(e.$t("settings.saveButton")),1)]})),_:1}),(0,c.bF)(X.A,{type:"secondary",onClick:A},{default:(0,c.k6)((function(){return[(0,c.eW)((0,l.v_)(e.$t("settings.publicKeyButton")),1)]})),_:1}),(0,c.bF)(X.A,{type:"ghost",onClick:E},{default:(0,c.k6)((function(){return[(0,c.eW)((0,l.v_)(e.$t("settings.helpButton")),1)]})),_:1}),(0,c.bF)(X.A,{type:"danger",onClick:y,class:"col-span-2"},{default:(0,c.k6)((function(){return[(0,c.eW)((0,l.v_)(e.$t("settings.resetButton")),1)]})),_:1})]),g.value?((0,c.uX)(),(0,c.CE)("div",{key:0,class:(0,l.C4)(["mt-4 p-4 rounded-lg text-center","success"===h.value?"bg-green-50 text-green-700":"bg-red-50 text-red-700"])},(0,l.v_)(g.value),3)):(0,c.Q3)("",!0)])])])}}}),At=St,yt=At;var Et=[{path:"/",name:"Home",component:de},{path:"/sections",name:"sections",component:function(){return n.e(778).then(n.bind(n,778))},meta:{requiresGame:!0}},{path:"/story",name:"Story",component:et},{path:"/settings",name:"Settings",component:yt},{path:"/review",name:"Review",component:function(){return n.e(784).then(n.bind(n,1784))},meta:{title:"reviewTitle"}}],bt=(0,j.aE)({history:(0,j.LA)(F.BASE_PATH),routes:Et});const wt=bt;var xt=n(8676),Tt=n(3772),kt=(n(113),n(2712),n(2010),n(5506),function(){return{currentSectionId:null,completedSections:[],unlockedSections:[],globalInfluencePoints:[],isGameInitialized:!1,selectedCharacter:"罗伯特",turnCount:0,plotTriggers:[],currentSection:null,currentIsReplay:!1,storyTitle:"",storyContent:"",availableCharacters:[],sectionResults:{}}}),_t={SET_CURRENT_SECTION_ID:function(e,t){e.currentSectionId=t},SET_COMPLETED_SECTIONS:function(e,t){e.completedSections=t},SET_UNLOCKED_SECTIONS:function(e,t){e.unlockedSections=t},SET_GLOBAL_INFLUENCE_POINTS:function(e,t){e.globalInfluencePoints=t},SET_CURRENT_SECTION:function(e,t){e.currentSection=t},SET_CURRENT_IS_REPLAY:function(e,t){e.currentIsReplay=t},SET_STORY_TITLE:function(e,t){e.storyTitle=t},SET_STORY_CONTENT:function(e,t){e.storyContent=t},INCREMENT_TURN_COUNT:function(e){e.turnCount++},SET_PLOT_TRIGGERS:function(e,t){e.plotTriggers=t},SET_SELECTED_CHARACTER:function(e,t){e.selectedCharacter=t},RESET_STATE:function(e){e.currentSectionId=null,e.completedSections=[],e.unlockedSections=[1],e.globalInfluencePoints=[],e.currentSection=null,e.currentIsReplay=!1,e.turnCount=0,e.plotTriggers=[],e.storyTitle="",e.storyContent="",e.isGameInitialized=!1},SET_AVAILABLE_CHARACTERS:function(e,t){e.availableCharacters=t},SET_SECTION_RESULT:function(e,t){var n=t.sectionId,r=t.result;e.sectionResults=(0,s.A)((0,s.A)({},e.sectionResults),{},(0,Tt.A)({},n,r))}},Ct={initializeGameState:function(e){var t=e.commit,n=e.dispatch,r=n("save/loadSave",null,{root:!0});r?(t("SET_CURRENT_SECTION_ID",r.currentSectionId),t("SET_COMPLETED_SECTIONS",r.completedSections),t("SET_UNLOCKED_SECTIONS",r.unlockedSections),t("SET_GLOBAL_INFLUENCE_POINTS",r.globalInfluencePoints)):t("RESET_STATE")},updateGameState:function(e,t){var n=e.state,r=e.dispatch,a=t.sectionId;r("save/saveSave",{currentSectionId:a,completedSections:n.completedSections,unlockedSections:n.unlockedSections,globalInfluencePoints:n.globalInfluencePoints},{root:!0})},handleSectionOutcome:function(e,t){return(0,o.A)((0,a.A)().mark((function n(){var r,o,i,s;return(0,a.A)().wrap((function(n){while(1)switch(n.prev=n.next){case 0:return r=e.commit,o=e.dispatch,i=t.sectionId,s=t.summary,n.prev=2,n.next=5,o("save/updateSaveData",{path:"progress.sectionResults.".concat(i),value:{objective:s.objective,influencePoints:s.influencePoints}},{root:!0});case 5:s.objective?r("conversation/ADD_TO_CONVERSATION_HISTORY",{role:"system",content:"".concat(s.objective_judge,"\n桥段完成")},{root:!0}):r("conversation/ADD_TO_CONVERSATION_HISTORY",{role:"system",content:"".concat(s.objective_judge,"\n桥段未完成")},{root:!0}),n.next=12;break;case 8:throw n.prev=8,n.t0=n["catch"](2),console.error("处理结果时出错:",n.t0),n.t0;case 12:case"end":return n.stop()}}),n,null,[[2,8]])})))()},createPlayerInfo:function(e){var t=e.state,n=e.rootGetters,r=n["sections/getCurrentSectionData"];if(!r||!t.availableCharacters.length)return console.error("Section未定义或没有可用角色"),"";var a=t.availableCharacters.find((function(e){return!e.isAI}));if(!a)return console.warn("未找到可用的玩家角色"),"";var o="<b>你的角色：".concat(a.name,"</b>").concat(a.description);if(a.characterTags&&t.gameManager){var i=a.characterTags.reduce((function(e,n){var r=t.gameManager.getCharacterTag(n);return r&&(e+="<br>- ".concat(n,": ").concat(r)),e}),"");o+=i}return o},resetState:function(e){var t=e.commit;t("RESET_STATE")},updateAvailableCharacters:function(e){var t,n=e.commit,r=e.state,a=e.rootState;if(null!==(t=a.gameManager)&&void 0!==t&&t.gameManager){var o=a.gameManager.gameManager.getFilteredCharacters(r.turnCount);n("SET_AVAILABLE_CHARACTERS",o)}},SET_GLOBAL_INFLUENCE_POINTS:function(e,t){var n=e.commit;n("SET_GLOBAL_INFLUENCE_POINTS",t)},SET_SECTION_RESULT:function(e,t){var n=e.commit;Object.entries(t).forEach((function(e){var t=(0,xt.A)(e,2),r=t[0],a=t[1];n("SET_SECTION_RESULT",{sectionId:r,result:a})}))}},It={hasSave:function(e){return null!==e.currentSectionId},currentSection:function(e){return e.currentSection},selectedCharacter:function(e){return e.selectedCharacter},turnCount:function(e){return e.turnCount},plotTriggers:function(e){return e.plotTriggers},isGameInitialized:function(e){return e.isGameInitialized},storyContent:function(e){return e.storyContent},availableCharacters:function(e){return e.availableCharacters}};const Rt={namespaced:!0,state:kt,mutations:_t,actions:Ct,getters:It};n(2008),n(8598),n(4554),n(9089);var Nt=function(){return{conversationHistory:[],optimizedConversationHistory:[],suggestions:[],streamingMessageId:null,isCompressing:!1,compressionThreshold:6,compressionBatchSize:6,preserveRecentMessages:2}},Ot={ADD_TO_CONVERSATION_HISTORY:function(e,t){var n=(0,s.A)((0,s.A)({},t),{},{id:Date.now().toString()});e.conversationHistory.push(n),"info"!==t.role&&e.optimizedConversationHistory.push((0,s.A)({},n))},SET_SUGGESTIONS:function(e,t){e.suggestions=t},RESET_CONVERSATION:function(e){e.conversationHistory=[],e.optimizedConversationHistory=[],e.suggestions=[]},SET_STREAMING_MESSAGE_ID:function(e,t){e.streamingMessageId=t},UPDATE_STREAMING_MESSAGE:function(e,t){var n=t.id,r=t.content,a=e.conversationHistory.find((function(e){return e.id===n})),o=e.optimizedConversationHistory.find((function(e){return e.id===n}));a&&(a.content=r),o&&(o.content=r)},SET_COMPRESSING_STATUS:function(e,t){e.isCompressing=t},REPLACE_OPTIMIZED_MESSAGES:function(e,t){var n=t.startIndex,r=t.endIndex,a=t.compressedMessage;e.optimizedConversationHistory.splice(n,r-n+1,{id:"compressed_".concat(Date.now()),role:"system",content:a,isCompressed:!0})},REMOVE_LAST_USER_MESSAGE:function(e){for(var t=e.conversationHistory.length-1;t>=0;t--)if("user"===e.conversationHistory[t].role){e.conversationHistory.splice(t,1);break}for(var n=e.optimizedConversationHistory.length-1;n>=0;n--)if("user"===e.optimizedConversationHistory[n].role){e.optimizedConversationHistory.splice(n,1);break}},SET_INITIAL_SUGGESTIONS:function(e,t){e.suggestions=t}},Lt={addUserMessage:function(e,t){return(0,o.A)((0,a.A)().mark((function n(){var r;return(0,a.A)().wrap((function(n){while(1)switch(n.prev=n.next){case 0:r=e.commit,r("ADD_TO_CONVERSATION_HISTORY",{role:"user",content:t});case 2:case"end":return n.stop()}}),n)})))()},handleUserInput:function(e,t){return(0,o.A)((0,a.A)().mark((function n(){var r,o,i;return(0,a.A)().wrap((function(n){while(1)switch(n.prev=n.next){case 0:return r=e.commit,o=e.dispatch,r("ADD_TO_CONVERSATION_HISTORY",{role:"user",content:t}),r("SET_SUGGESTIONS",[]),n.prev=3,o("interaction/setProcessing",!0,{root:!0}),n.next=7,o("gameManager/processUserInput",t,{root:!0});case 7:i=n.sent,i&&i.suggestions?r("SET_SUGGESTIONS",i.suggestions):i&&i.suggestion&&i.content&&r("SET_SUGGESTIONS",[i.content,i.suggestion]),i&&i.isValid&&o("checkAndTriggerCompression"),n.next=16;break;case 12:n.prev=12,n.t0=n["catch"](3),console.error("处理用户输入时出错:",n.t0),r("ADD_TO_CONVERSATION_HISTORY",{role:"system",content:"处理输入时发生错误，请重试。"});case 16:return n.prev=16,o("interaction/setProcessing",!1,{root:!0}),n.finish(16);case 19:case"end":return n.stop()}}),n,null,[[3,12,16,19]])})))()},clearConversation:function(e){var t=e.commit;t("RESET_CONVERSATION"),t("SET_STREAMING_MESSAGE_ID",null),t("SET_SUGGESTIONS",[]),t("SET_COMPRESSING_STATUS",!1)},startNewMessage:function(e,t){var n=e.commit,r=t.role,a=t.initialContent,o=void 0===a?"":a,i=Date.now().toString();return n("ADD_TO_CONVERSATION_HISTORY",{role:r,content:o,id:i}),n("SET_STREAMING_MESSAGE_ID",i),i},updateStreamingMessage:function(e,t){var n=e.commit,r=t.id,a=t.content;n("UPDATE_STREAMING_MESSAGE",{id:r,content:a})},finishStreamingMessage:function(e,t){var n=e.commit,r=e.state;r.streamingMessageId===t&&n("SET_STREAMING_MESSAGE_ID",null)},checkAndTriggerCompression:function(e){return(0,o.A)((0,a.A)().mark((function t(){var n,r,i,s;return(0,a.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(n=e.state,r=e.commit,i=e.dispatch,!(n.isCompressing||n.optimizedConversationHistory.length<n.compressionThreshold)){t.next=3;break}return t.abrupt("return");case 3:if(s=n.optimizedConversationHistory[n.optimizedConversationHistory.length-1],!s||"user"!==s.role){t.next=6;break}return t.abrupt("return");case 6:r("SET_COMPRESSING_STATUS",!0),setTimeout((0,o.A)((0,a.A)().mark((function e(){var t,o,s,c,u,l,p;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(e.prev=0,t=n.streamingMessageId?n.optimizedConversationHistory.length-2:n.optimizedConversationHistory.length-1,o=t-n.preserveRecentMessages,s=0,!(s>=o)){e.next=7;break}return r("SET_COMPRESSING_STATUS",!1),e.abrupt("return");case 7:return c=n.optimizedConversationHistory.slice(s,o+1).filter((function(e){return"info"!==e.role})).map((function(e){return"".concat(e.role,": ").concat(e.content)})).join("\n"),u={type:"object",properties:{keyPoints:{type:"array",items:{type:"object",additionalProperties:!1,properties:{event_time:{type:"string",description:"事件发生的相对时间点"},character_states:{type:"array",items:{type:"object",additionalProperties:!1,properties:{name:{type:"string"},health_status:{type:"string"},power_status:{type:"string"},mental_state:{type:"string"}},required:["name","health_status","power_status","mental_state"]},description:"相关角色的状态，包括健康状况、异能状态、精神状态等"},character_actions:{type:"array",items:{type:"object",additionalProperties:!1,properties:{actor:{type:"string"},action:{type:"string"},target:{type:"string"}},required:["actor","action","target"]},description:"角色的具体行动"},item_states:{type:"array",items:{type:"object",additionalProperties:!1,properties:{name:{type:"string"},condition:{type:"string"},usage_status:{type:"string"}},required:["name","condition","usage_status"]},description:"相关物品的状态"},significance:{type:"string",description:"这个关键点对剧情的重要性"}},required:["event_time","character_states","character_actions","item_states","significance"]}},compressedSummary:{type:"string",description:"压缩后的剧情总结，包含所有关键信息"}},required:["keyPoints","compressedSummary"],additionalProperties:!1},l="分析并压缩以下游戏剧情内容。这些剧情包含了角色互动、状态变化和物品使用情况。\n\n        对话内容：\n        ".concat(c,"\n\n        请注意记录以下要素：\n        1. 角色状态变化：\n           - 健康状况（受伤程度、体力等）\n           - 异能状态（使用程度、剩余能量等）\n           - 精神状态（情绪、意志等）\n        \n        2. 角色行动：\n           - 具体做了什么\n           - 对谁做的\n           - 行动的结果\n        \n        3. 物品状态：\n           - 武器/装备的损坏程度\n           - 消耗品的使用情况\n           - 载具的状态\n        \n        4. 事件重要性：\n           - 对后续剧情的影响\n           - 对角色关系的影响\n           - 对整体任务的影响\n      \n        请按照指定的JSON格式返回，确保每个关键时间点都包含：\n        1. event_time: 事件发生的相对时间\n        2. character_states: 相关角色的状态数组\n        3. character_actions: 具体行动数组\n        4. item_states: 相关物品状态数组\n        5. significance: 事件重要性说明\n        \n        同时提供一个 compressedSummary 作为整体概述包含各个要点，我们只会保存这个综述，前面的可以简短一点，你自己看得懂就行。"),e.next=12,i("api/callLargeLanguageModelWithSchema",{prompt:l,schema:u},{root:!0});case 12:p=e.sent,r("REPLACE_OPTIMIZED_MESSAGES",{startIndex:s,endIndex:o,compressedMessage:p.compressedSummary}),e.next=19;break;case 16:e.prev=16,e.t0=e["catch"](0),console.error("压缩消息时出错:",e.t0);case 19:return e.prev=19,r("SET_COMPRESSING_STATUS",!1),e.finish(19);case 22:case"end":return e.stop()}}),e,null,[[0,16,19,22]])}))),0);case 8:case"end":return t.stop()}}),t)})))()},removeLastUserMessage:function(e){var t=e.commit;t("REMOVE_LAST_USER_MESSAGE")},setSuggestions:function(e,t){var n=e.commit;n("SET_INITIAL_SUGGESTIONS",t)},addSystemMessage:function(e,t){var n=e.commit,r=t.content;n("ADD_TO_CONVERSATION_HISTORY",{role:"system",content:r})}},Dt={getLastRound:function(e){var t=e.conversationHistory.slice(-3);return t.map((function(e){return"".concat(e.role,": ").concat(e.content)})).join("\n")},conversationHistory:function(e){return e.conversationHistory},optimizedConversationHistory:function(e){return e.optimizedConversationHistory},suggestions:function(e){return e.suggestions},currentStreamingMessage:function(e){return e.streamingMessageId?e.conversationHistory.find((function(t){return t.id===e.streamingMessageId})):null},getCurrentStreamingMessage:function(e){return e.streamingMessageId?e.conversationHistory.find((function(t){return t.id===e.streamingMessageId})):null},getAllMessages:function(e){return e.conversationHistory}};const Pt={namespaced:!0,state:Nt,mutations:Ot,actions:Lt,getters:Dt},Mt={title:"设置",apiKeyLabel:"API Key",apiKeyPlaceholder:"输入你的API Key",apiUrlLabel:"API URL",apiUrlPlaceholder:"输入API URL",advancedModelLabel:"进阶模型 (用于桥段总结)",basicModelLabel:"基本模型 (用于其他操作)",saveButton:"保存设置",publicKeyButton:"获取公共key",resetButton:"恢复默认设置",helpButton:"这是什么？",savedMessage:"设置已保存",saveError:"保存设置失败",publicKeyFetched:"公共 Key 已成功获取并保存",publicKeyFetchFailed:"获取公共 Key 失败，请检查网络连接或稍后再试",resetMessage:"设置已恢复默认",confirmReset:"确定要恢复默认设置吗？这将清除所有自定义设置。",confirmExit:"确定要退出吗？未保存的更改将会丢失。",helpTitle:"帮助信息",helpContent:"\n    <p>本游戏<strong>基于</strong>可访问<strong>大语言模型</strong>的接口API进行，您可自行寻找相关API服务，默认API地址不构成推荐建议</p>\n    <p>第一次打开游戏网页时会自动尝试获取公共key，所以您可能直接开始游戏就可以游玩了。</p>\n    <p>公共key是作者买来给大家玩的</p>\n    <p>如遇无法输入API KEY，可以刷新网页</p>\n  ",apiKeyDisabled:"API Key 已被禁用，因为正在使用公共 Key",text:"设置",exitButton:"返回主菜单",modelOptions:{"gpt-4o-mini":"GPT-4-mini (推荐)","gpt-3.5-turbo":"GPT-3.5 Turbo","gpt-4":"GPT-4"}},Ut={title:"游戏教程",close:"关闭",understand:"我明白了",raw:{content:'\n      <p>你可以把本游戏理解为<strong>跑团（DND或COC）</strong>、<strong>语C</strong>、<strong>剧本杀</strong>或<strong>过家家</strong>🧑‍🤝‍🧑。本游戏制作时面向的玩家是<strong>喜欢剧情向游戏</strong>，愿意<strong>认真扮演角色</strong>🎭  的语C、跑团玩家👥。</p>\n      <ol>\n        <li>📝 <strong>目标</strong>：在每一个桥段里，你需要完成<strong>桥段目标</strong>🎯，目标可能是<strong>沟通</strong>💬、<strong>战斗</strong>⚔️、<strong>解密</strong>🧩等。</li>\n        <li>🎮 <strong>操作</strong>：根据你的人设和起始事件，在对话框中打字输入以<strong>你的角色的角度</strong>进行的行动、说的话🗣️。比如输入"我挥起武器说，与我何干！"，不需要特别注意格式</li>\n        <li>💡 <strong>技巧</strong>：很多角色有<strong>超能力</strong>🔮，比如银月篇主角罗伯特，可以<strong>减缓时间流速</strong>🕰️，你可以接住敌方扔来的飞刀扔回去🗡️，也能准确地瞄准你要攻击的物件🎯，只要你能想到。</li>\n      </ol>\n      <ul>\n        <li>⚠️ <strong>注意</strong>：如果出现输入之后无回复，可以回<strong>主菜单-设置</strong>⚙️里面点"<strong>恢复默认设置</strong>🔄"。一般是初始化的网络问题🌐。</li>\n        <li>🔍 <strong>注意</strong>：高亮有颜色的文字可以点🔗。</li>\n        <li>📜 <strong>注意</strong>：在<strong>桥段剧本</strong>之外，主持人给出的信息不完全保真（比如问队友问题，可能会得到不正确的回复🤔），可以完全取信的是非大模型的<strong>桥段剧本</strong>、<strong>初始事件</strong>、<strong>词条解释</strong>。</li>\n      </ul>\n    '}},jt={reviewTitle:"桥段回顾",noReviewRecords:"暂无桥段回顾记录。",rename:"重命名",delete:"删除",viewDetails:"查看详情",reviewDetails:"回顾详情",exportAsHTML:"导出为HTML",exportAsImage:"导出为长图",exportAsMultipleImages:"导出为多图",enterNewTitle:"请输入新的标题",confirmDelete:"您确定要删除这条回顾记录吗？",renameReview:"重命名回顾",confirmDeleteMessage:"确定要删除这条回顾记录吗？"},Gt={newGame:"开始新游戏",continueGame:"继续游戏",reviewRecords:"回顾记录",importSave:"导入存档",exportSave:"导出存档",deleteSave:"删除存档",confirmImport:"您确定要导入并覆盖存档吗？此操作无法撤销。您可以先导出自己的存档进行备份。",importSuccess:"存档已成功导入",returnToSections:"返回桥段选择",chooseSection:"选择桥段",completed:"已完成",replay:"重玩",skip:"跳过",start:"开始",locked:"未解锁",confirmReturn:"确定要返回吗？当前进度将不会保存。",loadSectionError:"加载章节失败",sectionSkipped:"已跳过本章节",confirmNewGame:"确定要开始新游戏吗？当前存档将会被覆盖。",startGameError:"开始新游戏失败",loadSaveError:"加载存档失败",typeCombat:"战斗",typeWits:"智斗",typeStory:"剧情",typePuzzle:"解谜",typePersuade:"说服",typeRomance:"恋爱",typeNone:"无标签",sectionFailed:"章节未完成",sectionSuccess:"章节完成",tryAgain:"重新尝试"},Bt={success:"成功",error:"错误",confirm:"确认",cancel:"取消",close:"关闭",back:"返回",return:"返回",loading:"加载中...",mainMenu:"主菜单",returnToMenu:"返回主菜单",save:"保存",reset:"重置",help:"帮助",confirmAction:"确定要执行此操作吗？",actionSuccess:"操作成功",actionFailed:"操作失败",networkError:"网络错误",pleaseWait:"请稍候...",retry:"重试",skip:"跳过",next:"下一步",previous:"上一步",finish:"完成",continue:"继续",exit:"退出"},Kt={mainTitle:"不止于纸上的故事",subTitle:"Beyond Books",gameDescription:"一个由AI(gpt4o-mini)驱动的异能战斗/交涉/聊天文字剧本杀",creatorsMessage:"制作者的话",creatorsMessageTitle:"制作者的话",creatorsMessageContent:'\n    <p>《不止于纸上的故事》曾经是我在2015年主导创作的纸上游戏、桌上剧团<b>"BB"</b>，到了大学我翻遍字典，找到了 <b>Beyond Books</b> 这两个词。我很荣幸能将其搬到电子游戏中，终于能与大家分享我的故事。</p>\n    <p>现代的大型语言模型可以帮我把大纲和细节演出的生动而充满意外，我不胜感激这个新时代。一个人做测试难免不周到，出bug还请多多海涵。</p>\n    <p>目前的故事进行到了<strong>银月篇罗伯特线的完结部分</strong>，接下来打算更新其他人在银月篇的线！罗伯特线里面实际上有大量未解答的东西，到其他人的视角中也许就真相大白了~ 我追求其他人的线不与旧线重复，重复部分略过。</p>\n    <p><strong>鸣谢与我交流的玩家们：</strong>小沃里 佚名 裴冬柚 shangui Hecean 洛海 机旅策划 H2Oovo</p>\n    <p><strong>致谢朋友们：</strong>TOLINIA Tourswen 镜子 Crystal 琼 玉米</p>\n    <p><strong>敬谢大自然：</strong>海南之海 灵界之海</p>\n    <p><strong>作者：</strong>苏敬峰/tobenot</p>\n  ',updateLog:"更新日志 24.11.02",updateLogTitle:"更新日志",updateLogContent:"\n    <p>只有比较大的更新在这里展示</p>\n    <p><strong>2024年11月</strong> 这个月把整个项目迁移到了vue3上，大幅度美化了界面，剧本结构有很大改动所以暂时还在翻新。</p>\n    <p><strong>2024年10月</strong> 做了多Agent的尝试，效果很好！</p>\n    <p><strong>2024年7月02日</strong> 银月篇 罗伯特线 完结！</p>\n    <p><strong>2024年6月23日</strong> 银月篇 罗伯特线 第二回</p>\n    <p><strong>2024年6月10日</strong> 银月篇 罗伯特线 开篇</p>\n    <p><strong>2024年6月03日</strong> 开坑！</p>\n  ",gameTutorial:{title:"游戏教程",content:'\n      <p>你可以把本游戏理解为<strong>跑团（DND或COC）</strong>、<strong>语C</strong>、<strong>剧本杀</strong>或<strong>过家家</strong>🧑‍🤝‍🧑。本游戏制作时面向的玩家是<strong>喜欢剧情向游戏</strong>，愿意<strong>认真扮演角色</strong>🎭  的语C、跑团玩家👥。</p>\n      <ol>\n        <li>📝 <strong>目标</strong>：在每一个桥段里，你需要完成<strong>桥段目标</strong>🎯，目标可能是<strong>沟通</strong>💬、<strong>战斗</strong>⚔️、<strong>解密</strong>🧩等。</li>\n        <li>🎮 <strong>操作</strong>：根据你的人设和起始事件，在对话框中打字输入以<strong>你的角色的角度</strong>进行的行动、说的话🗣️。比如输入"我挥起武器说，与我何干！"，不需要特别注意格式。</li>\n        <li>💡 <strong>技巧</strong>：很多角色有<strong>超能力</strong>🔮，比如银月篇主角罗伯特，可以<strong>减缓时间流速</strong>🕰️，你可以接住敌方扔来的飞刀扔回去🗡️，也能准确地瞄准你要攻击的物件🎯，只要你能想到。</li>\n      </ol>\n      <ul>\n        <li>⚠️ <strong>注意</strong>：如果出现输入之后无回复，可以回<strong>主菜单-设置</strong>⚙️里面点"<strong>恢复默认设置</strong>🔄"。一般是初始化的网络问题🌐。</li>\n        <li>🔍 <strong>注意</strong>：高亮有颜色的文字可以点🔗。</li>\n        <li>📜 <strong>注意</strong>：在<strong>桥段剧本</strong>之外，主持人给出的信息不完全保真（比如问队友问题，可能会得到不正确的回复🤔），可以完全取信的是非大模型的<strong>桥段剧本</strong>、<strong>初始事件</strong>、<strong>词条解释</strong>。</li>\n      </ul>\n    '},footer:{qqGroup:"QQ群",bilibili:"B站",welcomeMessage:"欢迎讨论剧情/私信留言等~"}},Ht={settings:Mt,tutorial:Ut,review:jt,game:Gt,common:Bt,menu:Kt};var Ft=(0,z.hU)({legacy:!1,locale:"zh-CN",fallbackLocale:"zh-CN",messages:{"zh-CN":Ht},globalInjection:!0});function Vt(e){e.use(Ft)}var Wt=function(){return{showTutorial:!1,tutorialContent:{title:"",content:""}}},zt={SET_SHOW_TUTORIAL:function(e,t){e.showTutorial=t},SET_TUTORIAL_CONTENT:function(e,t){e.tutorialContent=t},HIDE_TUTORIAL:function(e){e.showTutorial=!1}},Xt={showGameTutorial:function(e){var t=e.commit;t("SET_TUTORIAL_CONTENT",{title:r["default"].global.t("tutorial.title"),content:r["default"].global.t("tutorial.content")}),t("SET_SHOW_TUTORIAL",!0)},hideTutorial:function(e){var t=e.commit;t("HIDE_TUTORIAL")},showCustomTutorial:function(e,t){var n=e.commit,r=t.title,a=t.content;n("SET_TUTORIAL_CONTENT",{title:r,content:a}),n("SET_SHOW_TUTORIAL",!0)}},Jt={isShowingTutorial:function(e){return e.showTutorial},tutorialContent:function(e){return e.tutorialContent}};const Yt={namespaced:!0,state:Wt,mutations:zt,actions:Xt,getters:Jt};n(739),n(3110);var qt=n(1396),Qt=n.n(qt),$t={ADVANCED:"advanced",BASIC:"basic"},Zt=(0,Tt.A)((0,Tt.A)({},$t.ADVANCED,"gpt-4o-mini"),$t.BASIC,"gpt-4o-mini"),en="settings",tn="YourEncryptionKey",nn={ADVANCED:"advanced",BASIC:"basic"};function rn(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:nn.BASIC,t=JSON.parse(localStorage.getItem("settings"));return t&&t[e]||Zt[e]}var an={apiKey:"",apiUrl:"https://api.deepbricks.ai/v1/",advancedModel:"gpt-4o-mini",basicModel:"gpt-4o-mini",isPublicKey:!1},on={setSettings:function(e,t){t.apiKey&&(e.apiKey=t.apiKey),t.apiUrl&&(e.apiUrl=t.apiUrl),e.advancedModel=t.advancedModel,e.basicModel=t.basicModel,e.isPublicKey=t.isPublicKey,this.commit("api/SET_API_KEY",e.apiKey),this.commit("api/SET_API_URL",e.apiUrl)},SET_PUBLIC_KEY:function(e,t){e.apiKey=t,e.isPublicKey=!0,this.commit("api/SET_API_KEY",t)}},sn={loadSettings:function(e){return(0,o.A)((0,a.A)().mark((function t(){var n,r;return(0,a.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:return n=e.commit,t.next=3,cn();case 3:r=t.sent,n("setSettings",r);case 5:case"end":return t.stop()}}),t)})))()},saveSettings:function(e,t){return(0,o.A)((0,a.A)().mark((function n(){var r;return(0,a.A)().wrap((function(n){while(1)switch(n.prev=n.next){case 0:return r=e.commit,n.next=3,un(t);case 3:r("setSettings",t);case 4:case"end":return n.stop()}}),n)})))()},getPublicKey:function(e){return(0,o.A)((0,a.A)().mark((function t(){var n,r;return(0,a.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:return n=e.commit,t.prev=1,t.next=4,pn();case 4:if(r=t.sent,r){t.next=7;break}throw new Error("Invalid public key");case 7:return n("SET_PUBLIC_KEY",r),t.abrupt("return",!0);case 11:return t.prev=11,t.t0=t["catch"](1),console.error("获取公钥失败:",t.t0),t.abrupt("return",!1);case 15:case"end":return t.stop()}}),t,null,[[1,11]])})))()},resetSettings:function(e){return(0,o.A)((0,a.A)().mark((function t(){var n;return(0,a.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:return n=e.dispatch,t.next=3,un(ln());case 3:n("loadSettings");case 4:case"end":return t.stop()}}),t)})))()},initializeSave:function(e){return(0,o.A)((0,a.A)().mark((function t(){var n;return(0,a.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:return n=e.dispatch,t.next=3,n("loadSettings");case 3:case"end":return t.stop()}}),t)})))()}};function cn(){var e=localStorage.getItem(en);return e?JSON.parse(e):ln()}function un(e){localStorage.setItem(en,JSON.stringify(e))}function ln(){return{apiKey:"",apiUrl:"https://api.deepbricks.ai/v1/",advancedModel:"gpt-4o-mini",basicModel:"gpt-4o-mini",isPublicKey:!1}}function pn(){return dn.apply(this,arguments)}function dn(){return dn=(0,o.A)((0,a.A)().mark((function e(){var t,n,r;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,fetch("https://tobenot.top/storage/keyb.txt");case 3:if(t=e.sent,t.ok){e.next=6;break}throw new Error("Network response was not ok");case 6:return e.next=8,t.text();case 8:if(n=e.sent,r=gn(n,tn),r){e.next=12;break}throw new Error("Decryption failed");case 12:return e.abrupt("return",r);case 15:throw e.prev=15,e.t0=e["catch"](0),console.error("Error fetching or decrypting public key:",e.t0),e.t0;case 19:case"end":return e.stop()}}),e,null,[[0,15]])}))),dn.apply(this,arguments)}function gn(e,t){var n=Qt().AES.decrypt(e,t);return n.toString(Qt().enc.Utf8)}var hn={hasValidSettings:function(e){return!!e.apiKey&&!!e.apiUrl}};const vn={namespaced:!0,state:an,mutations:on,actions:sn,getters:hn};var fn=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";(0,ge.A)(this,e),this.debugMode=t,this.moduleName=n}return(0,he.A)(e,[{key:"getPrefix",value:function(){return this.moduleName?"[".concat(this.moduleName,"]"):""}},{key:"log",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;this.debugMode&&console.log("[LOG]".concat(this.getPrefix()," ").concat(e),t)}},{key:"warn",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;this.debugMode&&console.warn("[WARN]".concat(this.getPrefix()," ").concat(e),t)}},{key:"error",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;console.error("[ERROR]".concat(this.getPrefix()," ").concat(e),t)}}])}(),mn=new fn(!1,"API"),Sn=function(){return{apiKey:"",apiUrl:"",isLoading:!1}},An={SET_API_KEY:function(e,t){e.apiKey=t},SET_API_URL:function(e,t){e.apiUrl=t},SET_LOADING:function(e,t){e.isLoading=t}},yn={handleApiResponse:function(e,t){return(0,o.A)((0,a.A)().mark((function e(){var n;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(t.ok){e.next=6;break}return e.next=3,t.json();case 3:throw n=e.sent,console.error("错误响应内容:",n),new Error("HTTP error! status: ".concat(t.status));case 6:return e.next=8,t.json();case 8:return e.abrupt("return",e.sent);case 9:case"end":return e.stop()}}),e)})))()},processStreamingResponse:function(e,t){return(0,o.A)((0,a.A)().mark((function n(){var r,o,i,s,c,u,l,p,d,g,h,v,f,m,S,A,y,E,b;return(0,a.A)().wrap((function(n){while(1)switch(n.prev=n.next){case 0:return r=e.state,o=e.commit,i=t.prompt,s=t.updateCallback,mn.log("发送流式请求:",{prompt:i}),c={method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(r.apiKey),Accept:"text/event-stream"},body:JSON.stringify({model:rn(nn.BASIC),messages:[{role:"user",content:i}],max_tokens:1e3,stream:!0})},n.prev=4,o("SET_LOADING",!0),n.next=8,fetch(r.apiUrl+"chat/completions",c);case 8:if(u=n.sent,u.ok){n.next=11;break}throw new Error("HTTP error! status: ".concat(u.status));case 11:l=u.body.getReader(),p=new TextDecoder,d="",g="",h=!1;case 16:if(h){n.next=41;break}return n.next=19,l.read();case 19:if(v=n.sent,f=v.done,m=v.value,!f){n.next=24;break}return n.abrupt("break",41);case 24:d+=p.decode(m,{stream:!0}),S=d.split("\n"),A=0;case 27:if(!(A<S.length-1)){n.next=38;break}if(y=S[A],!y.startsWith("data: ")){n.next=35;break}if(E=y.slice(6),"[DONE]"!==E){n.next=34;break}return h=!0,n.abrupt("break",38);case 34:try{b=JSON.parse(E),b.choices&&b.choices[0].delta.content&&(g+=b.choices[0].delta.content,s(g))}catch(a){console.error("JSON解析错误:",a)}case 35:A++,n.next=27;break;case 38:d=S[S.length-1],n.next=16;break;case 41:return mn.log("流式响应完成:",{result:g}),n.abrupt("return",g);case 45:throw n.prev=45,n.t0=n["catch"](4),console.error("流式请求错误:",n.t0),n.t0;case 49:return n.prev=49,o("SET_LOADING",!1),n.finish(49);case 52:case"end":return n.stop()}}),n,null,[[4,45,49,52]])})))()},callLargeLanguageModelWithSchema:function(e,t){return(0,o.A)((0,a.A)().mark((function n(){var r,o,i,s,c,u,l,p;return(0,a.A)().wrap((function(n){while(1)switch(n.prev=n.next){case 0:return r=e.state,o=e.dispatch,i=t.prompt,s=t.schema,mn.log("发送API请求:",{prompt:i,schema:s}),c={method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(r.apiKey),Accept:"application/json"},body:JSON.stringify({model:rn(nn.BASIC),messages:[{role:"user",content:i}],response_format:{type:"json_schema",json_schema:{name:"moderator_response",schema:s,strict:!0}},max_tokens:1e3})},n.next=6,fetch(r.apiUrl+"chat/completions",c);case 6:return u=n.sent,n.next=9,o("handleApiResponse",u);case 9:return l=n.sent,p=JSON.parse(l.choices[0].message.content),mn.log("API响应:",{content:p}),n.abrupt("return",p);case 13:case"end":return n.stop()}}),n)})))()}},En={isLoading:function(e){return e.isLoading},hasApiKey:function(e){return!!e.apiKey}};const bn={namespaced:!0,state:Sn,mutations:An,actions:yn,getters:En};var wn=n(9258),xn=(n(8431),n(4346),n(5086),n(2892),"ReadingThisIsASpoilerForYourself");function Tn(e,t){var n=Qt().AES.decrypt(e,t),r=n.toString(Qt().enc.Utf8);try{return JSON.parse(r)}catch(a){throw console.error("解析JSON时出错:",a.message),a}}function kn(e){return _n.apply(this,arguments)}function _n(){return _n=(0,o.A)((0,a.A)().mark((function e(t){var n,r;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,fetch("".concat((0,m.D)(),"/").concat(t,"?v=").concat((new Date).getTime()));case 3:if(n=e.sent,n.ok){e.next=6;break}throw new Error("HTTP error! status: ".concat(n.status));case 6:return e.next=8,n.text();case 8:return r=e.sent,e.abrupt("return",Tn(r,xn));case 12:throw e.prev=12,e.t0=e["catch"](0),console.error("加载章节数据失败:",e.t0),e.t0;case 16:case"end":return e.stop()}}),e,null,[[0,12]])}))),_n.apply(this,arguments)}var Cn=function(){return{currentScenario:null,scenarioConfig:null,chapters:[],unlockedSections:[],currentSection:null,currentSectionData:null}},In={SET_CHAPTERS:function(e,t){e.chapters=t},SET_UNLOCKED_SECTIONS:function(e,t){e.unlockedSections=t},SET_CURRENT_SECTION:function(e,t){e.currentSection=t},SET_CURRENT_SECTION_DATA:function(e,t){e.currentSectionData=t},SET_SCENARIO_CONFIG:function(e,t){e.scenarioConfig=t},SET_CURRENT_SCENARIO:function(e,t){e.currentScenario=t}},Rn={initialize:function(e){return(0,o.A)((0,a.A)().mark((function t(){var n,r,o;return(0,a.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:n=e.commit,r=e.rootState,o=r.save.saveIndex.currentScenario||"silver_moon",console.log("初始化剧本ID:",o),n("SET_CURRENT_SCENARIO",o);case 4:case"end":return t.stop()}}),t)})))()},loadScenarioConfig:function(e){return(0,o.A)((0,a.A)().mark((function t(){var n,r,o,i,s,c;return(0,a.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(n=e.commit,r=e.state,o=e.dispatch,t.prev=1,r.currentScenario){t.next=6;break}return console.log("当前无剧本ID，尝试初始化..."),t.next=6,o("initialize");case 6:if(i=r.currentScenario,console.log("准备加载剧本配置，当前剧本ID:",i),i){t.next=10;break}throw new Error("初始化失败：无法获取剧本ID");case 10:return t.next=12,fetch("".concat((0,m.D)(),"/scenarios/").concat(i,"/config.json"));case 12:if(s=t.sent,s.ok){t.next=15;break}throw new Error("加载配置失败: ".concat(s.status," ").concat(s.statusText));case 15:return t.next=17,s.json();case 17:return c=t.sent,console.log("成功加载剧本配置:",c),n("SET_SCENARIO_CONFIG",c),t.abrupt("return",c);case 23:throw t.prev=23,t.t0=t["catch"](1),console.error("加载剧本配置失败:",t.t0),t.t0;case 27:case"end":return t.stop()}}),t,null,[[1,23]])})))()},loadSectionsIndex:function(e){return(0,o.A)((0,a.A)().mark((function t(){var n,r,o,i,s,c,u;return(0,a.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:return n=e.commit,r=e.state,o=e.dispatch,t.prev=1,console.log("开始加载章节索引..."),t.next=5,o("loadScenarioConfig");case 5:return t.next=7,fetch("".concat((0,m.D)(),"/scenarios/").concat(r.currentScenario,"/sections.json?v=").concat((new Date).getTime()));case 7:return s=t.sent,t.next=10,s.json();case 10:if(c=t.sent,c&&c.chapters){t.next=13;break}throw new Error("章节索引数据无效");case 13:return console.log("章节索引加载成功:",c),n("SET_CHAPTERS",c.chapters),u=(null===(i=r.scenarioConfig)||void 0===i?void 0:i.initialSection)||21,n("SET_UNLOCKED_SECTIONS",[u]),console.log("章节初始化完成"),t.abrupt("return",c);case 21:throw t.prev=21,t.t0=t["catch"](1),console.error("加载章节索引失败:",t.t0),t.t0;case 25:case"end":return t.stop()}}),t,null,[[1,21]])})))()},loadSection:function(e,t){return(0,o.A)((0,a.A)().mark((function n(){var r,o,i,s;return(0,a.A)().wrap((function(n){while(1)switch(n.prev=n.next){case 0:return r=e.commit,o=e.dispatch,i=e.state,n.prev=1,n.next=4,o("conversation/clearConversation",null,{root:!0});case 4:return n.next=6,o("gameState/resetState",null,{root:!0});case 6:return n.next=8,o("game/resetState",null,{root:!0});case 8:return n.next=10,kn("scenarios/".concat(i.currentScenario,"/sections/").concat(t));case 10:if(s=n.sent,s){n.next=13;break}throw new Error("章节数据加载失败: ".concat(t," 返回空数据"));case 13:if(s.startEvent){n.next=15;break}throw new Error("章节数据格式错误: ".concat(t," 缺少 startEvent 属性"));case 15:if(!s.image){n.next=19;break}return s.image="".concat((0,m.D)()).concat(s.image),n.next=19,fe.preloadImage(s.image);case 19:if(!s.initialSuggestions||!Array.isArray(s.initialSuggestions)){n.next=22;break}return n.next=22,o("conversation/setSuggestions",s.initialSuggestions,{root:!0});case 22:return r("SET_CURRENT_SECTION",s),r("SET_CURRENT_SECTION_DATA",s),n.next=26,o("game/initializeGame",null,{root:!0});case 26:return n.abrupt("return",s);case 29:throw n.prev=29,n.t0=n["catch"](1),console.error("加载章节失败:",n.t0),n.t0;case 33:case"end":return n.stop()}}),n,null,[[1,29]])})))()},unlockSection:function(e,t){return(0,o.A)((0,a.A)().mark((function n(){var r,o,i,s,c;return(0,a.A)().wrap((function(n){while(1)switch(n.prev=n.next){case 0:if(r=e.commit,o=e.state,i=e.dispatch,s=Number(t),!isNaN(s)){n.next=5;break}return console.warn("无效的章节ID:",t),n.abrupt("return");case 5:if(o.unlockedSections.includes(s)){n.next=11;break}return c=(0,wn.A)(new Set([].concat((0,wn.A)(o.unlockedSections),[s]))),r("SET_UNLOCKED_SECTIONS",c),n.next=10,i("save/updateSaveData",{path:"unlockedSections",value:c},{root:!0});case 10:i("checkUnlockConditions");case 11:case"end":return n.stop()}}),n)})))()},completeSection:function(e,t){return(0,o.A)((0,a.A)().mark((function n(){var r;return(0,a.A)().wrap((function(n){while(1)switch(n.prev=n.next){case 0:return r=e.dispatch,console.log("完成章节:",t),n.next=4,r("checkUnlockConditions");case 4:case"end":return n.stop()}}),n)})))()},skipSection:function(e,t){return(0,o.A)((0,a.A)().mark((function n(){var r,o,i,s;return(0,a.A)().wrap((function(n){while(1)switch(n.prev=n.next){case 0:return r=e.dispatch,o=e.state,n.prev=1,console.log("跳过章节:",t),console.log("当前剧本ID:",o.currentScenario),n.next=6,kn("scenarios/".concat(o.currentScenario,"/sections/").concat(t));case 6:if(i=n.sent,i&&i.id){n.next=9;break}throw new Error("无效的章节数据");case 9:return s={objective:!0,influencePoints:[],objective_judge:"章节已跳过",summary:"章节已跳过"},n.next=12,r("save/loadSave",null,{root:!0});case 12:return n.next=14,r("save/updateSaveData",{path:"progress.sectionResults.".concat(i.id),value:s},{root:!0});case 14:return n.next=16,r("unlockSection",i.id);case 16:return n.next=18,r("checkUnlockConditions");case 18:console.log("章节跳过完成:",i.id),n.next=25;break;case 21:throw n.prev=21,n.t0=n["catch"](1),console.error("跳过章节失败:",n.t0),n.t0;case 25:case"end":return n.stop()}}),n,null,[[1,21]])})))()},preloadSectionImages:function(e){return(0,o.A)((0,a.A)().mark((function t(){var n,r;return(0,a.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:return n=e.state,r=[],n.chapters.forEach((function(e){e.sections.forEach((function(e){e.image&&r.push("".concat((0,m.D)()).concat(e.image))}))})),t.next=5,fe.preloadBatch(r);case 5:case"end":return t.stop()}}),t)})))()},checkUnlockConditions:function(e){var t,n,r,a=e.state,o=e.dispatch,i=e.rootState;if(console.log("开始检查解锁条件"),console.log("rootState.save:",i.save),console.log("currentScenarioSave:",null===(t=i.save)||void 0===t?void 0:t.currentScenarioSave),console.log("saveData:",null===(n=i.save)||void 0===n||null===(n=n.currentScenarioSave)||void 0===n?void 0:n.saveData),null!==(r=i.save)&&void 0!==r&&null!==(r=r.currentScenarioSave)&&void 0!==r&&null!==(r=r.saveData)&&void 0!==r&&r.progress){var s=i.save.currentScenarioSave.saveData.progress.sectionResults||{},c=i.save.currentScenarioSave.saveData.progress.globalInfluencePoints||[];console.log("检查解锁条件开始"),console.log("当前已解锁章节:",a.unlockedSections),console.log("章节结果:",s);var u=a.chapters;u.forEach((function(e){e.sections.forEach((function(e){if(!a.unlockedSections.includes(e.id)&&e.preconditions&&Array.isArray(e.preconditions)){var t=e.preconditions.every((function(e){if(e.sectionId){var t=s[e.sectionId];return!(null===t||void 0===t||!t.objective)&&("objective"===e.condition?t.objective===e.result:!e.condition||t.influencePoints.some((function(t){return t.name===e.condition&&t.influence===e.result})))}if(e.global){var n=c.find((function(t){return t.name===e.condition}));return(null===n||void 0===n?void 0:n.influence)===e.result}return!1}));t&&o("unlockSection",e.id)}}))}))}else{var l,p,d;console.warn("存档数据未完全初始化:",{save:!!i.save,currentScenarioSave:!(null===(l=i.save)||void 0===l||!l.currentScenarioSave),saveData:!(null===(p=i.save)||void 0===p||null===(p=p.currentScenarioSave)||void 0===p||!p.saveData),progress:!(null===(d=i.save)||void 0===d||null===(d=d.currentScenarioSave)||void 0===d||null===(d=d.saveData)||void 0===d||!d.progress)})}},SET_UNLOCKED_SECTIONS:function(e,t){var n=e.commit;n("SET_UNLOCKED_SECTIONS",t)},SET_CURRENT_SCENARIO:function(e,t){var n=e.commit;n("SET_CURRENT_SCENARIO",t)}},Nn={isSectionUnlocked:function(e){return function(t){return e.unlockedSections.includes(t)}},isSectionCompleted:function(e,t,n){return function(e){var t,r=n.save.saveData.progress.sectionResults||{};return!0===(null===(t=r[e])||void 0===t?void 0:t.objective)}},getCurrentSection:function(e){return e.currentSection},getCurrentSectionData:function(e){return e.currentSectionData},getSectionTypeText:function(){return function(e){var t=Ft.global.t;if(!e)return t("game.typeNone");var n={combat:t("game.typeCombat"),wits:t("game.typeWits"),story:t("game.typeStory"),puzzle:t("game.typePuzzle"),persuade:t("game.typePersuade"),romance:t("game.typeRomance")};return n[e]||t("game.typeNone")}}};const On={namespaced:!0,state:Cn,mutations:In,actions:Rn,getters:Nn};var Ln=function(){return{tooltipInfo:{show:!1,description:"",imageUrl:"",term:"",event:null}}},Dn={SET_TOOLTIP_INFO:function(e,t){e.tooltipInfo=t}},Pn={showTermTooltip:function(e,t){var n=e.commit,r=t.term,a=t.event,o=S.value.terms[r];if(o){o.description&&(o.description=o.description.replace(/\n/g,"<br>"));var i=k({term:r,event:a,termConfig:o});n("SET_TOOLTIP_INFO",i)}},hideTermTooltip:function(e){var t=e.commit,n=_();t("SET_TOOLTIP_INFO",n)}};const Mn={namespaced:!0,state:Ln,mutations:Dn,actions:Pn};var Un=function(){return{isProcessing:!1,interactionStage:{stage:"",info:"",visible:!1},validationError:""}},jn={SET_PROCESSING:function(e,t){e.isProcessing=t},SET_INTERACTION_STAGE:function(e,t){var n=t.stage,r=t.info;e.interactionStage={stage:n,info:r?r.replace(/\\n/g,"\n"):"",visible:!0}},HIDE_INTERACTION_STAGE:function(e){e.interactionStage.visible=!1},SET_VALIDATION_ERROR:function(e,t){e.validationError=t},HIDE_VALIDATION_ERROR:function(e){e.validationError=""}},Gn={handleUserInput:function(e,t){return(0,o.A)((0,a.A)().mark((function n(){var r,o;return(0,a.A)().wrap((function(n){while(1)switch(n.prev=n.next){case 0:if(r=e.commit,o=e.dispatch,t.trim()){n.next=3;break}return n.abrupt("return");case 3:return r("SET_PROCESSING",!0),n.prev=4,n.next=7,o("conversation/addUserMessage",t,{root:!0});case 7:n.next=12;break;case 9:n.prev=9,n.t0=n["catch"](4),console.error("处理用户输入时出错:",n.t0);case 12:return n.prev=12,r("SET_PROCESSING",!1),n.finish(12);case 15:case"end":return n.stop()}}),n,null,[[4,9,12,15]])})))()},updateInteractionStage:function(e,t){var n=e.commit,r=t.stage,a=t.info;n("SET_INTERACTION_STAGE",{stage:r,info:a})},hideInteractionStage:function(e){var t=e.commit;t("HIDE_INTERACTION_STAGE")},showValidationError:function(e,t){var n=e.commit;n("SET_VALIDATION_ERROR",t)},hideValidationError:function(e){var t=e.commit;t("HIDE_VALIDATION_ERROR")}},Bn={isProcessing:function(e){return e.isProcessing},interactionStage:function(e){return e.interactionStage},isInputDisabled:function(e){return e.isProcessing},validationError:function(e){return e.validationError}};const Kn={namespaced:!0,state:Un,mutations:jn,actions:Gn,getters:Bn};n(1688),n(3296),n(7208),n(8408),n(4603),n(7566),n(8721);var Hn="beyondBooksSaveData",Fn="beyondBooksSaveIndex",Vn="YourExportSecretKey",Wn="YourReviewKey",zn=function(e){return"".concat(Hn,"_").concat(e)},Xn=function(){return{currentScenario:"silver_moon",scenarios:{silver_moon:{name:"不止于纸上的故事：银月篇",lastSaveTime:(new Date).toISOString(),startTime:(new Date).toISOString()}}}},Jn=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return{scenarioId:e,scenarioConfig:t,saveData:{currentSectionId:null,unlockedSections:[t.initialSection||21],progress:{globalInfluencePoints:[],sectionResults:{},plotTriggers:[],turnCount:0},player:{selectedCharacter:"罗伯特"},extensions:{}}}},Yn=function(){return{saveIndex:Xn(),currentScenarioSave:null,hasSave:!1}},qn={SET_SAVE_INDEX:function(e,t){e.saveIndex=t},SET_CURRENT_SCENARIO_SAVE:function(e,t){e.currentScenarioSave=t,e.hasSave=!0},UPDATE_SCENARIO_SAVE:function(e,t){for(var n=t.path,r=t.value,a=n.split("."),o=e.currentScenarioSave.saveData,i=0;i<a.length-1;i++)o=o[a[i]];o[a[a.length-1]]=r},CLEAR_CURRENT_SAVE:function(e){e.currentScenarioSave=null,e.hasSave=!1}},Qn={initializeSaveIndex:function(e){return(0,o.A)((0,a.A)().mark((function t(){var n,r,o;return(0,a.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:return n=e.commit,r=localStorage.getItem(Fn),o=r?JSON.parse(r):Xn(),n("SET_SAVE_INDEX",o),t.abrupt("return",o);case 5:case"end":return t.stop()}}),t)})))()},loadScenarioSave:function(e,t){return(0,o.A)((0,a.A)().mark((function n(){var r,o,i,s,c,u,l;return(0,a.A)().wrap((function(n){while(1)switch(n.prev=n.next){case 0:return r=e.commit,o=e.dispatch,i=e.state,n.prev=1,s=zn(t),c=localStorage.getItem(s),n.next=6,o("sections/SET_CURRENT_SCENARIO",t,{root:!0});case 6:return n.next=8,o("sections/loadScenarioConfig",null,{root:!0});case 8:return u=n.sent,c?(l=JSON.parse(c),l.saveData.progress||(console.warn("修复存档数据结构：添加缺失的progress对象"),l.saveData.progress={globalInfluencePoints:[],sectionResults:{},plotTriggers:[],turnCount:0})):l=Jn(t,u),console.log("加载的存档数据:",l),console.log("progress对象:",l.saveData.progress),r("SET_CURRENT_SCENARIO_SAVE",l),n.next=15,Promise.all([o("sections/SET_UNLOCKED_SECTIONS",l.saveData.unlockedSections,{root:!0}),o("gameState/SET_GLOBAL_INFLUENCE_POINTS",l.saveData.progress.globalInfluencePoints,{root:!0}),o("gameState/SET_SECTION_RESULT",l.saveData.progress.sectionResults,{root:!0})]);case 15:return n.next=17,o("sections/checkUnlockConditions",null,{root:!0});case 17:return n.abrupt("return",l);case 20:throw n.prev=20,n.t0=n["catch"](1),console.error("加载剧本存档失败:",n.t0,"存档数据结构:",i.currentScenarioSave),n.t0;case 24:case"end":return n.stop()}}),n,null,[[1,20]])})))()},saveCurrentScenario:function(e){return(0,o.A)((0,a.A)().mark((function t(){var n,r,o,i,c;return(0,a.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(n=e.commit,r=e.state,t.prev=1,r.currentScenarioSave){t.next=4;break}return t.abrupt("return");case 4:return o=r.currentScenarioSave.scenarioId,i=zn(o),c=(0,s.A)((0,s.A)({},r.saveIndex),{},{currentScenario:o,scenarios:(0,s.A)((0,s.A)({},r.saveIndex.scenarios),{},(0,Tt.A)({},o,(0,s.A)((0,s.A)({},r.saveIndex.scenarios[o]),{},{lastSaveTime:(new Date).toISOString()})))}),localStorage.setItem(Fn,JSON.stringify(c)),localStorage.setItem(i,JSON.stringify(r.currentScenarioSave)),n("SET_SAVE_INDEX",c),t.abrupt("return",r.currentScenarioSave);case 13:throw t.prev=13,t.t0=t["catch"](1),console.error("保存剧本失败:",t.t0),t.t0;case 17:case"end":return t.stop()}}),t,null,[[1,13]])})))()},exportSave:function(e){return(0,o.A)((0,a.A)().mark((function t(){var n,r,o,i,s,c,u,l,p,d,g;return(0,a.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(n=e.state,r=n.currentScenarioSave,r){t.next=4;break}return t.abrupt("return");case 4:o=JSON.stringify({scenarioId:r.scenarioId,saveData:r.saveData}),i=localStorage.getItem(Wn)||"{}",s=JSON.stringify({gameData:Qt().AES.encrypt(o,Vn).toString(),reviewData:Qt().AES.encrypt(i,Vn).toString()}),c=new Blob([s],{type:"application/octet-stream"}),u=URL.createObjectURL(c),l=new Date,p=l.toISOString().replace(/[:.]/g,"-").slice(0,19),d="BeyondBooks存档_".concat(r.scenarioId,"_").concat(p,".savegame"),g=document.createElement("a"),g.href=u,g.download=d,g.click(),URL.revokeObjectURL(u);case 17:case"end":return t.stop()}}),t)})))()},loadSave:function(e){return(0,o.A)((0,a.A)().mark((function t(){var n,r,o;return(0,a.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(n=e.dispatch,r=e.state,r.saveIndex.scenarios){t.next=4;break}return t.next=4,n("initializeSaveIndex");case 4:return o=r.saveIndex.currentScenario,t.abrupt("return",n("loadScenarioSave",o));case 6:case"end":return t.stop()}}),t)})))()},saveSave:function(e){return(0,o.A)((0,a.A)().mark((function t(){var n;return(0,a.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:return n=e.dispatch,t.abrupt("return",n("saveCurrentScenario"));case 2:case"end":return t.stop()}}),t)})))()},updateSaveData:function(e,t){return(0,o.A)((0,a.A)().mark((function n(){var r,o,i,s,c,u,l,p,d,g;return(0,a.A)().wrap((function(n){while(1)switch(n.prev=n.next){case 0:if(i=e.commit,s=e.dispatch,c=e.state,u=t.path,l=t.value,console.log("更新存档数据:",{path:u,value:l}),console.log("当前存档状态:",null===(r=c.currentScenarioSave)||void 0===r?void 0:r.saveData),c.currentScenarioSave){n.next=8;break}return console.warn("存档未初始化，尝试加载存档"),n.next=8,s("loadSave");case 8:for(null!==(o=c.currentScenarioSave)&&void 0!==o&&null!==(o=o.saveData)&&void 0!==o&&o.progress||(console.warn("修复存档数据结构"),c.currentScenarioSave.saveData||(c.currentScenarioSave.saveData={}),c.currentScenarioSave.saveData.progress={globalInfluencePoints:[],sectionResults:{},plotTriggers:[],turnCount:0}),p=u.split("."),d=c.currentScenarioSave.saveData,"progress"!==p[0]||d.progress||(d.progress={globalInfluencePoints:[],sectionResults:{},plotTriggers:[],turnCount:0}),g=0;g<p.length-1;g++)d[p[g]]||("sectionResults"===p[g]?d[p[g]]={}:["globalInfluencePoints","plotTriggers"].includes(p[g])?d[p[g]]=[]:d[p[g]]={}),d=d[p[g]];return i("UPDATE_SCENARIO_SAVE",{path:u,value:l}),n.abrupt("return",s("saveCurrentScenario"));case 15:case"end":return n.stop()}}),n)})))()},clearSave:function(e){var t,n=e.commit,r=e.state,a=null===(t=r.currentScenarioSave)||void 0===t?void 0:t.scenarioId;a&&localStorage.removeItem(zn(a)),n("CLEAR_CURRENT_SAVE")},importSave:function(e,t){return(0,o.A)((0,a.A)().mark((function n(){var r,i,c;return(0,a.A)().wrap((function(n){while(1)switch(n.prev=n.next){case 0:return r=e.commit,i=e.dispatch,c=e.state,n.abrupt("return",new Promise((function(e,n){var u=new FileReader;u.onload=function(){var t=(0,o.A)((0,a.A)().mark((function t(o){var u,l,p,d,g,h,v,f,m;return(0,a.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(t.prev=0,u=JSON.parse(o.target.result),l=Qt().AES.decrypt(u.gameData,Vn).toString(Qt().enc.Utf8),p=JSON.parse(l),d=JSON.parse(Qt().AES.decrypt(u.reviewData,Vn).toString(Qt().enc.Utf8)),g=p.scenarioId,h=p.saveData,g){t.next=8;break}throw new Error("存档文件缺少剧本ID");case 8:return t.next=10,i("sections/loadScenarioConfig",g,{root:!0});case 10:return v=t.sent,f={scenarioId:g,scenarioConfig:v,saveData:h},localStorage.setItem(zn(g),JSON.stringify(f)),m=(0,s.A)((0,s.A)({},c.saveIndex),{},{currentScenario:g,scenarios:(0,s.A)((0,s.A)({},c.saveIndex.scenarios),{},(0,Tt.A)({},g,{name:v.name||g,lastSaveTime:(new Date).toISOString(),startTime:(new Date).toISOString()}))}),localStorage.setItem(Fn,JSON.stringify(m)),localStorage.setItem(Wn,JSON.stringify(d)),r("SET_SAVE_INDEX",m),r("SET_CURRENT_SCENARIO_SAVE",f),t.next=20,i("sections/checkUnlockConditions",null,{root:!0});case 20:e(),t.next=26;break;case 23:t.prev=23,t.t0=t["catch"](0),n(new Error("入失败，密钥不匹配或数据损坏"));case 26:case"end":return t.stop()}}),t,null,[[0,23]])})));return function(e){return t.apply(this,arguments)}}(),u.onerror=function(){return n(new Error("读取文件失败"))},u.readAsText(t)})));case 2:case"end":return n.stop()}}),n)})))()},setCurrentScenario:function(e,t){return(0,o.A)((0,a.A)().mark((function n(){var r,o,i;return(0,a.A)().wrap((function(n){while(1)switch(n.prev=n.next){case 0:return r=e.commit,o=e.dispatch,i=(0,s.A)((0,s.A)({},Yn.saveIndex),{},{currentScenario:t}),localStorage.setItem(Fn,JSON.stringify(i)),r("SET_SAVE_INDEX",i),n.next=6,o("sections/SET_CURRENT_SCENARIO",t,{root:!0});case 6:case"end":return n.stop()}}),n)})))()}},$n={getSaveData:function(e){var t;return(null===(t=e.currentScenarioSave)||void 0===t?void 0:t.saveData)||Jn().saveData},hasSave:function(e){return e.hasSave},getCurrentScenarioSave:function(e){return e.currentScenarioSave},getSaveIndex:function(e){return e.saveIndex}};const Zn={namespaced:!0,state:Yn,mutations:qn,actions:Qn,getters:$n};n(8980);var er=function(){return{reviewRecords:[]}},tr={SET_REVIEW_RECORDS:function(e,t){e.reviewRecords=t},ADD_REVIEW_RECORD:function(e,t){e.reviewRecords.push(t)},DELETE_REVIEW_RECORD:function(e,t){e.reviewRecords=e.reviewRecords.filter((function(e){return e.id!==t}))},UPDATE_REVIEW_RECORD:function(e,t){var n=e.reviewRecords.findIndex((function(e){return e.id===t.id}));-1!==n&&e.reviewRecords.splice(n,1,t)}},nr={loadReviewRecords:function(e){var t=e.commit,n=localStorage.getItem("reviewRecords"),r=n?JSON.parse(n):[];t("SET_REVIEW_RECORDS",r)},saveReviewRecord:function(e,t){var n=e.commit,r=e.state;n("ADD_REVIEW_RECORD",t),localStorage.setItem("reviewRecords",JSON.stringify(r.reviewRecords))},deleteReviewRecord:function(e,t){var n=e.commit,r=e.state;n("DELETE_REVIEW_RECORD",t),localStorage.setItem("reviewRecords",JSON.stringify(r.reviewRecords))},updateReviewRecord:function(e,t){var n=e.commit,r=e.state;n("UPDATE_REVIEW_RECORD",t),localStorage.setItem("reviewRecords",JSON.stringify(r.reviewRecords))}},rr={getReviewRecords:function(e){return e.reviewRecords}};const ar={namespaced:!0,state:er,mutations:tr,actions:nr,getters:rr};var or=function(){return{currentView:"menu"}},ir={SET_CURRENT_VIEW:function(e,t){e.currentView=t}},sr={initializeUI:function(e){var t=e.commit;t("SET_CURRENT_VIEW","menu")},showSettings:function(e){var t=e.commit;t("SET_CURRENT_VIEW","settings")},hideSettings:function(e){var t=e.commit;t("SET_CURRENT_VIEW","menu")}};const cr={namespaced:!0,state:or,mutations:ir,actions:sr};n(1761);var ur=function(){function e(t,n,r,a,o){(0,ge.A)(this,e),this.name=t.name,this.description=t.description,this.personality=t.personality,this.goals=t.goals,this.sectionGuidance=a,this.debugMode=!1,this.commonKnowledge=n,this.startEvent=r,this.privateMemory=[],this.maxPrivateMemoryLength=5,this.logger=new fn(this.debugMode,"角色 ".concat(this.name)),this.characterTags=this.loadCharacterTag(t.characterTags,o)}return(0,he.A)(e,[{key:"log",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;this.logger&&this.logger.log(e,t)}},{key:"loadCharacterTag",value:function(e,t){return e&&t?(this.log("加载角色标签",{tagKeys:e,globalCharacterTagBase:t}),e.reduce((function(e,n){return t[n]?e[n]=t[n]:console.warn("标签键未找到: ".concat(n)),e}),{})):{}}},{key:"createPrompt",value:function(e){var t=Er.state.conversation.optimizedConversationHistory.map((function(e){return"".concat(e.role,": ").concat(e.content)})).join("\n"),n=this.privateMemory.map((function(e){return"想法: ".concat(e)})).join("\n"),r=Object.entries(this.characterTags).map((function(e){var t=(0,xt.A)(e,2),n=t[0],r=t[1];return"".concat(n,"：").concat(r)})).join("\n"),a="你是".concat(this.name,"。").concat(this.description,"。\n性格：").concat(this.personality,"\n").concat(r,"\n目标：").concat(this.goals.join(", "),"\n公共信息：").concat(this.commonKnowledge,"\n开始事件：").concat(this.startEvent,"\n桥段指导：").concat(this.sectionGuidance,"\n\n剧情历史：\n").concat(t,"\n\n你最近的私人想法：\n").concat(n,"\n\n当前情况：\n").concat(e,"\n再次强调你的角色是").concat(this.name,"。\n\n请用JSON格式回复，包括以下字段：\n1. activeAbilities：明确当前有什么异能正在发动过程中。\n2. checkCanAct：解释并判断你能否行动。比如说有人发动时间减速异能时，你不能行动。注意这是'能否行动'，而不是'要不要行动'。\n3. canAct：布尔值，表示是否能够行动。\n4. thoughts：数组，包含你的思考过程。每个思考步骤应包含思考阶段和内容。思考过程：\n   a. 分析当前情况：仔细考虑你当前的状态，你当前是什么情况。\n   b. 回顾个人目标：思考你的角色目标，以及当前情况如何影响这些目标。\n   c. 考虑可能的行动：列出几个可能的行动方案，包括可能推动剧情发展的合理的行动。\n   d. 哪个行动最快：判断并选择一个能尽快结束剧情的行动，避免进入对峙。哪怕是满足敌人的目标也行。\n5. action：你的最终行动和说的话。");return this.log("生成提示词",{optimizedHistory:t,recentPrivateMemory:n,characterTagText:r,situation:e,fullPrompt:a}),a}},{key:"updateMemory",value:function(e,t){var n=t.thoughts.filter((function(e,t){return 1===t||3===t})).map((function(e){return"".concat(e.step,": ").concat(e.content)})).join("; ");this.privateMemory.push(n),this.privateMemory.length>this.maxPrivateMemoryLength&&this.privateMemory.shift(),this.log("更新私有记忆",{situation:e,response:t,summarizedThoughts:n,currentPrivateMemory:this.privateMemory,memoryLength:this.privateMemory.length})}},{key:"addPrivateThought",value:function(e){this.privateMemory.push(e),this.privateMemory.length>this.maxPrivateMemoryLength&&this.privateMemory.shift(),this.log("添加私人想法",{thought:e,currentPrivateMemory:this.privateMemory,memoryLength:this.privateMemory.length})}},{key:"getResponse",value:function(){var e=(0,o.A)((0,a.A)().mark((function e(t){var n,r,o,i,s,c,u;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return n={type:"object",properties:{activeAbilities:{type:"string"},checkCanAct:{type:"string"},canAct:{type:"boolean"},thoughts:{type:"array",items:{type:"object",properties:{step:{type:"string"},content:{type:"string"}},required:["step","content"],additionalProperties:!1}},action:{type:"string"}},required:["activeAbilities","checkCanAct","canAct","thoughts","action"],additionalProperties:!1},this.log("准备获取AI响应",{action:t,schema:n}),r=this.createPrompt(t),o=[{role:"system",content:r},{role:"user",content:t}],this.log("发送API请求",{conversationHistory:o,apiUrl:Er.state.settings.apiUrl,model:rn(nn.BASIC)}),e.prev=5,e.next=8,fetch(Er.state.settings.apiUrl+"chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(Er.state.settings.apiKey),Accept:"application/json"},body:JSON.stringify({model:rn(nn.BASIC),messages:o,response_format:{type:"json_schema",json_schema:{name:"ai_player_response",schema:n,strict:!0}},max_tokens:1e3}),credentials:"include"});case 8:return i=e.sent,e.next=11,Er.dispatch("api/handleApiResponse",i);case 11:return s=e.sent,c=JSON.parse(s.choices[0].message.content),this.log("AI 原始响应",{responseData:s,parsedResponse:c,usage:s.usage}),!1===c.canAct&&(c.action=c.checkCanAct,c.thoughts=[{step:"无法思考",content:"来不及思考"}],this.log("AI无法行动",c)),this.updateMemory(t,c),u={action:c.action},this.log("AI 最终动作",u),e.abrupt("return",u);case 21:throw e.prev=21,e.t0=e["catch"](5),this.logger.error("Error in AI response:",e.t0),e.t0;case 25:case"end":return e.stop()}}),e,this,[[5,21]])})));function t(t){return e.apply(this,arguments)}return t}()}])}(),lr=function(){function e(){(0,ge.A)(this,e),this.decoder=new TextDecoder("utf-8"),this.buffer=""}return(0,he.A)(e,[{key:"handleStream",value:function(){var e=(0,o.A)((0,a.A)().mark((function e(t,n){var r,o,i,s,c,u,l,p,d,g,h;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:r=t.body.getReader(),o="",i=!0;case 3:if(!i){e.next=28;break}return e.next=6,r.read();case 6:if(s=e.sent,c=s.done,u=s.value,!c){e.next=11;break}return e.abrupt("break",28);case 11:this.buffer+=this.decoder.decode(u,{stream:!0}),l=this.buffer.split("\n"),p=0;case 14:if(!(p<l.length-1)){e.next=25;break}if(d=l[p],!d.startsWith("data: ")){e.next=22;break}if(g=d.slice(6),"[DONE]"!==g){e.next=21;break}return i=!1,e.abrupt("break",25);case 21:try{h=JSON.parse(g),h.choices&&h.choices[0].delta.content&&(o+=h.choices[0].delta.content,n(o))}catch(a){console.error("JSON解析错误:",a)}case 22:p++,e.next=14;break;case 25:this.buffer=l[l.length-1],e.next=3;break;case 28:return e.abrupt("return",o);case 29:case"end":return e.stop()}}),e,this)})));function t(t,n){return e.apply(this,arguments)}return t}()},{key:"fetchStream",value:function(){var e=(0,o.A)((0,a.A)().mark((function e(t,n,r){var o;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,fetch(t,(0,s.A)((0,s.A)({},n),{},{headers:(0,s.A)((0,s.A)({},n.headers),{},{Accept:"text/event-stream"})}));case 3:if(o=e.sent,o.ok){e.next=6;break}throw new Error("HTTP error! status: ".concat(o.status));case 6:return e.next=8,this.handleStream(o,r);case 8:return e.abrupt("return",e.sent);case 11:throw e.prev=11,e.t0=e["catch"](0),console.error("流式请求错误:",e.t0),e.t0;case 15:case"end":return e.stop()}}),e,this,[[0,11]])})));function t(t,n,r){return e.apply(this,arguments)}return t}()}])}(),pr=function(){function e(t,n){(0,ge.A)(this,e),this.moderator=t,this.gameManager=n,this.currentTurn=0,this.mainActor=null,this.logger=new fn(!0,"TurnManager"),this.recentMainActors=[],this.maxHistoryLength=5}return(0,he.A)(e,[{key:"startNewTurn",value:function(){var e=(0,o.A)((0,a.A)().mark((function e(){var t,n,r,o,i,s;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return this.currentTurn++,this.logger.log("开始第 ".concat(this.currentTurn," 回合")),e.next=4,this.gameManager.updateAvailableCharacters();case 4:return e.next=6,this.determineMainActor();case 6:return this.mainActor=e.sent,this.logger.log("主行动者: ".concat(this.mainActor)),this.logger.log("开始收集行动"),e.next=11,this.collectActions();case 11:return t=e.sent,this.logger.log("收集到的行动:",t),e.next=15,Er.dispatch("interaction/updateInteractionStage",{stage:"总结",info:"那么究竟是..."});case 15:return this.logger.log("主持人总结中..."),n=[{character:this.mainActor,action:t.mainAction}].concat((0,wn.A)(Object.entries(t.reactions).map((function(e){var t=(0,xt.A)(e,2),n=t[0],r=t[1];return{character:n,action:r.action}})))),e.next=19,this.moderator.summarizeActions(n,this.gameManager.plotTriggers,this.currentTurn);case 19:return r=e.sent,this.logger.log("主持人总结:",r),e.next=23,Er.dispatch("interaction/updateInteractionStage",{stage:"叙述",info:"所以说..."});case 23:return this.logger.log("生成回合叙述..."),o=this.gameManager.updateTriggeredPlots(r.triggerChecks),e.next=27,this.moderator.generateFinalResult(r,o);case 27:if(i=e.sent,this.logger.log("回合叙述完成"),!r.endSectionFlag){e.next=33;break}return e.next=32,Er.dispatch("interaction/hideInteractionStage");case 32:return e.abrupt("return",{summary:r,narration:i,triggeredPlots:o,endSectionFlag:!0});case 33:if(!(r.suggestions&&r.suggestions.length>0)){e.next=36;break}return e.next=36,Er.dispatch("conversation/setSuggestions",r.suggestions);case 36:return e.next=38,Er.dispatch("interaction/updateInteractionStage",{stage:"决定下一步",info:"接下来，谁该行动呢..."});case 38:return e.next=40,this.determineNextMainActor(r,i);case 40:return s=e.sent,this.logger.log("下一回合主行动者: ".concat(s)),e.next=44,Er.dispatch("interaction/hideInteractionStage");case 44:return e.abrupt("return",{summary:r,narration:i,nextMainActor:s,triggeredPlots:o,endSectionFlag:!1});case 45:case"end":return e.stop()}}),e,this)})));function t(){return e.apply(this,arguments)}return t}()},{key:"collectActions",value:function(){var e=(0,o.A)((0,a.A)().mark((function e(){var t,n,r,o,i,s=this;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return t={mainAction:"",reactions:{}},this.logger.log("收集主行动者 ".concat(this.mainActor," 的行动")),e.next=4,this.collectActionFromCharacter(this.mainActor);case 4:return n=e.sent,t.mainAction=n.action,this.logger.log("收集到主行动: ".concat(this.mainActor," => ").concat(t.mainAction)),e.next=9,Er.dispatch("interaction/updateInteractionStage",{stage:"收集反应",info:"让我们看看其他人的反应..."});case 9:return r=Er.state.gameState.availableCharacters.filter((function(e){return e.name!==s.mainActor})),this.logger.log("开始收集其他角色反应:",r.map((function(e){return e.name})).join(", ")),o=r.map((function(e){return s.collectActionFromCharacter(e.name,t.mainAction).then((function(t){return{name:e.name,response:t}}))})),e.next=14,Promise.all(o);case 14:return i=e.sent,i.forEach((function(e){var n=e.name,r=e.response;t.reactions[n]={action:r.action,character:n},s.logger.log("收集到反应: ".concat(n," => ").concat(r.action))})),this.logger.log("本回合所有行动:",{mainActor:"".concat(this.mainActor,": ").concat(t.mainAction),reactions:Object.entries(t.reactions).map((function(e){var t=(0,xt.A)(e,2),n=t[0],r=t[1];return"".concat(n,": ").concat(r.action)}))}),e.abrupt("return",t);case 18:case"end":return e.stop()}}),e,this)})));function t(){return e.apply(this,arguments)}return t}()},{key:"collectActionFromCharacter",value:function(){var e=(0,o.A)((0,a.A)().mark((function e(t){var n,r,o,i,s,c,u,l,p=arguments;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(n=p.length>1&&void 0!==p[1]?p[1]:"",r=t===Er.state.game.selectedCharacter,!r){e.next=35;break}o=null;case 4:if(o){e.next=32;break}return i=n?"".concat(this.mainActor,"行动了：").concat(n,"\n\n轮到你行动了，").concat(t,"！"):"轮到你行动了，".concat(t,"！"),e.next=8,Er.dispatch("interaction/updateInteractionStage",{stage:"等待玩家",info:i});case 8:return this.logger.log("等待玩家 ".concat(t," 输入...")),e.next=11,this.waitForPlayerInput();case 11:return s=e.sent,this.logger.log("收到玩家输入:",s),e.next=15,Er.dispatch("interaction/updateInteractionStage",{stage:"验证行动",info:"让我想想，这样做可行吗..."});case 15:return e.next=17,this.moderator.validateAction(s);case 17:if(c=e.sent,!c.isValid){e.next=25;break}return o=c.specificAction,this.logger.log("玩家行动验证通过:",o),e.next=23,Er.dispatch("conversation/setSuggestions",[]);case 23:e.next=30;break;case 25:return this.logger.log("玩家行动验证失败:",c.reason),e.next=28,Er.dispatch("interaction/updateInteractionStage",{stage:"行动无效",info:"这样做似乎不太可能..."});case 28:return e.next=30,Er.dispatch("interaction/showValidationError",c.reason);case 30:e.next=4;break;case 32:return e.abrupt("return",{action:o,character:t});case 35:return e.next=37,Er.dispatch("interaction/updateInteractionStage",{stage:"AI思考中",info:"正在思考..."});case 37:return this.logger.log("获取AI ".concat(t," 的响应...")),u=this.createSituationForAI(n),e.next=41,this.gameManager.aiPlayers[t].getResponse(u);case 41:return l=e.sent,this.logger.log("AI响应:",l),e.next=45,Er.dispatch("interaction/updateInteractionStage",{stage:"AI行动",info:"提交行动..."});case 45:if(n){e.next=50;break}return e.next=48,new Promise((function(e){return setTimeout(e,3e3)}));case 48:e.next=52;break;case 50:return e.next=52,new Promise((function(e){return setTimeout(e,2e3)}));case 52:return e.abrupt("return",{action:l.action,character:t});case 53:case"end":return e.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()},{key:"determineMainActor",value:function(){var e=(0,o.A)((0,a.A)().mark((function e(){var t;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(1!==this.currentTurn){e.next=4;break}return t=Er.state.game.selectedCharacter,this.recentMainActors.push(t),e.abrupt("return",t);case 4:return e.abrupt("return",this.mainActor);case 5:case"end":return e.stop()}}),e,this)})));function t(){return e.apply(this,arguments)}return t}()},{key:"waitForPlayerInput",value:function(){var e=(0,o.A)((0,a.A)().mark((function e(){var t=this;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return this.logger.log("等待玩家输入..."),e.abrupt("return",new Promise((function(e){var n=Er.subscribe((function(r){"conversation/ADD_TO_CONVERSATION_HISTORY"===r.type&&"user"===r.payload.role&&(t.logger.log("检测到玩家输入:",r.payload.content),n(),e(r.payload.content))}))})));case 2:case"end":return e.stop()}}),e,this)})));function t(){return e.apply(this,arguments)}return t}()},{key:"createSituationForAI",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",t=[];return e&&t.push("主行动者".concat(this.mainActor,"的行动：").concat(e)),t.join("\n")}},{key:"determineNextMainActor",value:function(){var e=(0,o.A)((0,a.A)().mark((function e(t,n){var r,o,i,s,c,u,l,p=this;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return r={type:"object",properties:{thoughts:{type:"array",items:{type:"object",properties:{step:{type:"string"},reasoning:{type:"string"}},required:["step","reasoning"],additionalProperties:!1}},reason:{type:"string",description:"选择该角色作为主行动者的原因"},nextActor:{type:"string",description:"下一回合的主行动者名字"}},required:["thoughts","reason","nextActor"],additionalProperties:!1},o=Er.state.gameState.availableCharacters,i=this.gameManager.sectionData,s=t.triggerChecks.filter((function(e){return e.isTriggered})).map((function(e){var t=p.gameManager.plotTriggers.find((function(t){return t.id===e.id}));return t?t.content:null})).filter(Boolean),c=t.nextTurnTriggers.map((function(e){return"[预告] ".concat(e.content)})).filter(Boolean),u="作为游戏主持人，请分析当前场景并决定下一回合谁最适合作为主要行动者。\n\n背景信息：\n".concat(i.backgroundInfo,"\n\n当前回合的小说化描述：\n").concat(n,"\n\n可选角色：\n").concat(o.map((function(e){return"- ".concat(e.name)})).join("\n"),"\n\n最近的主行动者历史：").concat(this.recentMainActors.join("，"),"\n\n本回合触发的特殊剧情：\n").concat(s.length>0?s.join("\n"):"无","\n\n下一回合会触发的剧情：\n").concat(c.length>0?c.join("\n"):"无","\n请按照以下步骤思考：\n1. 你自己想\n2. 你自己想\n3. 检查技能使用情况:\n   - 查看是否有角色使用了迅捷类技能\n   - 查看是否有角色使用了时间系技能\n   - 如有则这些角色必然是下一回合的主行动者，不用管前面的步骤和剧情，如果他们不是主行动者，其他人就会出现无法行动的问题，因为他们会检测到这些迅捷角色，会让他们认为他们无法反应。\n\n请用JSON格式回复，包含：\n1. thoughts: 思考过程数组，每步包含step(步骤)和reasoning(推理过程)\n2. reason: 总结原因\n3. nextActor: 下一回合的主行动者名字"),e.prev=6,e.next=9,Er.dispatch("api/callLargeLanguageModelWithSchema",{prompt:u,schema:r});case 9:return l=e.sent,this.logger.log("确定下一回合主行动者:",l),this.recentMainActors.push(l.nextActor),this.recentMainActors.length>this.maxHistoryLength&&this.recentMainActors.shift(),e.abrupt("return",l.nextActor);case 16:throw e.prev=16,e.t0=e["catch"](6),this.logger.error("确定主行动者失败:",e.t0),e.t0;case 20:case"end":return e.stop()}}),e,this,[[6,16]])})));function t(t,n){return e.apply(this,arguments)}return t}()}])}(),dr=n(7380),gr=function(){function e(t,n,r,a,o,i){(0,ge.A)(this,e),this.startEvent=t,this.commonKnowledge=n,this.GMDetails=r,this.playerInfo=a,this.sectionObjective=o,this.endConditions=i,this.streamHandler=new lr,this.endSectionFlag=!1,this.store=Er,this.eventBus=(0,dr.A)()}return(0,he.A)(e,[{key:"validateAction",value:function(){var e=(0,o.A)((0,a.A)().mark((function e(t){var n,r,o;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return n={type:"object",properties:{reason:{type:"string"},suggestion:{type:"string"},isValid:{type:"boolean"},specificAction:{type:"string"}},required:["reason","suggestion","isValid","specificAction"],additionalProperties:!1},r="\n作为游戏主持人，请评估玩家是否有能力进行他描述的行动，背景：\n\n开始事件：".concat(this.startEvent,"\n公共知识：").concat(this.commonKnowledge,"\nGM细节：").concat(this.GMDetails,"\n\n玩家信息：\n").concat(this.playerInfo,"\n\n上一回合：\n").concat(this.getLastRound(),"\n\n本回合玩家行动：").concat(t,"\n注意，玩家的行为可以胡闹，你主要判断可行性，只要有能力做到，就可以做。\n请用JSON格式回答，包含以下字段：\n- reason: 解释玩家行动是否可行的原因\n- suggestion: 如果行动不可行，给出的建议。如果可行，则留空。\n- isValid: 玩家行动是否可行的结论（布尔值）\n- specificAction: 请具体描述玩家实际做的事情和说得话，避免歧义，同时也尽量保留原话，最重要的是具体化对象。例如，如果玩家说'你好'，可以描述为'向在场的人问好'，或者判断到是向谁问好。如果不可行，可以留空。如果玩家使用了特殊能力或技能，请具体说明使用的是哪个能力，对能力的效果至少要有一句描写。注意，使用能力必须要是玩家主动发动，因为会耗灵力的，如果玩家没有明说，就不要发动能力。"),e.next=4,this.callLargeLanguageModel(r,n);case 4:if(o=e.sent,o.isValid){e.next=8;break}return e.next=8,this.store.dispatch("conversation/removeLastUserMessage");case 8:return e.abrupt("return",(0,s.A)((0,s.A)({},o),{},{suggestions:o.isValid?[]:[o.suggestion].filter(Boolean)}));case 9:case"end":return e.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()},{key:"summarizeActions",value:function(){var e=(0,o.A)((0,a.A)().mark((function e(t,n,r){var o,i,c,u,l,p;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return o={type:"object",properties:{triggerChecks:{type:"array",items:{type:"object",properties:{id:{type:"string"},triggerCondition:{type:"string"},currentProgress:{type:"string"},isTriggered:{type:"boolean"}},required:["id","triggerCondition","currentProgress","isTriggered"],additionalProperties:!1}},collision:{type:"string"},summary:{type:"array",items:{type:"object",properties:{name:{type:"string"},note:{type:"string"},successProbability:{type:"string",enum:["impossible","unlikely","possible","likely","certain"],description:"行动成功的可能性"}},required:["name","note","successProbability"],additionalProperties:!1}},endReasons:{type:"array",items:{type:"object",properties:{condition:{type:"string"},according:{type:"string"},isMet:{type:"boolean"}},required:["condition","according","isMet"],additionalProperties:!1}},endSectionFlag:{type:"boolean"},suggestions:{type:"array",items:{type:"string"}}},required:["triggerChecks","endReasons","endSectionFlag","collision","summary","suggestions"],additionalProperties:!1},i=this.getOptimizedHistory(),c="请考虑以下背景信息和优化后的对话历史：\n\n起始事件：".concat(this.startEvent,"\n公共信息：").concat(this.commonKnowledge,"\n主持人信息：").concat(this.GMDetails,"\n结束条件：\n").concat(this.endConditions.map((function(e,t){return"".concat(t+1,". ").concat(e)})).join("\n"),"\n\n优化后的对话历史：\n").concat(i,"\n\n本桥段目标：").concat(this.sectionObjective,"\n\n本回合各角色的行动：\n").concat(t.map((function(e){return"".concat(e.character,"：").concat(e.action)})).join("\n"),"\n\n当前回合数：").concat(r,"\n\n剧情触发器列表：\n").concat(n.filter((function(e){return!e.consumed&&!e.triggerCondition.startsWith("第")})).map((function(e){return"- ID: ".concat(e.id,", 触发条件: ").concat(e.triggerCondition)})).join("\n"),'\n\n请按照指定的JSON格式回复，包括以下字段：\n- triggerChecks: 一个数组，包含每个剧情触发器的以下信息：\n    触发器列表为空的时候留空数组。\n  - id: 触发器ID\n  - triggerCondition: 触发条件\n  - currentProgress: 当前触发进度的简单描述\n  - isTriggered: 布尔值，表示该触发器是否在这个回合被触发\n- collision: 角色之间行动的冲突，哪个角色做的可能让另一个角色达不到最终的效果\n- summary: 一个数组，包含每个角色的名字、行动结果注释和成功可能性。\n  - name: 角色名字\n  - note: 对该行动的结论性判定，例如"攻击"、"防御"、"行动"等，只简单写行动类型，不写成败。\n  - successProbability: 行动成功的可能性，必须是以下五个选项之一："impossible"（不可能）、"unlikely"（不太能）、"possible"（可能）、"likely"（很可能）、"certain"必然）。如果异能用对了方，那就是certain。\n- endReasons: 一个数组,包含每个结束条件及其是否满足的布尔值:\n  - condition: 结束条件\n  - according: 依据目前剧情是否满足结束条件\n  - isMet: 布尔值,表示该条件是否准确满足了\n- endSectionFlag: 布尔值,是否结束该桥段\n- suggestions: 一个数组，包含1-3个对').concat(this.store.state.game.selectedCharacter,'应对一分钟后的下一回合的建议，用第一人称的""我做某事""的形式。比如本回合敌人发射了火球，你可以建议').concat(this.store.state.game.selectedCharacter,"反击，比如").concat(this.store.state.game.selectedCharacter,"冲向了水池，就建议他在水池里做事。建议要从不同角度出发，可以疯狂一点。"),e.next=5,this.callLargeLanguageModel(c,o);case 5:return u=e.sent,u.triggerChecks=u.triggerChecks.map((function(e){var t=n.find((function(t){return t.id===e.id}));return(0,s.A)((0,s.A)({},e),{},{content:t?t.content:null})})),l=t.reduce((function(e,t){return e[t.character]=t.action,e}),{}),u.summary=u.summary.map((function(e){var t;switch(e.successProbability){case"impossible":t=0;break;case"unlikely":t=.3;break;case"possible":t=.6;break;case"likely":t=.8;break;case"certain":t=.95;break;default:t=.5}var n,r=Math.random(),a=r<t;if(a)n=r<=.2*t?"criticalSuccess":"normalSuccess";else{var o=Math.min(t+.8*(1-t),.95);n=r>=o?"criticalFailure":"normalFailure"}return(0,s.A)((0,s.A)({},e),{},{originalAction:l[e.name],isSuccessful:a,resultLevel:n,diceRoll:r})})),n.forEach((function(e){if(e.triggerCondition.startsWith("第")&&e.triggerCondition.endsWith("回合开始")){var t=parseInt(e.triggerCondition.replace(/[^0-9]/g,""));r===t&&u.triggerChecks.push({id:e.id,triggerCondition:e.triggerCondition,currentProgress:"当前是第".concat(r,"回合"),isTriggered:!0})}})),u.endSectionFlag=u.endReasons.some((function(e){return e.isMet})),this.endSectionFlag=u.endSectionFlag,e.next=14,this.getNextTurnTriggers(r);case 14:return p=e.sent,u.nextTurnTriggers=p,e.abrupt("return",u);case 17:case"end":return e.stop()}}),e,this)})));function t(t,n,r){return e.apply(this,arguments)}return t}()},{key:"generateFinalResult",value:function(){var e=(0,o.A)((0,a.A)().mark((function e(t,n){var r,o,i;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return r=this.getOptimizedHistory(),o=t.summary.map((function(e){var t;switch(e.resultLevel){case"criticalSuccess":t="戏剧性的大成功";break;case"normalSuccess":t="成功";break;case"normalFailure":t="失败";break;case"criticalFailure":t="戏剧性的大失败";break;default:t="未知"}return"".concat(e.name,":").concat(e.originalAction,"\n判定: ").concat(t)})).join("\n\n"),i="请考虑以下背景信息、优化后的对话历史和触发的剧情触发器：\n\n起始事件：".concat(this.startEvent,"\n公共信息：").concat(this.commonKnowledge,"\n主持人信息：").concat(this.GMDetails,"\n\n过去回合历史：\n").concat(r,"\n\n本回合各角色的行动和结果：\n").concat(o,"\n行动有冲突的情况，你可自行斟酌。\n\n本回合触发的剧情触发器：\n").concat(n.map((function(e){return e.content})).join("\n"),"\n\n请小说化地描述这个新的回合的结果，包括每个角色说出来的话/做的动作等。请用第三人称方式描写。请确保描述中自然地包含每个角色实际成功或失败的行动，以及触发的剧情触发器。注意你的回复会直接增量展示为小说内容，所以不要写前导前缀提示。也不要写太多内容，不要写重了。写三个自然段就行。如果有剧情触发器的话，必须体现在你的描述里，优先级很高。"),e.next=5,this.callLargeLanguageModelStream(i);case 5:return e.abrupt("return",e.sent);case 6:case"end":return e.stop()}}),e,this)})));function t(t,n){return e.apply(this,arguments)}return t}()},{key:"getOptimizedHistory",value:function(){var e=this.store.state.conversation.optimizedConversationHistory;return e&&Array.isArray(e)&&e.map((function(e){return"".concat(e.role,": ").concat(e.content)})).join("\n")||""}},{key:"getSelectedCharacter",value:function(){return this.store.state.game.selectedCharacter||""}},{key:"callLargeLanguageModel",value:function(){var e=(0,o.A)((0,a.A)().mark((function e(t,n){return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.store.dispatch("api/callLargeLanguageModelWithSchema",{prompt:t,schema:n});case 3:return e.abrupt("return",e.sent);case 6:throw e.prev=6,e.t0=e["catch"](0),console.error("API调用失败:",e.t0),e.t0;case 10:case"end":return e.stop()}}),e,this,[[0,6]])})));function t(t,n){return e.apply(this,arguments)}return t}()},{key:"callLargeLanguageModelStream",value:function(){var e=(0,o.A)((0,a.A)().mark((function e(t){var n,r,i,s=this;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.store.dispatch("conversation/startNewMessage",{role:"assistant",initialContent:""});case 3:return n=e.sent,r=function(){var e=(0,o.A)((0,a.A)().mark((function e(t){return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,s.store.dispatch("conversation/updateStreamingMessage",{id:n,content:t});case 2:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),e.next=7,this.store.dispatch("api/processStreamingResponse",{prompt:t,updateCallback:r});case 7:return i=e.sent,e.next=10,this.store.dispatch("conversation/finishStreamingMessage",n);case 10:return e.abrupt("return",i);case 13:throw e.prev=13,e.t0=e["catch"](0),console.error("流式处理出错:",e.t0),e.t0;case 17:case"end":return e.stop()}}),e,this,[[0,13]])})));function t(t){return e.apply(this,arguments)}return t}()},{key:"getLastRound",value:function(){return this.store.getters["conversation/getLastRound"]}},{key:"getNextTurnTriggers",value:function(){var e=(0,o.A)((0,a.A)().mark((function e(t){var n,r;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return n=t+1,r=[],this.store.state.gameState.plotTriggers.filter((function(e){return!e.consumed})).forEach((function(e){if(e.triggerCondition.startsWith("第")&&e.triggerCondition.endsWith("回合开始")){var t=parseInt(e.triggerCondition.replace(/[^0-9]/g,""));t===n&&r.push({id:e.id,triggerCondition:e.triggerCondition,content:e.content,currentProgress:"下一回合将是第".concat(n,"回合")})}})),e.abrupt("return",r);case 4:case"end":return e.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()}])}();function hr(){var e=(0,u.KR)(!1),t=function(e,t,n){return"\n      请基于以下对话历史，对完成度做出总结。\n      对话历史：\n      ".concat(t.map((function(e){return"".concat(e.role,": ").concat(e.content)})).join("\n"),"\n      以上是对话历史。\n      本桥段目标：").concat(e.objective,"\n      影响点：\n      ").concat(n,'\n      请按照以下JSON格式回复：\n      {\n        "objective": "是否达成了桥段目标，布尔值",\n        "influencePoints": [\n          {"name": 影响点英文别名, "influence": "是否，布尔值"}\n        ],\n        "summary": "总结的内容，单个字符串，可以写详细一点，不写影响点相关的内容，包括对玩家行为的评价。",\n        "objective_judge":"只写出对于判断桥段目标是否达成的解释，不写影响点相关的内容。请称玩家角色为\'你\'。"\n      }\n    ')},n=function(e){return e.map((function(e){return"".concat(e.name,"（").concat(e.alias,"）：").concat(e.description)})).join("\n")},r=function(){var e=(0,o.A)((0,a.A)().mark((function e(r,o){var i,s,c,u;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return i=n(r.influencePoints),s=t(r,o,i),e.prev=2,c={type:"object",additionalProperties:!1,properties:{objective:{type:"boolean"},influencePoints:{type:"array",items:{type:"object",additionalProperties:!1,properties:{name:{type:"string"},influence:{type:"boolean"}},required:["name","influence"]}},summary:{type:"string"},objective_judge:{type:"string"}},required:["objective","influencePoints","summary","objective_judge"]},e.next=6,Er.dispatch("api/callLargeLanguageModelWithSchema",{prompt:s,schema:c});case 6:return u=e.sent,e.abrupt("return",u);case 10:throw e.prev=10,e.t0=e["catch"](2),console.error("获取章节总结失败:",e.t0),e.t0;case 14:case"end":return e.stop()}}),e,null,[[2,10]])})));return function(t,n){return e.apply(this,arguments)}}(),i=function(){var t=(0,o.A)((0,a.A)().mark((function t(n){var o,i,s;return(0,a.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(o=n.section,!e.value){t.next=3;break}return t.abrupt("return");case 3:return t.prev=3,e.value=!0,Er.dispatch("game/setInputEnabled",!1),i=Er.state.conversation.optimizedConversationHistory,t.next=9,r(o,i);case 9:return s=t.sent,t.next=12,Er.dispatch("conversation/addSystemMessage",{content:"桥段总结：\n".concat(s.summary,"\n\n目标完成情况：\n").concat(s.objective_judge)});case 12:return t.next=14,Er.dispatch("save/updateSaveData",{path:"progress.sectionResults.".concat(o.id),value:s});case 14:if(!s.objective){t.next=17;break}return t.next=17,Er.dispatch("sections/completeSection",o.id);case 17:return t.abrupt("return",s);case 20:throw t.prev=20,t.t0=t["catch"](3),console.error("处理章节结束时出错:",t.t0),t.t0;case 24:return t.prev=24,e.value=!1,t.finish(24);case 27:case"end":return t.stop()}}),t,null,[[3,20,24,27]])})));return function(e){return t.apply(this,arguments)}}();return{handleSectionEnd:i,isProcessing:e}}var vr=function(){function e(t,n){(0,ge.A)(this,e),this.gameState=t,this.aiPlayers={},this.streamHandler=new lr,this.characterTagBase=null,this.playerInfo=null,this.turnCount=0,this.plotTriggers=[],this.sectionData=n,this.store=Er,this.turnManager=null,this.moderator=null}return(0,he.A)(e,[{key:"loadCharacterTagBase",value:function(){var e=(0,o.A)((0,a.A)().mark((function e(){var t,n;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.prev=0,t=(0,m.D)(),e.next=4,fetch("".concat(t,"/config/characterTagBase.json?v=").concat((new Date).getTime()));case 4:return n=e.sent,e.next=7,n.json();case 7:this.characterTagBase=e.sent,e.next=14;break;case 10:throw e.prev=10,e.t0=e["catch"](0),console.error("加载角色标签库时出错:",e.t0),e.t0;case 14:case"end":return e.stop()}}),e,this,[[0,10]])})));function t(){return e.apply(this,arguments)}return t}()},{key:"setupGame",value:function(){var e=(0,o.A)((0,a.A)().mark((function e(){var t,n=this;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(this.characterTagBase){e.next=3;break}return e.next=3,this.loadCharacterTagBase();case 3:if(t=this.sectionData,t){e.next=6;break}throw new Error("无法获取章节数据");case 6:return this.aiPlayers={},t.characters.forEach((function(e){e.isAI?n.aiPlayers[e.name]=new ur(e,t.commonKnowledge,t.startEvent,e.sectionGuidance,n.characterTagBase):n.mainPlayer=e})),this.initializePlotTriggers(t.plotTriggers),this.moderator=new gr(t.startEvent,t.commonKnowledge,t.GMDetails,this.playerInfo,t.objective,t.endConditions),this.turnManager=new pr(this.moderator,this),e.next=13,this.setupInitialContent(t);case 13:return e.next=15,this.updateAvailableCharacters();case 15:this.processTurns();case 16:case"end":return e.stop()}}),e,this)})));function t(){return e.apply(this,arguments)}return t}()},{key:"setupInitialContent",value:function(){var e=(0,o.A)((0,a.A)().mark((function e(t){var n,r;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return r="<h2>".concat(t.title,"</h2><p><b>目标：").concat(t.objective,"</b></p><p>").concat(t.backgroundInfo,"</p>"),e.next=3,this.store.dispatch("conversation/startNewMessage",{role:"system",initialContent:r});case 3:return e.next=5,this.createPlayerInfo(this.mainPlayer);case 5:return this.playerInfo=e.sent,e.next=8,this.store.dispatch("conversation/startNewMessage",{role:"info",initialContent:this.playerInfo});case 8:return e.next=10,this.store.dispatch("conversation/startNewMessage",{role:"assistant",initialContent:t.startEvent});case 10:if(null===(n=t.initialSuggestions)||void 0===n||!n.length){e.next=13;break}return e.next=13,this.store.dispatch("conversation/setSuggestions",t.initialSuggestions);case 13:case"end":return e.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()},{key:"createPlayerInfo",value:function(e){var t=this,n="<b>你的角色：".concat(e.name,"</b>").concat(e.description);if(e.characterTags){var r=e.characterTags.reduce((function(e,n){var r=t.getCharacterTag(n);return r&&(e+="<br>- ".concat(n,": ").concat(r)),e}),"");n+=r}return n}},{key:"handleSectionEnd",value:function(){var e=(0,o.A)((0,a.A)().mark((function e(){var t,n,r;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return t=hr(),n=t.handleSectionEnd,e.prev=1,e.next=4,n({section:this.sectionData});case 4:return r=e.sent,e.next=7,this.store.dispatch("interaction/updateInteractionStage",{stage:"收尾",info:"本桥段已结束..."});case 7:return e.next=9,this.store.commit("game/SET_SECTION_ENDED",!0);case 9:return e.abrupt("return",r);case 12:throw e.prev=12,e.t0=e["catch"](1),console.error("处理章节结束失败:",e.t0),e.t0;case 16:case"end":return e.stop()}}),e,this,[[1,12]])})));function t(){return e.apply(this,arguments)}return t}()},{key:"processTurns",value:function(){var e=(0,o.A)((0,a.A)().mark((function e(){var t,n;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:t=!0;case 1:if(!t){e.next=23;break}return e.prev=2,e.next=5,this.turnManager.startNewTurn();case 5:return n=e.sent,e.next=8,this.store.dispatch("gameState/updateGameState",{summary:n.summary,narration:n.narration});case 8:if(!n.endSectionFlag){e.next=13;break}return e.next=11,this.handleSectionEnd();case 11:return t=!1,e.abrupt("continue",1);case 13:this.turnManager.mainActor=n.nextMainActor,e.next=21;break;case 16:throw e.prev=16,e.t0=e["catch"](2),console.error("处理回合时出错:",e.t0),t=!1,e.t0;case 21:e.next=1;break;case 23:case"end":return e.stop()}}),e,this,[[2,16]])})));function t(){return e.apply(this,arguments)}return t}()},{key:"processPlayerInput",value:function(){var e=(0,o.A)((0,a.A)().mark((function e(t){var n;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.moderator.validateAction(t);case 3:if(n=e.sent,n.isValid){e.next=6;break}return e.abrupt("return",n);case 6:return e.next=8,this.store.dispatch("conversation/addUserMessage",t);case 8:return e.abrupt("return",n);case 11:throw e.prev=11,e.t0=e["catch"](0),console.error("处理玩家输入时出错:",e.t0),e.t0;case 15:case"end":return e.stop()}}),e,this,[[0,11]])})));function t(t){return e.apply(this,arguments)}return t}()},{key:"updateAvailableCharacters",value:function(){var e=(0,o.A)((0,a.A)().mark((function e(){var t;return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return t=this.getFilteredCharacters(this.turnCount),e.next=3,this.store.commit("gameState/SET_AVAILABLE_CHARACTERS",t);case 3:case"end":return e.stop()}}),e,this)})));function t(){return e.apply(this,arguments)}return t}()},{key:"initializePlotTriggers",value:function(e){this.plotTriggers=e.map((function(e){return(0,s.A)((0,s.A)({},e),{},{consumed:!1,memoryCharacter:e.memoryCharacter||null})}))}},{key:"getCharacterTag",value:function(e){return this.characterTagBase?this.characterTagBase[e]:null}},{key:"updateTriggeredPlots",value:function(e){var t=this,n=[];return e.forEach((function(e){var r=t.plotTriggers.find((function(t){return t.id===e.id}));r&&e.isTriggered&&!r.consumed&&(r.consumed=!0,n.push(r),r.memoryCharacter&&t.aiPlayers[r.memoryCharacter]&&t.aiPlayers[r.memoryCharacter].addPrivateThought(r.content))})),n}},{key:"getFilteredCharacters",value:function(e){if(!this.sectionData||!this.sectionData.characters)return console.warn("No section data or characters found"),[];var t=this.plotTriggers.filter((function(t){if(t.triggerCondition.startsWith("第")){var n=parseInt(t.triggerCondition.replace(/[^0-9]/g,""));return e>=n}return t.consumed})),n=this.sectionData.characters.filter((function(n){if(n.sectionGuidance){var r=n.sectionGuidance.match(/前(\d+)回合.*不在/);if(r){var a=parseInt(r[1]);if(e<=a)return!1}}var o=t.find((function(e){return e.content&&(e.content.includes("".concat(n.name,"退场"))||e.content.includes("".concat(n.name,"离开"))||e.content.includes("".concat(n.name,"不在场")))}));return!o}));return n}},{key:"getAvailableAICharacters",value:function(e){return this.getFilteredCharacters(e).filter((function(e){return e.isAI}))}},{key:"getAvailablePlayerCharacters",value:function(e){return this.getFilteredCharacters(e).filter((function(e){return!e.isAI}))}}])}(),fr=function(){return{isLoading:!1,isSubmitting:!1,isCooldown:!1,showTutorial:!1,tutorialContent:{title:"",content:""},selectedCharacter:"罗伯特",currentIsReplay:!1,turnCount:0,inputEnabled:!0,gameManager:null,isSectionEnded:!1}},mr={SET_LOADING:function(e,t){e.isLoading=t},SET_SUBMITTING:function(e,t){e.isSubmitting=t},SET_COOLDOWN:function(e,t){e.isCooldown=t},SET_SHOW_TUTORIAL:function(e,t){e.showTutorial=t},SET_TUTORIAL_CONTENT:function(e,t){e.tutorialContent=t},SET_SELECTED_CHARACTER:function(e,t){e.selectedCharacter=t},SET_CURRENT_IS_REPLAY:function(e,t){e.currentIsReplay=t},INCREMENT_TURN_COUNT:function(e){e.turnCount++},SET_INPUT_ENABLED:function(e,t){e.inputEnabled=t},SET_GAME_MANAGER:function(e,t){e.gameManager=t},RESET_STATE:function(e){e.isSubmitting=!1,e.isCooldown=!1,e.currentIsReplay=!1,e.turnCount=0,e.inputEnabled=!0,e.isLoading=!1,e.showTutorial=!1,e.tutorialContent={title:"",content:""},e.gameManager=null},SET_SECTION_ENDED:function(e,t){e.isSectionEnded=t}},Sr={initializeGame:function(e){return(0,o.A)((0,a.A)().mark((function t(){var n,r,o,i;return(0,a.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(n=e.commit,r=e.rootState,n("SET_LOADING",!0),t.prev=2,o=r.sections.currentSection,o){t.next=6;break}throw new Error("无法获取章节数据");case 6:return i=new vr(r.gameState,o),n("SET_GAME_MANAGER",i),t.next=10,i.setupGame();case 10:return t.prev=10,n("SET_LOADING",!1),t.finish(10);case 13:case"end":return t.stop()}}),t,null,[[2,,10,13]])})))()},showGameTutorial:function(e){var t=e.commit;t("SET_TUTORIAL_CONTENT",{title:r["default"].global.t("tutorial.title"),content:r["default"].global.t("tutorial.content")}),t("SET_SHOW_TUTORIAL",!0)},setInputEnabled:function(e,t){var n=e.commit;n("SET_INPUT_ENABLED",t)},resetState:function(e){var t=e.commit;t("RESET_STATE")},handleSectionEnd:function(e){return(0,o.A)((0,a.A)().mark((function t(){var n,r,o;return(0,a.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(n=e.commit,r=e.state,t.prev=1,r.gameManager){t.next=4;break}throw new Error("GameManager not initialized");case 4:return n("SET_SECTION_ENDED",!0),n("SET_INPUT_ENABLED",!1),t.next=8,r.gameManager.handleSectionEnd();case 8:return o=t.sent,t.abrupt("return",o);case 12:throw t.prev=12,t.t0=t["catch"](1),console.error("处理桥段结束时出错:",t.t0),t.t0;case 16:case"end":return t.stop()}}),t,null,[[1,12]])})))()}},Ar={isSubmitting:function(e){return e.isSubmitting},isCooldown:function(e){return e.isCooldown},selectedCharacter:function(e){return e.selectedCharacter},currentIsReplay:function(e){return e.currentIsReplay},turnCount:function(e){return e.turnCount},isInputEnabled:function(e,t,n){var r="等待玩家"===n.interaction.interactionStage.stage;return r&&!e.isSubmitting&&!e.isCooldown},gameManager:function(e){return e.gameManager}};const yr={namespaced:!0,state:fr,mutations:mr,actions:Sr,getters:Ar},Er=(0,U.y$)({modules:{gameState:Rt,conversation:Pt,tutorial:Yt,api:bn,sections:On,story:Mn,interaction:Kn,save:Zn,review:ar,settings:vn,ui:cr,game:yr}});var br={install:function(e){var t=(0,u.KR)({show:!1,title:"",content:"",closeButtonText:"关闭",buttons:[],large:!1}),n={show:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};t.value=(0,s.A)((0,s.A)({},t.value),{},{show:!0},n)},hide:function(){t.value.show=!1}};e.provide("$modal",n);var r=(0,i.Ef)({setup:function(){return function(){return(0,c.h)(f,(0,s.A)((0,s.A)({},t.value),{},{"onUpdate:show":function(e){return t.value.show=e},onClose:function(){return n.hide()}}))}}}),a=document.createElement("div");document.body.appendChild(a),r.mount(a)}};const wr=br;var xr=n(5246),Tr=(n(7917),{position:"top-right",timeout:3e3,closeOnClick:!0,pauseOnFocusLoss:!0,pauseOnHover:!0,draggable:!0,draggablePercent:.6,showCloseButtonOnHover:!1,hideProgressBar:!0,closeButton:"button",icon:!0,rtl:!1});const kr=xr.Ay;var _r=(0,i.Ef)(H);function Cr(){return Ir.apply(this,arguments)}function Ir(){return Ir=(0,o.A)((0,a.A)().mark((function e(){return(0,a.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,cn();case 3:_r.mount("#app"),e.next=9;break;case 6:e.prev=6,e.t0=e["catch"](0),console.error("初始化失败:",e.t0);case 9:case"end":return e.stop()}}),e,null,[[0,6]])}))),Ir.apply(this,arguments)}Vt(_r),_r.use(Er),_r.use(wt),_r.use(wr),_r.use(kr,Tr),_r.config.errorHandler=function(e,t,n){console.error("Vue Error:",e),console.log("Component:",t),console.log("Error Info:",n)},Cr()},3019:(e,t,n)=>{"use strict";n.d(t,{D:()=>r});var r=function(){var e="/vue/assets";return e}},6083:(e,t,n)=>{"use strict";n.d(t,{A:()=>c});n(4423);var r=n(641),a=["disabled"],o={class:"relative z-10 flex items-center gap-2"};const i={__name:"GameButton",props:{type:{type:String,default:"default",validator:function(e){return["primary","secondary","danger","default","ghost"].includes(e)}},size:{type:String,default:"default",validator:function(e){return["sm","default","lg"].includes(e)}},disabled:{type:Boolean,default:!1}},setup:function(e){var t={sm:"py-1.5 text-sm min-h-[32px]",default:"py-2 text-base min-h-[36px]",lg:"py-3 text-lg min-h-[44px]"},n={primary:"\n    border-2\n    !border-tech-primary/30 \n    hover:!border-tech-primary \n    bg-tech-primary \n    text-white \n    hover:bg-tech-primary/90 \n    shadow-md \n    hover:shadow-lg\n    transition-all\n    duration-300\n  ",secondary:"\n    border-2\n    !border-tech-accent/30 \n    hover:!border-tech-accent \n    bg-tech-accent \n    text-white \n    hover:bg-tech-accent/90 \n    shadow-md \n    hover:shadow-lg\n    transition-all\n    duration-300\n  ",danger:"\n    border-2\n    !border-red-500/30 \n    hover:!border-red-500 \n    bg-red-500 \n    text-white \n    hover:bg-red-600 \n    shadow-md \n    hover:shadow-lg\n    transition-all\n    duration-300\n  ",default:"\n    border-2\n    !border-gray-200 \n    hover:!border-tech-primary \n    bg-white \n    text-tech-primary \n    hover:text-tech-primary/90\n    hover:bg-gray-50\n    shadow-sm \n    hover:shadow-md\n    transition-all\n    duration-300\n  ",ghost:"\n    border-2\n    !border-gray-200\n    hover:!border-tech-primary\n    bg-white \n    text-tech-primary \n    hover:bg-gray-50/50\n    shadow-sm \n    hover:shadow \n    transition-all\n    duration-300\n  "};return function(i,s){return(0,r.uX)(),(0,r.CE)("button",(0,r.v6)({class:["relative overflow-hidden rounded-lg","font-medium tracking-wide flex items-center justify-center gap-2","hover:transform hover:scale-[1.02] active:scale-[0.98]","min-h-[36px]","px-4","border-2",t[e.size],n[e.type],{"opacity-50 cursor-not-allowed":e.disabled}],disabled:e.disabled},i.$attrs),[(0,r.Lk)("div",o,[(0,r.RG)(i.$slots,"icon"),(0,r.RG)(i.$slots,"default")]),s[0]||(s[0]=(0,r.Lk)("div",{class:"absolute inset-0 opacity-0 hover:opacity-10 transition-opacity duration-300 bg-gradient-to-r from-white via-transparent to-white"},null,-1))],16,a)}}},s=i,c=s},477:()=>{}},t={};function n(r){var a=t[r];if(void 0!==a)return a.exports;var o=t[r]={exports:{}};return e[r].call(o.exports,o,o.exports,n),o.exports}n.m=e,(()=>{var e=[];n.O=(t,r,a,o)=>{if(!r){var i=1/0;for(l=0;l<e.length;l++){for(var[r,a,o]=e[l],s=!0,c=0;c<r.length;c++)(!1&o||i>=o)&&Object.keys(n.O).every((e=>n.O[e](r[c])))?r.splice(c--,1):(s=!1,o<i&&(i=o));if(s){e.splice(l--,1);var u=a();void 0!==u&&(t=u)}}return t}o=o||0;for(var l=e.length;l>0&&e[l-1][2]>o;l--)e[l]=e[l-1];e[l]=[r,a,o]}})(),(()=>{n.n=e=>{var t=e&&e.__esModule?()=>e["default"]:()=>e;return n.d(t,{a:t}),t}})(),(()=>{n.d=(e,t)=>{for(var r in t)n.o(t,r)&&!n.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})}})(),(()=>{n.f={},n.e=e=>Promise.all(Object.keys(n.f).reduce(((t,r)=>(n.f[r](e,t),t)),[]))})(),(()=>{n.u=e=>"assets/js/"+e+"."+{778:"12ea1e82",784:"e204b822"}[e]+".js"})(),(()=>{n.miniCssF=e=>"assets/css/"+e+"."+{778:"e85c7ed4",784:"da63e35b"}[e]+".css"})(),(()=>{n.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"===typeof window)return window}}()})(),(()=>{n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t)})(),(()=>{var e={},t="beyond-books-vue:";n.l=(r,a,o,i)=>{if(e[r])e[r].push(a);else{var s,c;if(void 0!==o)for(var u=document.getElementsByTagName("script"),l=0;l<u.length;l++){var p=u[l];if(p.getAttribute("src")==r||p.getAttribute("data-webpack")==t+o){s=p;break}}s||(c=!0,s=document.createElement("script"),s.charset="utf-8",s.timeout=120,n.nc&&s.setAttribute("nonce",n.nc),s.setAttribute("data-webpack",t+o),s.src=r),e[r]=[a];var d=(t,n)=>{s.onerror=s.onload=null,clearTimeout(g);var a=e[r];if(delete e[r],s.parentNode&&s.parentNode.removeChild(s),a&&a.forEach((e=>e(n))),t)return t(n)},g=setTimeout(d.bind(null,void 0,{type:"timeout",target:s}),12e4);s.onerror=d.bind(null,s.onerror),s.onload=d.bind(null,s.onload),c&&document.head.appendChild(s)}}})(),(()=>{n.r=e=>{"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}})(),(()=>{n.p="/vue/"})(),(()=>{if("undefined"!==typeof document){var e=(e,t,r,a,o)=>{var i=document.createElement("link");i.rel="stylesheet",i.type="text/css",n.nc&&(i.nonce=n.nc);var s=n=>{if(i.onerror=i.onload=null,"load"===n.type)a();else{var r=n&&n.type,s=n&&n.target&&n.target.href||t,c=new Error("Loading CSS chunk "+e+" failed.\n("+r+": "+s+")");c.name="ChunkLoadError",c.code="CSS_CHUNK_LOAD_FAILED",c.type=r,c.request=s,i.parentNode&&i.parentNode.removeChild(i),o(c)}};return i.onerror=i.onload=s,i.href=t,r?r.parentNode.insertBefore(i,r.nextSibling):document.head.appendChild(i),i},t=(e,t)=>{for(var n=document.getElementsByTagName("link"),r=0;r<n.length;r++){var a=n[r],o=a.getAttribute("data-href")||a.getAttribute("href");if("stylesheet"===a.rel&&(o===e||o===t))return a}var i=document.getElementsByTagName("style");for(r=0;r<i.length;r++){a=i[r],o=a.getAttribute("data-href");if(o===e||o===t)return a}},r=r=>new Promise(((a,o)=>{var i=n.miniCssF(r),s=n.p+i;if(t(i,s))return a();e(r,s,null,a,o)})),a={524:0};n.f.miniCss=(e,t)=>{var n={778:1,784:1};a[e]?t.push(a[e]):0!==a[e]&&n[e]&&t.push(a[e]=r(e).then((()=>{a[e]=0}),(t=>{throw delete a[e],t})))}}})(),(()=>{var e={524:0};n.f.j=(t,r)=>{var a=n.o(e,t)?e[t]:void 0;if(0!==a)if(a)r.push(a[2]);else{var o=new Promise(((n,r)=>a=e[t]=[n,r]));r.push(a[2]=o);var i=n.p+n.u(t),s=new Error,c=r=>{if(n.o(e,t)&&(a=e[t],0!==a&&(e[t]=void 0),a)){var o=r&&("load"===r.type?"missing":r.type),i=r&&r.target&&r.target.src;s.message="Loading chunk "+t+" failed.\n("+o+": "+i+")",s.name="ChunkLoadError",s.type=o,s.request=i,a[1](s)}};n.l(i,c,"chunk-"+t,t)}},n.O.j=t=>0===e[t];var t=(t,r)=>{var a,o,[i,s,c]=r,u=0;if(i.some((t=>0!==e[t]))){for(a in s)n.o(s,a)&&(n.m[a]=s[a]);if(c)var l=c(n)}for(t&&t(r);u<i.length;u++)o=i[u],n.o(e,o)&&e[o]&&e[o][0](),e[o]=0;return n.O(l)},r=self["webpackChunkbeyond_books_vue"]=self["webpackChunkbeyond_books_vue"]||[];r.forEach(t.bind(null,0)),r.push=t.bind(null,r.push.bind(r))})();var r=n.O(void 0,[504],(()=>n(402)));r=n.O(r)})();