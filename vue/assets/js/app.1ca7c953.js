(()=>{var e={3500:(e,t,n)=>{"use strict";var r=n(4048),o=n(388),a=(n(3792),n(3362),n(9085),n(9391),n(3751)),i=n(1034),s=(n(2675),n(9463),n(641)),c=n(953),u=n(33),l=["innerHTML"],p={class:"button-container"};const d=Object.assign({name:"ModalDialog"},{__name:"ModalDialog",props:{show:{type:Boolean,required:!0},title:{type:String,default:""},content:{type:String,default:""},closeButtonText:{type:String,default:"关闭"},closeOnBackdrop:{type:Boolean,default:!0},large:{type:Boolean,default:!1}},emits:["close"],setup:function(e,t){var n=t.emit,r=e,o=n,i=function(){o("close")};return(0,s.wB)((function(){return r.show}),(function(e){document.body.style.overflow=e?"hidden":""})),(0,s.xo)((function(){document.body.style.overflow=""})),function(t,n){return(0,s.uX)(),(0,s.Wv)(a.eB,{name:"modal-fade"},{default:(0,s.k6)((function(){return[e.show?((0,s.uX)(),(0,s.CE)("div",{key:0,class:"modal",onClick:n[0]||(n[0]=(0,a.D$)((function(t){return e.closeOnBackdrop&&i()}),["self"]))},[(0,s.Lk)("div",{class:(0,u.C4)(["modal-content",{"modal-large":e.large}])},[(0,s.Lk)("h2",null,(0,u.v_)(e.title),1),(0,s.Lk)("div",{class:"modal-scroll",innerHTML:e.content},null,8,l),(0,s.Lk)("div",p,[(0,s.RG)(t.$slots,"buttons",{},(function(){return[(0,s.Lk)("button",{class:"button",onClick:i},(0,u.v_)(e.closeButtonText),1)]}))])],2)])):(0,s.Q3)("",!0)]})),_:3})}}});var h=n(6262);const f=(0,h.A)(d,[["__scopeId","data-v-9985e8d8"]]),v=f;n(6280),n(6918),n(8706),n(1629),n(2062),n(4114),n(4782),n(6910),n(3288),n(9432),n(6099),n(6034),n(8940),n(4864),n(7465),n(7495),n(7745),n(8781),n(7764),n(5440),n(1392),n(375),n(1119),n(2953),n(6031);var g=function(){var e="/vue/assets";return console.log("当前基础路径:",e),e},m=(0,c.KR)({terms:{}}),S=(0,c.KR)({colors:{}}),A=function(){var e=(0,o.A)((0,r.A)().mark((function e(){var t,n,o;return(0,r.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.prev=0,t=g(),e.next=4,fetch("".concat(t,"/lang/terms_explanations_zh-CN.json?v=").concat((new Date).getTime()));case 4:return n=e.sent,e.next=7,n.json();case 7:o=e.sent,m.value=o,e.next=15;break;case 12:e.prev=12,e.t0=e["catch"](0),console.error("加载名词配置文件时出错:",e.t0);case 15:E();case 16:case"end":return e.stop()}}),e,null,[[0,12]])})));return function(){return e.apply(this,arguments)}}(),y=function(){var e=(0,o.A)((0,r.A)().mark((function e(){var t,n,o;return(0,r.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.prev=0,t=g(),e.next=4,fetch("".concat(t,"/config/colors.json?v=").concat((new Date).getTime()));case 4:return n=e.sent,e.next=7,n.json();case 7:o=e.sent,S.value=o,console.log("Loaded colors config:",S.value),e.next=15;break;case 12:e.prev=12,e.t0=e["catch"](0),console.error("加载色盘配置文件时出错:",e.t0);case 15:case"end":return e.stop()}}),e,null,[[0,12]])})));return function(){return e.apply(this,arguments)}}();function b(e){var t=e.replace("#",""),n=parseInt(t.substr(0,2),16),r=parseInt(t.substr(2,2),16),o=parseInt(t.substr(4,2),16),a=.299*n+.587*r+.114*o;return a<128}function k(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",n=m.value.terms,r=S.value.colors,o=[],a=2,i={};return Object.keys(n).forEach((function(s){if(s!==t){var c,u=r[n[s].color]||n[s].color,l=new RegExp(s,"g");while(null!==(c=l.exec(e)))if(i[s]=(i[s]||0)+1,i[s]<=a){var p=b(u),d=p?"-1px -1px 2px #222, 1px -1px 2px #222, -1px 1px 2px #222, 1px 1px 2px #222":"-1px -1px 2px #000, 1px -1px 2px #000, -1px 1px 2px #000, 1px 1px 2px #000";o.push({term:s,start:c.index,end:c.index+s.length,color:u,textShadow:d})}}})),o.sort((function(e,t){return t.start-e.start})),o.forEach((function(t){e=e.slice(0,t.start)+'<span class="special-term" \n        style="font-weight: bold; color: '.concat(t.color,"; text-shadow: ").concat(t.textShadow,'; cursor: pointer;" \n        data-term="').concat(t.term,'"\n        @click="handleTermClick">').concat(t.term,"</span>")+e.slice(t.end)})),e}function E(){return T.apply(this,arguments)}function T(){return T=(0,o.A)((0,r.A)().mark((function e(){var t,n,o,a,i,s,c,u=arguments;return(0,r.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:t=u.length>0&&void 0!==u[0]?u[0]:5,n=u.length>1&&void 0!==u[1]?u[1]:1e3,o=[],a=g(),Object.values(m.value.terms).forEach((function(e){if(e.imageUrl){var t=e.imageUrl.startsWith("http")?e.imageUrl:"".concat(a).concat(e.imageUrl);o.push(t)}})),i=0;case 6:if(!(i<o.length)){e.next=23;break}return s=o.slice(i,i+t),c=s.map((function(e){return new Promise((function(t,n){var r=new Image;r.src=e,r.onload=function(){return t(e)},r.onerror=function(){return n(new Error("Failed to load image: ".concat(e)))}}))})),e.prev=9,e.next=12,Promise.all(c);case 12:console.log("Batch ".concat(Math.floor(i/t)+1," preloaded successfully")),e.next=18;break;case 15:e.prev=15,e.t0=e["catch"](9),console.error("Error preloading images:",e.t0);case 18:return e.next=20,new Promise((function(e){return setTimeout(e,n)}));case 20:i+=t,e.next=6;break;case 23:console.log("All images preloaded successfully");case 24:case"end":return e.stop()}}),e,null,[[9,15]])}))),T.apply(this,arguments)}var w=["innerHTML"],_=["src"];const C={__name:"TermTooltip",props:{show:Boolean,description:String,imageUrl:String,term:String,event:Object},setup:function(e){var t=e,n=(0,s.EW)((function(){return(0,i.A)({position:"fixed",display:t.show?"block":"none",minWidth:"150px",zIndex:1e3,backgroundColor:"#fff",padding:"10px",borderRadius:"4px",boxShadow:"0 2px 8px rgba(0,0,0,0.15)"},r())}));function r(){if(!t.event||!t.show)return{};var e=document.documentElement.clientWidth,n=document.documentElement.clientHeight,r=document.getElementById("term-tooltip");if(r){var o=r.offsetWidth,a=r.offsetHeight,i=t.event.clientY+10,s=t.event.clientX+10,c=e/3,u=t.event.clientX;return s=u<=c?t.event.clientX+10:u>=2*c?t.event.clientX-o-10:Math.max(10,t.event.clientX-o/2),i+a>n&&(i=n-a-10),s<0?s=10:s+o>e&&(s=e-o-10),{top:"".concat(i,"px"),left:"".concat(s,"px")}}}var o=(0,s.EW)((function(){return k(t.description,t.term)}));return function(t,r){return(0,s.bo)(((0,s.uX)(),(0,s.CE)("div",{id:"term-tooltip",style:(0,u.Tr)(n.value),onClick:r[1]||(r[1]=(0,a.D$)((function(){}),["stop"]))},[(0,s.Lk)("span",{innerHTML:o.value},null,8,w),e.imageUrl?((0,s.uX)(),(0,s.CE)("img",{key:0,src:e.imageUrl,class:"term-tooltip-image",alt:"术语图片",onLoad:r[0]||(r[0]=function(){return t.updatePosition&&t.updatePosition.apply(t,arguments)})},null,40,_)):(0,s.Q3)("",!0)],4)),[[a.aG,e.show]])}}},x=(0,h.A)(C,[["__scopeId","data-v-5ae5ed7e"]]),I=x;var O={id:"app"};const L=Object.assign({name:"AppRoot"},{__name:"App",setup:function(e,t){var n=t.expose,r=(0,c.KR)(!1),o=(0,c.KR)(""),a=(0,c.KR)(""),u=(0,c.KR)(""),l=(0,c.KR)(null),p=(0,c.KR)({});n({showModal:h,hideModal:f}),(0,s.sV)((function(){A(),y()}));var d=function(e){if(e.target.classList.contains("special-term")){var t=e.target.getAttribute("data-term"),n=m.value.terms[t];o.value=n.description,a.value=n.imageUrl,u.value=t,l.value=e,r.value=!0}else e.target.closest("#term-tooltip")||(r.value=!1)},h=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};p.value[e]=(0,i.A)((0,i.A)({},t),{},{show:!0})},f=function(e){p.value[e]&&(p.value[e].show=!1,delete p.value[e])};return(0,s.sV)((function(){document.addEventListener("click",d)})),(0,s.hi)((function(){document.removeEventListener("click",d)})),function(e,t){var n=(0,s.g2)("router-view");return(0,s.uX)(),(0,s.CE)("div",O,[(0,s.bF)(n),((0,s.uX)(!0),(0,s.CE)(s.FK,null,(0,s.pI)(p.value,(function(e,t){return(0,s.uX)(),(0,s.Wv)(v,(0,s.v6)({key:t,ref_for:!0},e,{onClose:function(e){return f(t)}}),null,16,["onClose"])})),128)),(0,s.bF)(I,{show:r.value,description:o.value,imageUrl:a.value,term:u.value,event:l.value},null,8,["show","description","imageUrl","term","event"])])}}}),N=L,P=N;var R=n(5220),M={BASE_PATH:"/vue/",ASSETS_PREFIX:"/vue/",API_BASE_URL:"/vue/"};const D="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA9klEQVQ4jWNgwA3mAPEfKJ6FRx1OANL4H4r/EFLMAsSmQMwG5UshaYZhEagcSI0VVA8cLIYqegzE/UB8EYsBR4C4DojvQPmLYJrNsSgmFoNcwhCFQ/ISEOdB8WUcahJABrAC8QQg/oummQPJixxohvwC4gYgZkYOh1YkBXkMmCAfSb4OizxDGwkGtCNLsAPxRDQvXEbzAicQX0GS/wv1Nsj7DGkM2APoMtTWfDTNyDgCZIAxmu2kYFuYE6dBBa4BcQ0DJNGgKz4PxL1A/BzKX4ccDoxArA7ETFC+CBYDJKByPEDsjBZGWAFJmQkbmMWAyM4zcSkCACP+g11NunLfAAAAAElFTkSuQmCC";var U=n(6278),B={class:"container",id:"menu"},j={id:"gameDescription"},G={class:"menu-controls"},K={class:"control-pair",id:"footerControl"},H={key:1,class:"control-pair"},V={class:"control-pair"},F={class:"control-pair"};const $=Object.assign({name:"HomeView"},{__name:"HomeView",setup:function(e){var t=(0,U.Pj)(),n=(0,R.rd)(),a=(0,c.KR)(null),i=(0,s.WQ)("$modal"),l=(0,s.EW)((function(){return t.getters["save/hasSave"]})),p=function(){var e=(0,o.A)((0,r.A)().mark((function e(){return(0,r.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,t.dispatch("save/clearSave");case 2:return e.next=4,t.dispatch("sections/loadSectionsIndex");case 4:return e.next=6,t.dispatch("save/saveSave");case 6:n.push("/sections");case 7:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),d=function(){n.push("/sections")},h=function(){n.push("/review")},f=function(){n.push("/settings")},v=function(){l.value&&!confirm(t.$i18n.t("confirmImport"))||a.value.click()},g=function(){var e=(0,o.A)((0,r.A)().mark((function e(n){var o;return(0,r.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(o=n.target.files[0],o){e.next=3;break}return e.abrupt("return");case 3:return e.prev=3,e.next=6,t.dispatch("save/importSave",o);case 6:i.show("success",{title:"成功",content:"导入存档成功"}),location.reload(),e.next=13;break;case 10:e.prev=10,e.t0=e["catch"](3),i.show("error",{title:"错误",content:e.t0.message});case 13:return e.prev=13,n.target.value="",e.finish(13);case 16:case"end":return e.stop()}}),e,null,[[3,10,13,16]])})));return function(t){return e.apply(this,arguments)}}(),m=function(){var e=(0,o.A)((0,r.A)().mark((function e(){return(0,r.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(!confirm(t.$i18n.t("confirmDelete"))){e.next=4;break}return e.next=3,t.dispatch("save/clearSave");case 3:location.reload();case 4:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),S=function(){i.show("creators-message",{title:"制作者信息",content:"这里是制作者信息内容...",closeButtonText:"关闭"})},A=function(){i.show("update-log",{title:"更新日志",content:"这里是更新日志内容...",closeButtonText:"关闭"})};return(0,s.sV)((function(){console.log("HomeView mounted"),console.log("Component data:",{})})),function(e,t){var n=(0,s.g2)("router-link");return(0,s.uX)(),(0,s.CE)("div",B,[(0,s.Lk)("h1",null,(0,u.v_)(e.$t("mainTitle")),1),(0,s.Lk)("h2",null,(0,u.v_)(e.$t("subTitle")),1),(0,s.Lk)("p",j,(0,u.v_)(e.$t("gameDescription")),1),(0,s.Lk)("div",G,[(0,s.Lk)("div",K,[(0,s.Lk)("button",{class:"button",onClick:S},(0,u.v_)(e.$t("creatorsMessage")),1),(0,s.Lk)("button",{class:"button",onClick:A},(0,u.v_)(e.$t("updateLog")),1)]),l.value?(0,s.Q3)("",!0):((0,s.uX)(),(0,s.CE)("button",{key:0,class:"button",onClick:p},(0,u.v_)(e.$t("newGame")),1)),l.value?((0,s.uX)(),(0,s.CE)("div",H,[(0,s.Lk)("button",{class:"button",onClick:d},(0,u.v_)(e.$t("continueGame")),1),(0,s.Lk)("button",{class:"button",onClick:h},(0,u.v_)(e.$t("reviewRecords")),1)])):(0,s.Q3)("",!0),(0,s.Lk)("div",V,[(0,s.Lk)("button",{class:"button",onClick:v},(0,u.v_)(e.$t("importSave")),1),l.value?((0,s.uX)(),(0,s.CE)("button",{key:0,class:"button",onClick:t[0]||(t[0]=function(){return e.exportSave&&e.exportSave.apply(e,arguments)})},(0,u.v_)(e.$t("exportSave")),1)):(0,s.Q3)("",!0)]),(0,s.Lk)("div",F,[(0,s.Lk)("button",{class:"button",onClick:f},[t[1]||(t[1]=(0,s.Lk)("img",{src:D,alt:""},null,-1)),(0,s.eW)(" "+(0,u.v_)(e.$t("settings")),1)]),l.value?((0,s.uX)(),(0,s.CE)("button",{key:0,class:"button",onClick:m},(0,u.v_)(e.$t("deleteSave")),1)):(0,s.Q3)("",!0)])]),(0,s.Lk)("input",{ref_key:"fileInput",ref:a,type:"file",style:{display:"none"},accept:".savegame",onChange:g},null,544),(0,s.bF)(n,{to:"/review",class:"menu-item"},{default:(0,s.k6)((function(){return[(0,s.eW)((0,u.v_)(e.$t("reviewTitle")),1)]})),_:1})])}}}),X=(0,h.A)($,[["__scopeId","data-v-6582251c"]]),W=X;var z=n(5246),J=n(6992),Y={class:"sections-container"},Q=["onClick"],q={key:1,class:"section-content"},Z=["src","alt"],ee=["onClick"],te=["onClick"],ne={key:2,class:"locked-section"};const re=Object.assign({name:"SectionsView"},{__name:"SectionsView",setup:function(e){var t=(0,U.Pj)(),n=(0,R.rd)(),a=(0,J.s9)(),i=a.t,c=(0,s.EW)((function(){return t.state.sections.chapters})),l=function(e){return t.getters["sections/isSectionUnlocked"](e)},p=function(e){return t.getters["sections/isSectionCompleted"](e)},d=function(e){return"".concat(g()).concat(e)},h=function(){var e=(0,o.A)((0,r.A)().mark((function e(o){return(0,r.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,t.dispatch("sections/loadSection",o);case 3:n.push("/story"),e.next=10;break;case 6:e.prev=6,e.t0=e["catch"](0),console.error("加载章节失败:",e.t0),(0,z.dj)().error(i("loadSectionError"));case 10:case"end":return e.stop()}}),e,null,[[0,6]])})));return function(t){return e.apply(this,arguments)}}(),f=function(){var e=(0,o.A)((0,r.A)().mark((function e(o){return(0,r.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,t.dispatch("sections/loadSection",o);case 2:n.push("/story");case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),v=function(){var e=(0,o.A)((0,r.A)().mark((function e(n){return(0,r.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,t.dispatch("sections/skipSection",n);case 2:(0,z.dj)().success(i("sectionSkipped"));case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),m=function(){n.push("/")};return(0,s.sV)((0,o.A)((0,r.A)().mark((function e(){var n;return(0,r.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,t.dispatch("save/loadSave");case 2:if(0!==c.value.length){e.next=5;break}return e.next=5,t.dispatch("sections/loadSectionsIndex");case 5:n=t.getters["save/saveData"],n.unlockedSections.length>0&&n.unlockedSections.forEach((function(e){t.dispatch("sections/unlockSection",e)}));case 7:case"end":return e.stop()}}),e)})))),function(e,t){return(0,s.uX)(),(0,s.CE)("div",Y,[(0,s.Lk)("h2",null,(0,u.v_)(e.$t("chooseSection")),1),((0,s.uX)(!0),(0,s.CE)(s.FK,null,(0,s.pI)(c.value,(function(t){return(0,s.uX)(),(0,s.CE)("div",{key:t.title,class:"chapter"},[(0,s.Lk)("h3",null,(0,u.v_)(t.title),1),((0,s.uX)(!0),(0,s.CE)(s.FK,null,(0,s.pI)(t.sections,(function(t){return(0,s.uX)(),(0,s.CE)("div",{key:t.id,class:"section"},[p(t.id)?((0,s.uX)(),(0,s.CE)("button",{key:0,class:"button completed",onClick:function(e){return f(t.file)}},(0,u.v_)(t.title)+" ("+(0,u.v_)(e.$t("completed"))+") - "+(0,u.v_)(e.$t("replay")),9,Q)):l(t.id)?((0,s.uX)(),(0,s.CE)("div",q,[(0,s.Lk)("img",{src:d(t.image),alt:"".concat(t.title," thumbnail")},null,8,Z),(0,s.Lk)("button",{class:"button",onClick:function(e){return h(t.file)}},(0,u.v_)(t.title),9,ee),(0,s.Lk)("button",{class:"button button-skip",onClick:function(e){return v(t.file)}},(0,u.v_)(e.$t("skip"))+" "+(0,u.v_)(t.title),9,te)])):((0,s.uX)(),(0,s.CE)("div",ne,(0,u.v_)(t.title)+" ("+(0,u.v_)(e.$t("locked"))+") ",1))])})),128))])})),128)),(0,s.Lk)("button",{class:"button",onClick:m},(0,u.v_)(e.$t("returnToMenu")),1)])}}}),oe=(0,h.A)(re,[["__scopeId","data-v-56b799ba"]]),ae=oe;n(2762);var ie=n(5026),se=n(9492),ce=(n(5276),n(6033),n(1415),n(7642),n(8004),n(3853),n(5876),n(2475),n(5024),n(1698),function(){function e(){(0,ie.A)(this,e),this.loadedImages=new Set,this.loading=new Map,this.basePath=g()}return(0,se.A)(e,[{key:"getFullUrl",value:function(e){if(e.startsWith("http")||e.startsWith(this.basePath))return e;var t=e.startsWith("/")?e.slice(1):e;return"".concat(this.basePath,"/").concat(t)}},{key:"preloadImage",value:function(){var e=(0,o.A)((0,r.A)().mark((function e(t){var n,o,a=this;return(0,r.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(console.log("preloadImage:",t),n=this.getFullUrl(t),!this.loadedImages.has(n)){e.next=4;break}return e.abrupt("return",n);case 4:if(!this.loading.has(n)){e.next=6;break}return e.abrupt("return",this.loading.get(n));case 6:return o=fetch(n).then((function(e){if(!e.ok)throw new Error("Failed to load image: ".concat(n));return a.loadedImages.add(n),a.loading["delete"](n),n}))["catch"]((function(e){throw a.loading["delete"](n),e})),this.loading.set(n,o),e.abrupt("return",o);case 9:case"end":return e.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()},{key:"preloadBatch",value:function(){var e=(0,o.A)((0,r.A)().mark((function e(t){var n,o,a,i,s,c,u,l,p=this,d=arguments;return(0,r.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:for(n=d.length>1&&void 0!==d[1]?d[1]:3,o=d.length>2&&void 0!==d[2]?d[2]:1e3,a=[],i=0;i<t.length;i+=n)s=t.slice(i,i+n),a.push(s);c=0,u=a;case 5:if(!(c<u.length)){e.next=21;break}return l=u[c],e.prev=7,e.next=10,Promise.all(l.map((function(e){return p.preloadImage(e)})));case 10:if(!(a.indexOf(l)<a.length-1)){e.next=13;break}return e.next=13,new Promise((function(e){return setTimeout(e,o)}));case 13:e.next=18;break;case 15:e.prev=15,e.t0=e["catch"](7),console.error("Error preloading batch:",e.t0);case 18:c++,e.next=5;break;case 21:case"end":return e.stop()}}),e,null,[[7,15]])})));function t(t){return e.apply(this,arguments)}return t}()},{key:"isImageLoaded",value:function(e){var t=this.getFullUrl(e);return this.loadedImages.has(t)}}])}()),ue=new ce,le={class:"lazy-image-container"},pe=["src","alt"],de={key:0,class:"image-placeholder"};const he={__name:"LazyImage",props:{src:{type:String,required:!0},alt:{type:String,default:""}},setup:function(e){var t=e,n=(0,s.EW)((function(){return ue.getFullUrl(t.src)})),a=(0,c.KR)(ue.isImageLoaded(t.src));(0,s.sV)((0,o.A)((0,r.A)().mark((function e(){return(0,r.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(a.value){e.next=10;break}return e.prev=1,e.next=4,ue.preloadImage(t.src);case 4:a.value=!0,e.next=10;break;case 7:e.prev=7,e.t0=e["catch"](1),console.error("图片加载失败:",e.t0);case 10:case"end":return e.stop()}}),e,null,[[1,7]])}))));var i=function(){return a.value=!0},l=function(){return console.error("Image load error:",t.src)};return function(t,r){return(0,s.uX)(),(0,s.CE)("div",le,[(0,s.Lk)("img",{src:a.value?n.value:"",alt:e.alt,class:(0,u.C4)(["lazy-image",{"is-loaded":a.value}]),onLoad:i,onError:l},null,42,pe),a.value?(0,s.Q3)("",!0):((0,s.uX)(),(0,s.CE)("div",de,r[0]||(r[0]=[(0,s.Lk)("span",null,"加载中...",-1)])))])}}},fe=(0,h.A)(he,[["__scopeId","data-v-b8fd235c"]]),ve=fe;n(4423),n(1699);var ge={key:0,class:"music-player"},me=["src"],Se=["src"];const Ae={__name:"MusicPlayer",props:{musicUrl:{type:String,required:!0}},setup:function(e){var t=e,n=(0,s.EW)((function(){return t.musicUrl.includes("bilibili.com")})),r=(0,s.EW)((function(){return t.musicUrl.includes("music.163.com")}));return function(t,o){return e.musicUrl?((0,s.uX)(),(0,s.CE)("div",ge,[n.value?((0,s.uX)(),(0,s.CE)("iframe",{key:0,src:e.musicUrl,scrolling:"no",border:"0",frameborder:"no",framespacing:"0",allowfullscreen:"false",style:{width:"100%",height:"100%"}},null,8,me)):r.value?((0,s.uX)(),(0,s.CE)("iframe",{key:1,src:e.musicUrl,scrolling:"no",border:"0",frameborder:"no",framespacing:"0",allowfullscreen:"false",style:{width:"330px",height:"86px"}},null,8,Se)):(0,s.Q3)("",!0)])):(0,s.Q3)("",!0)}}},ye=(0,h.A)(Ae,[["__scopeId","data-v-98bb9a3e"]]),be=ye;var ke={class:"story-container"},Ee={class:"section-title"},Te=["innerHTML"],we=["innerHTML"],_e={key:2,class:"suggestions-container"},Ce={class:"controls"},xe=["disabled"],Ie=["disabled"],Oe={key:3,class:"interaction-stage"},Le={key:4,class:"interaction-stage"};const Ne=Object.assign({name:"StoryView"},{__name:"StoryView",setup:function(e){var t=(0,U.Pj)(),n=(0,c.KR)(""),i=(0,c.KR)(null),l=(0,s.EW)((function(){return t.state.sections.currentSection})),p=(0,s.EW)((function(){return t.state.game.suggestions})),d=(0,s.EW)((function(){return t.state.game.isSubmitting})),h=(0,s.EW)((function(){return t.state.game.isCooldown})),f=(0,s.EW)((function(){return t.state.game.isLoading})),v=(0,s.EW)((function(){var e,n,r;return{stage:(null===(e=t.state.game.interactionStage)||void 0===e?void 0:e.stage)||"",info:(null===(n=t.state.game.interactionStage)||void 0===n?void 0:n.info)||"",visible:(null===(r=t.state.game.interactionStage)||void 0===r?void 0:r.visible)||!1}})),g=(0,s.EW)((function(){return t.state.game.conversationHistory})),m=(0,s.EW)((function(){var e=t.state.game.storyContent;return e?k(e):""})),S=function(){var e=(0,o.A)((0,r.A)().mark((function e(){return(0,r.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(!d.value&&!h.value&&n.value.trim()){e.next=2;break}return e.abrupt("return");case 2:return e.prev=2,e.next=5,t.dispatch("game/handleUserInput",n.value);case 5:n.value="",i.value&&setTimeout((function(){i.value.scrollTop=i.value.scrollHeight}),100),e.next=12;break;case 9:e.prev=9,e.t0=e["catch"](2),console.error("处理用户输入时出错:",e.t0);case 12:case"end":return e.stop()}}),e,null,[[2,9]])})));return function(){return e.apply(this,arguments)}}(),A=function(e){if(!e||!e.content)return"";var t=e.content;return t=t.replace(/\n/g,"<br>"),"user"===e.role?t="<br><i>".concat(t,"</i><br><br>"):"info"===e.role&&(t='<div class="info-message">'.concat(t,"</div>")),k(t)};return(0,s.wB)(g,(function(){i.value&&setTimeout((function(){i.value.scrollTop=i.value.scrollHeight}),100)}),{deep:!0}),(0,s.sV)((function(){i.value&&(i.value.scrollTop=0)})),function(e,t){return(0,s.uX)(),(0,s.CE)("div",ke,[(0,s.Lk)("h2",Ee,(0,u.v_)(l.value.title),1),l.value.image?((0,s.uX)(),(0,s.Wv)(ve,{key:0,src:l.value.image,alt:l.value.title,class:"section-image"},null,8,["src","alt"])):(0,s.Q3)("",!0),l.value.musicUrl?((0,s.uX)(),(0,s.Wv)(be,{key:1,"music-url":l.value.musicUrl},null,8,["music-url"])):(0,s.Q3)("",!0),(0,s.Lk)("div",{class:"text-container",ref_key:"storyContentRef",ref:i},[(0,s.Lk)("div",{innerHTML:m.value},null,8,Te),((0,s.uX)(!0),(0,s.CE)(s.FK,null,(0,s.pI)(g.value,(function(e,t){return(0,s.uX)(),(0,s.CE)("div",{key:t,class:(0,u.C4)(["message",e.role])},[(0,s.Lk)("div",{innerHTML:A(e)},null,8,we)],2)})),128))],512),p.value.length?((0,s.uX)(),(0,s.CE)("div",_e,[((0,s.uX)(!0),(0,s.CE)(s.FK,null,(0,s.pI)(p.value,(function(e,t){return(0,s.uX)(),(0,s.CE)("div",{key:t,class:"suggestion"}," 建议："+(0,u.v_)(e),1)})),128))])):(0,s.Q3)("",!0),(0,s.Lk)("div",Ce,[(0,s.bo)((0,s.Lk)("input",{type:"text","onUpdate:modelValue":t[0]||(t[0]=function(e){return n.value=e}),maxlength:"200",placeholder:"你要怎么做？",onKeydown:(0,a.jR)(S,["enter"]),autocomplete:"off",disabled:d.value||h.value},null,40,xe),[[a.Jo,n.value]]),(0,s.Lk)("button",{class:"button",onClick:S,disabled:d.value||h.value}," 开始 ",8,Ie)]),v.value.visible?((0,s.uX)(),(0,s.CE)("div",Oe,[(0,s.Lk)("p",null,(0,u.v_)(v.value.stage)+": "+(0,u.v_)(v.value.info),1)])):(0,s.Q3)("",!0),f.value?((0,s.uX)(),(0,s.CE)("div",Le,t[1]||(t[1]=[(0,s.Lk)("p",null,"万物运行...",-1)]))):(0,s.Q3)("",!0)])}}}),Pe=(0,h.A)(Ne,[["__scopeId","data-v-510a1e61"]]),Re=Pe;var Me={class:"settings-container"},De={class:"settings-form"},Ue={for:"api-key"},Be=["placeholder","disabled"],je={for:"api-url"},Ge=["placeholder"],Ke={for:"advanced-model"},He={for:"basic-model"},Ve={class:"button-container"};const Fe=Object.assign({name:"SettingsView"},{__name:"SettingsView",setup:function(e){var t=this,n=(0,U.Pj)(),l=(0,c.KR)({apiKey:"",apiUrl:"",advancedModel:"",basicModel:"",isPublicKey:!1}),p=(0,s.EW)((function(){return{apiKey:n.state.settings.apiKey,apiUrl:n.state.settings.apiUrl,advancedModel:n.state.settings.advancedModel,basicModel:n.state.settings.basicModel,isPublicKey:n.state.settings.isPublicKey}})),d=function(){l.value=(0,i.A)({},p.value)},h=function(){var e=(0,o.A)((0,r.A)().mark((function e(){return(0,r.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,n.dispatch("settings/saveSettings",l.value);case 2:t.$toast.success(t.$t("settings.savedMessage"));case 3:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),f=function(){var e=(0,o.A)((0,r.A)().mark((function e(){var o;return(0,r.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,n.dispatch("settings/getPublicKey");case 2:o=e.sent,o?(t.$toast.success(t.$t("settings.publicKeyFetched")),d()):t.$toast.error(t.$t("settings.publicKeyFetchFailed"));case 4:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),v=function(){var e=(0,o.A)((0,r.A)().mark((function e(){return(0,r.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,n.dispatch("settings/resetSettings");case 2:d(),t.$toast.info(t.$t("settings.resetMessage"));case 4:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),g=function(){t.$modal.show("settings-help",{title:t.$t("settings.helpTitle"),content:t.$t("settings.helpContent")})};return(0,s.sV)((function(){n.dispatch("settings/loadSettings"),d()})),function(e,t){return(0,s.uX)(),(0,s.CE)("div",Me,[(0,s.Lk)("h2",null,(0,u.v_)(e.$t("settings.title")),1),(0,s.Lk)("div",De,[(0,s.Lk)("label",Ue,(0,u.v_)(e.$t("settings.apiKeyLabel")),1),(0,s.bo)((0,s.Lk)("input",{type:"password",id:"api-key","onUpdate:modelValue":t[0]||(t[0]=function(e){return l.value.apiKey=e}),placeholder:e.$t("settings.apiKeyPlaceholder"),disabled:l.value.isPublicKey},null,8,Be),[[a.Jo,l.value.apiKey]]),(0,s.Lk)("label",je,(0,u.v_)(e.$t("settings.apiUrlLabel")),1),(0,s.bo)((0,s.Lk)("input",{type:"text",id:"api-url","onUpdate:modelValue":t[1]||(t[1]=function(e){return l.value.apiUrl=e}),placeholder:e.$t("settings.apiUrlPlaceholder")},null,8,Ge),[[a.Jo,l.value.apiUrl]]),(0,s.Lk)("label",Ke,(0,u.v_)(e.$t("settings.advancedModelLabel")),1),(0,s.bo)((0,s.Lk)("select",{id:"advanced-model","onUpdate:modelValue":t[2]||(t[2]=function(e){return l.value.advancedModel=e})},t[4]||(t[4]=[(0,s.Lk)("option",{value:"gpt-4o-mini"},"gpt-4o-mini",-1)]),512),[[a.u1,l.value.advancedModel]]),(0,s.Lk)("label",He,(0,u.v_)(e.$t("settings.basicModelLabel")),1),(0,s.bo)((0,s.Lk)("select",{id:"basic-model","onUpdate:modelValue":t[3]||(t[3]=function(e){return l.value.basicModel=e})},t[5]||(t[5]=[(0,s.Lk)("option",{value:"gpt-4o-mini"},"gpt-4o-mini",-1)]),512),[[a.u1,l.value.basicModel]]),(0,s.Lk)("div",Ve,[(0,s.Lk)("button",{onClick:h},(0,u.v_)(e.$t("settings.saveButton")),1),(0,s.Lk)("button",{onClick:f},(0,u.v_)(e.$t("settings.publicKeyButton")),1),(0,s.Lk)("button",{onClick:v},(0,u.v_)(e.$t("settings.resetButton")),1),(0,s.Lk)("button",{onClick:g},(0,u.v_)(e.$t("settings.helpButton")),1)])])])}}}),$e=Fe,Xe=$e;var We=[{path:"/",name:"Home",component:W},{path:"/sections",name:"Sections",component:ae},{path:"/story",name:"Story",component:Re},{path:"/settings",name:"Settings",component:Xe},{path:"/review",name:"Review",component:function(){return n.e(561).then(n.bind(n,9561))},meta:{title:"reviewTitle"}}],ze=(0,R.aE)({history:(0,R.LA)(M.BASE_PATH),routes:We});const Je=ze;var Ye=n(9258),Qe=n(1396),qe=n.n(Qe),Ze="ReadingThisIsASpoilerForYourself";function et(){return tt.apply(this,arguments)}function tt(){return tt=(0,o.A)((0,r.A)().mark((function e(){var t,n,o;return(0,r.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.prev=0,t=g(),e.next=4,fetch("".concat(t,"/sections/sections.bbs?v=").concat((new Date).getTime()));case 4:if(n=e.sent,n.ok){e.next=7;break}throw new Error("HTTP error! status: ".concat(n.status));case 7:return e.next=9,n.text();case 9:return o=e.sent,e.abrupt("return",ot(o,Ze));case 13:throw e.prev=13,e.t0=e["catch"](0),console.error("加载章节索引失败:",e.t0),new Error("加载章节失败，请检查网络连接或刷新页面重试");case 17:case"end":return e.stop()}}),e,null,[[0,13]])}))),tt.apply(this,arguments)}function nt(e){return rt.apply(this,arguments)}function rt(){return rt=(0,o.A)((0,r.A)().mark((function e(t){var n,o,a;return(0,r.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return n=g(),e.next=3,fetch("".concat(n,"/sections/").concat(t,"?v=").concat((new Date).getTime()));case 3:return o=e.sent,e.next=6,o.text();case 6:return a=e.sent,e.abrupt("return",ot(a,Ze));case 8:case"end":return e.stop()}}),e)}))),rt.apply(this,arguments)}function ot(e,t){var n=qe().AES.decrypt(e,t),r=n.toString(qe().enc.Utf8);try{return JSON.parse(r)}catch(o){throw console.error("解析JSON时出错:",o.message),o}}var at=function(){return{chapters:[],unlockedSections:[],completedSections:[],currentSection:null,currentSectionData:null}},it={SET_CHAPTERS:function(e,t){e.chapters=t},SET_UNLOCKED_SECTIONS:function(e,t){e.unlockedSections=t},SET_COMPLETED_SECTIONS:function(e,t){e.completedSections=t},SET_CURRENT_SECTION:function(e,t){e.currentSection=t},SET_CURRENT_SECTION_DATA:function(e,t){e.currentSectionData=t}},st={loadSectionsIndex:function(e){return(0,o.A)((0,r.A)().mark((function t(){var n,o,a,i,s;return(0,r.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:return n=e.commit,o=e.dispatch,a=e.rootGetters,t.prev=1,console.log("开始加载章节索引..."),t.next=5,et();case 5:i=t.sent,console.log("章节索引加载成功:",i),n("SET_CHAPTERS",i.chapters),s=a["save/saveData"],(!s||!s.unlockedSections||s.unlockedSections&&0===s.unlockedSections.length)&&o("unlockSection",1),t.next=16;break;case 12:throw t.prev=12,t.t0=t["catch"](1),console.error("加载章节索引失败:",t.t0),t.t0;case 16:case"end":return t.stop()}}),t,null,[[1,12]])})))()},loadSection:function(e,t){return(0,o.A)((0,r.A)().mark((function n(){var o,a,i;return(0,r.A)().wrap((function(n){while(1)switch(n.prev=n.next){case 0:return o=e.commit,a=e.dispatch,n.prev=1,n.next=4,nt(t);case 4:if(i=n.sent,i){n.next=7;break}throw new Error("章节数据加载失败: ".concat(t," 返回空数据"));case 7:if(i.startEvent){n.next=9;break}throw new Error("章节数据格式错误: ".concat(t," 缺少 startEvent 属性"));case 9:if(!i.image){n.next=14;break}return console.log("加载图片:",i.image),i.image="".concat(g()).concat(i.image),n.next=14,ue.preloadImage(i.image);case 14:return o("SET_CURRENT_SECTION",i),o("SET_CURRENT_SECTION_DATA",i),n.next=18,a("game/initializeGame",null,{root:!0});case 18:return n.abrupt("return",i);case 21:throw n.prev=21,n.t0=n["catch"](1),console.error("加载章节失败:",n.t0),n.t0;case 25:case"end":return n.stop()}}),n,null,[[1,21]])})))()},unlockSection:function(e,t){var n=e.commit,r=e.state,o=[].concat((0,Ye.A)(r.unlockedSections),[t]);n("SET_UNLOCKED_SECTIONS",o)},completeSection:function(e,t){var n=e.commit,r=e.state,o=[].concat((0,Ye.A)(r.completedSections),[t]);n("SET_COMPLETED_SECTIONS",o)},skipSection:function(e,t){return(0,o.A)((0,r.A)().mark((function n(){var o,a;return(0,r.A)().wrap((function(n){while(1)switch(n.prev=n.next){case 0:return o=e.dispatch,n.next=3,nt(t);case 3:a=n.sent,o("completeSection",a.id),o("unlockSection",a.id+1);case 6:case"end":return n.stop()}}),n)})))()},preloadSectionImages:function(e){return(0,o.A)((0,r.A)().mark((function t(){var n,o;return(0,r.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:return n=e.state,o=[],n.chapters.forEach((function(e){e.sections.forEach((function(e){e.image&&o.push("".concat(g()).concat(e.image))}))})),t.next=5,ue.preloadBatch(o);case 5:case"end":return t.stop()}}),t)})))()}},ct={isSectionUnlocked:function(e){return function(t){return e.unlockedSections.includes(t)}},isSectionCompleted:function(e){return function(t){return e.completedSections.includes(t)}},getCurrentSection:function(e){return e.currentSection},getCurrentSectionData:function(e){return e.currentSectionData}};const ut={namespaced:!0,state:at,mutations:it,actions:st,getters:ct};n(113),n(8598),n(739),n(2010),n(3110);var lt=n(8676),pt=(n(5506),n(3921),n(2008),n(5086),n(9449),n(3772)),dt={ADVANCED:"advanced",BASIC:"basic"},ht=(0,pt.A)((0,pt.A)({},dt.ADVANCED,"gpt-4o-mini"),dt.BASIC,"gpt-4o-mini"),ft="settings";function vt(){return gt.apply(this,arguments)}function gt(){return gt=(0,o.A)((0,r.A)().mark((function e(){var t;return(0,r.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return t=localStorage.getItem(ft),e.abrupt("return",t?JSON.parse(t):mt());case 2:case"end":return e.stop()}}),e)}))),gt.apply(this,arguments)}function mt(){return{apiKey:"",apiUrl:"https://api.deepbricks.ai/v1/",advancedModel:"gpt-4o-mini",basicModel:"gpt-4o-mini",isPublicKey:!1}}function St(e){var t=JSON.parse(localStorage.getItem("settings"));return t&&t[e]||ht[e]}var At={ADVANCED:"advanced",BASIC:"basic"};function yt(){arguments.length>0&&void 0!==arguments[0]||At.BASIC;return At.ADVANCED,"gpt-4o-mini"}function bt(e){return kt.apply(this,arguments)}function kt(){return kt=(0,o.A)((0,r.A)().mark((function e(t){var n;return(0,r.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(t.ok){e.next=6;break}return e.next=3,t.json();case 3:throw n=e.sent,console.error("错误响应内容:",n),new Error("HTTP error! status: ".concat(t.status));case 6:return e.next=8,t.json();case 8:return e.abrupt("return",e.sent);case 9:case"end":return e.stop()}}),e)}))),kt.apply(this,arguments)}var Et=function(){function e(){(0,ie.A)(this,e),this.decoder=new TextDecoder("utf-8"),this.buffer=""}return(0,se.A)(e,[{key:"handleStream",value:function(){var e=(0,o.A)((0,r.A)().mark((function e(t,n){var o,a,i,s,c,u,l,p,d,h,f;return(0,r.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:o=t.body.getReader(),a="",i=!0;case 3:if(!i){e.next=27;break}return e.next=6,o.read();case 6:if(s=e.sent,c=s.done,u=s.value,!c){e.next=11;break}return e.abrupt("break",27);case 11:this.buffer+=this.decoder.decode(u,{stream:!0}),l=this.buffer.split("\n"),p=0;case 14:if(!(p<l.length-1)){e.next=24;break}if(d=l[p],!d.startsWith("data: ")){e.next=21;break}if(h=d.slice(6),"[DONE]"!==h){e.next=20;break}return e.abrupt("break",24);case 20:try{f=JSON.parse(h),f.choices&&f.choices[0].delta.content&&(a+=f.choices[0].delta.content,n(a))}catch(r){console.error("JSON解析错误:",r)}case 21:p++,e.next=14;break;case 24:this.buffer=l[l.length-1],e.next=3;break;case 27:return e.abrupt("return",a);case 28:case"end":return e.stop()}}),e,this)})));function t(t,n){return e.apply(this,arguments)}return t}()},{key:"fetchStream",value:function(){var e=(0,o.A)((0,r.A)().mark((function e(t,n,o){var a;return(0,r.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,fetch(t,(0,i.A)((0,i.A)({},n),{},{headers:(0,i.A)((0,i.A)({},n.headers),{},{Accept:"text/event-stream"})}));case 3:if(a=e.sent,a.ok){e.next=6;break}throw new Error("HTTP error! status: ".concat(a.status));case 6:return e.next=8,this.handleStream(a,o);case 8:return e.abrupt("return",e.sent);case 11:throw e.prev=11,e.t0=e["catch"](0),console.error("流式请求错误:",e.t0),e.t0;case 15:case"end":return e.stop()}}),e,this,[[0,11]])})));function t(t,n,r){return e.apply(this,arguments)}return t}()}])}(),Tt=function(){function e(t,n,r,o,a,i){(0,ie.A)(this,e),this.startEvent=t,this.commonKnowledge=n,this.GMDetails=r,this.playerInfo=o,this.sectionObjective=a,this.endConditions=i,this.streamHandler=new Et,this.endSectionFlag=!1,this.store=(0,s.WQ)("store")}return(0,se.A)(e,[{key:"validateAction",value:function(){var e=(0,o.A)((0,r.A)().mark((function e(t){var n,o;return(0,r.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return n={type:"object",properties:{reason:{type:"string"},suggestion:{type:"string"},isValid:{type:"boolean"},specificAction:{type:"string"}},required:["reason","suggestion","isValid","specificAction"],additionalProperties:!1},o="\n作为游戏主持人，请评估玩家是否有能力进行他描述的行动，背景：\n\n开始事件：".concat(this.startEvent,"\n公共知识：").concat(this.commonKnowledge,"\nGM细节：").concat(this.GMDetails,"\n\n玩家信息：\n").concat(this.playerInfo,"\n\n上一回合：\n").concat(this.getLastRound(),"\n\n本回合玩家行动：").concat(t,"\n注意，玩家的行为可以胡闹，你主要判断可行性，只要有能力做到，就可以做。\n请用JSON格式回答，包含以下字段：\n- reason: 解释玩家行动是否可行的原因\n- suggestion: 如果行动不可行，给出的建议。如果可行，则留空。\n- isValid: 玩家行动是否可行的结论（布尔值）\n- specificAction: 请具体描述玩家实际做的事情和说得话，避免歧义，同时也尽量保留原话，最重要的是具体化对象。例如，如果玩家说'你好'，可以描述为'向在场的人问好'，或者判断到是向谁问好。如果不可行，可以留空。如果玩家使用了特殊能力或技能，请具体说明使用的是哪个能力，对能力的效果至少要有一句描写。注意，使用能力必须要是玩家主动发动，因为会消耗灵力的，如果玩家没有明说，就不要发动能力。"),e.next=4,this.callLargeLanguageModel(o,n);case 4:return e.abrupt("return",e.sent);case 5:case"end":return e.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()},{key:"summarizeActions",value:function(){var e=(0,o.A)((0,r.A)().mark((function e(t,n,o,a){var s,c,u,l;return(0,r.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return s={type:"object",properties:{triggerChecks:{type:"array",items:{type:"object",properties:{id:{type:"string"},triggerCondition:{type:"string"},currentProgress:{type:"string"},isTriggered:{type:"boolean"}},required:["id","triggerCondition","currentProgress","isTriggered"],additionalProperties:!1}},collision:{type:"string"},summary:{type:"array",items:{type:"object",properties:{name:{type:"string"},note:{type:"string"},successProbability:{type:"string",enum:["impossible","unlikely","possible","likely","certain"],description:"行动成功的可能性"}},required:["name","note","successProbability"],additionalProperties:!1}},endReasons:{type:"array",items:{type:"object",properties:{condition:{type:"string"},isMet:{type:"boolean"}},required:["condition","isMet"],additionalProperties:!1}},endSectionFlag:{type:"boolean"},suggestions:{type:"array",items:{type:"string"}}},required:["triggerChecks","endReasons","endSectionFlag","collision","summary","suggestions"],additionalProperties:!1},c=this.getOptimizedHistory(),u="请考虑以下背景信息和优化后的对话历史：\n\n起始事件：".concat(this.startEvent,"\n公共信息：").concat(this.commonKnowledge,"\n主持人信息：").concat(this.GMDetails,"\n结束条件：\n").concat(this.endConditions.map((function(e,t){return"".concat(t+1,". ").concat(e)})).join("\n"),"\n\n优化后的对话历史：\n").concat(c,"\n\n主角目标：").concat(this.sectionObjective,"\n\n现在，请分析这个回合中每个角色的行动：\n主角行动：").concat(t,"\n\n其他角色行动：\n").concat(Object.entries(n).map((function(e){var t=(0,lt.A)(e,2),n=t[0],r=t[1];return"".concat(n,": ").concat(r.action)})).join("\n"),"\n\n当前回合数：").concat(a,"\n\n剧情触发器列表：\n").concat(o.filter((function(e){return!e.consumed&&!e.triggerCondition.startsWith("第")})).map((function(e){return"- ID: ".concat(e.id,", 触发条件: ").concat(e.triggerCondition)})).join("\n"),'\n\n请按照指定的JSON格式回复，包括以下字段：\n- triggerChecks: 一个数组，包含每个剧情触发器的以下信息：\n    触发器列表为空的时候留空数组。\n  - id: 触发器ID\n  - triggerCondition: 触发条件\n  - currentProgress: 当前触发进度的简单描述\n  - isTriggered: 布尔值，表示该触发器是否在这个回合被触发\n- collision: 角色之间行动的冲突，哪个角色做的可能让另一个角色达不到最终的效果\n- summary: 一个数组，包含每个角色的名字、行动结果注释和成功可能性。\n  - name: 角色名字\n  - note: 对该行动的结论性判定，例如"攻击"、"防御"、"行动"等，只简单写行动类型，不写成败。\n  - successProbability: 行动成功的可能性，必须是以下五个选项之一："impossible"（不可能）、"unlikely"（不太可能）、"possible"（可能）、"likely"（很可能）、"certain"（必然）。如果异能用对了方式，那就是certain。\n- endReasons: 一个数组,包含每个结束条件及其是否满足的布尔值:\n  - condition: 结束条件\n  - isMet: 布尔值,表示该条件是否满足\n- endSectionFlag: 布尔值,是否结束该桥段\n- suggestions: 一个数组，包含1-2个对主角继续推进剧情的建议。这些建议应该考虑当前情况和桥段目标。'),e.next=5,this.callLargeLanguageModel(u,s);case 5:return l=e.sent,l.summary=l.summary.map((function(e){var t;switch(e.successProbability){case"impossible":t=.05;break;case"unlikely":t=.25;break;case"possible":t=.5;break;case"likely":t=.65;break;case"certain":t=.9;break;default:t=.5}return(0,i.A)((0,i.A)({},e),{},{isSuccessful:Math.random()<t})})),o.forEach((function(e){if(e.triggerCondition.startsWith("第")&&e.triggerCondition.endsWith("回合")){var t=parseInt(e.triggerCondition.replace(/[^0-9]/g,""));a===t&&l.triggerChecks.push({id:e.id,triggerCondition:e.triggerCondition,currentProgress:"当前是第".concat(a,"回合"),isTriggered:!0})}})),l.endSectionFlag=l.endReasons.some((function(e){return e.isMet})),this.endSectionFlag=l.endSectionFlag,e.abrupt("return",l);case 11:case"end":return e.stop()}}),e,this)})));function t(t,n,r,o){return e.apply(this,arguments)}return t}()},{key:"generateFinalResult",value:function(){var e=(0,o.A)((0,r.A)().mark((function e(t,n,o,a){var i,s,c,u,l=this;return(0,r.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return s=this.getOptimizedHistory(),c=[{name:this.getSelectedCharacter(),action:n,isSuccessful:null===(i=t.summary.find((function(e){return e.name===l.getSelectedCharacter()})))||void 0===i?void 0:i.isSuccessful}].concat((0,Ye.A)(Object.entries(o).map((function(e){var n=(0,lt.A)(e,2),r=n[0],o=n[1],a=t.summary.find((function(e){return e.name===r}));return{name:r,action:o.action,isSuccessful:null===a||void 0===a?void 0:a.isSuccessful}})))),u="请考虑以下背景信息、优化后的对话历史和触发的剧情触发器：\n\n起始事件：".concat(this.startEvent,"\n公共信息：").concat(this.commonKnowledge,"\n主持人信息：").concat(this.GMDetails,"\n\n过去回合历史：\n").concat(s,"\n\n本回合各角色的行动和结果：\n").concat(c.map((function(e){return"".concat(e.name,": ").concat(e.action,"\n判定: ").concat(e.isSuccessful?"成功":"失败或有意外")})).join("\n\n"),"\n行动有冲突的情况，你可自行斟酌。\n\n本回合触发的剧情触发器：\n").concat(a.map((function(e){return e.content})).join("\n"),"\n\n请小说化地描述这个新的回合的结果，包括每个角色说出来的话、做的动作等。请用第三人称方式描写。请确保描述中自然地包含每个角色实际成功或失败的行动，以及触发的剧情触发器。注意你的回复会直接增量展示为小说内容，所以不要写前导后缀提示。也不要写太多内容，不要写重复了。也不要描写主角").concat(this.getSelectedCharacter(),"的心理活动或主观气氛。写三个自然段就行。如果有剧情触发器的话，必须体现在你的描述里，优先级很高。"),e.next=5,this.callLargeLanguageModelStream(u);case 5:return e.abrupt("return",e.sent);case 6:case"end":return e.stop()}}),e,this)})));function t(t,n,r,o){return e.apply(this,arguments)}return t}()},{key:"getOptimizedHistory",value:function(){return this.store.state.interaction.optimizedConversationHistory.map((function(e){return"".concat(e.role,": ").concat(e.content)})).join("\n")||""}},{key:"getSelectedCharacter",value:function(){return this.store.state.game.selectedCharacter||""}},{key:"callLargeLanguageModel",value:function(){var e=(0,o.A)((0,r.A)().mark((function e(t,n){var o,a;return(0,r.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,fetch({NODE_ENV:"production",BASE_URL:"/vue/"}.VITE_API_URL,{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat({NODE_ENV:"production",BASE_URL:"/vue/"}.VITE_API_KEY),Accept:"application/json"},body:JSON.stringify({model:yt(At.BASIC),messages:[{role:"user",content:t}],response_format:{type:"json_schema",json_schema:{name:"moderator_response",schema:n,strict:!0}},max_tokens:1e3})});case 2:return o=e.sent,e.next=5,bt(o);case 5:return a=e.sent,e.abrupt("return",JSON.parse(a.choices[0].message.content));case 7:case"end":return e.stop()}}),e)})));function t(t,n){return e.apply(this,arguments)}return t}()},{key:"callLargeLanguageModelStream",value:function(){var e=(0,o.A)((0,r.A)().mark((function e(t){var n,o,a=this;return(0,r.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return n={method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat({NODE_ENV:"production",BASE_URL:"/vue/"}.VITE_API_KEY),Accept:"application/json"},body:JSON.stringify({model:yt(At.BASIC),messages:[{role:"user",content:t}],max_tokens:1e3,stream:!0})},o="",e.next=4,this.streamHandler.fetchStream({NODE_ENV:"production",BASE_URL:"/vue/"}.VITE_API_URL,n,(function(e){o=e,a.$emit("streamUpdate",e)}));case 4:return e.abrupt("return",o);case 5:case"end":return e.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()},{key:"getLastRound",value:function(){return""}}])}(),wt=(n(2712),function(){function e(t,n,r,o,a){(0,ie.A)(this,e),this.name=t.name,this.description=t.description,this.personality=t.personality,this.goals=t.goals,this.sectionGuidance=o,this.memory=[],this.debugMode=!1,this.commonKnowledge=n,this.startEvent=r,this.privateMemory=[],this.maxPrivateMemoryLength=5,this.characterTags=this.loadCharacterTag(t.characterTags,a)}return(0,se.A)(e,[{key:"loadCharacterTag",value:function(e,t){return e.reduce((function(e,n){return t[n]?e[n]=t[n]:console.warn("标签键未找到: ".concat(n)),e}),{})}},{key:"log",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;this.debugMode&&console.log("[DEBUG AI ".concat(this.name,"] ").concat(e),t)}},{key:"createPrompt",value:function(e){var t=this.memory.slice(-5).map((function(e){return"".concat(e.role,": ").concat(e.content)})).join("\n"),n=this.privateMemory.map((function(e){return"想法: ".concat(e)})).join("\n"),r=Object.entries(this.characterTags).map((function(e){var t=(0,lt.A)(e,2),n=t[0],r=t[1];return"".concat(n,"：").concat(r)})).join("\n");return"你是".concat(this.name,"。").concat(this.description,"。\n性格：").concat(this.personality,"\n").concat(r,"\n目标：").concat(this.goals.join(", "),"\n公共信息：").concat(this.commonKnowledge,"\n开始事件：").concat(this.startEvent,"\n桥段指导：").concat(this.sectionGuidance,"\n\n最近的公共记忆：\n").concat(t,"\n\n你最近的私人想法：\n").concat(n,"\n\n当前情况：\n").concat(e,"\n再次强调你的角色是").concat(this.name,"。\n\n请用JSON格式回复，包括以下字段：\n1. activeAbilities：明确当前有什么异能正在发动过程中。\n2. checkCanAct：解释并判断你能否行动。比如说有人发动时间减速异能时，你不能行动。注意这是'能否行动'，而不是'要不要行动'。\n3. canAct：布尔值，表示是否能够行动。\n4. thoughts：数组，包含你的思考过程。每个思考步骤应包含思考阶段和内容。思考过程：\n   a. 分析当前情况：仔细考虑当前的环境、其他角色的行动和可能的影响。\n   b. 回顾个人目标：思考你的角色目标，以及当前情况如何影响这些目标。\n   c. 考虑可能的行动：列出几个可能的行动方案，包括可能推动剧情发展的行动。\n   d. 哪个行动最快：判断并选择一个能尽快结束剧情的行动，避免进入对峙。哪怕是满足敌人的目标也行。\n5. action：你的最终行动和说的话。")}},{key:"updateMemory",value:function(e,t){var n=t.thoughts.filter((function(e,t){return 1===t||3===t})).map((function(e){return"".concat(e.step,": ").concat(e.content)})).join("; ");this.privateMemory.push(n),this.privateMemory.length>this.maxPrivateMemoryLength&&this.privateMemory.shift(),this.log("更新私有记忆",{situation:e,response:t,currentPrivateMemory:this.privateMemory})}},{key:"addPrivateThought",value:function(e){this.privateMemory.push(e),this.privateMemory.length>this.maxPrivateMemoryLength&&this.privateMemory.shift(),this.log("添加私人想法",{thought:e,currentPrivateMemory:this.privateMemory})}},{key:"getResponse",value:function(){var e=(0,o.A)((0,r.A)().mark((function e(t){var n,o,a,i,s,c,u;return(0,r.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return n={type:"object",properties:{activeAbilities:{type:"string"},checkCanAct:{type:"string"},canAct:{type:"boolean"},thoughts:{type:"array",items:{type:"object",properties:{step:{type:"string"},content:{type:"string"}},required:["step","content"],additionalProperties:!1}},action:{type:"string"}},required:["activeAbilities","checkCanAct","canAct","thoughts","action"],additionalProperties:!1},o=this.createPrompt(t),a=[{role:"system",content:o},{role:"user",content:t}],e.prev=3,e.next=6,fetch({NODE_ENV:"production",BASE_URL:"/vue/"}.VITE_API_URL,{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat({NODE_ENV:"production",BASE_URL:"/vue/"}.VITE_API_KEY),Accept:"application/json"},body:JSON.stringify({model:yt(At.BASIC),messages:a,response_format:{type:"json_schema",json_schema:{name:"ai_player_response",schema:n,strict:!0}},max_tokens:1e3}),credentials:"include"});case 6:return i=e.sent,e.next=9,bt(i);case 9:return s=e.sent,c=JSON.parse(s.choices[0].message.content),this.log("AI 反应",c),!1===c.canAct&&(c.action=c.checkCanAct,c.thoughts=[{step:"无法思考",content:"来不及思考"}]),this.updateMemory(t,c),u={action:c.action},this.log("AI 提交动作",u),e.abrupt("return",u);case 19:throw e.prev=19,e.t0=e["catch"](3),console.error("Error in AI response:",e.t0),e.t0;case 23:case"end":return e.stop()}}),e,this,[[3,19]])})));function t(t){return e.apply(this,arguments)}return t}()}])}()),_t=function(){function e(t,n){(0,ie.A)(this,e),this.gameState=t,this.moderator=null,this.aiPlayers={},this.streamHandler=new Et,this.characterTagBase=null,this.playerInfo=null,this.turnCount=0,this.plotTriggers=[],this.sectionData=n}return(0,se.A)(e,[{key:"loadCharacterTagBase",value:function(){var e=(0,o.A)((0,r.A)().mark((function e(){var t,n;return(0,r.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.prev=0,t=g(),e.next=4,fetch("".concat(t,"/config/characterTagBase.json?v=").concat((new Date).getTime()));case 4:return n=e.sent,e.next=7,n.json();case 7:this.characterTagBase=e.sent,console.log("加载角色标签库:",this.characterTagBase),e.next=15;break;case 11:throw e.prev=11,e.t0=e["catch"](0),console.error("加载角色标签库时出错:",e.t0),e.t0;case 15:case"end":return e.stop()}}),e,this,[[0,11]])})));function t(){return e.apply(this,arguments)}return t}()},{key:"setupGame",value:function(){var e=(0,o.A)((0,r.A)().mark((function e(){var t,n=this;return(0,r.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(this.characterTagBase){e.next=3;break}return e.next=3,this.loadCharacterTagBase();case 3:if(t=this.sectionData,t){e.next=6;break}throw new Error("无法获取章节数据");case 6:this.aiPlayers={},t.characters.forEach((function(e){e.isAI?n.aiPlayers[e.name]=new wt(e,t.commonKnowledge,t.startEvent,e.sectionGuidance,n.characterTagBase):n.mainPlayer=e})),this.initializePlotTriggers(t.plotTriggers),this.currentContext=t.backgroundInfo,this.mainPlayer.isAI||(this.playerInfo=this.createPlayerInfo(this.mainPlayer)),this.moderator=new Tt(t.startEvent,t.commonKnowledge,t.GMDetails,this.playerInfo,t.objective,t.endConditions);case 12:case"end":return e.stop()}}),e,this)})));function t(){return e.apply(this,arguments)}return t}()},{key:"initializePlotTriggers",value:function(e){this.plotTriggers=e.map((function(e){return(0,i.A)((0,i.A)({},e),{},{consumed:!1,memoryCharacter:e.memoryCharacter||null})}))}},{key:"createPlayerInfo",value:function(e){var t=this,n="角色：".concat(e.name,"\n");return n+="描述：".concat(e.description,"\n"),e.characterTags.forEach((function(e){var r=t.getCharacterTag(e);r&&(n+="- ".concat(e,": ").concat(r,"\n"))})),n}},{key:"processMainPlayerAction",value:function(){var e=(0,o.A)((0,r.A)().mark((function e(t){var n,o,a,i,s,c;return(0,r.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return this.turnCount++,e.next=3,this.moderator.validateAction(t);case 3:if(n=e.sent,n.isValid){e.next=6;break}return e.abrupt("return",{content:n.reason,isValid:!1,suggestions:n.suggestion?[n.suggestion]:[]});case 6:return o=n.specificAction,e.next=9,this.getAIPlayersResponses(o);case 9:return a=e.sent,e.next=12,this.moderator.summarizeActions(o,a,this.plotTriggers,this.turnCount);case 12:return i=e.sent,s=this.updateTriggeredPlots(i.triggerChecks),e.next=16,this.moderator.generateFinalResult(i,o,a,s);case 16:return c=e.sent,this.updateContext(c),e.abrupt("return",{content:c,isValid:!0,suggestions:i.suggestions,endSectionFlag:i.endSectionFlag});case 19:case"end":return e.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()},{key:"updateContext",value:function(e){this.currentContext+="\n".concat(e)}},{key:"getAIPlayersResponses",value:function(){var e=(0,o.A)((0,r.A)().mark((function e(t){var n,a;return(0,r.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return n=Object.entries(this.aiPlayers).map(function(){var e=(0,o.A)((0,r.A)().mark((function e(n){var o,a,i,s;return(0,r.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return o=(0,lt.A)(n,2),a=o[0],i=o[1],e.next=3,i.getResponse(t);case 3:return s=e.sent,e.abrupt("return",[a,s]);case 5:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),e.next=3,Promise.all(n);case 3:return a=e.sent,e.abrupt("return",Object.fromEntries(a));case 5:case"end":return e.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()},{key:"getCharacterTag",value:function(e){return this.characterTagBase?this.characterTagBase[e]:null}},{key:"updateTriggeredPlots",value:function(e){var t=this,n=[];return e.forEach((function(e){var r=t.plotTriggers.find((function(t){return t.id===e.id}));r&&e.isTriggered&&!r.consumed&&(r.consumed=!0,n.push(r),r.memoryCharacter&&t.aiPlayers[r.memoryCharacter]&&t.aiPlayers[r.memoryCharacter].addPrivateThought(r.content))})),n}}])}(),Ct=function(){return{currentSectionId:null,completedSections:[],unlockedSections:[],globalInfluencePoints:[],storyTitle:"",storyContent:"",gameManager:null,suggestions:[],isLoading:!1,moderator:null,conversationHistory:[],streamHandler:new Et,streamingContent:"",showTutorial:!1,tutorialContent:{title:"",content:""},isSubmitting:!1,isCooldown:!1,selectedCharacter:"罗伯特",currentSection:null,currentIsReplay:!1,optimizedConversationHistory:[],turnCount:0,plotTriggers:[],isGameInitialized:!1,userInput:"",interactionStage:{stage:"",info:"",visible:!1}}},xt={SET_CURRENT_SECTION:function(e,t){e.currentSection=t},SET_COMPLETED_SECTIONS:function(e,t){e.completedSections=t},SET_UNLOCKED_SECTIONS:function(e,t){e.unlockedSections=t},SET_GLOBAL_INFLUENCE_POINTS:function(e,t){e.globalInfluencePoints=t},SET_STORY_TITLE:function(e,t){e.storyTitle=t},SET_STORY_CONTENT:function(e,t){e.storyContent=t},SET_GAME_MANAGER:function(e,t){e.gameManager=t},SET_SUGGESTIONS:function(e,t){e.suggestions=t},SET_LOADING:function(e,t){e.isLoading=t},SET_MODERATOR:function(e,t){e.moderator=t},ADD_TO_CONVERSATION_HISTORY:function(e,t){e.conversationHistory.push(t)},UPDATE_STREAMING_CONTENT:function(e,t){e.streamingContent=t},SET_SHOW_TUTORIAL:function(e,t){e.showTutorial=t},SET_TUTORIAL_CONTENT:function(e,t){e.tutorialContent=t},SET_SUBMITTING:function(e,t){e.isSubmitting=t},SET_COOLDOWN:function(e,t){e.isCooldown=t},SET_SELECTED_CHARACTER:function(e,t){e.selectedCharacter=t},SET_CURRENT_IS_REPLAY:function(e,t){e.currentIsReplay=t},ADD_CONVERSATION_HISTORY:function(e,t){e.conversationHistory.push(t)},ADD_OPTIMIZED_CONVERSATION_HISTORY:function(e,t){e.optimizedConversationHistory.push(t)},INCREMENT_TURN_COUNT:function(e){e.turnCount++},SET_PLOT_TRIGGERS:function(e,t){e.plotTriggers=t},RESET_STATE:function(e){e.isSubmitting=!1,e.isCooldown=!1,e.conversationHistory=[],e.optimizedConversationHistory=[],e.currentSection=null,e.currentIsReplay=!1,e.turnCount=0,e.plotTriggers=[]},SET_USER_INPUT:function(e,t){e.userInput=t},SET_GAME_INITIALIZED:function(e,t){e.isGameInitialized=t},SET_INTERACTION_STAGE:function(e,t){var n=t.stage,r=t.info;e.interactionStage={stage:n,info:r,visible:!0}},HIDE_INTERACTION_STAGE:function(e){e.interactionStage.visible=!1}},It={initializeGameState:function(e){var t=e.commit,n=e.dispatch,r=n("save/loadSave",null,{root:!0});r?(t("SET_CURRENT_SECTION",r.currentSectionId),t("SET_COMPLETED_SECTIONS",r.completedSections),t("SET_UNLOCKED_SECTIONS",r.unlockedSections),t("SET_GLOBAL_INFLUENCE_POINTS",r.globalInfluencePoints)):(t("SET_CURRENT_SECTION",null),t("SET_COMPLETED_SECTIONS",[]),t("SET_UNLOCKED_SECTIONS",[1]),t("SET_GLOBAL_INFLUENCE_POINTS",[]))},newGame:function(e){var t=e.dispatch;t("save/clearSave",null,{root:!0}),t("initializeGameState")},continueGame:function(e){var t=e.dispatch;t("initializeGameState")},updateGameState:function(e,t){var n=e.state,r=e.dispatch,o=t.sectionId;r("save/saveSave",{currentSectionId:o,completedSections:n.completedSections,unlockedSections:n.unlockedSections,globalInfluencePoints:n.globalInfluencePoints},{root:!0})},initializeGameManager:function(e){return(0,o.A)((0,r.A)().mark((function t(){var n,o,a,i,s,c;return(0,r.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(n=e.commit,o=e.state,a=e.rootGetters,console.log("初始化游戏管理器"),i=a["sections/getCurrentSectionData"],i){t.next=6;break}return console.error("初始化游戏管理器时缺少section数据"),t.abrupt("return");case 6:if(s=new _t(o,i),n("SET_GAME_MANAGER",s),c=new Tt(i.startEvent,i.commonKnowledge,i.GMDetails,o.playerInfo,i.objective,i.endConditions),n("SET_MODERATOR",c),o.gameManager){t.next=15;break}return console.error("GameManager 实例未创建"),t.abrupt("return");case 15:console.log("GameManager 实例已创建");case 16:case"end":return t.stop()}}),t)})))()},processUserInput:function(e,t){return(0,o.A)((0,r.A)().mark((function n(){var o,a,i,s;return(0,r.A)().wrap((function(n){while(1)switch(n.prev=n.next){case 0:return o=e.commit,a=e.state,i=e.dispatch,o("SET_SUBMITTING",!0),n.prev=2,n.next=5,a.gameManager.processMainPlayerAction(t,(function(e){i("clearSuggestions"),o("ADD_OPTIMIZED_CONVERSATION_HISTORY",{role:"user",content:e})}));case 5:if(s=n.sent,!s.isValid){n.next=14;break}return n.next=9,i("updateConversationWithResult",s.finalResult);case 9:if(!a.gameManager.moderator.endSectionFlag){n.next=12;break}return n.next=12,i("handleSectionEnd");case 12:n.next=15;break;case 14:o("ADD_TO_CONVERSATION_HISTORY",{role:"system",content:s.feedback});case 15:n.next=20;break;case 17:n.prev=17,n.t0=n["catch"](2),console.error("处理用户输入时出错:",n.t0);case 20:return n.prev=20,o("SET_SUBMITTING",!1),o("SET_COOLDOWN",!0),setTimeout((function(){o("SET_COOLDOWN",!1)}),1e3),n.finish(20);case 25:case"end":return n.stop()}}),n,null,[[2,17,20,25]])})))()},initializeGame:function(e){return(0,o.A)((0,r.A)().mark((function t(){var n,o,a,i,s,c,u,l;return(0,r.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(n=e.commit,o=e.dispatch,a=e.state,i=e.rootGetters,s=i["sections/getCurrentSectionData"],s){t.next=5;break}return console.error("初始化游戏时缺少section数据"),t.abrupt("return");case 5:return console.log("初始化游戏:",s),n("SET_LOADING",!0),t.prev=7,t.next=10,o("initializeGameManager");case 10:if(c=a.gameManager,console.log("gameManager 完成设置",c),c){t.next=14;break}throw new Error("GameManager 初始化失败");case 14:return t.next=16,c.setupGame();case 16:return u=Nt(s),n("SET_STORY_CONTENT",u),t.next=20,o("showGameTutorial");case 20:return n("SET_STORY_TITLE",s.title),t.next=23,o("createPlayerInfo");case 23:l=t.sent,n("ADD_TO_CONVERSATION_HISTORY",{role:"info",content:l}),n("ADD_TO_CONVERSATION_HISTORY",{role:"assistant",content:s.startEvent});case 26:return t.prev=26,n("SET_LOADING",!1),t.finish(26);case 29:case"end":return t.stop()}}),t,null,[[7,,26,29]])})))()},handleOutcome:function(e,t){return(0,o.A)((0,r.A)().mark((function n(){var o,a,i,s,c;return(0,r.A)().wrap((function(n){while(1)switch(n.prev=n.next){case 0:if(o=e.commit,a=e.dispatch,i=t.sectionId,s=t.summary,c=t.isReplay,n.prev=2,!s.objective){n.next=13;break}if(c){n.next=7;break}return n.next=7,a("updateGameState",{sectionId:i,result:{objectiveAchieved:s.objective,influencePoints:s.influencePoints}});case 7:if(o("ADD_TO_CONVERSATION_HISTORY",{role:"system",content:"".concat(s.objective_judge,"\n桥段目标完成")}),c){n.next=11;break}return n.next=11,a("review/storeSectionReview",{sectionId:i,conversationHistory:Ct.conversationHistory,storyContent:document.getElementById("storyContent").innerHTML},{root:!0});case 11:n.next=14;break;case 13:o("ADD_TO_CONVERSATION_HISTORY",{role:"system",content:"".concat(s.objective_judge,"\n桥段目标未达成")});case 14:n.next=20;break;case 16:throw n.prev=16,n.t0=n["catch"](2),console.error("处理结果时出错:",n.t0),n.t0;case 20:case"end":return n.stop()}}),n,null,[[2,16]])})))()},processStreamingResponse:function(e,t){return(0,o.A)((0,r.A)().mark((function n(){var o,a,i;return(0,r.A)().wrap((function(n){while(1)switch(n.prev=n.next){case 0:return o=e.commit,a=e.state,i={method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat({NODE_ENV:"production",BASE_URL:"/vue/"}.VITE_API_KEY)},body:JSON.stringify({model:St(dt.BASIC),messages:[{role:"user",content:t}],max_tokens:1e3,stream:!0})},n.prev=2,n.next=5,a.streamHandler.fetchStream({NODE_ENV:"production",BASE_URL:"/vue/"}.VITE_API_URL,i,(function(e){o("UPDATE_STREAMING_CONTENT",e)}));case 5:n.next=11;break;case 7:throw n.prev=7,n.t0=n["catch"](2),console.error("Error in streaming response:",n.t0),n.t0;case 11:case"end":return n.stop()}}),n,null,[[2,7]])})))()},showGameTutorial:function(e){var t=e.commit,n={title:"游戏教程",content:'\n        <p>你可以把本游戏理解为<strong>跑团（DND或COC）</strong>、<strong>语C</strong>、<strong>剧本杀</strong>或<strong>过家家</strong>🧑‍🤝‍🧑。本游戏制作时面向的玩家是<strong>喜欢剧情向游戏</strong>，愿意<strong>认真扮演角色</strong>🎭  的语C、跑团玩家👥。</p>\n        <ol>\n          <li>📝 <strong>目标</strong>：在每一个桥段里，你需要完成<strong>桥段目标</strong>🎯，目标可能是<strong>沟通</strong>💬、<strong>战斗</strong>⚔️、<strong>解密</strong>🧩等。</li>\n          <li>🎮 <strong>操作</strong>：根据你的人设和起始事件，在对话框中打字输入以<strong>你的角色的角度</strong>进行的行动、说的话🗣️。比如输入"我挥起武器说，与我何干！"，不需要特别注意格式</li>\n          <li>💡 <strong>技巧</strong>：很多角色有<strong>超能力</strong>🔮，比如银月篇主角罗伯特，可以<strong>减缓时间流速</strong>🕰️，你可以接住敌方扔来的飞刀扔回去🗡️，也能准确地瞄准你要攻击的物件🎯，只要你能想到。</li>\n        </ol>\n\n        <ul>\n          <li>⚠️ <strong>注意</strong>：如果出现输入之后无回复，可以回<strong>主菜单-设置</strong>⚙️里面点"<strong>恢复默认设置</strong>🔄"。一般是初始化的网络问题🌐。</li>\n          <li>🔍 <strong>注意</strong>：高亮有颜色的文字可以点🔗。</li>\n          <li>📜 <strong>注意</strong>：在<strong>桥段剧本</strong>之外，主持人给出的信息不完全保真（比如问队友问题，可能会得到不正确的回复🤔），可以完全取信的是非大模型的<strong>桥段剧本</strong>、<strong>初始事件</strong>、<strong>词条解释</strong>。</li>\n        </ul>\n      '};t("SET_TUTORIAL_CONTENT",n),t("SET_SHOW_TUTORIAL",!0)},handleUserInput:function(e){return(0,o.A)((0,r.A)().mark((function t(){var n,o,a,i;return(0,r.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(n=e.commit,o=e.state,a=e.dispatch,!o.isSubmitting&&!o.isCooldown){t.next=3;break}return t.abrupt("return");case 3:if(i=o.userInput,i){t.next=6;break}return t.abrupt("return");case 6:if(n("ADD_CONVERSATION_HISTORY",{role:"user",content:i}),a("updateDisplay",{role:"user",content:i}),!(o.conversationHistory.length>40)){t.next=12;break}return t.next=11,a("endSection");case 11:return t.abrupt("return");case 12:return t.next=14,a("processUserInput",i);case 14:case"end":return t.stop()}}),t)})))()},callLargeLanguageModel:function(e,t){return(0,o.A)((0,r.A)().mark((function n(){var o,a,i;return(0,r.A)().wrap((function(n){while(1)switch(n.prev=n.next){case 0:return o=e.state,n.next=3,fetch(o.apiUrl,{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(o.apiKey),Accept:"application/json"},body:JSON.stringify({model:St(dt.BASIC),messages:[{role:"user",content:t}],max_tokens:1e3}),credentials:"include"});case 3:return a=n.sent,n.next=6,a.json();case 6:return i=n.sent,n.abrupt("return",i.choices[0].message.content);case 8:case"end":return n.stop()}}),n)})))()},updateInteractionStage:function(e,t){var n=e.commit,r=t.stage,o=t.info;n("SET_INTERACTION_STAGE",{stage:r,info:o})},hideInteractionStage:function(e){var t=e.commit;t("HIDE_INTERACTION_STAGE")},createPlayerInfo:function(e){var t=e.state,n=e.rootGetters,r=n["sections/getCurrentSectionData"];if(!r||!r.characters)return console.error("Section或characters未定义:",r),"";var o=r.characters.find((function(e){return!e.isAI}));if(!o)return console.warn("未找到玩家角色"),"";var a="<b>你的角色：</b>\n    <b>".concat(o.name,"</b>\n    ").concat(o.description);return o.characterTags&&t.gameManager&&(console.log("玩家角色标签:",o.characterTags),o.characterTags.forEach((function(e){var n=t.gameManager.getCharacterTag(e);console.log("标签键: ".concat(e,", 标签值: ").concat(n)),n&&(a+="<br>- ".concat(e,": ").concat(n))}))),a}},Ot={hasSave:function(e){return null!==e.currentSectionId},getLastRound:function(e){var t=e.conversationHistory.slice(-5);return t.map((function(e){return"".concat(e.role,": ").concat(e.content)})).join("\n")},isSubmitting:function(e){return e.isSubmitting},isCooldown:function(e){return e.isCooldown},selectedCharacter:function(e){return e.selectedCharacter},currentSection:function(e){return e.currentSection},conversationHistory:function(e){return e.conversationHistory},optimizedConversationHistory:function(e){return e.optimizedConversationHistory},gameManager:function(e){return e.gameManager},turnCount:function(e){return e.turnCount},plotTriggers:function(e){return e.plotTriggers},isGameInitialized:function(e){return e.isGameInitialized},interactionStage:function(e){return e.interactionStage},storyContent:function(e){return e.storyContent}};const Lt={namespaced:!0,state:Ct,mutations:xt,actions:It,getters:Ot};function Nt(e){var t="\n    <h2>".concat(e.title,"</h2>\n    <p><b>目标：").concat(e.objective,"</b></p>\n    <p>").concat(e.backgroundInfo,"</p>\n  ");return t}n(1688),n(3296),n(7208),n(8408),n(4603),n(7566),n(8721);var Pt="beyondBooksSaveData",Rt="YourExportSecretKey",Mt="reviewRecords",Dt=function(){return{hasSave:!1,currentSectionId:null,completedSections:[],unlockedSections:[],globalInfluencePoints:[],gameData:null}},Ut={SET_HAS_SAVE:function(e,t){e.hasSave=t},SET_SAVE_DATA:function(e,t){t?(e.currentSectionId=t.currentSectionId,e.completedSections=t.completedSections,e.unlockedSections=t.unlockedSections,e.globalInfluencePoints=t.globalInfluencePoints,e.hasSave=!0):(e.currentSectionId=null,e.completedSections=[],e.unlockedSections=[1],e.globalInfluencePoints=[],e.hasSave=!1)},SET_GAME_DATA:function(e,t){e.gameData=t},CLEAR_SAVE:function(e){e.gameData=null}},Bt={loadSave:function(e){var t=e.commit,n=localStorage.getItem(Pt),r=n?JSON.parse(n):null;return t("SET_SAVE_DATA",r),r},saveSave:function(e){var t=e.state,n={currentSectionId:t.currentSectionId,completedSections:t.completedSections,unlockedSections:t.unlockedSections,globalInfluencePoints:t.globalInfluencePoints};localStorage.setItem(Pt,JSON.stringify(n))},clearSave:function(e){var t=e.commit;t("CLEAR_SAVE"),localStorage.removeItem(Pt)},exportSave:function(e){return(0,o.A)((0,r.A)().mark((function t(){var n,o,a,i,s,c,u,l,p,d;return(0,r.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:n=e.state,o=JSON.stringify({currentSectionId:n.currentSectionId,completedSections:n.completedSections,unlockedSections:n.unlockedSections,globalInfluencePoints:n.globalInfluencePoints}),a=localStorage.getItem(Mt)||"{}",i=JSON.stringify({gameData:qe().AES.encrypt(o,Rt).toString(),reviewData:qe().AES.encrypt(a,Rt).toString()}),s=new Blob([i],{type:"application/octet-stream"}),c=URL.createObjectURL(s),u=new Date,l=u.toISOString().replace(/[:.]/g,"-").slice(0,19),p="BeyondBooks存档_".concat(l,".savegame"),d=document.createElement("a"),d.href=c,d.download=p,d.click(),URL.revokeObjectURL(c);case 14:case"end":return t.stop()}}),t)})))()},importSave:function(e,t){return(0,o.A)((0,r.A)().mark((function n(){var a;return(0,r.A)().wrap((function(n){while(1)switch(n.prev=n.next){case 0:return a=e.commit,n.abrupt("return",new Promise((function(e,n){var i=new FileReader;i.onload=function(){var t=(0,o.A)((0,r.A)().mark((function t(o){var i,s,c;return(0,r.A)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:try{i=JSON.parse(o.target.result),s=JSON.parse(qe().AES.decrypt(i.gameData,Rt).toString(qe().enc.Utf8)),c=JSON.parse(qe().AES.decrypt(i.reviewData,Rt).toString(qe().enc.Utf8)),localStorage.setItem(Pt,JSON.stringify(s)),a("SET_SAVE_DATA",s),localStorage.setItem(Mt,JSON.stringify(c)),e()}catch(r){n(new Error("导入失败，密钥不匹配或数据损坏"))}case 1:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}(),i.onerror=function(){return n(new Error("读取文件失败"))},i.readAsText(t)})));case 2:case"end":return n.stop()}}),n)})))()}},jt={saveData:function(e){return{currentSectionId:e.currentSectionId,completedSections:e.completedSections,unlockedSections:e.unlockedSections,globalInfluencePoints:e.globalInfluencePoints}},hasSave:function(e){return!!e.gameData}};const Gt={namespaced:!0,state:Dt,mutations:Ut,actions:Bt,getters:jt},Kt=(0,U.y$)({modules:{sections:ut,game:Lt,save:Gt}});var Ht={settings:{title:"设置",apiKeyLabel:"API Key",apiKeyPlaceholder:"输入你的API Key",apiUrlLabel:"API URL",apiUrlPlaceholder:"输入API URL",advancedModelLabel:"进阶模型 (用于桥段总结)",basicModelLabel:"基本模型 (用于其他操作)",saveButton:"保存设置",publicKeyButton:"获取公共key",resetButton:"恢复默认设置",helpButton:"这是什么？",savedMessage:"设置已保存",publicKeyFetched:"公共 Key 已成功获取并保存",resetMessage:"设置已恢复默认",helpTitle:"帮助信息",helpContent:"\n      <p>本游戏<strong>基于</strong>可访问<strong>大语言模型</strong>的接口API进行，您可自行寻找相关API服务，默认API地址不构成推荐建议</p>\n      <p>第一次打开游戏网页时会自动尝试获取公共key，所以您可能直接开始游戏就可以游玩了。</p>\n      <p>公共key是作者买来给大家玩的</p>\n      <p>如遇无法输入API KEY，可以刷新网页</p>\n    ",publicKeyFetchFailed:"获取公共 Key 失败，请检查网络连接或稍后再试",apiKeyDisabled:"API Key 已被禁用，因为正在使用公共 Key",text:"设置"},reviewTitle:"桥段回顾",returnToMenu:"返回主菜单",noReviewRecords:"暂无桥段回顾记录。",rename:"重命名",delete:"删除",viewDetails:"查看详情",reviewDetails:"回顾详情",exportAsHTML:"导出为HTML",exportAsImage:"导出为长图",exportAsMultipleImages:"导出为多图",enterNewTitle:"请输入新的标题",confirmDelete:"您确定要删除这条回顾记录吗？",close:"关闭",newGame:"开始新游戏",continueGame:"继续游戏",reviewRecords:"回顾记录",importSave:"导入存档",exportSave:"导出存档",deleteSave:"删除存档",confirmImport:"您确定要导入并覆盖存档吗？此操作无法撤销。您可以先导出自己的存档进行备份。",success:"成功",error:"错误",importSuccess:"存档已成功导入",tutorial:{title:"游戏教程",close:"关闭",understand:"我明白了",content:{intro:"你可以把本游戏理解为..."}},exportHTML:"导出HTML",exportImage:"导出长图",exportMultipleImages:"导出多图"};const Vt=(0,J.hU)({legacy:!1,locale:"zh-CN",messages:{"zh-CN":Ht}});var Ft={install:function(e){var t=(0,c.KR)({show:!1,title:"",content:"",closeButtonText:"关闭",buttons:[],large:!1}),n={show:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};t.value=(0,i.A)((0,i.A)({},t.value),{},{show:!0},n)},hide:function(){t.value.show=!1}};e.provide("$modal",n);var r=(0,a.Ef)({setup:function(){return function(){return(0,s.h)(v,(0,i.A)((0,i.A)({},t.value),{},{"onUpdate:show":function(e){return t.value.show=e},onClose:function(){return n.hide()}}))}}}),o=document.createElement("div");document.body.appendChild(o),r.mount(o)}};const $t=Ft;n(7917);var Xt={position:"top-right",timeout:3e3,closeOnClick:!0,pauseOnFocusLoss:!0,pauseOnHover:!0,draggable:!0,draggablePercent:.6,showCloseButtonOnHover:!1,hideProgressBar:!0,closeButton:"button",icon:!0,rtl:!1};const Wt=z.Ay;function zt(){return Jt.apply(this,arguments)}function Jt(){return Jt=(0,o.A)((0,r.A)().mark((function e(){var t;return(0,r.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,vt();case 3:t=(0,a.Ef)(P),t.config.errorHandler=function(e,t,n){console.error("Vue Error:",e),console.log("Component:",t),console.log("Error Info:",n)},t.use(Je),t.use(Kt),t.use(Vt),t.use($t),t.use(Wt,Xt),t.mount("#app"),e.next=16;break;case 13:e.prev=13,e.t0=e["catch"](0),console.error("初始化失败:",e.t0);case 16:case"end":return e.stop()}}),e,null,[[0,13]])}))),Jt.apply(this,arguments)}zt()},477:()=>{}},t={};function n(r){var o=t[r];if(void 0!==o)return o.exports;var a=t[r]={exports:{}};return e[r].call(a.exports,a,a.exports,n),a.exports}n.m=e,(()=>{var e=[];n.O=(t,r,o,a)=>{if(!r){var i=1/0;for(l=0;l<e.length;l++){for(var[r,o,a]=e[l],s=!0,c=0;c<r.length;c++)(!1&a||i>=a)&&Object.keys(n.O).every((e=>n.O[e](r[c])))?r.splice(c--,1):(s=!1,a<i&&(i=a));if(s){e.splice(l--,1);var u=o();void 0!==u&&(t=u)}}return t}a=a||0;for(var l=e.length;l>0&&e[l-1][2]>a;l--)e[l]=e[l-1];e[l]=[r,o,a]}})(),(()=>{n.n=e=>{var t=e&&e.__esModule?()=>e["default"]:()=>e;return n.d(t,{a:t}),t}})(),(()=>{n.d=(e,t)=>{for(var r in t)n.o(t,r)&&!n.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})}})(),(()=>{n.f={},n.e=e=>Promise.all(Object.keys(n.f).reduce(((t,r)=>(n.f[r](e,t),t)),[]))})(),(()=>{n.u=e=>"assets/js/"+e+".a1dbef0e.js"})(),(()=>{n.miniCssF=e=>"assets/css/"+e+".662c6ded.css"})(),(()=>{n.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"===typeof window)return window}}()})(),(()=>{n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t)})(),(()=>{var e={},t="beyond-books-vue:";n.l=(r,o,a,i)=>{if(e[r])e[r].push(o);else{var s,c;if(void 0!==a)for(var u=document.getElementsByTagName("script"),l=0;l<u.length;l++){var p=u[l];if(p.getAttribute("src")==r||p.getAttribute("data-webpack")==t+a){s=p;break}}s||(c=!0,s=document.createElement("script"),s.charset="utf-8",s.timeout=120,n.nc&&s.setAttribute("nonce",n.nc),s.setAttribute("data-webpack",t+a),s.src=r),e[r]=[o];var d=(t,n)=>{s.onerror=s.onload=null,clearTimeout(h);var o=e[r];if(delete e[r],s.parentNode&&s.parentNode.removeChild(s),o&&o.forEach((e=>e(n))),t)return t(n)},h=setTimeout(d.bind(null,void 0,{type:"timeout",target:s}),12e4);s.onerror=d.bind(null,s.onerror),s.onload=d.bind(null,s.onload),c&&document.head.appendChild(s)}}})(),(()=>{n.r=e=>{"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}})(),(()=>{n.p="/vue/"})(),(()=>{if("undefined"!==typeof document){var e=(e,t,r,o,a)=>{var i=document.createElement("link");i.rel="stylesheet",i.type="text/css",n.nc&&(i.nonce=n.nc);var s=n=>{if(i.onerror=i.onload=null,"load"===n.type)o();else{var r=n&&n.type,s=n&&n.target&&n.target.href||t,c=new Error("Loading CSS chunk "+e+" failed.\n("+r+": "+s+")");c.name="ChunkLoadError",c.code="CSS_CHUNK_LOAD_FAILED",c.type=r,c.request=s,i.parentNode&&i.parentNode.removeChild(i),a(c)}};return i.onerror=i.onload=s,i.href=t,r?r.parentNode.insertBefore(i,r.nextSibling):document.head.appendChild(i),i},t=(e,t)=>{for(var n=document.getElementsByTagName("link"),r=0;r<n.length;r++){var o=n[r],a=o.getAttribute("data-href")||o.getAttribute("href");if("stylesheet"===o.rel&&(a===e||a===t))return o}var i=document.getElementsByTagName("style");for(r=0;r<i.length;r++){o=i[r],a=o.getAttribute("data-href");if(a===e||a===t)return o}},r=r=>new Promise(((o,a)=>{var i=n.miniCssF(r),s=n.p+i;if(t(i,s))return o();e(r,s,null,o,a)})),o={524:0};n.f.miniCss=(e,t)=>{var n={561:1};o[e]?t.push(o[e]):0!==o[e]&&n[e]&&t.push(o[e]=r(e).then((()=>{o[e]=0}),(t=>{throw delete o[e],t})))}}})(),(()=>{var e={524:0};n.f.j=(t,r)=>{var o=n.o(e,t)?e[t]:void 0;if(0!==o)if(o)r.push(o[2]);else{var a=new Promise(((n,r)=>o=e[t]=[n,r]));r.push(o[2]=a);var i=n.p+n.u(t),s=new Error,c=r=>{if(n.o(e,t)&&(o=e[t],0!==o&&(e[t]=void 0),o)){var a=r&&("load"===r.type?"missing":r.type),i=r&&r.target&&r.target.src;s.message="Loading chunk "+t+" failed.\n("+a+": "+i+")",s.name="ChunkLoadError",s.type=a,s.request=i,o[1](s)}};n.l(i,c,"chunk-"+t,t)}},n.O.j=t=>0===e[t];var t=(t,r)=>{var o,a,[i,s,c]=r,u=0;if(i.some((t=>0!==e[t]))){for(o in s)n.o(s,o)&&(n.m[o]=s[o]);if(c)var l=c(n)}for(t&&t(r);u<i.length;u++)a=i[u],n.o(e,a)&&e[a]&&e[a][0](),e[a]=0;return n.O(l)},r=self["webpackChunkbeyond_books_vue"]=self["webpackChunkbeyond_books_vue"]||[];r.forEach(t.bind(null,0)),r.push=t.bind(null,r.push.bind(r))})();var r=n.O(void 0,[504],(()=>n(3500)));r=n.O(r)})();